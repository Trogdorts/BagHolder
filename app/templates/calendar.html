{% extends "base.html" %}
{% block content %}
{% set ui_cfg = cfg.get('ui', {}) %}
{% set notes_cfg = cfg.get('notes', {}) %}
{% set show_unrealized_default = show_unrealized_flag if show_unrealized_flag is defined else ui_cfg.get('show_unrealized', True) %}
{% set show_trade_count_badges = show_trade_badges if show_trade_badges is defined else ui_cfg.get('show_trade_count', True) %}
{% set show_text_default = show_text_flag if show_text_flag is defined else ui_cfg.get('show_text', True) %}
{% set show_weekends = show_weekends_flag if show_weekends_flag is defined else ui_cfg.get('show_weekends', False) %}
{% set notes_enabled = notes_enabled_flag if notes_enabled_flag is defined else notes_cfg.get('enabled', True) %}
<div x-data="{
        showUnrealized: {{ 'true' if show_unrealized_default else 'false' }},
        exportOpen: false,
        init() {
          try {
            const storage = window.localStorage;
            if (!storage) {
              return;
            }

            const stored = storage.getItem('bagholder:showUnrealized');
            if (stored !== null) {
              this.showUnrealized = stored === 'true';
            }

            this.$watch('showUnrealized', (value) => {
              storage.setItem('bagholder:showUnrealized', value ? 'true' : 'false');
            });
          } catch (error) {
            console.warn('Unable to persist showUnrealized preference', error);
          }
        }
      }" class="space-y-4">
<div class="flex items-center justify-between">
  <div class="text-lg font-semibold">{{ year }}-{{ "%02d"|format(month) }}</div>
  <div class="flex items-center gap-2 flex-wrap justify-end" @keydown.escape.window="exportOpen = false">
    {% set prev_year = (month == 1) and year-1 or year %}
    {% set prev_month = (month == 1) and 12 or month-1 %}
    {% set next_year = (month == 12) and year+1 or year %}
    {% set next_month = (month == 12) and 1 or month+1 %}
    <a href="/calendar/{{ prev_year }}/{{ prev_month }}" class="px-3 py-1 border border-neutral-700 rounded hover:bg-neutral-800">Prev</a>
    <a href="/calendar/{{ current_year }}/{{ current_month }}" class="px-3 py-1 border border-neutral-700 rounded hover:bg-neutral-800">Home</a>
    <a href="/calendar/{{ next_year }}/{{ next_month }}" class="px-3 py-1 border border-neutral-700 rounded hover:bg-neutral-800">Next</a>
    <div class="relative">
      <button type="button"
              class="px-3 py-1 border border-neutral-700 rounded hover:bg-neutral-800 transition"
              :class="{ 'bg-neutral-800 text-neutral-100 border-neutral-600': exportOpen }"
              @click="exportOpen = !exportOpen"
              aria-haspopup="true"
              :aria-expanded="exportOpen.toString()">
        Export
      </button>
      <div x-show="exportOpen"
           x-cloak
           @click.outside="exportOpen = false"
           class="absolute right-0 z-30 mt-2 w-72 space-y-3 rounded border border-neutral-800 bg-neutral-950 p-4 shadow-xl">
        <form method="get" action="/export" class="space-y-3">
          <p class="text-sm text-neutral-300">Download data from the selected date range.</p>
          <div class="space-y-2">
            <label class="block text-sm">
              <span class="text-neutral-400">Start date</span>
              <input type="date" name="start" value="{{ export_default_start }}"
                     class="mt-1 w-full rounded border border-neutral-700 bg-neutral-900 px-2 py-1 text-neutral-100 focus:outline-none focus:ring-1 focus:ring-neutral-500" />
            </label>
            <label class="block text-sm">
              <span class="text-neutral-400">End date</span>
              <input type="date" name="end" value="{{ export_default_end }}"
                     class="mt-1 w-full rounded border border-neutral-700 bg-neutral-900 px-2 py-1 text-neutral-100 focus:outline-none focus:ring-1 focus:ring-neutral-500" />
            </label>
            <label class="block text-sm">
              <span class="text-neutral-400">Data type</span>
              <select name="dataset"
                      class="mt-1 w-full rounded border border-neutral-700 bg-neutral-900 px-2 py-1 text-neutral-100 focus:outline-none focus:ring-1 focus:ring-neutral-500">
                <option value="summaries">Daily summaries (CSV)</option>
                <option value="trades">Trades (CSV)</option>
                <option value="notes">Notes (JSON)</option>
              </select>
            </label>
          </div>
          <div class="flex items-center justify-end gap-2 pt-2 border-t border-neutral-800">
            <button type="button" class="px-3 py-1 rounded border border-neutral-700 hover:bg-neutral-800" @click="exportOpen = false">Cancel</button>
            <button type="submit" class="px-3 py-1 rounded bg-blue-600 text-white hover:bg-blue-500">Download</button>
          </div>
        </form>
      </div>
    </div>
    <button type="button"
            class="px-3 py-1 border border-neutral-700 rounded hover:bg-neutral-800 transition"
            :class="{ 'bg-neutral-800 text-neutral-100 border-neutral-600': !showUnrealized }"
            @click="showUnrealized = !showUnrealized"
            aria-pressed="{{ 'true' if show_unrealized_default else 'false' }}"
            :aria-pressed="showUnrealized.toString()">
      <span x-text="showUnrealized ? 'Hide unrealized' : 'Show unrealized'">
        {% if show_unrealized_default %}Hide unrealized{% else %}Show unrealized{% endif %}
      </span>
    </button>
  </div>
</div>

{% set day_labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'] %}
{% set visible_day_labels = day_labels if show_weekends else day_labels[:5] %}
{% set grid_columns = visible_day_labels|length + 1 %}

<div class="grid gap-2" style="grid-template-columns: repeat({{ grid_columns }}, minmax(0, 1fr));">
  {% for label in visible_day_labels %}
  <div class="text-xs text-neutral-400">{{ label }}</div>
  {% endfor %}
  <div class="text-xs text-neutral-400 text-right">Week</div>
</div>

<div class="grid gap-2 mt-2" style="grid-template-columns: repeat({{ grid_columns }}, minmax(0, 1fr));">
{% for week in weeks %}
  {% for d in week.days %}
    {% if show_weekends or not d.is_weekend %}
      {% set cls = (d.realized > 0) and 'cell-bg-pos' or (d.realized < 0) and 'cell-bg-neg' or 'bg-neutral-900' %}
      <div class="relative min-h-[7rem] rounded border border-neutral-800 p-2 {{ 'opacity-100' if d.in_month else 'opacity-30' }} {{ cls }} flex flex-col gap-2" data-day-cell="{{ d.date.strftime('%Y-%m-%d') }}">
        <div class="flex items-center gap-1 text-xs text-neutral-400">
          <span>{{ d.date.day }}</span>
          {% set trade_button_classes = [
            'relative inline-flex items-center justify-center rounded-full bg-emerald-900/20 p-1 text-emerald-400 hover:bg-emerald-800/30 focus:outline-none focus:ring-2 focus:ring-emerald-500'
          ] %}
          {% if not d.has_trades %}
            {% set trade_button_classes = trade_button_classes + ['icon-translucent'] %}
          {% endif %}
          <button type="button"
                  class="{{ trade_button_classes|join(' ') }}"
                  onclick="openTrades('{{ d.date.strftime('%Y-%m-%d') }}'); return false;"
                  aria-label="View trades">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
              <circle cx="12" cy="12" r="9" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h-1.125a1.875 1.875 0 000 3.75h2.25a1.875 1.875 0 010 3.75H12m0-10.5v10.5" />
            </svg>
            <span class="sr-only">View trades</span>
            {% set trade_count = d.trades|length %}
            {% if trade_count and show_trade_count_badges %}
            <span class="trade-count-badge absolute -top-1 -right-1 min-w-[1.25rem] rounded-full bg-emerald-400 text-neutral-900 text-[10px] font-semibold px-1 text-center">{{ trade_count }}</span>
            {% endif %}
          </button>
        </div>

        {% if show_text_default %}
        <div class="text-sm space-y-1">
          {% set realized_class = 'text-green-400' if d.realized > 0 else ('text-red-400' if d.realized < 0 else 'text-neutral-200') %}
          {% if d.show_realized %}
          <div class="{{ realized_class }}">Realized: {{ d.realized|money }}</div>
          {% endif %}
          <div class="{{ 'text-green-400' if d.unrealized > 0 else ('text-red-400' if d.unrealized < 0 else 'text-neutral-200') }}"
               x-show="showUnrealized" x-cloak>
            Unrealized: {{ d.unrealized|money }}
          </div>
        </div>
        {% endif %}

        <!-- Gear icon for manual entry -->
        <a class="absolute top-1 right-1 icon-translucent z-10" href="#"
           aria-label="Edit daily values"
           onclick="openManual('{{ d.date.strftime('%Y-%m-%d') }}', {{ d.realized }}, {{ d.unrealized }}); return false;">
          <svg class="w-4 h-4 action-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M19.14,12.94a7.43,7.43,0,0,0,.05-.94,7.43,7.43,0,0,0-.05-.94l2.11-1.65a.5.5,0,0,0,.12-.64l-2-3.46a.5.5,0,0,0-.6-.22l-2.49,1a7.3,7.3,0,0,0-1.63-.94l-.38-2.65A.5.5,0,0,0,12.64,1H9.36a.5.5,0,0,0-.49.41L8.49,4.06a7.3,7.3,0,0,0-1.63.94l-2.49-1a.5.5,0,0,0-.6.22l-2,3.46a.5.5,0,0,0,.12.64L3.94,11.06a7.43,7.43,0,0,0-.05.94,7.43,7.43,0,0,0,.05.94L1.83,14.59a.5.5,0,0,0-.12.64l2,3.46a.5.5,0,0,0,.6.22l2.49-1a7.3,7.3,0,0,0,1.63.94l.38,2.65a.5.5,0,0,0,.49.41h3.28a.5.5,0,0,0,.49-.41l.38-2.65a7.3,7.3,0,0,0,1.63-.94l2.49,1a.5.5,0,0,0,.6-.22l2-3.46a.5.5,0,0,0-.12-.64Zm-7.14,2.56A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z" fill="currentColor" />
          </svg>
        </a>
        {% if notes_enabled %}
        <!-- Note icon -->
        <a class="note-trigger absolute bottom-1 right-1 icon-translucent z-10{% if d.has_note %} has-note{% endif %}"
           href="#"
           aria-label="{{ 'Edit daily note' if d.has_note else 'Add daily note' }}"
           data-note-text="{{ d.note | e }}"
           data-note-updated="{{ d.note_updated_at | default('', true) }}"
           onclick="openDailyNote('{{ d.date.strftime('%Y-%m-%d') }}'); return false;">
          <svg class="w-4 h-4 action-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M19 3H5a2 2 0 0 0-2 2v14l4-4h12a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z" fill="currentColor" />
          </svg>
          <div class="note-tooltip absolute bottom-6 right-0 z-20 rounded border border-neutral-700 bg-neutral-900 p-2 text-xs text-neutral-100 shadow-lg w-fit">
            <p class="whitespace-pre-line" data-note-tooltip-body>{{ d.note | e }}</p>
          </div>
        </a>
        {% endif %}
      </div>
    {% endif %}
  {% endfor %}
  {% set week_cls = (week.week_realized > 0) and 'cell-bg-pos' or (week.week_realized < 0) and 'cell-bg-neg' or 'bg-neutral-900' %}
  <div class="relative min-h-[7rem] rounded border border-neutral-800 p-2 flex flex-col justify-between {{ week_cls }}">
    <div>
      <div class="text-xs text-neutral-400">Week {{ week.week_index }}</div>
      <div class="mt-2 text-sm space-y-1 text-right">
        <div class="{{ 'text-green-400' if week.week_realized > 0 else ('text-red-400' if week.week_realized < 0 else 'text-neutral-200') }}">Realized: {{ week.week_realized|money }}</div>
        <div class="{{ 'text-green-400' if week.week_unrealized > 0 else ('text-red-400' if week.week_unrealized < 0 else 'text-neutral-200') }}"
             x-show="showUnrealized" x-cloak>
          Unrealized: {{ week.week_unrealized|money }}
        </div>
      </div>
    </div>
    {% if notes_enabled %}
    <div class="flex justify-end">
      <a class="note-trigger weekly-note-trigger z-10{% if week.has_note %} has-note{% else %} icon-translucent{% endif %}" href="#"
         aria-label="{{ 'Edit weekly note' if week.has_note else 'Add weekly note' }}"
         data-week-year="{{ week.week_year }}"
         data-week-index="{{ week.week_number }}"
         data-note-text="{{ week.note | default('', true) | e }}"
         data-note-updated="{{ week.note_updated_at | default('', true) }}"
         onclick="openWeeklyNote({{ week.week_year }}, {{ week.week_number }}); return false;">
        <svg class="w-4 h-4 action-icon{% if week.has_note %} text-amber-400{% endif %}" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M19 3H5a2 2 0 0 0-2 2v14l4-4h12a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z" fill="currentColor" />
        </svg>
        <div class="note-tooltip absolute bottom-6 right-0 z-20 rounded border border-neutral-700 bg-neutral-900 p-2 text-xs text-neutral-100 shadow-lg w-fit">
          <p class="whitespace-pre-line" data-note-tooltip-body>{{ week.note | default('', true) | e }}</p>
        </div>
      </a>
    </div>
    {% endif %}
  </div>
{% endfor %}
</div>

<div class="mt-6 max-w-3xl">
  <div class="grid gap-4 sm:grid-cols-2">
    <div class="rounded border border-neutral-800 p-3 bg-neutral-950 relative">
      <h2 class="font-semibold">Monthly summary</h2>
      <div>Realized: <span class="{{ 'text-green-400' if month_realized > 0 else ('text-red-400' if month_realized < 0 else 'text-neutral-200') }}">{{ month_realized|money }}</span></div>
      <div x-show="showUnrealized" x-cloak>
        Unrealized (invested): <span class="{{ 'text-green-400' if month_unrealized > 0 else ('text-red-400' if month_unrealized < 0 else 'text-neutral-200') }}">{{ month_unrealized|money }}</span>
      </div>
        {% set month_note_text = month_note.note | default('', true) %}
        {% set month_note_has = month_note_text.strip() %}
        {% if notes_enabled %}
        <a class="note-trigger absolute top-1 right-1 z-10{% if month_note_has %} has-note{% else %} icon-translucent{% endif %}" href="#"
           aria-label="{{ 'Edit monthly note' if month_note_has else 'Add monthly note' }}"
           data-month-key="{{ year }}-{{ '%02d'|format(month) }}"
           data-note-text="{{ month_note_text | e }}"
           data-note-updated="{{ month_note.updated_at | default('', true) }}"
           onclick="openMonthlyNote({{ year }}, {{ month }}); return false;">
          <svg class="w-4 h-4 action-icon{% if month_note_has %} text-amber-400{% endif %}" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M19 3H5a2 2 0 0 0-2 2v14l4-4h12a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z" fill="currentColor" />
          </svg>
          <div class="note-tooltip absolute bottom-6 right-0 z-20 rounded border border-neutral-700 bg-neutral-900 p-2 text-xs text-neutral-100 shadow-lg w-fit">
            <p class="whitespace-pre-line" data-note-tooltip-body>{{ month_note_text | e }}</p>
          </div>
        </a>
        {% endif %}
    </div>
    <div class="rounded border border-neutral-800 p-3 bg-neutral-950">
      <h2 class="font-semibold">Yearly summary</h2>
      <div>Realized: <span class="{{ 'text-green-400' if year_realized > 0 else ('text-red-400' if year_realized < 0 else 'text-neutral-200') }}">{{ year_realized|money }}</span></div>
      <div x-show="showUnrealized" x-cloak>
        Unrealized (invested): <span class="{{ 'text-green-400' if year_unrealized > 0 else ('text-red-400' if year_unrealized < 0 else 'text-neutral-200') }}">{{ year_unrealized|money }}</span>
      </div>
    </div>
  </div>
</div>

</div>

<!-- Modals -->
<div
  id="modal"
  x-data="{
    open: false,
    title: '',
    body: '',
    save: null,
    previouslyFocused: null,
    closeLabel: 'Close',
    saveLabel: 'Save',
    saving: false,
    shouldReloadOnClose: false,
    beforeClose: null,
    init() {
      window.modalController = this;
      this.$watch('open', (value) => {
        document.body.classList.toggle('modal-open', value);
        this.toggleBackgroundInteractivity(value);
        if (value) {
          this.storeActiveElement();
          this.$nextTick(() => this.focusFirstElement());
        } else {
          this.restoreActiveElement();
          this.resetState();
        }
      });
    },
    toggleBackgroundInteractivity(isOpen) {
      const applyState = (element) => {
        if (!element) {
          return;
        }
        element.classList.toggle('modal-background-inert', isOpen);
        if (isOpen) {
          element.setAttribute('aria-hidden', 'true');
        } else {
          element.removeAttribute('aria-hidden');
        }
        if ('inert' in element) {
          element.inert = isOpen;
        }
      };

      applyState(document.querySelector('nav'));

      const main = document.querySelector('main');
      if (!main) {
        return;
      }

      const backgroundElements = Array.from(main.children).filter((child) => child.id !== 'modal');
      backgroundElements.forEach(applyState);
    },
    storeActiveElement() {
      this.previouslyFocused = document.activeElement;
    },
    restoreActiveElement() {
      if (this.previouslyFocused && typeof this.previouslyFocused.focus === 'function') {
        this.previouslyFocused.focus({ preventScroll: true });
      }
      this.previouslyFocused = null;
    },
    focusFirstElement() {
      const dialog = this.$refs.dialog;
      if (!dialog) {
        return;
      }
      const focusable = dialog.querySelector('[data-autofocus], button, textarea, input, select, [tabindex]:not([tabindex=&quot;-1&quot;])');
      if (focusable && typeof focusable.focus === 'function') {
        focusable.focus();
      } else if (typeof dialog.focus === 'function') {
        dialog.focus();
      }
    },
    resetState() {
      this.save = null;
      this.closeLabel = 'Close';
      this.saveLabel = 'Save';
      this.saving = false;
      this.shouldReloadOnClose = false;
      this.beforeClose = null;
    },
    close(force = false) {
      if (!force && typeof this.beforeClose === 'function') {
        try {
          const shouldClose = this.beforeClose();
          if (shouldClose === false) {
            return;
          }
        } catch (error) {
          console.error(error);
          return;
        }
      }
      const reload = this.shouldReloadOnClose;
      this.open = false;
      if (reload) {
        setTimeout(() => window.location.reload(), 0);
      }
    },
  }"
  x-show="open"
  x-cloak
  class="fixed inset-0 z-50 bg-black/60 flex items-center justify-center"
  role="dialog"
  aria-modal="true"
  :aria-hidden="(!open).toString()"
  @click.self="close()"
  @keydown.escape.window.stop.prevent="close()"
>
  <div
    x-ref="dialog"
    class="bg-neutral-950 border border-neutral-800 rounded p-4 w-full max-w-3xl focus:outline-none"
    role="document"
    tabindex="-1"
    @click.stop
  >
    <h3 class="font-semibold mb-2" x-text="title"></h3>
    <div x-html="body"></div>
    <div class="mt-4 flex justify-end gap-2">
      <button type="button" class="px-3 py-1 rounded border border-neutral-700" @click="close()" x-text="closeLabel"></button>
      <button
        type="button"
        class="px-3 py-1 rounded bg-blue-600 hover:bg-blue-500"
        :class="{ 'opacity-60 cursor-not-allowed': saving || !save }"
        :disabled="saving || !save"
        @click="if (!saving && save) save()"
      >
        <span x-text="saving ? 'Saving…' : saveLabel"></span>
      </button>
    </div>
  </div>
</div>

<script>
function openTrades(dateStr) {
  fetch('/api/trades/' + dateStr)
    .then(response => {
      if (!response.ok) {
        return response.json().catch(() => ({})).then(data => {
          const message = data && data.detail ? data.detail : 'Failed to load trades.';
          throw new Error(message);
        });
      }
      return response.json();
    })
    .then(js => {
      const modal = getModalController();
      if (!modal) return;
      modal.title = 'Trades ' + dateStr;
      modal.body = createTradeEditorHTML();
      modal.save = () => saveTrades(dateStr);
      modal.open = true;
      setTimeout(() => setupTradeEditor(js.trades || [], dateStr), 0);
    })
    .catch(err => {
      const modal = getModalController();
      if (!modal) return;
      modal.title = 'Trades ' + dateStr;
      modal.body = `<p class="text-sm text-red-400">${err.message || 'Failed to load trades.'}</p>`;
      modal.save = null;
      modal.open = true;
    });
}

function createTradeEditorHTML() {
  return `
    <div id="trade-editor" class="space-y-3">
      <p id="trade-error" class="text-sm text-red-400 hidden"></p>
      <p id="trade-success" class="text-sm text-emerald-400 hidden"></p>
      <p id="trade-unsaved" class="text-xs text-amber-400 hidden">Unsaved changes. Save your trades to keep them.</p>
      <div id="trade-empty-message" class="text-sm text-neutral-400 hidden">No trades recorded for this date.</div>
      <div class="overflow-x-auto" style="max-height: 20rem; overflow-y: auto;">
        <table class="min-w-full text-sm text-left text-neutral-200 border border-neutral-800">
          <thead class="bg-neutral-900 text-neutral-400">
            <tr>
              <th class="px-2 py-1 border border-neutral-800">Action</th>
              <th class="px-2 py-1 border border-neutral-800">Symbol</th>
              <th class="px-2 py-1 border border-neutral-800 text-right">Quantity</th>
              <th class="px-2 py-1 border border-neutral-800 text-right">Price</th>
              <th class="px-2 py-1 border border-neutral-800 text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="trade-table-body"></tbody>
        </table>
      </div>
      <div class="flex items-center justify-between flex-wrap gap-2">
        <div class="flex items-center gap-2">
          <button type="button" id="add-trade-row" class="px-3 py-1 rounded border border-neutral-700 hover:bg-neutral-800 text-sm">Add trade</button>
          <button type="button" id="clear-trades" class="px-3 py-1 rounded border border-red-700 text-red-300 hover:bg-red-900/40 text-sm">Clear all trades</button>
        </div>
        <span class="text-xs text-neutral-500">Remove a row to delete a trade. Amounts are calculated on save.</span>
      </div>
    </div>`;
}

const tradeEditorState = {
  initialSnapshot: '[]',
  isDirty: false,
  unsavedWarning: null,
};

function getTradeEditorWarningElement() {
  if (tradeEditorState.unsavedWarning && document.body && document.body.contains(tradeEditorState.unsavedWarning)) {
    return tradeEditorState.unsavedWarning;
  }
  const element = document.getElementById('trade-unsaved');
  tradeEditorState.unsavedWarning = element || null;
  return tradeEditorState.unsavedWarning;
}

function setTradeEditorDirty(isDirty) {
  tradeEditorState.isDirty = !!isDirty;
  const warning = getTradeEditorWarningElement();
  if (warning) {
    warning.classList.toggle('hidden', !tradeEditorState.isDirty);
  }
}

function captureTradeEditorSnapshot() {
  const tbody = document.getElementById('trade-table-body');
  if (!tbody) {
    return '[]';
  }
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const normalized = rows.map((row) => {
    const actionSelect = row.querySelector('.trade-action');
    const symbolInput = row.querySelector('.trade-symbol');
    const qtyInput = row.querySelector('.trade-qty');
    const priceInput = row.querySelector('.trade-price');
    return {
      id: row.dataset.tradeId ? String(row.dataset.tradeId) : '',
      action: actionSelect ? actionSelect.value : '',
      symbol: symbolInput ? symbolInput.value : '',
      qty: qtyInput ? qtyInput.value : '',
      price: priceInput ? priceInput.value : '',
    };
  });
  return JSON.stringify(normalized);
}

function refreshTradeEditorDirtyState() {
  const snapshot = captureTradeEditorSnapshot();
  const isDirty = snapshot !== tradeEditorState.initialSnapshot;
  setTradeEditorDirty(isDirty);
  return isDirty;
}

function resetTradeEditorInitialSnapshot() {
  tradeEditorState.initialSnapshot = captureTradeEditorSnapshot();
  setTradeEditorDirty(false);
}

function focusTradeEditorFirstField() {
  const editor = document.getElementById('trade-editor');
  if (!editor) {
    return;
  }
  const field = editor.querySelector('.trade-symbol, .trade-qty, .trade-price, .trade-action');
  if (field && typeof field.focus === 'function') {
    try {
      field.focus({ preventScroll: true });
    } catch (error) {
      field.focus();
    }
  }
}

function setupTradeEditor(trades) {
  clearTradeEditorMessages();
  const tbody = document.getElementById('trade-table-body');
  if (!tbody) return;

  tbody.innerHTML = '';
  (trades || []).forEach(trade => {
    tbody.appendChild(createTradeRow(trade));
  });

  const addButton = document.getElementById('add-trade-row');
  if (addButton) {
    addButton.onclick = () => {
      hideTradeEditorSuccess();
      tbody.appendChild(createTradeRow({ action: 'BUY', symbol: '', qty: '', price: '' }));
      updateTradeEmptyState();
      refreshTradeEditorDirtyState();
    };
  }

  const clearButton = document.getElementById('clear-trades');
  if (clearButton) {
    clearButton.onclick = () => {
      hideTradeEditorSuccess();
      clearTrades(dateStr);
    };
  }

  updateTradeEmptyState();

  tradeEditorState.unsavedWarning = document.getElementById('trade-unsaved');
  resetTradeEditorInitialSnapshot();

  const modal = getModalController();
  if (modal) {
    modal.beforeClose = () => {
      const dirty = refreshTradeEditorDirtyState();
      if (!dirty) {
        return true;
      }
      const confirmClose = window.confirm('You have unsaved changes to these trades. Discard them?');
      if (!confirmClose) {
        focusTradeEditorFirstField();
        return false;
      }
      return true;
    };
  }
}

function createTradeRow(trade) {
  const row = document.createElement('tr');
  row.className = 'border-b border-neutral-800';
  if (trade && trade.id !== undefined && trade.id !== null) {
    row.dataset.tradeId = String(trade.id);
  }

  const markDirty = () => {
    hideTradeEditorSuccess();
    refreshTradeEditorDirtyState();
  };

  const actionCell = document.createElement('td');
  actionCell.className = 'px-2 py-1 border border-neutral-800';
  const actionSelect = document.createElement('select');
  actionSelect.className = 'trade-action bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-neutral-100';
  ['BUY', 'SELL'].forEach(optionValue => {
    const option = document.createElement('option');
    option.value = optionValue;
    option.textContent = optionValue;
    actionSelect.appendChild(option);
  });
  const actionValue = trade && trade.action ? String(trade.action).toUpperCase() : 'BUY';
  actionSelect.value = actionValue;
  actionSelect.addEventListener('change', markDirty);
  actionCell.appendChild(actionSelect);
  row.appendChild(actionCell);

  const symbolCell = document.createElement('td');
  symbolCell.className = 'px-2 py-1 border border-neutral-800';
  const symbolInput = document.createElement('input');
  symbolInput.type = 'text';
  symbolInput.className = 'trade-symbol w-full bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-neutral-100 uppercase';
  symbolInput.value = trade && trade.symbol ? trade.symbol : '';
  symbolInput.autocomplete = 'off';
  symbolInput.spellcheck = false;
  symbolInput.addEventListener('input', markDirty);
  symbolCell.appendChild(symbolInput);
  row.appendChild(symbolCell);

  const qtyCell = document.createElement('td');
  qtyCell.className = 'px-2 py-1 border border-neutral-800 text-right';
  const qtyInput = document.createElement('input');
  qtyInput.type = 'number';
  qtyInput.step = '1';
  qtyInput.min = '0';
  qtyInput.inputMode = 'decimal';
  qtyInput.className = 'trade-qty w-full bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-neutral-100 text-right';
  qtyInput.value = trade && trade.qty !== undefined && trade.qty !== null ? trade.qty : '';
  qtyInput.addEventListener('input', markDirty);
  qtyCell.appendChild(qtyInput);
  row.appendChild(qtyCell);

  const priceCell = document.createElement('td');
  priceCell.className = 'px-2 py-1 border border-neutral-800 text-right';
  const priceInput = document.createElement('input');
  priceInput.type = 'number';
  priceInput.step = '0.01';
  priceInput.min = '0';
  priceInput.inputMode = 'decimal';
  priceInput.className = 'trade-price w-full bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-neutral-100 text-right';
  priceInput.value = trade && trade.price !== undefined && trade.price !== null ? trade.price : '';
  priceInput.addEventListener('input', markDirty);
  priceCell.appendChild(priceInput);
  row.appendChild(priceCell);

  const actionsCell = document.createElement('td');
  actionsCell.className = 'px-2 py-1 border border-neutral-800 text-right';
  const removeButton = document.createElement('button');
  removeButton.type = 'button';
  removeButton.className = 'remove-trade-row px-2 py-1 rounded border border-red-700 text-red-300 hover:bg-red-900/40 text-xs';
  removeButton.textContent = 'Remove';
  removeButton.addEventListener('click', () => {
    hideTradeEditorSuccess();
    row.remove();
    updateTradeEmptyState();
    refreshTradeEditorDirtyState();
  });
  actionsCell.appendChild(removeButton);
  row.appendChild(actionsCell);

  return row;
}

function updateTradeEmptyState() {
  const tbody = document.getElementById('trade-table-body');
  const message = document.getElementById('trade-empty-message');
  if (!tbody || !message) return;
  if (tbody.children.length === 0) {
    message.classList.remove('hidden');
  } else {
    message.classList.add('hidden');
  }
}

function clearTradeEditorMessages() {
  const errorEl = document.getElementById('trade-error');
  if (errorEl) {
    errorEl.textContent = '';
    errorEl.classList.add('hidden');
  }
  hideTradeEditorSuccess();
}

function hideTradeEditorSuccess() {
  const successEl = document.getElementById('trade-success');
  if (successEl) {
    successEl.textContent = '';
    successEl.classList.add('hidden');
  }
}

function showTradeEditorError(message) {
  hideTradeEditorSuccess();
  const errorEl = document.getElementById('trade-error');
  if (errorEl) {
    errorEl.textContent = message;
    errorEl.classList.remove('hidden');
  }
}

function showTradeEditorSuccess(message) {
  const errorEl = document.getElementById('trade-error');
  if (errorEl) {
    errorEl.textContent = '';
    errorEl.classList.add('hidden');
  }
  const successEl = document.getElementById('trade-success');
  if (successEl) {
    successEl.textContent = message;
    successEl.classList.remove('hidden');
  }
}

function saveTrades(dateStr) {
  const modal = getModalController();
  if (!modal) return;
  const tbody = document.getElementById('trade-table-body');
  if (!tbody) return;

  clearTradeEditorMessages();

  const rows = Array.from(tbody.querySelectorAll('tr'));
  const trades = [];
  let hasError = false;

  rows.forEach(row => {
    const actionSelect = row.querySelector('.trade-action');
    const symbolInput = row.querySelector('.trade-symbol');
    const qtyInput = row.querySelector('.trade-qty');
    const priceInput = row.querySelector('.trade-price');

    const symbol = symbolInput ? symbolInput.value.trim() : '';
    const qtyRaw = qtyInput ? qtyInput.value.trim() : '';
    const priceRaw = priceInput ? priceInput.value.trim() : '';
    const isEmpty = !symbol && !qtyRaw && !priceRaw;

    if (isEmpty) {
      row.classList.remove('bg-red-900/40');
      return;
    }

    const qty = parseFloat(qtyRaw);
    const price = parseFloat(priceRaw);
    if (!symbol || Number.isNaN(qty) || Number.isNaN(price) || qty <= 0 || price <= 0) {
      row.classList.add('bg-red-900/40');
      hasError = true;
      return;
    }

    row.classList.remove('bg-red-900/40');
    trades.push({
      id: row.dataset.tradeId ? Number(row.dataset.tradeId) : null,
      symbol: symbol.toUpperCase(),
      action: actionSelect ? actionSelect.value : 'BUY',
      qty: Math.abs(qty),
      price: Math.abs(price),
    });
  });

  if (hasError) {
    showTradeEditorError('Please complete all fields for each trade or remove unused rows.');
    return;
  }

  modal.saving = true;

  fetch('/api/trades/' + dateStr, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ trades }),
  })
    .then(response => {
      if (!response.ok) {
        return response.json().catch(() => ({})).then(data => {
          const message = data && data.detail ? data.detail : 'Failed to save trades.';
          throw new Error(message);
        });
      }
      return response.json();
    })
    .then(data => {
      const savedTrades = data && Array.isArray(data.trades) ? data.trades : [];
      setupTradeEditor(savedTrades, dateStr);
      showTradeEditorSuccess('Trades saved. You can continue adding stocks.');
      modal.shouldReloadOnClose = true;
      updateTradeIndicators(dateStr, savedTrades);
    })
    .catch(err => {
      showTradeEditorError(err.message || 'Failed to save trades.');
    })
    .finally(() => {
      modal.saving = false;
    });
}

function clearTrades(dateStr) {
  if (!dateStr) {
    return;
  }

  const modal = getModalController();
  if (!modal) {
    return;
  }

  const confirmed = window.confirm(`Clear all trades for ${dateStr}? This action cannot be undone.`);
  if (!confirmed) {
    return;
  }

  modal.saving = true;
  clearTradeEditorMessages();

  fetch('/api/trades/' + dateStr, { method: 'DELETE' })
    .then(response => {
      if (!response.ok) {
        return response.json().catch(() => ({})).then(data => {
          const message = data && data.detail ? data.detail : 'Failed to clear trades.';
          throw new Error(message);
        });
      }
      return response.json();
    })
    .then(data => {
      setupTradeEditor([], dateStr);
      showTradeEditorSuccess('All trades cleared for this date.');
      updateTradeIndicators(dateStr, []);
      modal.shouldReloadOnClose = true;
    })
    .catch(err => {
      showTradeEditorError(err && err.message ? err.message : 'Failed to clear trades.');
    })
    .finally(() => {
      modal.saving = false;
    });
}

function updateTradeIndicators(dateStr, trades) {
  const cell = document.querySelector(`[data-day-cell='${dateStr}']`);
  if (!cell) {
    return;
  }
  const trigger = cell.querySelector("button[aria-label='View trades']");
  if (!trigger) {
    return;
  }

  const tradeCount = Array.isArray(trades) ? trades.length : 0;
  trigger.classList.toggle('icon-translucent', tradeCount === 0);

  let badge = trigger.querySelector('.trade-count-badge');
  if (tradeCount > 0) {
    if (!badge) {
      badge = document.createElement('span');
      badge.className = 'trade-count-badge absolute -top-1 -right-1 min-w-[1.25rem] rounded-full bg-emerald-400 text-neutral-900 text-[10px] font-semibold px-1 text-center';
      trigger.appendChild(badge);
    }
    badge.textContent = String(tradeCount);
  } else if (badge) {
    badge.remove();
  }
}

  function openManual(dateStr, realized, unrealized) {
    const modal = getModalController();
    if (!modal) return;

    const normalizedRealized = typeof realized === 'number' && Number.isFinite(realized) ? realized : '';
    const normalizedUnrealized = typeof unrealized === 'number' && Number.isFinite(unrealized) ? unrealized : '';

    modal.title = 'Manual edit ' + dateStr;
    modal.closeLabel = 'Cancel';
    modal.saveLabel = 'Save values';
    modal.saving = false;
    modal.body = `
      <form id="manual-form" class="space-y-3">
        <p class="text-sm text-red-400 hidden" data-manual-error></p>
        <label class="block text-sm space-y-1">
          <span class="text-neutral-300">Realized</span>
          <input type="number" step="0.01" inputmode="decimal" name="realized" value="${normalizedRealized}" class="w-full rounded border border-neutral-700 bg-neutral-900 px-2 py-1 text-neutral-100 focus:outline-none focus:ring-1 focus:ring-neutral-500">
        </label>
        <label class="block text-sm space-y-1">
          <span class="text-neutral-300">Unrealized (invested)</span>
          <input type="number" step="0.01" inputmode="decimal" name="unrealized" value="${normalizedUnrealized}" class="w-full rounded border border-neutral-700 bg-neutral-900 px-2 py-1 text-neutral-100 focus:outline-none focus:ring-1 focus:ring-neutral-500">
        </label>
      </form>`;
    modal.save = () => {
      const form = document.getElementById('manual-form');
      if (!form) {
        modal.save = null;
        return;
      }

      const errorEl = form.querySelector('[data-manual-error]');
      if (errorEl) {
        errorEl.textContent = '';
        errorEl.classList.add('hidden');
      }

      const fd = new FormData(form);
      modal.saving = true;

      fetch('/api/daily/' + dateStr, { method: 'POST', body: fd })
        .then((response) => {
          if (!response.ok) {
            return response
              .json()
              .catch(() => ({}))
              .then((data) => {
                const message = data && data.detail ? data.detail : 'Failed to save daily values.';
                throw new Error(message);
              });
          }
          return response.json();
        })
        .then(() => {
          modal.saving = false;
          modal.close(true);
          window.location.reload();
        })
        .catch((error) => {
          console.error(error);
          modal.saving = false;
          if (errorEl) {
            errorEl.textContent = error && error.message ? error.message : 'Failed to save daily values.';
            errorEl.classList.remove('hidden');
          }
        });
    };
    modal.open = true;
  }

function escapeHtml(value) {
  return String(value ?? '').replace(/[&<>"']/g, (char) => {
    switch (char) {
      case '&':
        return '&amp;';
      case '<':
        return '&lt;';
      case '>':
        return '&gt;';
      case '"':
        return '&quot;';
      case "'":
        return '&#39;';
      default:
        return char;
    }
  });
}

function formatNoteTimestamp(isoString) {
  if (!isoString) {
    return '';
  }
  try {
    const value = new Date(isoString);
    if (Number.isNaN(value.getTime())) {
      return '';
    }
    return value.toLocaleString(undefined, {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    });
  } catch (error) {
    return '';
  }
}

function formatDailySubtitle(dateStr) {
  try {
    const [year, month, day] = dateStr.split('-').map(Number);
    const value = new Date(year, (month || 1) - 1, day || 1);
    return value.toLocaleDateString(undefined, {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });
  } catch (error) {
    return dateStr;
  }
}

function getIsoWeekStart(year, week) {
  const simple = new Date(year, 0, 1 + (week - 1) * 7);
  const dayOfWeek = simple.getDay() || 7;
  const isoStart = new Date(simple);
  if (dayOfWeek <= 4) {
    isoStart.setDate(simple.getDate() - dayOfWeek + 1);
  } else {
    isoStart.setDate(simple.getDate() + (8 - dayOfWeek));
  }
  isoStart.setHours(0, 0, 0, 0);
  return isoStart;
}

function formatWeeklySubtitle(year, week) {
  try {
    const start = getIsoWeekStart(year, week);
    const end = new Date(start);
    end.setDate(start.getDate() + 6);
    const startLabel = start.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
    const endLabel = end.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
    return `Week ${week} • ${startLabel} – ${endLabel}`;
  } catch (error) {
    return `Week ${week}, ${year}`;
  }
}

function formatMonthlySubtitle(year, month) {
  try {
    const value = new Date(year, (month || 1) - 1, 1);
    return value.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
  } catch (error) {
    return `${year}-${String(month).padStart(2, '0')}`;
  }
}

function openNoteEditor(config) {
  const modal = getModalController();
  if (!modal) {
    return;
  }

  const {
    title,
    subtitle,
    fetchUrl,
    saveUrl,
    placeholder,
    onSave,
    closeLabel = 'Cancel',
    saveLabel = 'Save note',
  } = config;

  modal.title = title;
  modal.closeLabel = closeLabel;
  modal.saveLabel = saveLabel;
  modal.saving = false;
  modal.body = '<div class="flex items-center justify-center p-6 text-sm text-neutral-300">Loading note…</div>';
  modal.save = null;
  modal.open = true;

  fetch(fetchUrl)
    .then((response) => {
      if (!response.ok) {
        return response
          .json()
          .catch(() => ({}))
          .then((data) => {
            const message = data && data.detail ? data.detail : 'Failed to load note.';
            throw new Error(message);
          });
      }
      return response.json();
    })
    .then((payload) => {
      const noteText = payload && typeof payload.note === 'string' ? payload.note : '';
      const updatedAt = payload && typeof payload.updated_at === 'string' ? payload.updated_at : '';
      renderNoteEditor(modal, {
        subtitle,
        noteText,
        updatedAt,
        placeholder,
        saveUrl,
        onSave,
        saveLabel,
      });
    })
    .catch((error) => {
      console.error(error);
      const message = error && error.message ? error.message : 'Failed to load note.';
      modal.body = `<p class="text-sm text-red-400">${escapeHtml(message)}</p>`;
      modal.closeLabel = 'Close';
      modal.saveLabel = 'Save';
      modal.save = null;
    });
}

function renderNoteEditor(modal, config) {
  const {
    subtitle,
    noteText,
    updatedAt,
    placeholder,
    saveUrl,
    onSave,
    saveLabel,
  } = config;

  const subtitleText = subtitle ? escapeHtml(subtitle) : '';
  const placeholderText = placeholder ? escapeHtml(placeholder) : 'Add your note…';

  modal.saveLabel = saveLabel;
  modal.body = `
    <div class="space-y-4" data-note-editor-root>
      <div class="space-y-1">
        <p class="text-xs uppercase tracking-wide text-neutral-500">Context</p>
        <p class="text-sm text-neutral-300">${subtitleText}</p>
        <p class="text-xs text-neutral-500" data-note-updated-display></p>
      </div>
      <div class="space-y-2">
        <label class="block text-sm text-neutral-300" for="note-field">
          <span class="mb-2 block text-neutral-400">Note</span>
          <textarea id="note-field" data-autofocus class="w-full min-h-[14rem] rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="${placeholderText}" spellcheck="true"></textarea>
        </label>
        <div class="flex items-center justify-between text-xs text-neutral-500">
          <span>Notes are saved as plain text.</span>
          <span data-note-char-count>0 characters</span>
        </div>
        <p class="text-xs text-amber-400 hidden" data-note-unsaved-warning>Unsaved changes. Save your note to keep it.</p>
      </div>
      <p class="text-sm text-red-400 hidden" data-note-error></p>
      <div class="flex items-center justify-between border-t border-neutral-800 pt-3">
        <button type="button" class="text-xs text-neutral-400 transition hover:text-neutral-100" data-note-clear>Clear note</button>
        <span class="text-xs text-neutral-500" data-note-updated-display-secondary></span>
      </div>
    </div>
  `;

  window.requestAnimationFrame(() => {
    initializeNoteEditor({
      modal,
      noteText,
      updatedAt,
      saveUrl,
      onSave,
    });
  });
}

function initializeNoteEditor(options) {
  const { modal, noteText, updatedAt, saveUrl, onSave } = options;
  const root = document.querySelector('[data-note-editor-root]');
  if (!root) {
    return;
  }

  const field = root.querySelector('#note-field');
  const counter = root.querySelector('[data-note-char-count]');
  const errorEl = root.querySelector('[data-note-error]');
  const clearButton = root.querySelector('[data-note-clear]');
  const updatedDisplays = root.querySelectorAll('[data-note-updated-display], [data-note-updated-display-secondary]');
  const unsavedWarning = root.querySelector('[data-note-unsaved-warning]');

  let initialValue = typeof noteText === 'string' ? noteText : '';

  const updateDirtyState = () => {
    const currentValue = field ? field.value : '';
    const isDirty = currentValue !== initialValue;
    if (unsavedWarning) {
      unsavedWarning.classList.toggle('hidden', !isDirty);
    }
    return isDirty;
  };

  const updateDisplays = (isoString) => {
    let label = 'Not saved yet';
    if (isoString) {
      const formatted = formatNoteTimestamp(isoString);
      label = formatted ? `Last updated ${formatted}` : `Last updated ${isoString}`;
    }
    updatedDisplays.forEach((element) => {
      if (element) {
        element.textContent = label;
      }
    });
  };

  const updateCounter = () => {
    if (!counter || !field) {
      return;
    }
    const length = field.value.length;
    counter.textContent = `${length} ${length === 1 ? 'character' : 'characters'}`;
  };

  if (field) {
    field.value = noteText;
    try {
      field.focus({ preventScroll: true });
    } catch (error) {
      field.focus();
    }
    const length = noteText.length;
    if (typeof field.setSelectionRange === 'function') {
      try {
        field.setSelectionRange(length, length);
      } catch (error) {
        // ignore selection issues for unsupported inputs
      }
    }
    field.addEventListener('input', () => {
      updateCounter();
      if (errorEl) {
        errorEl.textContent = '';
        errorEl.classList.add('hidden');
      }
      updateDirtyState();
    });
  }

  updateCounter();
  updateDisplays(updatedAt);
  updateDirtyState();

  if (clearButton && field) {
    clearButton.addEventListener('click', () => {
      field.value = '';
      try {
        field.focus({ preventScroll: true });
      } catch (error) {
        field.focus();
      }
      updateCounter();
      updateDirtyState();
    });
  }

  modal.beforeClose = () => {
    const dirty = updateDirtyState();
    if (!dirty) {
      return true;
    }
    const confirmClose = window.confirm('You have unsaved changes to this note. Discard them?');
    if (!confirmClose) {
      if (field) {
        try {
          field.focus({ preventScroll: true });
        } catch (error) {
          field.focus();
        }
      }
      return false;
    }
    return true;
  };

  modal.save = () => {
    if (!field) {
      return;
    }

    if (errorEl) {
      errorEl.textContent = '';
      errorEl.classList.add('hidden');
    }

    const noteValue = field.value;
    modal.saving = true;
    const fd = new FormData();
    fd.append('note', noteValue);

    fetch(saveUrl, { method: 'POST', body: fd })
      .then((response) => {
        if (!response.ok) {
          return response
            .json()
            .catch(() => ({}))
            .then((data) => {
              const message = data && data.detail ? data.detail : 'Failed to save note.';
              throw new Error(message);
            });
        }
        return response.json();
      })
      .then((payload) => {
        modal.saving = false;
        const updatedValue = payload && typeof payload.updated_at === 'string'
          ? payload.updated_at
          : new Date().toISOString();
        if (typeof onSave === 'function') {
          onSave(noteValue, { updatedAt: updatedValue });
        }
        initialValue = noteValue;
        updateDirtyState();
        modal.close(true);
      })
      .catch((error) => {
        console.error(error);
        modal.saving = false;
        if (errorEl) {
          errorEl.textContent = error && error.message ? error.message : 'Failed to save note.';
          errorEl.classList.remove('hidden');
        }
      });
  };
}

function openDailyNote(dateStr) {
  openNoteEditor({
    title: 'Daily note',
    subtitle: formatDailySubtitle(dateStr),
    fetchUrl: '/api/notes/daily/' + dateStr,
    saveUrl: '/api/notes/daily/' + dateStr,
    placeholder: 'Capture highlights from this trading day…',
    onSave: (noteValue, meta) => {
      updateDailyNoteIndicator(dateStr, noteValue, meta && meta.updatedAt);
    },
  });
}

function openWeeklyNote(year, week) {
  openNoteEditor({
    title: 'Weekly note',
    subtitle: formatWeeklySubtitle(year, week),
    fetchUrl: `/api/notes/weekly/${year}/${week}`,
    saveUrl: `/api/notes/weekly/${year}/${week}`,
    placeholder: 'Summarize how the week went…',
    onSave: (noteValue, meta) => {
      updateWeeklyNoteIndicator(year, week, noteValue, meta && meta.updatedAt);
    },
  });
}

function openMonthlyNote(year, month) {
  openNoteEditor({
    title: 'Monthly note',
    subtitle: formatMonthlySubtitle(year, month),
    fetchUrl: `/api/notes/monthly/${year}/${month}`,
    saveUrl: `/api/notes/monthly/${year}/${month}`,
    placeholder: 'Reflect on the month as a whole…',
    onSave: (noteValue, meta) => {
      updateMonthlyNoteIndicator(year, month, noteValue, meta && meta.updatedAt);
    },
  });
}

function getModalController() {
  const modal = window.modalController;
  if (!modal) {
    console.error('Modal controller is not ready yet');
    return null;
  }
  return modal;
}

function updateWeeklyNoteIndicator(year, week, noteText, updatedAt) {
  const selector = `[data-week-year='${year}'][data-week-index='${week}']`;
  const trigger = document.querySelector(selector);
  if (!trigger) {
    return;
  }
  const normalized = typeof noteText === 'string' ? noteText : '';
  const hasNote = normalized.trim().length > 0;
  trigger.dataset.noteText = normalized;
  trigger.dataset.noteUpdated = updatedAt || '';
  trigger.classList.toggle('has-note', hasNote);
  trigger.classList.toggle('icon-translucent', !hasNote);
  trigger.setAttribute('aria-label', hasNote ? 'Edit weekly note' : 'Add weekly note');
  const svg = trigger.querySelector('svg');
  if (svg) {
    svg.classList.toggle('text-amber-400', hasNote);
  }
  const tooltipBody = trigger.querySelector('.note-tooltip [data-note-tooltip-body]');
  if (tooltipBody) {
    tooltipBody.textContent = normalized;
  }
  if (hasNote) {
    trigger.setAttribute('title', normalized);
  } else {
    trigger.removeAttribute('title');
  }
}

function updateDailyNoteIndicator(dateStr, noteText, updatedAt) {
  const cell = document.querySelector(`[data-day-cell='${dateStr}']`);
  if (!cell) {
    return;
  }
  const trigger = cell.querySelector('.note-trigger');
  if (!trigger) {
    return;
  }
  const normalized = typeof noteText === 'string' ? noteText : '';
  const hasNote = normalized.trim().length > 0;
  trigger.dataset.noteText = normalized;
  trigger.dataset.noteUpdated = updatedAt || '';
  trigger.classList.toggle('has-note', hasNote);
  trigger.classList.toggle('icon-translucent', !hasNote);
  trigger.setAttribute('aria-label', hasNote ? 'Edit daily note' : 'Add daily note');
  const tooltipBody = trigger.querySelector('.note-tooltip [data-note-tooltip-body]');
  if (tooltipBody) {
    tooltipBody.textContent = normalized;
  }
}

function updateMonthlyNoteIndicator(year, month, noteText, updatedAt) {
  const selector = `[data-month-key='${year}-${String(month).padStart(2, '0')}']`;
  const trigger = document.querySelector(selector);
  if (!trigger) {
    return;
  }
  const normalized = typeof noteText === 'string' ? noteText : '';
  const hasNote = normalized.trim().length > 0;
  trigger.dataset.noteText = normalized;
  trigger.dataset.noteUpdated = updatedAt || '';
  trigger.classList.toggle('has-note', hasNote);
  trigger.classList.toggle('icon-translucent', !hasNote);
  trigger.setAttribute('aria-label', hasNote ? 'Edit monthly note' : 'Add monthly note');
  const svg = trigger.querySelector('svg');
  if (svg) {
    svg.classList.toggle('text-amber-400', hasNote);
  }
  const tooltipBody = trigger.querySelector('.note-tooltip [data-note-tooltip-body]');
  if (tooltipBody) {
    tooltipBody.textContent = normalized;
  }
}
</script>
{% endblock %}
