{% extends "base.html" %}
{% block content %}
{% set ui_cfg = cfg.get('ui', {}) %}
{% set show_unrealized_default = ui_cfg.get('show_unrealized', True) %}
<div x-data="{
        showUnrealized: {{ 'true' if show_unrealized_default else 'false' }},
        exportOpen: false,
        init() {
          try {
            const storage = window.localStorage;
            if (!storage) {
              return;
            }

            const stored = storage.getItem('bagholder:showUnrealized');
            if (stored !== null) {
              this.showUnrealized = stored === 'true';
            }

            this.$watch('showUnrealized', (value) => {
              storage.setItem('bagholder:showUnrealized', value ? 'true' : 'false');
            });
          } catch (error) {
            console.warn('Unable to persist showUnrealized preference', error);
          }
        }
      }" class="space-y-4">
<div class="flex items-center justify-between">
  <div class="text-lg font-semibold">{{ year }}-{{ "%02d"|format(month) }}</div>
  <div class="flex items-center gap-2 flex-wrap justify-end" @keydown.escape.window="exportOpen = false">
    {% set prev_year = (month == 1) and year-1 or year %}
    {% set prev_month = (month == 1) and 12 or month-1 %}
    {% set next_year = (month == 12) and year+1 or year %}
    {% set next_month = (month == 12) and 1 or month+1 %}
    <a href="/calendar/{{ prev_year }}/{{ prev_month }}" class="px-3 py-1 border border-neutral-700 rounded hover:bg-neutral-800">Prev</a>
    <a href="/calendar/{{ current_year }}/{{ current_month }}" class="px-3 py-1 border border-neutral-700 rounded hover:bg-neutral-800">Home</a>
    <a href="/calendar/{{ next_year }}/{{ next_month }}" class="px-3 py-1 border border-neutral-700 rounded hover:bg-neutral-800">Next</a>
    <div class="relative">
      <button type="button"
              class="px-3 py-1 border border-neutral-700 rounded hover:bg-neutral-800 transition"
              :class="{ 'bg-neutral-800 text-neutral-100 border-neutral-600': exportOpen }"
              @click="exportOpen = !exportOpen"
              aria-haspopup="true"
              :aria-expanded="exportOpen.toString()">
        Export
      </button>
      <div x-show="exportOpen"
           x-cloak
           @click.outside="exportOpen = false"
           class="absolute right-0 z-30 mt-2 w-72 space-y-3 rounded border border-neutral-800 bg-neutral-950 p-4 shadow-xl">
        <form method="get" action="/export" class="space-y-3">
          <p class="text-sm text-neutral-300">Download daily summaries as CSV.</p>
          <div class="space-y-2">
            <label class="block text-sm">
              <span class="text-neutral-400">Start date</span>
              <input type="date" name="start" value="{{ export_default_start }}"
                     class="mt-1 w-full rounded border border-neutral-700 bg-neutral-900 px-2 py-1 text-neutral-100 focus:outline-none focus:ring-1 focus:ring-neutral-500" />
            </label>
            <label class="block text-sm">
              <span class="text-neutral-400">End date</span>
              <input type="date" name="end" value="{{ export_default_end }}"
                     class="mt-1 w-full rounded border border-neutral-700 bg-neutral-900 px-2 py-1 text-neutral-100 focus:outline-none focus:ring-1 focus:ring-neutral-500" />
            </label>
          </div>
          <div class="flex items-center justify-end gap-2 pt-2 border-t border-neutral-800">
            <button type="button" class="px-3 py-1 rounded border border-neutral-700 hover:bg-neutral-800" @click="exportOpen = false">Cancel</button>
            <button type="submit" class="px-3 py-1 rounded bg-blue-600 text-white hover:bg-blue-500">Download</button>
          </div>
        </form>
      </div>
    </div>
    <button type="button"
            class="px-3 py-1 border border-neutral-700 rounded hover:bg-neutral-800 transition"
            :class="{ 'bg-neutral-800 text-neutral-100 border-neutral-600': !showUnrealized }"
            @click="showUnrealized = !showUnrealized"
            aria-pressed="{{ 'true' if show_unrealized_default else 'false' }}"
            :aria-pressed="showUnrealized.toString()">
      <span x-text="showUnrealized ? 'Hide unrealized' : 'Show unrealized'">
        {% if show_unrealized_default %}Hide unrealized{% else %}Show unrealized{% endif %}
      </span>
    </button>
  </div>
</div>

{% set show_weekends = ui_cfg.get('show_weekends', False) %}
{% set day_labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'] %}
{% set visible_day_labels = day_labels if show_weekends else day_labels[:5] %}
{% set grid_columns = visible_day_labels|length + 1 %}

<div class="grid gap-2" style="grid-template-columns: repeat({{ grid_columns }}, minmax(0, 1fr));">
  {% for label in visible_day_labels %}
  <div class="text-xs text-neutral-400">{{ label }}</div>
  {% endfor %}
  <div class="text-xs text-neutral-400 text-right">Week</div>
</div>

<div class="grid gap-2 mt-2" style="grid-template-columns: repeat({{ grid_columns }}, minmax(0, 1fr));">
{% for week in weeks %}
  {% for d in week.days %}
    {% if show_weekends or not d.is_weekend %}
      {% set cls = (d.realized > 0) and 'cell-bg-pos' or (d.realized < 0) and 'cell-bg-neg' or 'bg-neutral-900' %}
      <div class="relative min-h-[7rem] rounded border border-neutral-800 p-2 {{ 'opacity-100' if d.in_month else 'opacity-30' }} {{ cls }} flex flex-col gap-2" data-day-cell="{{ d.date.strftime('%Y-%m-%d') }}">
        <div class="flex items-center gap-1 text-xs text-neutral-400">
          <span>{{ d.date.day }}</span>
          {% if d.has_trades %}
          <div x-data="{
                 open: false,
                 closeTimer: null,
                 openPanel() {
                   this.open = true;
                   this.cancelClose();
                 },
                 scheduleClose() {
                   this.cancelClose();
                   this.closeTimer = setTimeout(() => {
                     this.open = false;
                     this.closeTimer = null;
                   }, 120);
                 },
                 cancelClose() {
                   if (this.closeTimer) {
                     clearTimeout(this.closeTimer);
                     this.closeTimer = null;
                   }
                 },
                 togglePanel() {
                   if (this.open) {
                     this.open = false;
                     this.cancelClose();
                   } else {
                     this.openPanel();
                   }
                 }
               }"
               class="relative cursor-pointer"
               role="button"
               tabindex="0"
               @mouseenter="openPanel()"
               @mouseleave="scheduleClose()"
               @click="togglePanel()"
               @click.outside="open = false; cancelClose()"
               @focus="openPanel()"
               @blur="scheduleClose()"
               @keydown.enter.prevent="togglePanel()"
               @keydown.space.prevent="togglePanel()">
            <svg class="h-4 w-4 text-sky-400" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M7 6h11l-1.5-1.5L18 3l4 4-4 4-1.5-1.5L18 8H7a2 2 0 0 0-2 2v2H3V10a4 4 0 0 1 4-4zm10 12H6l1.5 1.5L6 21l-4-4 4-4 1.5 1.5L6 15h11a2 2 0 0 0 2-2v-2h2v2a4 4 0 0 1-4 4z" />
            </svg>
            <span class="sr-only">Trades recorded</span>
            <div class="absolute left-0 top-5 z-20 rounded border border-neutral-700 bg-neutral-900 p-2 text-xs text-neutral-100 shadow-lg w-fit"
                 x-show="open" x-cloak @mouseenter="cancelClose()" @mouseleave="scheduleClose()">
              <div class="mb-1 font-semibold text-neutral-200">Trades</div>
              <ul class="space-y-1">
                {% for trade in d.trades %}
                <li>{{ trade.action }} {{ '%.2f'|format(trade.qty) }} {{ trade.symbol }} @ {{ trade.price|money }}</li>
                {% endfor %}
              </ul>
            </div>
          </div>
          {% endif %}
        </div>

        {% if cfg.ui.show_text %}
        <div class="text-sm space-y-1">
          <div class="{{ 'text-green-400' if d.realized > 0 else ('text-red-400' if d.realized < 0 else 'text-neutral-200') }}">Realized: {{ d.realized|money }}</div>
          <div class="{{ 'text-green-400' if d.unrealized > 0 else ('text-red-400' if d.unrealized < 0 else 'text-neutral-200') }}"
               x-show="showUnrealized" x-cloak>
            Unrealized: {{ d.unrealized|money }}
          </div>
        </div>
        {% endif %}

        <!-- Gear icon for manual entry -->
        <a class="absolute top-1 right-1 icon-translucent z-10" href="#"
           aria-label="Edit daily values"
           onclick="openManual('{{ d.date.strftime('%Y-%m-%d') }}', {{ d.realized }}, {{ d.unrealized }}); return false;">
          <svg class="w-4 h-4 action-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M19.14,12.94a7.43,7.43,0,0,0,.05-.94,7.43,7.43,0,0,0-.05-.94l2.11-1.65a.5.5,0,0,0,.12-.64l-2-3.46a.5.5,0,0,0-.6-.22l-2.49,1a7.3,7.3,0,0,0-1.63-.94l-.38-2.65A.5.5,0,0,0,12.64,1H9.36a.5.5,0,0,0-.49.41L8.49,4.06a7.3,7.3,0,0,0-1.63.94l-2.49-1a.5.5,0,0,0-.6.22l-2,3.46a.5.5,0,0,0,.12.64L3.94,11.06a7.43,7.43,0,0,0-.05.94,7.43,7.43,0,0,0,.05.94L1.83,14.59a.5.5,0,0,0-.12.64l2,3.46a.5.5,0,0,0,.6.22l2.49-1a7.3,7.3,0,0,0,1.63.94l.38,2.65a.5.5,0,0,0,.49.41h3.28a.5.5,0,0,0,.49-.41l.38-2.65a7.3,7.3,0,0,0,1.63-.94l2.49,1a.5.5,0,0,0,.6-.22l2-3.46a.5.5,0,0,0-.12-.64Zm-7.14,2.56A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z" fill="currentColor" />
          </svg>
        </a>
        <div class="daily-note-indicator absolute bottom-1 left-1 cursor-default z-10 group{% if not d.has_note %} hidden{% endif %}"
             data-note-date="{{ d.date.strftime('%Y-%m-%d') }}"
             data-note-text="{{ d.note | e }}">
          <svg class="w-4 h-4 text-amber-400" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M19 3H5a2 2 0 0 0-2 2v14l4-4h12a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z" />
          </svg>
          <span class="sr-only">Daily note available</span>
          <div class="note-tooltip absolute bottom-6 left-0 z-20 hidden whitespace-pre-line rounded border border-neutral-700 bg-neutral-900 p-2 text-xs text-neutral-100 shadow-lg w-fit group-hover:block">
            {{ d.note | e }}
          </div>
        </div>
        <!-- Note icon -->
        <a class="absolute bottom-1 right-1 icon-translucent z-10" href="#" aria-label="Add daily note"
           onclick="openDailyNote('{{ d.date.strftime('%Y-%m-%d') }}'); return false;">
          <svg class="w-4 h-4 action-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M19 3H5a2 2 0 0 0-2 2v14l4-4h12a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z" fill="currentColor" />
          </svg>
        </a>
      </div>
    {% endif %}
  {% endfor %}
  {% set week_cls = (week.week_realized > 0) and 'cell-bg-pos' or (week.week_realized < 0) and 'cell-bg-neg' or 'bg-neutral-900' %}
  <div class="relative min-h-[7rem] rounded border border-neutral-800 p-2 flex flex-col justify-between {{ week_cls }}">
    <div>
      <div class="text-xs text-neutral-400">Week {{ week.week_index }}</div>
      <div class="mt-2 text-sm space-y-1 text-right">
        <div class="{{ 'text-green-400' if week.week_realized > 0 else ('text-red-400' if week.week_realized < 0 else 'text-neutral-200') }}">Realized: {{ week.week_realized|money }}</div>
        <div class="{{ 'text-green-400' if week.week_unrealized > 0 else ('text-red-400' if week.week_unrealized < 0 else 'text-neutral-200') }}"
             x-show="showUnrealized" x-cloak>
          Unrealized: {{ week.week_unrealized|money }}
        </div>
      </div>
    </div>
    <div class="flex justify-end">
      <a class="icon-translucent z-10" href="#" aria-label="Add weekly note"
         onclick="openWeeklyNote({{ year }}, {{ week.week_index }}); return false;">
        <svg class="w-4 h-4 action-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M19 3H5a2 2 0 0 0-2 2v14l4-4h12a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z" fill="currentColor" />
        </svg>
      </a>
    </div>
  </div>
{% endfor %}
</div>

<div class="mt-6 max-w-3xl">
  <div class="grid gap-4 sm:grid-cols-2">
    <div class="rounded border border-neutral-800 p-3 bg-neutral-950 relative">
      <h2 class="font-semibold">Monthly summary</h2>
      <div>Realized: <span class="{{ 'text-green-400' if month_realized > 0 else ('text-red-400' if month_realized < 0 else 'text-neutral-200') }}">{{ month_realized|money }}</span></div>
      <div x-show="showUnrealized" x-cloak>
        Unrealized (invested): <span class="{{ 'text-green-400' if month_unrealized > 0 else ('text-red-400' if month_unrealized < 0 else 'text-neutral-200') }}">{{ month_unrealized|money }}</span>
      </div>
      <a class="absolute top-1 right-1 icon-translucent z-10" href="#" aria-label="Add monthly note"
         onclick="openMonthlyNote({{ year }}, {{ month }}); return false;">
        <svg class="w-4 h-4 action-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M19 3H5a2 2 0 0 0-2 2v14l4-4h12a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z" fill="currentColor" />
        </svg>
      </a>
    </div>
    <div class="rounded border border-neutral-800 p-3 bg-neutral-950">
      <h2 class="font-semibold">Yearly summary</h2>
      <div>Realized: <span class="{{ 'text-green-400' if year_realized > 0 else ('text-red-400' if year_realized < 0 else 'text-neutral-200') }}">{{ year_realized|money }}</span></div>
      <div x-show="showUnrealized" x-cloak>
        Unrealized (invested): <span class="{{ 'text-green-400' if year_unrealized > 0 else ('text-red-400' if year_unrealized < 0 else 'text-neutral-200') }}">{{ year_unrealized|money }}</span>
      </div>
    </div>
  </div>
</div>

</div>

<!-- Modals -->
<div id="modal" x-data="{open:false, title:'', body:'', save: null}" x-init="window.modalController = $data" x-show="open" x-cloak class="fixed inset-0 bg-black/60 flex items-center justify-center">
  <div class="bg-neutral-950 border border-neutral-800 rounded p-4 w-full max-w-lg">
    <h3 class="font-semibold mb-2" x-text="title"></h3>
    <div x-html="body"></div>
    <div class="mt-4 flex justify-end gap-2">
      <button class="px-3 py-1 rounded border border-neutral-700" @click="open=false">Close</button>
      <button class="px-3 py-1 rounded bg-blue-600 hover:bg-blue-500" @click="if (save) save()">Save</button>
    </div>
  </div>
</div>

<script>
function openManual(dateStr, realized, unrealized) {
  const modal = getModalController();
  if (!modal) return;
  modal.title = "Manual edit " + dateStr;
  modal.body = `
    <form id="manual-form">
      <label class="block mb-2 text-sm">Realized
        <input type="number" step="0.01" name="realized" value="${realized}" class="w-full bg-neutral-800 rounded px-2 py-1">
      </label>
      <label class="block mb-2 text-sm">Unrealized (invested)
        <input type="number" step="0.01" name="unrealized" value="${unrealized}" class="w-full bg-neutral-800 rounded px-2 py-1">
      </label>
    </form>`;
  modal.save = () => {
    const form = document.getElementById('manual-form');
    const fd = new FormData(form);
    fetch('/api/daily/' + dateStr, { method:'POST', body: fd }).then(() => location.reload());
  };
  modal.open = true;
}

function openDailyNote(dateStr) {
  fetch('/api/notes/daily/' + dateStr).then(r => r.json()).then(js => {
    const modal = getModalController();
    if (!modal) return;
    modal.title = "Daily note " + dateStr;
    modal.body = `<textarea id="note-field" class="w-full h-40 bg-neutral-800 rounded p-2">${js.note||''}</textarea>`;
    modal.save = () => {
      const noteValue = document.getElementById('note-field').value;
      const fd = new FormData();
      fd.append('note', noteValue);
      fetch('/api/notes/daily/' + dateStr, {method:'POST', body:fd})
        .then((response) => {
          if (!response.ok) {
            throw new Error('Failed to save daily note');
          }
          return response.json();
        })
        .then(() => {
          modal.open = false;
          updateDailyNoteIndicator(dateStr, noteValue);
        })
        .catch((err) => {
          console.error(err);
        });
    };
    modal.open = true;
  });
}

function openWeeklyNote(year, week) {
  fetch('/api/notes/weekly/' + year + '/' + week).then(r => r.json()).then(js => {
    const modal = getModalController();
    if (!modal) return;
    modal.title = "Weekly note Y"+year+" W"+week;
    modal.body = `<textarea id="note-field" class="w-full h-40 bg-neutral-800 rounded p-2">${js.note||''}</textarea>`;
    modal.save = () => {
      const fd = new FormData(); fd.append('note', document.getElementById('note-field').value);
      fetch('/api/notes/weekly/' + year + '/' + week, {method:'POST', body:fd}).then(() => modal.open=false);
    };
    modal.open = true;
  });
}

function openMonthlyNote(year, month) {
  fetch('/api/notes/monthly/' + year + '/' + month).then(r => r.json()).then(js => {
    const modal = getModalController();
    if (!modal) return;
    modal.title = "Monthly note " + year + "-" + String(month).padStart(2,'0');
    modal.body = `<textarea id="note-field" class="w-full h-40 bg-neutral-800 rounded p-2">${js.note||''}</textarea>`;
    modal.save = () => {
      const fd = new FormData(); fd.append('note', document.getElementById('note-field').value);
      fetch('/api/notes/monthly/' + year + '/' + month, {method:'POST', body:fd}).then(() => modal.open=false);
    };
    modal.open = true;
  });
}

function getModalController() {
  const modal = window.modalController;
  if (!modal) {
    console.error('Modal controller is not ready yet');
    return null;
  }
  return modal;
}

function updateDailyNoteIndicator(dateStr, noteText) {
  const cell = document.querySelector(`[data-day-cell='${dateStr}']`);
  if (!cell) {
    return;
  }
  const indicator = cell.querySelector('.daily-note-indicator');
  if (!indicator) {
    return;
  }
  const tooltip = indicator.querySelector('.note-tooltip');
  const hasNote = noteText.trim().length > 0;
  if (hasNote) {
    indicator.classList.remove('hidden');
    indicator.dataset.noteText = noteText;
    if (tooltip) {
      tooltip.textContent = noteText;
    }
  } else {
    indicator.classList.add('hidden');
    indicator.dataset.noteText = '';
    if (tooltip) {
      tooltip.textContent = '';
    }
  }
}
</script>
{% endblock %}
