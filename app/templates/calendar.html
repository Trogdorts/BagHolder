{% extends "base.html" %}
{% block content %}
{% set ui_cfg = cfg.get('ui', {}) %}
{% set notes_cfg = cfg.get('notes', {}) %}
{% set show_market_value_default = show_market_value_flag if show_market_value_flag is defined else ui_cfg.get('show_market_value', ui_cfg.get('show_total', True)) %}
{% set show_trade_count_badges = show_trade_badges if show_trade_badges is defined else ui_cfg.get('show_trade_count', False) %}
{% set show_text_default = show_text_flag if show_text_flag is defined else ui_cfg.get('show_text', True) %}
{% set show_percentages_default = show_percentages_flag if show_percentages_flag is defined else ui_cfg.get('show_percentages', True) %}
{% set show_weekends = show_weekends_flag if show_weekends_flag is defined else ui_cfg.get('show_weekends', True) %}
{% set show_exclude_controls = show_exclude_controls_flag if show_exclude_controls_flag is defined else ui_cfg.get('show_exclude_controls', True) %}
{% set notes_enabled = notes_enabled_flag if notes_enabled_flag is defined else notes_cfg.get('enabled', True) %}
<div x-data="calendarToolbar({
        showMarketValue: {{ 'true' if show_market_value_default else 'false' }},
        showExcludeControls: {{ 'true' if show_exclude_controls else 'false' }},
        showPercentages: {{ 'true' if show_percentages_default else 'false' }},
        showWeekends: {{ 'true' if show_weekends else 'false' }},
        showTradeCounts: {{ 'true' if show_trade_count_badges else 'false' }}
      })"
     data-calendar-root="true"
     data-calendar-year="{{ year }}"
     data-calendar-month="{{ '%02d'|format(month) }}"
     data-simulator-defaults='{{ simulation_defaults|tojson }}'
     data-simulator-account-path="{{ simulation_account_path|e }}"
     class="space-y-4{% if not show_exclude_controls %} hide-exclude-controls{% endif %}{% if not show_percentages_default %} hide-percentages{% endif %}"
     :class="{ 'hide-exclude-controls': !showExcludeControls, 'hide-percentages': !showPercentages }">
<style>
  .toolbar-card {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding: 0;
    border: none;
    background: none;
    box-shadow: none;
  }

  .toolbar-top {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    align-items: stretch;
  }

  .toolbar-heading {
    align-self: center;
    font-size: 1.875rem;
    line-height: 2.25rem;
    font-weight: 600;
    letter-spacing: -0.015em;
    color: #f4f4f5;
    text-align: center;
  }

  @media (min-width: 640px) {
    .toolbar-heading {
      font-size: 2.25rem;
      line-height: 2.5rem;
    }
  }

  .toolbar-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    align-items: center;
    width: 100%;
  }

  .toolbar-nav {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .toolbar-quick-nav {
    position: relative;
  }

  @media (min-width: 768px) {
    .toolbar-actions {
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
    }
  }

  .toolbar-nav-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 0.9rem;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: #e4e4e7;
    border-radius: 9999px;
    transition: background-color 0.2s ease, color 0.2s ease;
  }

  .toolbar-nav-button {
    border: none;
    background: none;
    cursor: pointer;
  }

  .toolbar-nav-link:hover,
  .toolbar-nav-link:focus-visible {
    background-color: rgba(63, 63, 70, 0.7);
    color: #fafafa;
  }

  .toolbar-quick-nav-panel {
    position: absolute;
    top: calc(100% + 0.6rem);
    left: 50%;
    transform: translateX(-50%);
    width: max(20rem, 100%);
    padding: 0.85rem 1rem 1rem;
    border-radius: 0.75rem;
    background: rgba(24, 24, 27, 0.96);
    border: 1px solid rgba(63, 63, 70, 0.85);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.45);
    color: #e4e4e7;
    z-index: 40;
  }

  .toolbar-quick-nav-panel h3 {
    margin: 0 0 0.75rem;
    font-size: 0.95rem;
    font-weight: 600;
    color: #fafafa;
  }

  .toolbar-quick-nav-form {
    display: grid;
    gap: 0.75rem;
  }

  @media (min-width: 480px) {
    .toolbar-quick-nav-form {
      grid-template-columns: repeat(2, minmax(0, 1fr));
      align-items: end;
      column-gap: 1rem;
    }

    .toolbar-quick-nav-actions {
      grid-column: 1 / -1;
    }
  }

  .toolbar-quick-nav-field {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .toolbar-quick-nav-field label {
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: #a1a1aa;
  }

  .toolbar-quick-nav-stepper {
    display: flex;
    align-items: stretch;
    width: 100%;
    min-width: 8.5rem;
    border-radius: 0.5rem;
    border: 1px solid rgba(82, 82, 91, 0.75);
    background: rgba(15, 15, 15, 0.9);
    overflow: hidden;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .toolbar-quick-nav-stepper:focus-within {
    border-color: #818cf8;
    box-shadow: 0 0 0 2px rgba(129, 140, 248, 0.35);
  }

  .toolbar-quick-nav-stepper input {
    flex: 1 1 auto;
    min-width: 8ch;
    padding: 0.5rem 1rem;
    border: none;
    background: transparent;
    color: #fafafa;
    font-size: 0.95rem;
    text-align: center;
    font-variant-numeric: tabular-nums;
  }

  .toolbar-quick-nav-stepper input::-webkit-outer-spin-button,
  .toolbar-quick-nav-stepper input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .toolbar-quick-nav-stepper input[type="number"] {
    -moz-appearance: textfield;
  }

  .toolbar-quick-nav-stepper input:focus {
    outline: none;
  }

  .toolbar-quick-nav-step {
    flex: 0 0 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    background: transparent;
    color: #a1a1aa;
    font-size: 1.1rem;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease;
  }

  .toolbar-quick-nav-step:hover,
  .toolbar-quick-nav-step:focus-visible {
    background-color: rgba(63, 63, 70, 0.65);
    color: #fafafa;
  }

  .toolbar-quick-nav-select {
    width: 100%;
    padding: 0.55rem 0.75rem;
    border-radius: 0.5rem;
    border: 1px solid rgba(82, 82, 91, 0.75);
    background: rgba(15, 15, 15, 0.9);
    color: #fafafa;
    font-size: 0.95rem;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .toolbar-quick-nav-select:focus {
    outline: none;
    border-color: #818cf8;
    box-shadow: 0 0 0 2px rgba(129, 140, 248, 0.35);
  }

  .toolbar-quick-nav-actions {
    display: flex;
    justify-content: flex-end;
  }

  .toolbar-quick-nav-go {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.55rem 1rem;
    border-radius: 0.5rem;
    border: 1px solid rgba(82, 82, 91, 0.75);
    background: rgba(39, 39, 42, 0.95);
    color: #fafafa;
    font-weight: 600;
    font-size: 0.9rem;
    letter-spacing: 0.02em;
    cursor: pointer;
    transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .toolbar-quick-nav-go:hover,
  .toolbar-quick-nav-go:focus-visible {
    background-color: rgba(63, 63, 70, 0.9);
    border-color: rgba(113, 113, 122, 0.85);
    box-shadow: 0 0 0 2px rgba(129, 140, 248, 0.35);
  }

  .toolbar-quick-nav-panel p {
    margin-top: 0.75rem;
    font-size: 0.75rem;
    color: #71717a;
  }

  .toolbar-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  @media (min-width: 768px) {
    .toolbar-controls {
      margin-left: auto;
      justify-content: flex-end;
    }
  }

  .toolbar-toggle {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 0.95rem;
    border-radius: 9999px;
    border: 1px solid rgba(63, 63, 70, 0.75);
    background: rgba(17, 17, 17, 0.85);
    color: #d4d4d8;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
  }

  .toolbar-toggle {
    position: relative;
  }

  .toolbar-tooltip {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.96);
    width: min(24rem, calc(100vw - 3rem));
    padding: 1.25rem 1.5rem;
    border-radius: 0.75rem;
    background: rgba(24, 24, 27, 0.96);
    color: #f4f4f5;
    text-align: left;
    box-shadow: 0 25px 70px rgba(0, 0, 0, 0.55);
    border: 1px solid rgba(82, 82, 91, 0.75);
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity 0.25s ease, transform 0.25s ease;
    transition-delay: 0s;
    z-index: 60;
  }

  .toolbar-tooltip h3 {
    margin-bottom: 0.5rem;
    font-size: 1rem;
    font-weight: 600;
    color: #fafafa;
  }

  .toolbar-tooltip p {
    font-size: 0.875rem;
    line-height: 1.6;
    color: #d4d4d8;
  }

  .toolbar-tooltip ul {
    margin-top: 0.75rem;
    padding-left: 1.1rem;
    list-style: disc;
    color: #c4c4cc;
  }

  .toolbar-tooltip li + li {
    margin-top: 0.35rem;
  }

  .toolbar-toggle:hover .toolbar-tooltip,
  .toolbar-toggle:focus-visible .toolbar-tooltip {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
    transform: translate(-50%, -50%) scale(1);
    transition-delay: 1s;
  }

  .toolbar-toggle:hover,
  .toolbar-toggle:focus-visible {
    background: rgba(63, 63, 70, 0.6);
    border-color: rgba(82, 82, 91, 0.85);
    color: #fafafa;
  }

  .toolbar-toggle.is-active {
    background: rgba(99, 102, 241, 0.2);
    border-color: rgba(129, 140, 248, 0.7);
    color: #e0e7ff;
    box-shadow: inset 0 0 0 1px rgba(129, 140, 248, 0.3);
  }

  .toolbar-toggle:focus-visible {
    outline: 2px solid rgba(129, 140, 248, 0.5);
    outline-offset: 2px;
  }

  .toolbar-card .toolbar-toggle span {
    pointer-events: none;
  }

  .day-excluded {
    opacity: 0.4;
  }

  .day-include-toggle {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    border: 1px solid #3f3f46;
    background-color: #171717;
    color: #a3a3a3;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, opacity 0.2s ease;
  }

  .week-include-toggle {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    border: 1px solid #3f3f46;
    background-color: #171717;
    color: #a3a3a3;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, opacity 0.2s ease;
  }

  .week-include-toggle.toggle-excluded {
    border-color: var(--danger-color);
    background-color: var(--danger-soft-bg);
    color: var(--danger-text-subtle);
  }

  .week-include-toggle:focus-visible {
    outline: 2px solid var(--primary-focus-ring);
    outline-offset: 2px;
  }

  .week-excluded {
    opacity: 0.5;
  }

  .calendar-card-heading {
    font-size: 1rem;
    line-height: 1.5rem;
    font-weight: 600;
    letter-spacing: -0.01em;
    color: #f4f4f5;
  }

  .calendar-day-number {
    font-size: 1.125rem;
    line-height: 1.25rem;
    font-weight: 700;
  }

  .calendar-metric-group {
    color: #e4e4e7;
  }

  .calendar-metric-line {
    display: flex;
    align-items: baseline;
    gap: 0.25rem;
    font-size: 0.9375rem;
    line-height: 1.5rem;
    color: inherit;
  }

  .calendar-metric-label {
    color: #e4e4e7;
  }

  .calendar-metric-value {
    color: inherit;
  }

  .calendar-primary-metric {
    display: block;
    font-size: 0.9375rem;
    line-height: 1.5rem;
    color: inherit;
  }

  .calendar-secondary-metric {
    display: block;
    font-size: 0.9375rem;
    line-height: 1.5rem;
    color: inherit;
  }

  .calendar-section-label {
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: #a1a1aa;
  }

  .win-ratio-dial-heading {
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: #a1a1aa;
  }

  .win-ratio-visual {
    width: 100%;
  }

  .win-ratio-bar {
    position: relative;
    width: 100%;
    height: 1.75rem;
    border-radius: 9999px;
    background: linear-gradient(90deg, rgba(39, 39, 42, 0.95) 0%, rgba(24, 24, 27, 0.95) 100%);
    overflow: hidden;
    border: 1px solid rgba(63, 63, 70, 0.9);
    box-shadow: inset 0 0 0 1px rgba(24, 24, 27, 0.85);
  }

  .win-ratio-bar-fill {
    position: absolute;
    inset: 0;
    width: 0%;
    opacity: 0;
    background: linear-gradient(
      90deg,
      #ef4444 0%,
      #f97316 20%,
      #facc15 45%,
      #84cc16 72%,
      #22c55e 100%
    );
    transition: width 0.35s ease, opacity 0.3s ease;
  }

  .win-ratio-bar-fill::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, rgba(250, 250, 250, 0.18) 0%, rgba(0, 0, 0, 0) 55%);
    mix-blend-mode: screen;
  }

  .win-ratio-bar-indicator {
    position: absolute;
    top: 50%;
    left: 0;
    display: flex;
    align-items: center;
    gap: 0.375rem;
    transform: translate(-50%, -50%);
    transition: left 0.35s ease, opacity 0.3s ease;
    opacity: 0;
    pointer-events: none;
  }

  .win-ratio-bar-indicator::before {
    content: '';
    width: 1px;
    height: 1.25rem;
    border-radius: 9999px;
    background: linear-gradient(180deg, rgba(244, 244, 245, 0.35) 0%, rgba(113, 113, 122, 0.1) 100%);
  }

  .win-ratio-bar-indicator.win-ratio-indicator-empty {
    opacity: 0.4;
  }

  .win-ratio-bar-indicator span {
    font-size: 0.8125rem;
    font-weight: 600;
    color: #f4f4f5;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    border: 1px solid rgba(82, 82, 91, 0.6);
    background: rgba(10, 10, 10, 0.92);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
    text-align: center;
  }

  .win-ratio-bar-indicator.win-ratio-indicator-empty span {
    color: #a1a1aa;
    border-color: rgba(82, 82, 91, 0.35);
  }

  .win-ratio-scale {
    font-size: 0.625rem;
    font-weight: 600;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: #71717a;
  }

  .day-include-toggle.toggle-excluded {
    background-color: var(--danger-soft-bg);
    border-color: var(--danger-color);
    color: var(--danger-text-subtle);
  }

  .day-include-toggle:focus-visible {
    outline: 2px solid var(--primary-focus-ring);
    outline-offset: 2px;
  }

  .day-include-toggle:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .hide-exclude-controls .day-include-toggle,
  .hide-exclude-controls .week-include-toggle {
    display: none;
  }

  .hide-percentages [data-day-percent],
  .hide-percentages [data-week-percent],
  .hide-percentages [data-month-percent],
  .hide-percentages [data-rolling-percent],
  .hide-percentages [data-year-percent] {
    display: none !important;
  }

  [data-day-realized-amount],
  [data-day-percent],
  [data-week-percent],
  [data-month-percent],
  [data-rolling-percent],
  [data-year-percent] {
    display: block;
  }
</style>
  <div class="toolbar-card">
    <div class="toolbar-top">
      {% set prev_year = (month == 1) and year-1 or year %}
      {% set prev_month = (month == 1) and 12 or month-1 %}
      {% set next_year = (month == 12) and year+1 or year %}
      {% set next_month = (month == 12) and 1 or month+1 %}
      <div class="toolbar-heading">
        {{ year }}-{{ "%02d"|format(month) }}
      </div>
      <div class="toolbar-actions">
        <nav class="toolbar-nav" aria-label="Calendar navigation">
          <a href="/calendar/{{ prev_year }}/{{ prev_month }}" class="toolbar-nav-link">Prev</a>
          <a href="/calendar/{{ current_year }}/{{ current_month }}" class="toolbar-nav-link">Today</a>
          <a href="/calendar/{{ next_year }}/{{ next_month }}" class="toolbar-nav-link">Next</a>
          <div class="toolbar-quick-nav"
               x-data="quickMonthPicker()"
               x-init="init()"
               @pointerdown.window="handleOutside($event)">
            <button type="button"
                    class="toolbar-nav-link toolbar-nav-button"
                    x-ref="trigger"
                    @click="toggle()"
                    :aria-expanded="isOpen.toString()"
                    aria-controls="quick-month-picker"
                    aria-haspopup="dialog">
              Jump to…
            </button>
            <div x-show="isOpen"
                 x-transition.origin.top
                 id="quick-month-picker"
                 class="toolbar-quick-nav-panel"
                 role="dialog"
                 aria-modal="true"
                 aria-label="Jump to month"
                 x-ref="panel"
                 @keydown.escape.window="close()">
              <h3>Quick navigation</h3>
              <div class="toolbar-quick-nav-form">
                <div class="toolbar-quick-nav-field">
                  <label for="quick-year-input">Year</label>
                  <div class="toolbar-quick-nav-stepper">
                    <button type="button"
                            class="toolbar-quick-nav-step"
                            @click="stepYear(-1)"
                            aria-label="Previous year">
                      −
                    </button>
                    <input id="quick-year-input"
                           type="number"
                           inputmode="numeric"
                           step="1"
                           min="1"
                           x-ref="yearInput"
                           x-model="year"
                           @change="normalizeYear()"
                           @blur="normalizeYear()"
                           @keydown.enter.prevent="go()" />
                    <button type="button"
                            class="toolbar-quick-nav-step"
                            @click="stepYear(1)"
                            aria-label="Next year">
                      +
                    </button>
                  </div>
                </div>
                <div class="toolbar-quick-nav-field">
                  <label for="quick-month-select">Month</label>
                  <select id="quick-month-select"
                          class="toolbar-quick-nav-select"
                          x-ref="monthSelect"
                          x-model="month"
                          @keydown.enter.prevent="go()">
                    <option value="01">January</option>
                    <option value="02">February</option>
                    <option value="03">March</option>
                    <option value="04">April</option>
                    <option value="05">May</option>
                    <option value="06">June</option>
                    <option value="07">July</option>
                    <option value="08">August</option>
                    <option value="09">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                  </select>
                </div>
                <div class="toolbar-quick-nav-actions">
                  <button type="button"
                          class="toolbar-quick-nav-go"
                          @click="go()">
                    Go
                  </button>
                </div>
              </div>
              <p>Select a year and month to jump to that calendar view.</p>
            </div>
          </div>
        </nav>
        <div class="toolbar-controls">
          {% set market_value_tooltip_id = 'toolbar-tooltip-market-value' %}
          <button type="button"
                  class="toolbar-toggle"
                  :class="{ 'is-active': !showMarketValue }"
                  @click="toggleMarketValue()"
                  aria-pressed="{{ 'true' if show_market_value_default else 'false' }}"
                  :aria-pressed="showMarketValue.toString()"
                  aria-describedby="{{ market_value_tooltip_id }}">
            <span x-text="showMarketValue ? 'Hide market value' : 'Show market value'">
              {% if show_market_value_default %}Hide market value{% else %}Show market value{% endif %}
            </span>
            <div id="{{ market_value_tooltip_id }}" class="toolbar-tooltip" role="tooltip">
              <h3>Market value totals</h3>
              <p>Shows the estimated worth of the shares you still held at the end of each day. This number does not include any cash in your brokerage account.</p>
              <ul>
                <li>Turn it off if you only want to track profit or loss from the trades you closed.</li>
                <li>Turn it on to see how your open positions changed in value alongside your closed trades.</li>
              </ul>
            </div>
          </button>
          {% set exclude_controls_tooltip_id = 'toolbar-tooltip-exclude-controls' %}
          <button type="button"
                  class="toolbar-toggle"
                  :class="{ 'is-active': !showExcludeControls }"
                  @click="toggleExcludeControls()"
                  aria-pressed="{{ 'true' if show_exclude_controls else 'false' }}"
                  :aria-pressed="showExcludeControls.toString()"
                  aria-describedby="{{ exclude_controls_tooltip_id }}">
            <span x-text="showExcludeControls ? 'Hide exclude' : 'Show exclude'">
              {% if show_exclude_controls %}Hide exclude{% else %}Show exclude{% endif %}
            </span>
            <div id="{{ exclude_controls_tooltip_id }}" class="toolbar-tooltip" role="tooltip">
              <h3>Exclude day controls</h3>
              <p>Adds a simple switch on each day so you can temporarily ignore that day in the totals. Helpful if you want to see "what if" results without deleting data.</p>
              <ul>
                <li>Show the switches when you need to hide a day that feels unusual or incorrect.</li>
                <li>Hide the switches when you are done so the calendar stays clean.</li>
              </ul>
            </div>
          </button>
          {% set percentages_tooltip_id = 'toolbar-tooltip-percentages' %}
          <button type="button"
                  class="toolbar-toggle"
                  :class="{ 'is-active': !showPercentages }"
                  @click="togglePercentages()"
                  aria-pressed="{{ 'true' if show_percentages_default else 'false' }}"
                  :aria-pressed="showPercentages.toString()"
                  aria-describedby="{{ percentages_tooltip_id }}">
            <span x-text="showPercentages ? 'Hide percent' : 'Show percent'">
              {% if show_percentages_default %}Hide percent{% else %}Show percent{% endif %}
            </span>
            <div id="{{ percentages_tooltip_id }}" class="toolbar-tooltip" role="tooltip">
              <h3>Return percentages</h3>
              <p>Shows how much you made or lost in percent instead of dollars. It uses the trading results shown here and does not describe the cash sitting in your account.</p>
              <ul>
                <li>Turn it off when you only care about dollar gains and losses.</li>
                <li>Leave it on to see which days were strong or weak regardless of account size.</li>
              </ul>
            </div>
          </button>
          {% set weekends_tooltip_id = 'toolbar-tooltip-weekends' %}
          <button type="button"
                  class="toolbar-toggle"
                  :class="{ 'is-active': showWeekends }"
                  @click="toggleWeekends()"
                  aria-pressed="{{ 'true' if show_weekends else 'false' }}"
                  :aria-pressed="showWeekends.toString()"
                  aria-describedby="{{ weekends_tooltip_id }}">
            <span x-text="showWeekends ? 'Hide weekends' : 'Show weekends'">
              {% if show_weekends %}Hide weekends{% else %}Show weekends{% endif %}
            </span>
            <div id="{{ weekends_tooltip_id }}" class="toolbar-tooltip" role="tooltip">
              <h3>Weekend columns</h3>
              <p>Choose if Saturdays and Sundays appear in the calendar. Hiding them gives more space to weekdays when the market is open.</p>
              <ul>
                <li>Hide weekends for a tighter view of only the trading days.</li>
                <li>Show weekends if you log notes or activity outside normal market hours.</li>
              </ul>
            </div>
          </button>
          {% set trade_counts_tooltip_id = 'toolbar-tooltip-trade-counts' %}
          <button type="button"
                  class="toolbar-toggle"
                  :class="{ 'is-active': showTradeCounts }"
                  @click="toggleTradeCounts()"
                  aria-pressed="{{ 'true' if show_trade_count_badges else 'false' }}"
                  :aria-pressed="showTradeCounts.toString()"
                  aria-describedby="{{ trade_counts_tooltip_id }}">
            <span x-text="showTradeCounts ? 'Hide trade count' : 'Show trade count'">
              {% if show_trade_count_badges %}Hide trade count{% else %}Show trade count{% endif %}
            </span>
            <div id="{{ trade_counts_tooltip_id }}" class="toolbar-tooltip" role="tooltip">
              <h3>Daily trade badges</h3>
              <p>Shows a small badge with the number of trades you made that day. A quick way to spot busy or quiet sessions.</p>
              <ul>
                <li>Hide the badges if you find the extra numbers distracting.</li>
                <li>Show them to connect big profit or loss days with how many trades you placed.</li>
              </ul>
            </div>
          </button>
        </div>
      </div>
    </div>
  </div>

  {% set day_labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'] %}
  {% set visible_day_labels = day_labels if show_weekends else day_labels[:5] %}
  {% set grid_columns = visible_day_labels|length + 1 %}
  <div class="grid gap-3" style="grid-template-columns: repeat({{ grid_columns }}, minmax(0, 1fr));">
    {% for label in visible_day_labels %}
    <div class="text-sm font-medium text-neutral-300 tracking-wide">{{ label }}</div>
    {% endfor %}
    <div class="text-sm font-medium text-neutral-300 text-right tracking-wide">Week</div>
  </div>

  <div class="grid gap-3 mt-3" style="grid-template-columns: repeat({{ grid_columns }}, minmax(0, 1fr));">
  {% for week in weeks %}
    {% for d in week.days %}
      {% if show_weekends or not d.is_weekend %}
      {% set cls = (d.realized > 0) and 'cell-bg-pos' or (d.realized < 0) and 'cell-bg-neg' or 'bg-neutral-900' %}
      {% set day_identifier = d.date.strftime('%Y-%m-%d') %}
      {% set week_key = week.week_year ~ '-' ~ week.week_number %}
      <div class="relative min-h-[10rem] rounded-xl border border-neutral-800 p-4 {{ 'opacity-100' if d.in_month else 'opacity-30' }} {{ cls }} flex flex-col gap-3"
           data-day-cell="{{ day_identifier }}"
           data-day-realized="{{ '%.10g'|format(d.realized) }}"
           data-day-invested="{{ '%.10g'|format(d.invested) }}"
           data-day-has-values="{{ 'true' if d.has_values else 'false' }}"
           data-day-in-month="{{ 'true' if d.in_month else 'false' }}"
           data-day-in-rolling="{{ 'true' if d.in_rolling else 'false' }}"
           data-day-belongs-year="{{ 'true' if d.belongs_to_year else 'false' }}"
           data-week-key="{{ week_key }}"
           data-week-position="{{ loop.index0 }}">
        <div class="flex items-center gap-2 calendar-card-heading">
          <span class="calendar-day-number">{{ d.date.day }}</span>
          {% set trade_button_classes = [
            'relative inline-flex items-center justify-center rounded-full p-1.5 trade-button focus:outline-none focus-ring-success transition'
          ] %}
          {% if not d.has_trades %}
            {% set trade_button_classes = trade_button_classes + ['icon-translucent'] %}
          {% endif %}
          <button type="button"
                  class="{{ trade_button_classes|join(' ') }}"
                  onclick="openTrades('{{ d.date.strftime('%Y-%m-%d') }}'); return false;"
                  aria-label="View trades">
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
              <circle cx="12" cy="12" r="9" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h-1.125a1.875 1.875 0 000 3.75h2.25a1.875 1.875 0 010 3.75H12m0-10.5v10.5" />
            </svg>
            <span class="sr-only">View trades</span>
            {% set trade_count = d.trades|length %}
            {% if trade_count %}
              <span class="trade-count-badge absolute -top-1 -right-1 min-w-[1.25rem] rounded-full text-[10px] font-semibold px-1 text-center"
                    x-cloak
                    x-show="showTradeCounts"
                    {% if not show_trade_count_badges %}style="display: none;"{% endif %}>{{ trade_count }}</span>
            {% endif %}
          </button>
          {% set dividend_button_classes = [
            'relative inline-flex items-center justify-center rounded-full p-1.5 dividend-button focus:outline-none focus-ring-success transition'
          ] %}
          {% if not d.has_dividends %}
            {% set dividend_button_classes = dividend_button_classes + ['icon-translucent'] %}
          {% endif %}
          <button type="button"
                  class="{{ dividend_button_classes|join(' ') }}"
                  onclick="openDividends('{{ d.date.strftime('%Y-%m-%d') }}'); return false;"
                  aria-label="View dividends">
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
              <circle cx="12" cy="12" r="9" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M9.5 9.25c0-1.24 1.12-2.25 2.5-2.25s2.5.9 2.5 2c0 1.8-3.75 1.8-3.75 3.6 0 1.1.93 1.9 2.25 1.9 1.32 0 2.25-.8 2.25-1.9M12 6.5v11" />
            </svg>
            <span class="sr-only">View dividends</span>
            {% set dividend_count = d.dividends|length %}
            {% if dividend_count %}
              <span class="dividend-count-badge absolute -top-1 -right-1 min-w-[1.25rem] rounded-full text-[10px] font-semibold px-1 text-center">{{ dividend_count }}</span>
            {% endif %}
          </button>
        </div>

        {% if show_text_default %}
        <div class="calendar-metric-group space-y-2">
          {% set realized_class = 'text-profit' if d.realized > 0 else ('text-loss' if d.realized < 0 else 'text-neutral-200') %}
          {% set market_value_class = 'text-profit' if d.market_value > 0 else ('text-loss' if d.market_value < 0 else 'text-neutral-200') %}
          {% if d.show_realized %}
          <div class="space-y-1">
            <div class="calendar-metric-line" data-day-realized-amount data-has-percent="{{ 'true' if d.percent is not none else 'false' }}">
              <span class="calendar-metric-label">Realized:</span>
              <span class="calendar-metric-value {{ realized_class }}" data-day-realized-value>{{ d.realized|money }}</span>
            </div>
            <div data-day-percent class="calendar-metric-line{% if d.percent is none %} hidden{% endif %} mt-1">
              <span class="calendar-metric-label">Realized:</span>
              <span data-day-percent-value class="calendar-metric-value {{ realized_class }}">{{ '{:+.2f}%'.format(d.percent) if d.percent is not none else '' }}</span>
            </div>
          </div>
          {% endif %}
          {% if d.market_value %}
          <div class="calendar-metric-line"
               x-show="showMarketValue" x-cloak>
            <span class="calendar-metric-label">Market value:</span>
            <span class="calendar-metric-value {{ market_value_class }}" data-day-market-value>{{ d.market_value|money }}</span>
          </div>
          {% endif %}
        </div>
        {% endif %}

        <!-- Gear icon for manual entry -->
        <a class="absolute top-2 right-2 icon-translucent z-10" href="#"
           aria-label="Edit daily values"
           onclick="openManual('{{ d.date.strftime('%Y-%m-%d') }}', {{ d.realized }}, {{ d.invested }}); return false;">
          <svg class="w-4 h-4 action-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M19.14,12.94a7.43,7.43,0,0,0,.05-.94,7.43,7.43,0,0,0-.05-.94l2.11-1.65a.5.5,0,0,0,.12-.64l-2-3.46a.5.5,0,0,0-.6-.22l-2.49,1a7.3,7.3,0,0,0-1.63-.94l-.38-2.65A.5.5,0,0,0,12.64,1H9.36a.5.5,0,0,0-.49.41L8.49,4.06a7.3,7.3,0,0,0-1.63.94l-2.49-1a.5.5,0,0,0-.6.22l-2,3.46a.5.5,0,0,0,.12.64L3.94,11.06a7.43,7.43,0,0,0-.05.94,7.43,7.43,0,0,0,.05.94L1.83,14.59a.5.5,0,0,0-.12.64l2,3.46a.5.5,0,0,0,.6.22l2.49-1a7.3,7.3,0,0,0,1.63.94l.38,2.65a.5.5,0,0,0,.49.41h3.28a.5.5,0,0,0,.49-.41l.38-2.65a7.3,7.3,0,0,0,1.63-.94l2.49,1a.5.5,0,0,0,.6-.22l2-3.46a.5.5,0,0,0-.12-.64Zm-7.14,2.56A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z" fill="currentColor" />
          </svg>
        </a>
        <div class="mt-auto flex items-center gap-2">
          <button type="button"
                  class="day-include-toggle"
                  data-day-toggle="{{ day_identifier }}"
                  {% if not d.in_month %}disabled{% endif %}
                  aria-pressed="true">
            Include Day
          </button>
          {% if notes_enabled %}
          <!-- Note icon -->
          <a class="note-trigger relative inline-flex items-center justify-center ml-auto icon-translucent z-10{% if d.has_note %} has-note{% endif %}"
             href="#"
             aria-label="{{ 'Edit daily note' if d.has_note else 'Add daily note' }}"
             data-note-text="{{ d.note | e }}"
             data-note-updated="{{ d.note_updated_at | default('', true) }}"
             data-note-label-empty="Add daily note"
             data-note-label-filled="Edit daily note"
             onclick="openDailyNote('{{ d.date.strftime('%Y-%m-%d') }}'); return false;">
            <svg class="w-4 h-4 action-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M19 3H5a2 2 0 0 0-2 2v14l4-4h12a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z" fill="currentColor" />
            </svg>
            <div class="note-tooltip absolute bottom-7 right-0 z-20 w-[min(24rem,calc(100vw-2rem))] rounded-lg border border-neutral-800 bg-neutral-950 p-3 text-left text-sm text-neutral-100 shadow-xl ring-1 ring-black/40">
              <div class="flex flex-col gap-2">
                <div>
                  <p class="text-[10px] uppercase tracking-wide text-neutral-500">Daily note</p>
                  <p class="text-[11px] text-neutral-400" data-note-tooltip-updated>Not saved yet</p>
                </div>
                <div class="overflow-visible whitespace-pre-wrap break-words leading-relaxed" data-note-tooltip-body>{{ d.note | e }}</div>
              </div>
            </div>
          </a>
          {% endif %}
        </div>
      </div>
    {% endif %}
  {% endfor %}
  {% set week_key = week.week_year ~ '-' ~ week.week_number %}
  {% set week_cls = (week.week_realized > 0) and 'cell-bg-pos' or (week.week_realized < 0) and 'cell-bg-neg' or 'bg-neutral-900' %}
  <div class="relative min-h-[10rem] rounded-xl border border-neutral-800 p-4 flex flex-col gap-3 {{ week_cls }}"
       data-week-summary="{{ week_key }}">
    <div class="flex flex-col gap-2">
      <div class="calendar-section-label">Week {{ week.week_index }}</div>
      <div class="calendar-metric-group space-y-2">
        {% set week_realized_class = 'text-neutral-200' %}
        {% if week.week_realized > 0 %}
          {% set week_realized_class = 'text-profit' %}
        {% elif week.week_realized < 0 %}
          {% set week_realized_class = 'text-loss' %}
        {% endif %}
        {% set week_percent_class = 'text-neutral-200' %}
        {% if week.week_percent is not none %}
          {% if week.week_percent > 0 %}
            {% set week_percent_class = 'text-profit' %}
          {% elif week.week_percent < 0 %}
            {% set week_percent_class = 'text-loss' %}
          {% endif %}
        {% endif %}
        <div data-week-realized
             class="space-y-1{% if not week.show_week_realized %} hidden{% endif %}">
          <div class="calendar-metric-line">
            <span class="calendar-metric-label">Realized:</span>
            <span class="calendar-metric-value {{ week_realized_class }}" data-week-realized-value>{{ week.week_realized|money }}</span>
          </div>
          <div data-week-percent class="calendar-metric-line{% if not (show_percentages_default and week.week_percent is not none) %} hidden{% endif %}">
            {% if show_percentages_default and week.week_percent is not none %}
            <span class="calendar-metric-label">Realized:</span>
            <span data-week-percent-value class="calendar-metric-value {{ week_percent_class }}">{{ '{:+.2f}%'.format(week.week_percent) }}</span>
            {% endif %}
          </div>
          <div data-week-average class="calendar-metric-line hidden">
            <span class="calendar-metric-label">Avg Daily P&amp;L (<span data-week-average-count>0</span> days):</span>
            <span class="calendar-metric-value" data-week-average-value></span>
          </div>
        </div>
      </div>
    </div>
    {% if show_exclude_controls or notes_enabled %}
    <div class="mt-auto flex items-center gap-2">
      {% if show_exclude_controls %}
      <button type="button"
              class="week-include-toggle"
              data-week-toggle="{{ week_key }}"
              aria-pressed="true">
        Include week
      </button>
      {% endif %}
      {% if notes_enabled %}
      <a class="note-trigger weekly-note-trigger relative inline-flex items-center justify-center ml-auto z-10{% if week.has_note %} has-note{% else %} icon-translucent{% endif %}"
         href="#"
         aria-label="{{ 'Edit weekly note' if week.has_note else 'Add weekly note' }}"
         data-week-year="{{ week.week_year }}"
         data-week-index="{{ week.week_number }}"
         data-note-text="{{ week.note | default('', true) | e }}"
         data-note-updated="{{ week.note_updated_at | default('', true) }}"
         data-note-label-empty="Add weekly note"
         data-note-label-filled="Edit weekly note"
         onclick="openWeeklyNote({{ week.week_year }}, {{ week.week_number }}); return false;">
        <svg class="w-4 h-4 action-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M19 3H5a2 2 0 0 0-2 2v14l4-4h12a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z" fill="currentColor" />
        </svg>
        <div class="note-tooltip absolute bottom-7 right-0 z-20 w-[min(24rem,calc(100vw-2rem))] rounded-lg border border-neutral-800 bg-neutral-950 p-3 text-left text-sm text-neutral-100 shadow-xl ring-1 ring-black/40">
          <div class="flex flex-col gap-2">
            <div>
              <p class="text-[10px] uppercase tracking-wide text-neutral-500">Weekly note</p>
              <p class="text-[11px] text-neutral-400" data-note-tooltip-updated>Not saved yet</p>
            </div>
            <div class="overflow-visible whitespace-pre-wrap break-words leading-relaxed" data-note-tooltip-body>{{ week.note | default('', true) | e }}</div>
          </div>
        </div>
      </a>
      {% endif %}
    </div>
    {% endif %}
  </div>
{% endfor %}
</div>

<div class="mt-6 w-full lg:max-w-5xl xl:max-w-6xl">
  <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-[minmax(0,1fr)_minmax(0,1fr)_minmax(0,1.35fr)]">
    <div class="rounded border border-neutral-800 p-3 bg-neutral-950 relative"
         data-month-summary
         data-base-realized="{{ '%.10g'|format(month_realized) }}">
      <h2 class="calendar-card-heading">Monthly summary</h2>
      <div class="calendar-metric-group space-y-1">
        <div class="calendar-primary-metric">Realized: <span data-month-realized-value class="{{ 'text-profit' if month_realized > 0 else ('text-loss' if month_realized < 0 else 'text-neutral-200') }}">{{ month_realized|money }}</span></div>
        {% set month_percent_class = 'text-neutral-200' %}
        {% if month_percent is not none %}
          {% if month_percent > 0 %}
            {% set month_percent_class = 'text-profit' %}
          {% elif month_percent < 0 %}
            {% set month_percent_class = 'text-loss' %}
          {% endif %}
        {% endif %}
        <div data-month-percent class="calendar-secondary-metric{% if not (show_percentages_default and month_percent is not none) %} hidden{% endif %}">
          {% if show_percentages_default and month_percent is not none %}Realized: <span data-month-percent-value class="{{ month_percent_class }}">{{ '{:+.2f}%'.format(month_percent) }}</span>{% endif %}
        </div>
      </div>
      <div class="calendar-secondary-metric hidden mt-2" data-month-average>
        <span>Avg Daily P&amp;L (<span data-month-average-count>0</span> days):</span>
        <span data-month-average-value></span>
      </div>
      {% set month_note_text = month_note.note | default('', true) %}
      {% set month_note_has = month_note_text.strip() %}
        {% if notes_enabled %}
        <a class="note-trigger absolute top-1 right-1 z-10{% if month_note_has %} has-note{% else %} icon-translucent{% endif %}" href="#"
           aria-label="{{ 'Edit monthly note' if month_note_has else 'Add monthly note' }}"
           data-month-key="{{ year }}-{{ '%02d'|format(month) }}"
           data-note-text="{{ month_note_text | e }}"
           data-note-updated="{{ month_note.updated_at | default('', true) }}"
           data-note-label-empty="Add monthly note"
           data-note-label-filled="Edit monthly note"
           onclick="openMonthlyNote({{ year }}, {{ month }}); return false;">
          <svg class="w-4 h-4 action-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M19 3H5a2 2 0 0 0-2 2v14l4-4h12a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z" fill="currentColor" />
          </svg>
          <div class="note-tooltip absolute bottom-7 right-0 z-20 w-[min(24rem,calc(100vw-2rem))] rounded-lg border border-neutral-800 bg-neutral-950 p-3 text-left text-sm text-neutral-100 shadow-xl ring-1 ring-black/40">
            <div class="flex flex-col gap-2">
              <div>
                <p class="text-[10px] uppercase tracking-wide text-neutral-500">Monthly note</p>
                <p class="text-[11px] text-neutral-400" data-note-tooltip-updated>Not saved yet</p>
              </div>
              <div class="overflow-visible whitespace-pre-wrap break-words leading-relaxed" data-note-tooltip-body>{{ month_note_text | e }}</div>
            </div>
          </div>
        </a>
        {% endif %}
    </div>
    {% set month_ratio_text = '—' %}
    {% if month_win_ratio is not none %}
      {% set month_ratio_text = '{:.1f}%'.format(month_win_ratio).replace('.0%', '%') %}
    {% endif %}
    {% set year_ratio_text = '—' %}
    {% if year_win_ratio is not none %}
      {% set year_ratio_text = '{:.1f}%'.format(year_win_ratio).replace('.0%', '%') %}
    {% endif %}
    {% set month_ratio_value = month_win_ratio if month_win_ratio is not none else 0 %}
    {% set year_ratio_value = year_win_ratio if year_win_ratio is not none else 0 %}
    {% set month_fill_value = month_ratio_value %}
    {% if month_fill_value < 0 %}
      {% set month_fill_value = 0 %}
    {% elif month_fill_value > 100 %}
      {% set month_fill_value = 100 %}
    {% endif %}
    {% set year_fill_value = year_ratio_value %}
    {% if year_fill_value < 0 %}
      {% set year_fill_value = 0 %}
    {% elif year_fill_value > 100 %}
      {% set year_fill_value = 100 %}
    {% endif %}
    {% set month_indicator_value = 50 if month_win_ratio is none else month_fill_value %}
    {% if month_win_ratio is not none %}
      {% if month_indicator_value < 2 %}
        {% set month_indicator_value = 2 %}
      {% elif month_indicator_value > 98 %}
        {% set month_indicator_value = 98 %}
      {% endif %}
    {% endif %}
    {% set year_indicator_value = 50 if year_win_ratio is none else year_fill_value %}
    {% if year_win_ratio is not none %}
      {% if year_indicator_value < 2 %}
        {% set year_indicator_value = 2 %}
      {% elif year_indicator_value > 98 %}
        {% set year_indicator_value = 98 %}
      {% endif %}
    {% endif %}
    <div class="rounded border border-neutral-800 p-3 bg-neutral-950">
      <h2 class="calendar-card-heading">Yearly summary</h2>
      <div class="mt-2 space-y-4">
        <div class="calendar-metric-group space-y-1"
             data-rolling-summary
             data-base-realized="{{ '%.10g'|format(rolling_year_realized) }}"
             data-base-trading-days="{{ rolling_year_trading_days }}"
             data-other-invested-max="{{ '%.10g'|format(rolling_year_other_invested_max) }}">
          <p class="calendar-section-label">Last 12 months</p>
          <div class="calendar-primary-metric">Realized: <span data-rolling-realized-value class="{{ 'text-profit' if rolling_year_realized > 0 else ('text-loss' if rolling_year_realized < 0 else 'text-neutral-200') }}">{{ rolling_year_realized|money }}</span></div>
          {% set rolling_percent_class = 'text-neutral-200' %}
          {% if rolling_year_percent is not none %}
            {% if rolling_year_percent > 0 %}
              {% set rolling_percent_class = 'text-profit' %}
            {% elif rolling_year_percent < 0 %}
              {% set rolling_percent_class = 'text-loss' %}
            {% endif %}
          {% endif %}
          <div data-rolling-percent class="calendar-secondary-metric{% if not (show_percentages_default and rolling_year_percent is not none) %} hidden{% endif %}">
            {% if show_percentages_default and rolling_year_percent is not none %}Realized: <span data-rolling-percent-value class="{{ rolling_percent_class }}">{{ '{:+.2f}%'.format(rolling_year_percent) }}</span>{% endif %}
          </div>
          <div class="calendar-secondary-metric hidden" data-rolling-average>
            <span>Avg Daily P&amp;L (<span data-rolling-average-count>0</span> days):</span>
            <span data-rolling-average-value></span>
          </div>

        </div>
        <div class="calendar-metric-group space-y-1"
             data-year-summary
             data-base-realized="{{ '%.10g'|format(year_realized) }}"
             data-base-trading-days="{{ year_trading_days }}"
             data-other-invested-max="{{ '%.10g'|format(year_other_invested_max) }}">
          <p class="calendar-section-label">Since Jan 1</p>
          <div class="calendar-primary-metric">Realized: <span data-year-realized-value class="{{ 'text-profit' if year_realized > 0 else ('text-loss' if year_realized < 0 else 'text-neutral-200') }}">{{ year_realized|money }}</span></div>
          {% set year_percent_class = 'text-neutral-200' %}
          {% if year_percent is not none %}
            {% if year_percent > 0 %}
              {% set year_percent_class = 'text-profit' %}
            {% elif year_percent < 0 %}
              {% set year_percent_class = 'text-loss' %}
            {% endif %}
          {% endif %}
          <div data-year-percent class="calendar-secondary-metric{% if not (show_percentages_default and year_percent is not none) %} hidden{% endif %}">
            {% if show_percentages_default and year_percent is not none %}Realized: <span data-year-percent-value class="{{ year_percent_class }}">{{ '{:+.2f}%'.format(year_percent) }}</span>{% endif %}
          </div>
          <div class="calendar-secondary-metric hidden" data-year-average>
            <span>Avg Daily P&amp;L (<span data-year-average-count>0</span> days):</span>
            <span data-year-average-value></span>
          </div>

        </div>
      </div>
    </div>
    <div class="rounded border border-neutral-800 p-3 bg-neutral-950"
         data-win-ratio-panel
         data-month-wins="{{ month_wins }}"
         data-month-losses="{{ month_losses }}"
         data-year-month-wins="{{ month_year_wins }}"
         data-year-month-losses="{{ month_year_losses }}"
         data-year-other-wins="{{ year_other_wins }}"
         data-year-other-losses="{{ year_other_losses }}">
      <h2 class="calendar-card-heading">Win ratios</h2>
      <div class="mt-4 grid gap-6 sm:grid-cols-2" data-win-ratio-dials>
        <div class="flex flex-col items-center gap-3" data-win-ratio-dial="month">
          <p class="win-ratio-dial-heading">Monthly</p>
          <div class="w-full max-w-xs win-ratio-visual">
            <div class="win-ratio-bar">
              <div class="win-ratio-bar-fill" data-win-ratio-fill style="width: {{ '%.4f'|format(month_fill_value if month_win_ratio is not none else 0) }}%;{% if month_fill_value <= 0 %} opacity: 0;{% else %} opacity: 1;{% endif %}"></div>
              <div class="win-ratio-bar-indicator{% if month_win_ratio is none %} win-ratio-indicator-empty{% endif %}" data-win-ratio-indicator style="left: {{ '%.4f'|format(month_indicator_value) }}%;{% if month_win_ratio is none %} opacity: 0.4;{% else %} opacity: 1;{% endif %}">
                <span data-win-ratio-value>{{ month_ratio_text }}</span>
              </div>
            </div>
            <div class="mt-2 flex justify-between win-ratio-scale">
              <span>0%</span>
              <span>50%</span>
              <span>100%</span>
            </div>
          </div>
          <p class="text-center text-xs text-neutral-500">
            Wins: <span data-win-ratio-wins>{{ month_wins }}</span> &bull; Losses: <span data-win-ratio-losses>{{ month_losses }}</span>
          </p>
        </div>
        <div class="flex flex-col items-center gap-3" data-win-ratio-dial="year">
          <p class="win-ratio-dial-heading">Yearly</p>
          <div class="w-full max-w-xs win-ratio-visual">
            <div class="win-ratio-bar">
              <div class="win-ratio-bar-fill" data-win-ratio-fill style="width: {{ '%.4f'|format(year_fill_value if year_win_ratio is not none else 0) }}%;{% if year_fill_value <= 0 %} opacity: 0;{% else %} opacity: 1;{% endif %}"></div>
              <div class="win-ratio-bar-indicator{% if year_win_ratio is none %} win-ratio-indicator-empty{% endif %}" data-win-ratio-indicator style="left: {{ '%.4f'|format(year_indicator_value) }}%;{% if year_win_ratio is none %} opacity: 0.4;{% else %} opacity: 1;{% endif %}">
                <span data-win-ratio-value>{{ year_ratio_text }}</span>
              </div>
            </div>
            <div class="mt-2 flex justify-between win-ratio-scale">
              <span>0%</span>
              <span>50%</span>
              <span>100%</span>
            </div>
          </div>
          <p class="text-center text-xs text-neutral-500">
            Wins: <span data-win-ratio-wins>{{ year_wins }}</span> &bull; Losses: <span data-win-ratio-losses>{{ year_losses }}</span>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

</div>

<!-- Modals -->
<div
  id="modal"
  x-data="{
    open: false,
    title: '',
    body: '',
    save: null,
    previouslyFocused: null,
    closeLabel: 'Close',
    saveLabel: 'Save',
    saving: false,
    shouldReloadOnClose: false,
    beforeClose: null,
    init() {
      window.modalController = this;
      this.$watch('open', (value) => {
        document.body.classList.toggle('modal-open', value);
        this.toggleBackgroundInteractivity(value);
        if (value) {
          this.storeActiveElement();
          this.$nextTick(() => this.focusFirstElement());
        } else {
          this.restoreActiveElement();
          this.resetState();
        }
      });
    },
    toggleBackgroundInteractivity(isOpen) {
      const applyState = (element) => {
        if (!element) {
          return;
        }
        element.classList.toggle('modal-background-inert', isOpen);
        if (isOpen) {
          element.setAttribute('aria-hidden', 'true');
        } else {
          element.removeAttribute('aria-hidden');
        }
        if ('inert' in element) {
          element.inert = isOpen;
        }
      };

      applyState(document.querySelector('nav'));

      const main = document.querySelector('main');
      if (!main) {
        return;
      }

      const backgroundElements = Array.from(main.children).filter((child) => child.id !== 'modal');
      backgroundElements.forEach(applyState);
    },
    storeActiveElement() {
      this.previouslyFocused = document.activeElement;
    },
    restoreActiveElement() {
      if (this.previouslyFocused && typeof this.previouslyFocused.focus === 'function') {
        this.previouslyFocused.focus({ preventScroll: true });
      }
      this.previouslyFocused = null;
    },
    focusFirstElement() {
      const dialog = this.$refs.dialog;
      if (!dialog) {
        return;
      }
      const focusable = dialog.querySelector('[data-autofocus], button, textarea, input, select, [tabindex]:not([tabindex=&quot;-1&quot;])');
      if (focusable && typeof focusable.focus === 'function') {
        focusable.focus();
      } else if (typeof dialog.focus === 'function') {
        dialog.focus();
      }
    },
    resetState() {
      this.save = null;
      this.closeLabel = 'Close';
      this.saveLabel = 'Save';
      this.saving = false;
      this.shouldReloadOnClose = false;
      this.beforeClose = null;
    },
    close(force = false) {
      if (!force && typeof this.beforeClose === 'function') {
        try {
          const shouldClose = this.beforeClose();
          if (shouldClose === false) {
            return;
          }
        } catch (error) {
          console.error(error);
          return;
        }
      }
      const reload = this.shouldReloadOnClose;
      this.open = false;
      if (reload) {
        setTimeout(() => window.location.reload(), 0);
      }
    },
  }"
  x-show="open"
  x-cloak
  class="fixed inset-0 z-50 bg-black/60 flex items-center justify-center"
  role="dialog"
  aria-modal="true"
  :aria-hidden="(!open).toString()"
  @click.self="close()"
  @keydown.escape.window.stop.prevent="close()"
>
  <div
    x-ref="dialog"
    class="bg-neutral-950 border border-neutral-800 rounded p-4 w-full max-w-3xl focus:outline-none"
    role="document"
    tabindex="-1"
    @click.stop
  >
    <h3 class="font-semibold mb-2" x-text="title"></h3>
    <div x-html="body"></div>
    <div class="mt-4 flex justify-end gap-2">
      <button type="button" class="px-3 py-1 rounded border border-neutral-700" @click="close()" x-text="closeLabel"></button>
      <button
        type="button"
        class="btn btn-primary px-3 py-1 text-sm"
        :class="{ 'opacity-60 cursor-not-allowed': saving || !save }"
        :disabled="saving || !save"
        @click="if (!saving && save) save()"
      >
        <span x-text="saving ? 'Saving…' : saveLabel"></span>
      </button>
    </div>
  </div>
</div>

</div>

<script>
async function updateUiPreferences(payload) {
  try {
    const response = await fetch('/api/ui/preferences', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload || {}),
    });
    if (!response.ok) {
      let message = 'Failed to save preference.';
      try {
        const data = await response.json();
        if (data && data.detail) {
          message = data.detail;
        }
      } catch (error) {
        // Ignore JSON parse errors and use fallback message
      }
      throw new Error(message);
    }
    return true;
  } catch (error) {
    console.warn('Unable to save preference', error);
    return false;
  }
}

function calendarToolbar(initialState = {}) {
  return {
    showMarketValue:
      initialState.showMarketValue === undefined
        ? true
        : !!initialState.showMarketValue,
    showExcludeControls:
      initialState.showExcludeControls === undefined
        ? true
        : !!initialState.showExcludeControls,
    showPercentages:
      initialState.showPercentages === undefined
        ? true
        : !!initialState.showPercentages,
    showWeekends: !!initialState.showWeekends,
    showTradeCounts:
      initialState.showTradeCounts === undefined
        ? false
        : !!initialState.showTradeCounts,
    async toggleMarketValue() {
      const previous = this.showMarketValue;
      const next = !previous;
      this.showMarketValue = next;
      const saved = await updateUiPreferences({ show_market_value: next });
      if (!saved) {
        this.showMarketValue = previous;
      }
    },
    async toggleExcludeControls() {
      const previous = this.showExcludeControls;
      const next = !previous;
      this.showExcludeControls = next;
      const saved = await updateUiPreferences({ show_exclude_controls: next });
      if (!saved) {
        this.showExcludeControls = previous;
      }
    },
    async togglePercentages() {
      const previous = this.showPercentages;
      const next = !previous;
      this.showPercentages = next;
      const saved = await updateUiPreferences({ show_percentages: next });
      if (!saved) {
        this.showPercentages = previous;
      }
    },
    async toggleWeekends() {
      const previous = this.showWeekends;
      const next = !previous;
      this.showWeekends = next;
      const saved = await updateUiPreferences({ show_weekends: next });
      if (!saved) {
        this.showWeekends = previous;
        return;
      }
      window.location.reload();
    },
    async toggleTradeCounts() {
      const previous = this.showTradeCounts;
      const next = !previous;
      this.showTradeCounts = next;
      const saved = await updateUiPreferences({ show_trade_count: next });
      if (!saved) {
        this.showTradeCounts = previous;
      }
    },
  };
}

function quickMonthPicker() {
  return {
    isOpen: false,
    year: '',
    month: '',
    init() {
      const current = this.currentParts();
      this.year = current.year || this.defaultYear();
      this.month = current.month || this.defaultMonth();
    },
    currentParts() {
      const root = document.querySelector('[data-calendar-root]');
      if (!root) {
        return { year: '', month: '' };
      }
      const year = Number.parseInt(root.dataset.calendarYear, 10);
      const month = root.dataset.calendarMonth || '';
      const normalizedMonth = /^(0[1-9]|1[0-2])$/.test(month)
        ? month
        : '';
      return {
        year: Number.isFinite(year) ? year : '',
        month: normalizedMonth,
      };
    },
    defaultYear() {
      return new Date().getFullYear();
    },
    defaultMonth() {
      return String(new Date().getMonth() + 1).padStart(2, '0');
    },
    open() {
      this.isOpen = true;
      const current = this.currentParts();
      this.year = current.year || this.sanitizedYear() || this.defaultYear();
      this.month = current.month || this.ensureMonth(this.month) || this.defaultMonth();
      this.$nextTick(() => {
        if (this.$refs.yearInput) {
          this.$refs.yearInput.focus();
          if (typeof this.$refs.yearInput.select === 'function') {
            this.$refs.yearInput.select();
          }
        }
      });
    },
    ensureMonth(value) {
      if (typeof value !== 'string') {
        return '';
      }
      const trimmed = value.trim();
      if (/^(0[1-9]|1[0-2])$/.test(trimmed)) {
        return trimmed;
      }
      if (/^([1-9]|1[0-2])$/.test(trimmed)) {
        return String(Number.parseInt(trimmed, 10)).padStart(2, '0');
      }
      return '';
    },
    close() {
      this.isOpen = false;
    },
    toggle() {
      if (this.isOpen) {
        this.close();
      } else {
        this.open();
      }
    },
    handleOutside(event) {
      if (!this.isOpen) {
        return;
      }
      const panel = this.$refs.panel;
      const trigger = this.$refs.trigger;
      const target = event ? event.target : null;
      if (!target) {
        return;
      }
      if ((panel && panel.contains(target)) || (trigger && trigger.contains(target))) {
        return;
      }
      this.close();
    },
    sanitizedYear() {
      const numeric = Number.parseInt(String(this.year).trim(), 10);
      if (!Number.isFinite(numeric) || numeric < 1) {
        return null;
      }
      return numeric;
    },
    normalizeYear() {
      const sanitized = this.sanitizedYear();
      if (sanitized === null) {
        const current = this.currentParts();
        this.year = current.year || this.defaultYear();
        return;
      }
      this.year = sanitized;
    },
    stepYear(delta) {
      const sanitized = this.sanitizedYear();
      const base = sanitized !== null
        ? sanitized
        : this.currentParts().year || this.defaultYear();
      const next = base + delta;
      this.year = next < 1 ? 1 : next;
    },
    go() {
      const year = this.sanitizedYear();
      const month = this.ensureMonth(this.month);
      if (year === null) {
        this.normalizeYear();
        return;
      }
      if (!month) {
        this.month = this.defaultMonth();
        return;
      }
      this.month = month;
      this.close();
      window.location.href = `/calendar/${year}/${month}`;
    },
  };
}

const dayImpactSimulator = (() => {
  const cells = Array.from(document.querySelectorAll('[data-day-cell]'));
  if (!cells.length) {
    return null;
  }

  const parseNumber = (value) => {
    if (typeof value === 'number') {
      return Number.isFinite(value) ? value : 0;
    }
    if (typeof value === 'string' && value.trim() !== '') {
      const parsed = Number(value);
      return Number.isFinite(parsed) ? parsed : 0;
    }
    return 0;
  };

  const isApproximatelyZero = (value) => Math.abs(value) <= 0.005;

  const formatMoney = (value) => {
    const numeric = Number(value);
    if (!Number.isFinite(numeric)) {
      return '$0.00';
    }
    const sign = numeric < 0 ? '-' : '';
    const absolute = Math.abs(numeric);
    return `${sign}$${absolute.toLocaleString(undefined, {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    })}`;
  };

  const formatPercentage = (value) => {
    const numeric = Number(value);
    if (!Number.isFinite(numeric)) {
      return '';
    }
    const rounded = Math.round(numeric * 100) / 100;
    const sign = rounded >= 0 ? '+' : '';
    return `${sign}${rounded.toFixed(2)}%`;
  };

  const calculatePercentageValue = (realized, samples) => {
    const valid = [];
    samples.forEach((sample) => {
      const numeric = Math.abs(Number(sample));
      if (Number.isFinite(numeric) && !isApproximatelyZero(numeric)) {
        valid.push(numeric);
      }
    });
    if (!valid.length) {
      return null;
    }
    const denominator = Math.max(...valid);
    if (!Number.isFinite(denominator) || isApproximatelyZero(denominator)) {
      return null;
    }
    const result = (Number(realized) / denominator) * 100;
    if (!Number.isFinite(result)) {
      return null;
    }
    return Math.round(result * 100) / 100;
  };

  const collectInvestedSample = (collection, value) => {
    const magnitude = Math.abs(Number(value));
    if (!Number.isFinite(magnitude) || isApproximatelyZero(magnitude)) {
      return;
    }
    collection.push(magnitude);
  };

  const createWinRatioController = (element) => {
    if (!element) {
      return null;
    }

    const parseCount = (value) => {
      if (value === undefined || value === null || value === '') {
        return 0;
      }
      const numeric = Number(value);
      if (!Number.isFinite(numeric)) {
        return 0;
      }
      if (numeric <= 0) {
        return 0;
      }
      return Math.round(numeric);
    };

    const baseYearOtherWins = parseCount(element.dataset.yearOtherWins);
    const baseYearOtherLosses = parseCount(element.dataset.yearOtherLosses);
    const baseMonthWins = parseCount(element.dataset.monthWins);
    const baseMonthLosses = parseCount(element.dataset.monthLosses);
    const baseYearMonthWins = parseCount(element.dataset.yearMonthWins);
    const baseYearMonthLosses = parseCount(element.dataset.yearMonthLosses);

    const dialConfigs = Array.from(element.querySelectorAll('[data-win-ratio-dial]')).map((dial) => ({
      type: dial.dataset.winRatioDial === 'year' ? 'year' : 'month',
      fillEl: dial.querySelector('[data-win-ratio-fill]'),
      indicatorEl: dial.querySelector('[data-win-ratio-indicator]'),
      valueEl: dial.querySelector('[data-win-ratio-value]'),
      winsEl: dial.querySelector('[data-win-ratio-wins]'),
      lossesEl: dial.querySelector('[data-win-ratio-losses]'),
    }));

    const state = {
      month: { wins: baseMonthWins, losses: baseMonthLosses },
      year: {
        wins: baseYearOtherWins + baseYearMonthWins,
        losses: baseYearOtherLosses + baseYearMonthLosses,
      },
    };

    const clampRatio = (ratio) => Math.min(100, Math.max(0, Number(ratio)));

    const formatRatio = (ratio) => {
      if (ratio === null || !Number.isFinite(ratio)) {
        return '—';
      }
      const fixed = ratio.toFixed(1);
      const trimmed = fixed.endsWith('.0') ? fixed.slice(0, -2) : fixed;
      return `${trimmed}%`;
    };

    const updateFill = (fillEl, ratio) => {
      if (!fillEl) {
        return;
      }
      if (ratio === null || !Number.isFinite(ratio)) {
        fillEl.style.width = '0%';
        fillEl.style.opacity = '0';
        return;
      }
      const clamped = clampRatio(ratio);
      fillEl.style.width = `${clamped}%`;
      fillEl.style.opacity = clamped <= 0 ? '0' : '1';
    };

    const updateIndicator = (indicatorEl, ratio) => {
      if (!indicatorEl) {
        return;
      }
      if (ratio === null || !Number.isFinite(ratio)) {
        indicatorEl.style.left = '50%';
        indicatorEl.style.opacity = '0.4';
        indicatorEl.classList.add('win-ratio-indicator-empty');
        return;
      }
      const clamped = clampRatio(ratio);
      const bounded = Math.min(98, Math.max(2, clamped));
      indicatorEl.style.left = `${bounded}%`;
      indicatorEl.style.opacity = '1';
      indicatorEl.classList.remove('win-ratio-indicator-empty');
    };

    const renderDial = (config) => {
      if (!config || !config.type) {
        return;
      }
      const current = state[config.type] || { wins: 0, losses: 0 };
      const total = current.wins + current.losses;
      const ratio = total > 0 ? clampRatio((current.wins / total) * 100) : null;

      if (config.valueEl) {
        config.valueEl.textContent = formatRatio(ratio);
      }
      if (config.winsEl) {
        config.winsEl.textContent = String(current.wins);
      }
      if (config.lossesEl) {
        config.lossesEl.textContent = String(current.losses);
      }
      updateFill(config.fillEl, ratio);
      updateIndicator(config.indicatorEl, ratio);
    };

    const renderAll = () => {
      dialConfigs.forEach((config) => renderDial(config));
    };

    renderAll();

    const normalizeCount = (value) => {
      const numeric = Number(value);
      if (!Number.isFinite(numeric) || numeric <= 0) {
        return 0;
      }
      return Math.round(numeric);
    };

    return {
      updateFromCounts(monthWins, monthLosses, yearMonthWins, yearMonthLosses) {
        state.month.wins = normalizeCount(monthWins);
        state.month.losses = normalizeCount(monthLosses);
        state.year.wins = baseYearOtherWins + normalizeCount(yearMonthWins);
        state.year.losses = baseYearOtherLosses + normalizeCount(yearMonthLosses);
        renderAll();
      },
      refresh: renderAll,
    };
  };

  const calendarRoot = document.querySelector('[data-calendar-root]');
  const calendarYear = calendarRoot ? calendarRoot.dataset.calendarYear : '';
  const calendarMonth = calendarRoot ? calendarRoot.dataset.calendarMonth : '';
  const excludedStorageKey =
    calendarYear && calendarMonth
      ? `bagholder:excludedDays:${calendarYear}-${calendarMonth}`
      : null;

  const loadStoredExcludedDays = () => {
    if (!excludedStorageKey) {
      return new Set();
    }
    try {
      const storage = window.localStorage;
      if (!storage) {
        return new Set();
      }
      const raw = storage.getItem(excludedStorageKey);
      if (!raw) {
        return new Set();
      }
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed)) {
        return new Set();
      }
      const valid = parsed.filter((value) => typeof value === 'string' && value);
      return new Set(valid);
    } catch (error) {
      console.warn('Unable to restore excluded day selections', error);
      return new Set();
    }
  };

  const excludedDays = loadStoredExcludedDays();

  const persistExcludedDays = () => {
    if (!excludedStorageKey) {
      return;
    }
    try {
      const storage = window.localStorage;
      if (!storage) {
        return;
      }
      storage.setItem(excludedStorageKey, JSON.stringify(Array.from(excludedDays)));
    } catch (error) {
      console.warn('Unable to persist excluded day selections', error);
    }
  };

  const updateExcludedStorage = (dateStr, included) => {
    if (!excludedStorageKey || !dateStr) {
      return;
    }
    if (included) {
      excludedDays.delete(dateStr);
    } else {
      excludedDays.add(dateStr);
    }
    persistExcludedDays();
  };

  const dayMap = new Map();
  const weekStructure = new Map();
  const weekStates = new Map();

  const setDayToggleState = (toggle, included) => {
    if (!toggle) {
      return;
    }
    toggle.classList.toggle('toggle-excluded', !included);
    toggle.setAttribute('aria-pressed', included ? 'true' : 'false');
    toggle.dataset.state = included ? 'included' : 'excluded';
    toggle.textContent = included ? 'Include Day' : 'Exclude Day';
  };

  const setWeekToggleState = (toggle, included) => {
    if (!toggle) {
      return;
    }
    toggle.classList.toggle('toggle-excluded', !included);
    toggle.setAttribute('aria-pressed', included ? 'true' : 'false');
    toggle.dataset.state = included ? 'included' : 'excluded';
    toggle.textContent = included ? 'Exclude week' : 'Include week';
  };

  cells.forEach((cell) => {
    const dateStr = cell.dataset.dayCell;
    if (!dateStr) {
      return;
    }
    const day = {
      cell,
      realized: parseNumber(cell.dataset.dayRealized),
      invested: parseNumber(cell.dataset.dayInvested),
      hasValues: cell.dataset.dayHasValues === 'true',
      inMonth: cell.dataset.dayInMonth === 'true',
      inRolling: cell.dataset.dayInRolling === 'true',
      belongsToYear: cell.dataset.dayBelongsYear === 'true',
      weekKey: cell.dataset.weekKey || '',
      weekPosition: Number(cell.dataset.weekPosition || '0'),
      included: true,
    };
    dayMap.set(dateStr, day);

    if (day.inMonth && excludedDays.has(dateStr)) {
      day.included = false;
    }
    day.dateStr = dateStr;

    if (day.weekKey) {
      if (!weekStructure.has(day.weekKey)) {
        weekStructure.set(day.weekKey, []);
      }
      weekStructure.get(day.weekKey).push({ date: dateStr, position: day.weekPosition });
    }

    const toggle = cell.querySelector('[data-day-toggle]');
    if (toggle) {
      day.toggle = toggle;
      if (!toggle.disabled) {
        toggle.addEventListener('click', () => {
          day.included = !day.included;
          if (day.inMonth) {
            updateExcludedStorage(dateStr, day.included);
          }
          updateSummaries();
        });
      }
    }
  });

  if (excludedDays.size) {
    const valid = new Set();
    dayMap.forEach((value, key) => {
      if (value.inMonth && excludedDays.has(key)) {
        valid.add(key);
      }
    });
    if (valid.size !== excludedDays.size) {
      excludedDays.clear();
      valid.forEach((key) => excludedDays.add(key));
      persistExcludedDays();
    }
  }

  if (!dayMap.size) {
    return null;
  }

  weekStructure.forEach((entries) => {
    entries.sort((a, b) => a.position - b.position);
  });

  const winRatioPanelEl = document.querySelector('[data-win-ratio-panel]');
  const winRatioController = createWinRatioController(winRatioPanelEl);

  const applyWinRatioCountUpdates = (() => {
    if (!winRatioPanelEl) {
      return () => {};
    }

    const normalizeCountValue = (value) => {
      const numeric = Number(value);
      if (!Number.isFinite(numeric) || numeric <= 0) {
        return 0;
      }
      return Math.round(numeric);
    };

    const monthDialEl = winRatioPanelEl.querySelector('[data-win-ratio-dial="month"]');
    const yearDialEl = winRatioPanelEl.querySelector('[data-win-ratio-dial="year"]');

    const monthWinsEl = monthDialEl ? monthDialEl.querySelector('[data-win-ratio-wins]') : null;
    const monthLossesEl = monthDialEl ? monthDialEl.querySelector('[data-win-ratio-losses]') : null;
    const yearWinsEl = yearDialEl ? yearDialEl.querySelector('[data-win-ratio-wins]') : null;
    const yearLossesEl = yearDialEl ? yearDialEl.querySelector('[data-win-ratio-losses]') : null;

    const baseYearOtherWins = normalizeCountValue(winRatioPanelEl.dataset.yearOtherWins);
    const baseYearOtherLosses = normalizeCountValue(winRatioPanelEl.dataset.yearOtherLosses);

    return (monthWins, monthLosses, yearMonthWins, yearMonthLosses) => {
      const normalizedMonthWins = normalizeCountValue(monthWins);
      const normalizedMonthLosses = normalizeCountValue(monthLosses);
      const normalizedYearMonthWins = normalizeCountValue(yearMonthWins);
      const normalizedYearMonthLosses = normalizeCountValue(yearMonthLosses);

      if (monthWinsEl) {
        monthWinsEl.textContent = String(normalizedMonthWins);
      }
      if (monthLossesEl) {
        monthLossesEl.textContent = String(normalizedMonthLosses);
      }
      if (yearWinsEl) {
        yearWinsEl.textContent = String(baseYearOtherWins + normalizedYearMonthWins);
      }
      if (yearLossesEl) {
        yearLossesEl.textContent = String(baseYearOtherLosses + normalizedYearMonthLosses);
      }

      winRatioPanelEl.dataset.monthWins = String(normalizedMonthWins);
      winRatioPanelEl.dataset.monthLosses = String(normalizedMonthLosses);
      winRatioPanelEl.dataset.yearMonthWins = String(normalizedYearMonthWins);
      winRatioPanelEl.dataset.yearMonthLosses = String(normalizedYearMonthLosses);
    };
  })();
  const monthSummaryEl = document.querySelector('[data-month-summary]');
  const monthRealizedEl = monthSummaryEl ? monthSummaryEl.querySelector('[data-month-realized-value]') : null;
  const monthPercentContainer = monthSummaryEl ? monthSummaryEl.querySelector('[data-month-percent]') : null;
  const monthPercentValueEl = monthSummaryEl ? monthSummaryEl.querySelector('[data-month-percent-value]') : null;
  const monthAverageContainer = monthSummaryEl ? monthSummaryEl.querySelector('[data-month-average]') : null;
  const monthAverageCountEl = monthSummaryEl ? monthSummaryEl.querySelector('[data-month-average-count]') : null;
  const monthAverageValueEl = monthSummaryEl ? monthSummaryEl.querySelector('[data-month-average-value]') : null;

  const rollingSummaryEl = document.querySelector('[data-rolling-summary]');
  const rollingRealizedEl = rollingSummaryEl ? rollingSummaryEl.querySelector('[data-rolling-realized-value]') : null;
  const rollingPercentContainer = rollingSummaryEl ? rollingSummaryEl.querySelector('[data-rolling-percent]') : null;
  const rollingPercentValueEl = rollingSummaryEl ? rollingSummaryEl.querySelector('[data-rolling-percent-value]') : null;
  const rollingAverageContainer = rollingSummaryEl ? rollingSummaryEl.querySelector('[data-rolling-average]') : null;
  const rollingAverageCountEl = rollingSummaryEl ? rollingSummaryEl.querySelector('[data-rolling-average-count]') : null;
  const rollingAverageValueEl = rollingSummaryEl ? rollingSummaryEl.querySelector('[data-rolling-average-value]') : null;

  const yearSummaryEl = document.querySelector('[data-year-summary]');
  const yearRealizedEl = yearSummaryEl ? yearSummaryEl.querySelector('[data-year-realized-value]') : null;
  const yearPercentContainer = yearSummaryEl ? yearSummaryEl.querySelector('[data-year-percent]') : null;
  const yearPercentValueEl = yearSummaryEl ? yearSummaryEl.querySelector('[data-year-percent-value]') : null;
  const yearAverageContainer = yearSummaryEl ? yearSummaryEl.querySelector('[data-year-average]') : null;
  const yearAverageCountEl = yearSummaryEl ? yearSummaryEl.querySelector('[data-year-average-count]') : null;
  const yearAverageValueEl = yearSummaryEl ? yearSummaryEl.querySelector('[data-year-average-value]') : null;

  const weekSummaries = new Map();
  document.querySelectorAll('[data-week-summary]').forEach((weekEl) => {
    const key = weekEl.dataset.weekSummary;
    if (!key) {
      return;
    }
    if (!weekStates.has(key)) {
      weekStates.set(key, { included: true });
    }
    const toggle = weekEl.querySelector('[data-week-toggle]');
    if (toggle) {
      toggle.addEventListener('click', () => {
        const state = weekStates.get(key);
        state.included = !state.included;
        updateSummaries();
      });
    }
    weekSummaries.set(key, {
      element: weekEl,
      realizedContainer: weekEl.querySelector('[data-week-realized]'),
      realizedValue: weekEl.querySelector('[data-week-realized-value]'),
      percent: weekEl.querySelector('[data-week-percent]'),
      percentValue: weekEl.querySelector('[data-week-percent-value]'),
      averageContainer: weekEl.querySelector('[data-week-average]'),
      averageCount: weekEl.querySelector('[data-week-average-count]'),
      averageValue: weekEl.querySelector('[data-week-average-value]'),
      toggle,
    });
  });

  const isWeekIncluded = (key) => {
    if (!key) {
      return true;
    }
    const state = weekStates.get(key);
    if (!state) {
      return true;
    }
    return state.included !== false;
  };

  const isDayEffectivelyIncluded = (day) => {
    if (!day) {
      return false;
    }
    if (!day.included) {
      return false;
    }
    return isWeekIncluded(day.weekKey);
  };

  function updateDayVisualState(day) {
    if (!day) {
      return;
    }
    const included = isDayEffectivelyIncluded(day);
    if (day.toggle) {
      setDayToggleState(day.toggle, included);
    }
    const shouldExclude = day.inMonth && !included;
    day.cell.classList.toggle('day-excluded', shouldExclude);
  }

  const yearBaseRealized = parseNumber(yearSummaryEl && yearSummaryEl.dataset.baseRealized);
  const yearBaseTradingDays = parseNumber(yearSummaryEl && yearSummaryEl.dataset.baseTradingDays);
  const yearOtherInvestedMax = parseNumber(yearSummaryEl && yearSummaryEl.dataset.otherInvestedMax);
  const rollingBaseRealized = parseNumber(rollingSummaryEl && rollingSummaryEl.dataset.baseRealized);
  const rollingBaseTradingDays = parseNumber(rollingSummaryEl && rollingSummaryEl.dataset.baseTradingDays);
  const rollingOtherInvestedMax = parseNumber(rollingSummaryEl && rollingSummaryEl.dataset.otherInvestedMax);

  let monthInitialRealized = 0;
  let rollingMonthRealized = 0;
  let monthInitialYearTradingDays = 0;
  let monthInitialRollingTradingDays = 0;

  dayMap.forEach((day) => {
    if (day.inMonth && day.hasValues) {
      monthInitialRealized += day.realized;
      if (day.inRolling) {
        rollingMonthRealized += day.realized;
        monthInitialRollingTradingDays += 1;
      }
      if (day.belongsToYear) {
        monthInitialYearTradingDays += 1;
      }
    }
  });

  const yearOtherRealized = yearBaseRealized - monthInitialRealized;
  const rollingOtherRealized = rollingBaseRealized - rollingMonthRealized;
  const yearOtherTradingDays = Math.max(0, yearBaseTradingDays - monthInitialYearTradingDays);
  const rollingOtherTradingDays = Math.max(0, rollingBaseTradingDays - monthInitialRollingTradingDays);

  function applySignClass(element, value) {
    if (!element) {
      return;
    }
    element.classList.remove('text-profit', 'text-loss', 'text-neutral-200');
    if (value > 0.005) {
      element.classList.add('text-profit');
    } else if (value < -0.005) {
      element.classList.add('text-loss');
    } else {
      element.classList.add('text-neutral-200');
    }
  }

  function applyBackgroundClass(element, value) {
    if (!element) {
      return;
    }
    element.classList.remove('cell-bg-pos', 'cell-bg-neg', 'bg-neutral-900');
    if (value > 0.005) {
      element.classList.add('cell-bg-pos');
    } else if (value < -0.005) {
      element.classList.add('cell-bg-neg');
    } else {
      element.classList.add('bg-neutral-900');
    }
  }

  function updateWeekSummary(key, state) {
    const dom = weekSummaries.get(key);
    if (!dom) {
      return;
    }

    const isIncluded = state.included !== false;
    if (dom.element) {
      dom.element.classList.toggle('week-excluded', !isIncluded);
    }
    if (dom.toggle) {
      setWeekToggleState(dom.toggle, isIncluded);
    }

    const realizedValue = state.hasIncluded && isIncluded ? state.realized : 0;
    if (dom.realizedContainer) {
      const shouldShow = state.hasIncluded && isIncluded && !isApproximatelyZero(realizedValue);
      dom.realizedContainer.classList.toggle('hidden', !shouldShow);
      if (dom.realizedValue) {
        dom.realizedValue.textContent = formatMoney(realizedValue);
      }
      applySignClass(dom.realizedContainer, realizedValue);
      if (dom.percent && dom.percentValue) {
        const percentValue = shouldShow ? calculatePercentageValue(realizedValue, state.investedSamples) : null;
        if (percentValue === null) {
          dom.percent.classList.add('hidden');
          dom.percentValue.textContent = '';
          applySignClass(dom.percentValue, 0);
        } else {
          dom.percent.classList.remove('hidden');
          dom.percentValue.textContent = formatPercentage(percentValue);
          applySignClass(dom.percentValue, percentValue);
        }
      }
    }

    if (dom.averageContainer && dom.averageCount && dom.averageValue) {
      const tradingDays = state.tradingDays && isIncluded ? state.tradingDays : 0;
      if (state.hasIncluded && isIncluded && tradingDays > 0) {
        dom.averageCount.textContent = tradingDays.toString();
        const averageValue = realizedValue / tradingDays;
        dom.averageValue.textContent = formatMoney(averageValue);
        applySignClass(dom.averageValue, averageValue);
        dom.averageContainer.classList.remove('hidden');
      } else {
        dom.averageContainer.classList.add('hidden');
      }
    }

    applyBackgroundClass(dom.element, realizedValue);
  }

  function updateSummaries() {
    let monthRealized = 0;
    const monthInvestedSamples = [];
    const rollingInvestedSamples = [];
    const yearInvestedSamples = [];
    let monthTradingDays = 0;
    let yearRealized = yearOtherRealized;
    let yearTradingDays = yearOtherTradingDays;
    let rollingRealized = rollingOtherRealized;
    let rollingTradingDays = rollingOtherTradingDays;
    let monthWins = 0;
    let monthLosses = 0;
    let yearMonthWins = 0;
    let yearMonthLosses = 0;

    collectInvestedSample(rollingInvestedSamples, rollingOtherInvestedMax);
    collectInvestedSample(yearInvestedSamples, yearOtherInvestedMax);

    dayMap.forEach((day) => {
      const included = isDayEffectivelyIncluded(day);
      updateDayVisualState(day);
      if (!included) {
        return;
      }
      if (day.inMonth && day.hasValues) {
        monthRealized += day.realized;
        collectInvestedSample(monthInvestedSamples, day.invested);
        monthTradingDays += 1;
        if (day.realized > 0.005) {
          monthWins += 1;
        } else if (day.realized < -0.005) {
          monthLosses += 1;
        }
      }
      if (day.inMonth && day.hasValues && day.belongsToYear) {
        yearRealized += day.realized;
        yearTradingDays += 1;
        collectInvestedSample(yearInvestedSamples, day.invested);
        if (day.realized > 0.005) {
          yearMonthWins += 1;
        } else if (day.realized < -0.005) {
          yearMonthLosses += 1;
        }
      }
      if (day.inRolling && day.hasValues) {
        rollingRealized += day.realized;
        collectInvestedSample(rollingInvestedSamples, day.invested);
        if (day.inMonth) {
          rollingTradingDays += 1;
        }
      }
    });

    if (monthRealizedEl) {
      monthRealizedEl.textContent = formatMoney(monthRealized);
      applySignClass(monthRealizedEl, monthRealized);
    }
    if (monthPercentContainer && monthPercentValueEl) {
      const percentValue = calculatePercentageValue(monthRealized, monthInvestedSamples);
      if (percentValue === null) {
        monthPercentContainer.classList.add('hidden');
        monthPercentValueEl.textContent = '';
        applySignClass(monthPercentValueEl, 0);
      } else {
        monthPercentContainer.classList.remove('hidden');
        monthPercentValueEl.textContent = formatPercentage(percentValue);
        applySignClass(monthPercentValueEl, percentValue);
      }
    }
    if (monthAverageContainer && monthAverageCountEl && monthAverageValueEl) {
      if (monthTradingDays > 0) {
        monthAverageCountEl.textContent = monthTradingDays.toString();
        const averageValue = monthRealized / monthTradingDays;
        monthAverageValueEl.textContent = formatMoney(averageValue);
        applySignClass(monthAverageValueEl, averageValue);
        monthAverageContainer.classList.remove('hidden');
      } else {
        monthAverageContainer.classList.add('hidden');
      }
    }

    if (rollingRealizedEl) {
      rollingRealizedEl.textContent = formatMoney(rollingRealized);
      applySignClass(rollingRealizedEl, rollingRealized);
    }
    if (rollingPercentContainer && rollingPercentValueEl) {
      const percentValue = calculatePercentageValue(rollingRealized, rollingInvestedSamples);
      if (percentValue === null) {
        rollingPercentContainer.classList.add('hidden');
        rollingPercentValueEl.textContent = '';
        applySignClass(rollingPercentValueEl, 0);
      } else {
        rollingPercentContainer.classList.remove('hidden');
        rollingPercentValueEl.textContent = formatPercentage(percentValue);
        applySignClass(rollingPercentValueEl, percentValue);
      }
    }
    if (rollingAverageContainer && rollingAverageCountEl && rollingAverageValueEl) {
      if (rollingTradingDays > 0) {
        rollingAverageCountEl.textContent = rollingTradingDays.toString();
        const rollingAverage = rollingRealized / rollingTradingDays;
        rollingAverageValueEl.textContent = formatMoney(rollingAverage);
        applySignClass(rollingAverageValueEl, rollingAverage);
        rollingAverageContainer.classList.remove('hidden');
      } else {
        rollingAverageContainer.classList.add('hidden');
      }
    }

    if (yearRealizedEl) {
      yearRealizedEl.textContent = formatMoney(yearRealized);
      applySignClass(yearRealizedEl, yearRealized);
    }
    if (yearPercentContainer && yearPercentValueEl) {
      const percentValue = calculatePercentageValue(yearRealized, yearInvestedSamples);
      if (percentValue === null) {
        yearPercentContainer.classList.add('hidden');
        yearPercentValueEl.textContent = '';
        applySignClass(yearPercentValueEl, 0);
      } else {
        yearPercentContainer.classList.remove('hidden');
        yearPercentValueEl.textContent = formatPercentage(percentValue);
        applySignClass(yearPercentValueEl, percentValue);
      }
    }
    if (yearAverageContainer && yearAverageCountEl && yearAverageValueEl) {
      if (yearTradingDays > 0) {
        yearAverageCountEl.textContent = yearTradingDays.toString();
        const yearAverage = yearRealized / yearTradingDays;
        yearAverageValueEl.textContent = formatMoney(yearAverage);
        applySignClass(yearAverageValueEl, yearAverage);
        yearAverageContainer.classList.remove('hidden');
      } else {
        yearAverageContainer.classList.add('hidden');
      }
    }

    if (winRatioController) {
      winRatioController.updateFromCounts(monthWins, monthLosses, yearMonthWins, yearMonthLosses);
    }
    applyWinRatioCountUpdates(monthWins, monthLosses, yearMonthWins, yearMonthLosses);

    weekStructure.forEach((entries, key) => {
      const weekIncluded = isWeekIncluded(key);
      const state = {
        realized: 0,
        investedSamples: [],
        hasIncluded: false,
        included: weekIncluded,
        tradingDays: 0,
      };

      if (weekIncluded) {
        entries.forEach((entry) => {
          const day = dayMap.get(entry.date);
          if (!day || !day.inMonth || !isDayEffectivelyIncluded(day)) {
            return;
          }
          if (day.hasValues) {
            state.realized += day.realized;
            collectInvestedSample(state.investedSamples, day.invested);
            state.tradingDays += 1;
          }
          state.hasIncluded = true;
        });
      }

      updateWeekSummary(key, state);
    });
  }

  updateSummaries();

  return {
    update: updateSummaries,
  };
})();

function openTrades(dateStr) {
  fetch('/api/trades/' + dateStr)
    .then(response => {
      if (!response.ok) {
        return response.json().catch(() => ({})).then(data => {
          const message = data && data.detail ? data.detail : 'Failed to load trades.';
          throw new Error(message);
        });
      }
      return response.json();
    })
    .then(js => {
      const modal = getModalController();
      if (!modal) return;
      modal.title = 'Trades ' + dateStr;
      modal.body = createTradeEditorHTML();
      modal.save = () => saveTrades(dateStr);
      modal.open = true;
      setTimeout(() => setupTradeEditor(js.trades || [], dateStr), 0);
    })
    .catch(err => {
      const modal = getModalController();
      if (!modal) return;
      modal.title = 'Trades ' + dateStr;
      modal.body = `<p class="text-sm text-danger">${err.message || 'Failed to load trades.'}</p>`;
      modal.save = null;
      modal.open = true;
    });
}

function createTradeEditorHTML() {
  return `
    <div id="trade-editor" class="space-y-3">
      <p id="trade-error" class="text-sm text-danger hidden"></p>
      <p id="trade-success" class="text-sm text-success hidden"></p>
      <p id="trade-unsaved" class="text-xs text-warning hidden">Unsaved changes. Save your trades to keep them.</p>
      <div id="trade-empty-message" class="text-sm text-neutral-400 hidden">No trades recorded for this date.</div>
      <div class="overflow-x-auto" style="max-height: 20rem; overflow-y: auto;">
        <table class="min-w-full text-sm text-left text-neutral-200 border border-neutral-800">
          <thead class="bg-neutral-900 text-neutral-400">
            <tr>
              <th class="px-2 py-1 border border-neutral-800 text-center">Order</th>
              <th class="px-2 py-1 border border-neutral-800">Action</th>
              <th class="px-2 py-1 border border-neutral-800">Symbol</th>
              <th class="px-2 py-1 border border-neutral-800 text-right">Quantity</th>
              <th class="px-2 py-1 border border-neutral-800 text-right">Price</th>
              <th class="px-2 py-1 border border-neutral-800 text-center">Time</th>
              <th class="px-2 py-1 border border-neutral-800 text-right">Fee</th>
              <th class="px-2 py-1 border border-neutral-800 text-center">Note</th>
              <th class="px-2 py-1 border border-neutral-800 text-right">Remove</th>
            </tr>
          </thead>
          <tbody id="trade-table-body"></tbody>
        </table>
      </div>
      <div class="space-y-2">
        <div class="flex items-center justify-between flex-wrap gap-2">
          <div class="flex items-center gap-2 flex-wrap">
            <button type="button" id="add-trade-row" class="px-3 py-1 rounded border border-neutral-700 hover:bg-neutral-800 text-sm">Add trade</button>
            <button type="button" id="clear-trades" class="btn btn-outline-danger px-3 py-1 text-sm">Clear all trades</button>
          </div>
          <div class="flex items-center gap-2 flex-wrap">
            <input type="file" id="trade-import-input" accept=".csv,text/csv" class="hidden">
            <button type="button" id="export-trades" class="px-3 py-1 rounded border border-neutral-700 hover:bg-neutral-800 text-sm">Export CSV</button>
            <button type="button" id="import-trades" class="btn btn-outline-primary px-3 py-1 text-sm">Import CSV</button>
          </div>
        </div>
        <span class="text-xs text-neutral-500">Remove a row to delete a trade. Amounts are calculated on save.</span>
      </div>
    </div>`;
}

function createTableDragManager(tbody, options = {}) {
  if (!tbody) {
    return { registerRow: () => {} };
  }

  const handleSelector = options.handleSelector || '.drag-handle';
  const onReorder = typeof options.onReorder === 'function' ? options.onReorder : () => {};
  const state = {
    dragging: null,
    moved: false,
  };

  function getDragAfterElement(container, y) {
    const rows = Array.from(container.querySelectorAll('tr:not(.is-dragging)'));
    let closest = { offset: Number.NEGATIVE_INFINITY, element: null };
    rows.forEach((child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      if (offset < 0 && offset > closest.offset) {
        closest = { offset, element: child };
      }
    });
    return closest.element;
  }

  function handleDragOver(event) {
    if (!state.dragging) {
      return;
    }
    event.preventDefault();
    const afterElement = getDragAfterElement(tbody, event.clientY);
    const dragging = state.dragging;
    if (!dragging) {
      return;
    }
    if (afterElement === null) {
      if (tbody.lastElementChild !== dragging) {
        tbody.appendChild(dragging);
        state.moved = true;
      }
    } else if (afterElement !== dragging) {
      tbody.insertBefore(dragging, afterElement);
      state.moved = true;
    }
  }

  tbody.addEventListener('dragover', handleDragOver);
  tbody.addEventListener('drop', (event) => {
    if (!state.dragging) {
      return;
    }
    event.preventDefault();
    handleDragOver(event);
  });

  function registerRow(row) {
    if (!row) {
      return;
    }
    row.setAttribute('draggable', 'true');
    row.addEventListener('dragstart', (event) => {
      if (!event.target || !event.target.closest(handleSelector)) {
        event.preventDefault();
        row.setAttribute('draggable', 'false');
        window.setTimeout(() => row.setAttribute('draggable', 'true'), 0);
        return;
      }
      state.dragging = row;
      state.moved = false;
      row.classList.add('is-dragging');
      try {
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', '');
      } catch (error) {
        // Ignore browsers that block dataTransfer modification
      }
    });
    row.addEventListener('dragend', () => {
      row.classList.remove('is-dragging');
      const moved = state.moved;
      state.dragging = null;
      state.moved = false;
      if (moved) {
        onReorder();
      }
    });
  }

  return {
    registerRow,
  };
}

const tradeEditorState = {
  initialSnapshot: '[]',
  isDirty: false,
  unsavedWarning: null,
  currentDate: null,
  dragManager: null,
};

function getTradeEditorWarningElement() {
  if (tradeEditorState.unsavedWarning && document.body && document.body.contains(tradeEditorState.unsavedWarning)) {
    return tradeEditorState.unsavedWarning;
  }
  const element = document.getElementById('trade-unsaved');
  tradeEditorState.unsavedWarning = element || null;
  return tradeEditorState.unsavedWarning;
}

function setTradeEditorDirty(isDirty) {
  tradeEditorState.isDirty = !!isDirty;
  const warning = getTradeEditorWarningElement();
  if (warning) {
    warning.classList.toggle('hidden', !tradeEditorState.isDirty);
  }
}

function captureTradeEditorSnapshot() {
  const tbody = document.getElementById('trade-table-body');
  if (!tbody) {
    return '[]';
  }
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const normalized = rows.map((row) => {
    const actionSelect = row.querySelector('.trade-action');
    const symbolInput = row.querySelector('.trade-symbol');
    const qtyInput = row.querySelector('.trade-qty');
    const priceInput = row.querySelector('.trade-price');
    const timeInput = row.querySelector('.trade-time');
    const feeInput = row.querySelector('.trade-fee');
    return {
      id: row.dataset.tradeId ? String(row.dataset.tradeId) : '',
      action: actionSelect ? actionSelect.value : '',
      symbol: symbolInput ? symbolInput.value : '',
      qty: qtyInput ? qtyInput.value : '',
      price: priceInput ? priceInput.value : '',
      time: timeInput ? timeInput.value : '',
      fee: feeInput ? feeInput.value : '',
    };
  });
  return JSON.stringify(normalized);
}

function refreshTradeEditorDirtyState() {
  const snapshot = captureTradeEditorSnapshot();
  const isDirty = snapshot !== tradeEditorState.initialSnapshot;
  setTradeEditorDirty(isDirty);
  return isDirty;
}

function resetTradeEditorInitialSnapshot() {
  tradeEditorState.initialSnapshot = captureTradeEditorSnapshot();
  setTradeEditorDirty(false);
}

function focusTradeEditorFirstField() {
  const editor = document.getElementById('trade-editor');
  if (!editor) {
    return;
  }
  const field = editor.querySelector('.trade-symbol, .trade-qty, .trade-price, .trade-action');
  if (field && typeof field.focus === 'function') {
    try {
      field.focus({ preventScroll: true });
    } catch (error) {
      field.focus();
    }
  }
}

function setupTradeEditor(trades, dateStr, options = {}) {
  clearTradeEditorMessages();
  const tbody = document.getElementById('trade-table-body');
  if (!tbody) return;

  tbody.innerHTML = '';
  tradeEditorState.dragManager = createTableDragManager(tbody, {
    handleSelector: '.trade-drag-handle',
    onReorder: () => {
      hideTradeEditorSuccess();
      refreshTradeEditorDirtyState();
    },
  });

  (trades || []).forEach(trade => {
    tbody.appendChild(createTradeRow(trade, dateStr, tradeEditorState.dragManager));
  });

  const addButton = document.getElementById('add-trade-row');
  if (addButton) {
    addButton.onclick = () => {
      hideTradeEditorSuccess();
      tbody.appendChild(
        createTradeRow(
          { action: 'BUY', symbol: '', qty: '', price: '', time: '', fee: '' },
          dateStr,
          tradeEditorState.dragManager,
        ),
      );
      updateTradeEmptyState();
      refreshTradeEditorDirtyState();
    };
  }

  const clearButton = document.getElementById('clear-trades');
  if (clearButton) {
    clearButton.onclick = () => {
      hideTradeEditorSuccess();
      clearTrades(dateStr);
    };
  }

  const importInput = document.getElementById('trade-import-input');
  const importButton = document.getElementById('import-trades');
  if (importButton && importInput) {
    importButton.onclick = () => {
      importInput.click();
    };
  }
  if (importInput) {
    importInput.onchange = (event) => handleTradeCsvImport(event, dateStr);
  }

  const exportButton = document.getElementById('export-trades');
  if (exportButton) {
    exportButton.onclick = () => exportTradesToCsv(dateStr);
  }

  updateTradeEmptyState();

  tradeEditorState.unsavedWarning = document.getElementById('trade-unsaved');
  tradeEditorState.currentDate = dateStr;
  if (options && typeof options.initialSnapshotOverride === 'string') {
    tradeEditorState.initialSnapshot = options.initialSnapshotOverride;
    refreshTradeEditorDirtyState();
  } else {
    resetTradeEditorInitialSnapshot();
  }

  const modal = getModalController();
  if (modal) {
    modal.beforeClose = () => {
      const dirty = refreshTradeEditorDirtyState();
      if (!dirty) {
        return true;
      }
      const confirmClose = window.confirm('You have unsaved changes to these trades. Discard them?');
      if (!confirmClose) {
        focusTradeEditorFirstField();
        return false;
      }
      return true;
    };
  }
}

function createTradeRow(trade, dateStr, dragManager) {
  const row = document.createElement('tr');
  row.className = 'border-b border-neutral-800';
  if (trade && trade.id !== undefined && trade.id !== null) {
    row.dataset.tradeId = String(trade.id);
  }
  if (trade && trade.sequence !== undefined && trade.sequence !== null) {
    row.dataset.tradeSequence = String(trade.sequence);
  }

  const markDirty = () => {
    hideTradeEditorSuccess();
    refreshTradeEditorDirtyState();
  };

  const orderCell = document.createElement('td');
  orderCell.className = 'px-2 py-1 border border-neutral-800 text-center align-middle';
  const handleButton = document.createElement('button');
  handleButton.type = 'button';
  handleButton.className = 'trade-drag-handle drag-handle inline-flex h-6 w-6 items-center justify-center rounded border border-neutral-700 bg-neutral-900 text-xs text-neutral-300 transition hover:bg-neutral-800 focus:outline-none focus:ring-1 focus:ring-neutral-600';
  handleButton.innerHTML = '<span aria-hidden="true">☰</span><span class="sr-only">Drag to reorder</span>';
  orderCell.appendChild(handleButton);
  row.appendChild(orderCell);

  const actionCell = document.createElement('td');
  actionCell.className = 'px-2 py-1 border border-neutral-800';
  const actionSelect = document.createElement('select');
  actionSelect.className = 'trade-action bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-neutral-100';
  ['BUY', 'SELL'].forEach(optionValue => {
    const option = document.createElement('option');
    option.value = optionValue;
    option.textContent = optionValue;
    actionSelect.appendChild(option);
  });
  const actionValue = trade && trade.action ? String(trade.action).toUpperCase() : 'BUY';
  actionSelect.value = actionValue;
  actionSelect.addEventListener('change', markDirty);
  actionCell.appendChild(actionSelect);
  row.appendChild(actionCell);

  const symbolCell = document.createElement('td');
  symbolCell.className = 'px-2 py-1 border border-neutral-800';
  const symbolInput = document.createElement('input');
  symbolInput.type = 'text';
  symbolInput.className = 'trade-symbol w-full bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-neutral-100 uppercase';
  symbolInput.value = trade && trade.symbol ? trade.symbol : '';
  symbolInput.autocomplete = 'off';
  symbolInput.spellcheck = false;
  symbolInput.addEventListener('input', markDirty);
  symbolCell.appendChild(symbolInput);
  row.appendChild(symbolCell);

  const qtyCell = document.createElement('td');
  qtyCell.className = 'px-2 py-1 border border-neutral-800 text-right';
  const qtyInput = document.createElement('input');
  qtyInput.type = 'number';
  qtyInput.step = '1';
  qtyInput.min = '0';
  qtyInput.inputMode = 'decimal';
  qtyInput.className = 'trade-qty w-full min-w-[6rem] bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-neutral-100 text-right';
  qtyInput.value = trade && trade.qty !== undefined && trade.qty !== null ? trade.qty : '';
  qtyInput.addEventListener('input', markDirty);
  qtyCell.appendChild(qtyInput);
  row.appendChild(qtyCell);

  const priceCell = document.createElement('td');
  priceCell.className = 'px-2 py-1 border border-neutral-800 text-right';
  const priceInput = document.createElement('input');
  priceInput.type = 'number';
  priceInput.step = '0.01';
  priceInput.min = '0';
  priceInput.inputMode = 'decimal';
  priceInput.className = 'trade-price w-full min-w-[6rem] bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-neutral-100 text-right';
  priceInput.value = trade && trade.price !== undefined && trade.price !== null ? trade.price : '';
  priceInput.addEventListener('input', markDirty);
  priceCell.appendChild(priceInput);
  row.appendChild(priceCell);

  const timeCell = document.createElement('td');
  timeCell.className = 'px-2 py-1 border border-neutral-800 text-center';
  const timeInput = document.createElement('input');
  timeInput.type = 'time';
  timeInput.step = '1';
  timeInput.className = 'trade-time w-full bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-neutral-100 text-center';
  timeInput.value = trade && trade.time ? trade.time : '';
  timeInput.addEventListener('change', markDirty);
  timeInput.addEventListener('input', markDirty);
  timeCell.appendChild(timeInput);
  row.appendChild(timeCell);

  const feeCell = document.createElement('td');
  feeCell.className = 'px-2 py-1 border border-neutral-800 text-right';
  const feeInput = document.createElement('input');
  feeInput.type = 'number';
  feeInput.min = '0';
  feeInput.step = '0.01';
  feeInput.className = 'trade-fee w-full min-w-[6rem] bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-neutral-100 text-right';
  if (trade && trade.fee !== undefined && trade.fee !== null) {
    const feeNumber = Number(trade.fee);
    if (Number.isFinite(feeNumber)) {
      feeInput.value = feeNumber === 0 ? '' : String(feeNumber);
    }
  }
  feeInput.addEventListener('input', markDirty);
  feeCell.appendChild(feeInput);
  row.appendChild(feeCell);

  const noteCell = document.createElement('td');
  noteCell.className = 'px-2 py-1 border border-neutral-800 text-center';
  const noteButton = document.createElement('button');
  noteButton.type = 'button';
  noteButton.className = 'btn btn-outline-primary px-2 py-1 text-xs';
  noteButton.textContent = 'Note';
  noteButton.addEventListener('click', () => {
    const targetDate = dateStr || tradeEditorState.currentDate;
    if (!targetDate) {
      return;
    }
    openTradeNoteEditor(targetDate, actionSelect, qtyInput, priceInput);
  });
  noteCell.appendChild(noteButton);
  row.appendChild(noteCell);

  const actionsCell = document.createElement('td');
  actionsCell.className = 'px-2 py-1 border border-neutral-800 text-right';
  const removeButton = document.createElement('button');
  removeButton.type = 'button';
  removeButton.className = 'remove-trade-row btn btn-outline-danger px-2 py-1 text-xs';
  removeButton.textContent = 'Remove';
  removeButton.addEventListener('click', () => {
    hideTradeEditorSuccess();
    row.remove();
    updateTradeEmptyState();
    refreshTradeEditorDirtyState();
  });
  actionsCell.appendChild(removeButton);
  row.appendChild(actionsCell);

  if (dragManager && typeof dragManager.registerRow === 'function') {
    dragManager.registerRow(row);
  }

  return row;
}

function formatTradeNotePrefix(action, qty, price) {
  const normalizedAction = (action || 'BUY').toString().trim().toUpperCase() || 'BUY';
  const qtyNumber = Number(qty);
  let qtyText;
  if (Number.isFinite(qtyNumber)) {
    qtyText = Math.abs(qtyNumber - Math.round(qtyNumber)) < 1e-9
      ? String(Math.round(qtyNumber))
      : qtyNumber.toString();
  } else {
    const rawQty = typeof qty === 'string' ? qty.trim() : '';
    qtyText = rawQty || '?';
  }

  const priceNumber = Number(price);
  let priceText;
  if (Number.isFinite(priceNumber)) {
    priceText = priceNumber.toFixed(2);
  } else {
    const rawPrice = typeof price === 'string' ? price.trim() : '';
    priceText = rawPrice && /\d/.test(rawPrice) ? rawPrice : '0.00';
  }

  return `[ ${normalizedAction} - ${qtyText} x $${priceText} ]`;
}

function captureTradeEditorStateForRestore() {
  const dateStr = tradeEditorState.currentDate;
  if (!dateStr) {
    return null;
  }
  const snapshot = captureTradeEditorSnapshot();
  let rows = [];
  try {
    const parsed = JSON.parse(snapshot);
    if (Array.isArray(parsed)) {
      rows = parsed;
    }
  } catch (error) {
    rows = [];
  }
  const scrollContainer = document.querySelector('#trade-editor .overflow-x-auto');
  return {
    dateStr,
    rows,
    initialSnapshot: typeof tradeEditorState.initialSnapshot === 'string'
      ? tradeEditorState.initialSnapshot
      : null,
    scrollTop: scrollContainer ? scrollContainer.scrollTop : 0,
  };
}

function restoreTradeEditorState(state) {
  if (!state || !state.dateStr) {
    return;
  }

  const modal = getModalController();
  if (!modal) {
    return;
  }

  modal.title = 'Trades ' + state.dateStr;
  modal.body = createTradeEditorHTML();
  modal.save = () => saveTrades(state.dateStr);
  modal.open = true;

  const rows = Array.isArray(state.rows) ? state.rows : [];
  const normalizedRows = rows.map((row) => ({
    id: row && row.id !== undefined && row.id !== null ? row.id : undefined,
    action: row && row.action ? row.action : 'BUY',
    symbol: row && row.symbol ? row.symbol : '',
    qty: row && row.qty !== undefined ? row.qty : '',
    price: row && row.price !== undefined ? row.price : '',
    time: row && row.time !== undefined ? row.time : '',
    fee: row && row.fee !== undefined ? row.fee : '',
  }));

  const overrideSnapshot = typeof state.initialSnapshot === 'string' ? state.initialSnapshot : undefined;

  window.setTimeout(() => {
    setupTradeEditor(normalizedRows, state.dateStr, {
      initialSnapshotOverride: overrideSnapshot,
    });
    if (typeof state.scrollTop === 'number') {
      const container = document.querySelector('#trade-editor .overflow-x-auto');
      if (container) {
        container.scrollTop = state.scrollTop;
      }
    }
  }, 0);
}

function openTradeNoteEditor(dateStr, actionSelect, qtyInput, priceInput) {
  const actionValue = actionSelect && actionSelect.value ? actionSelect.value : 'BUY';
  const qtyValue = qtyInput && qtyInput.value !== undefined ? qtyInput.value : '';
  const priceValue = priceInput && priceInput.value !== undefined ? priceInput.value : '';
  const prefix = formatTradeNotePrefix(actionValue, qtyValue, priceValue);
  const tradeState = captureTradeEditorStateForRestore();

  const prepareNote = (existingNote) => {
    const normalized = typeof existingNote === 'string' ? existingNote.replace(/\r\n/g, '\n') : '';
    const entry = `${prefix} `;
    if (!normalized) {
      return {
        text: entry,
        selectionStart: entry.length,
        selectionEnd: entry.length,
        scrollToSelection: true,
      };
    }

    const existingIndex = normalized.indexOf(entry);
    if (existingIndex !== -1) {
      const caret = existingIndex + entry.length;
      return {
        text: normalized,
        selectionStart: caret,
        selectionEnd: caret,
      };
    }

    const trimmed = normalized.trimEnd();
    const base = trimmed ? `${trimmed}\n\n` : '';
    const text = `${base}${entry}`;
    return {
      text,
      selectionStart: text.length,
      selectionEnd: text.length,
      scrollToSelection: true,
    };
  };

  openDailyNote(dateStr, {
    prepareNote,
    onSave: () => {
      if (tradeState) {
        window.setTimeout(() => restoreTradeEditorState(tradeState), 0);
      } else {
        window.setTimeout(() => openTrades(dateStr), 0);
      }
    },
  });
}

function updateTradeEmptyState() {
  const tbody = document.getElementById('trade-table-body');
  const message = document.getElementById('trade-empty-message');
  if (!tbody || !message) return;
  if (tbody.children.length === 0) {
    message.classList.remove('hidden');
  } else {
    message.classList.add('hidden');
  }
}

function clearTradeEditorMessages() {
  const errorEl = document.getElementById('trade-error');
  if (errorEl) {
    errorEl.textContent = '';
    errorEl.classList.add('hidden');
  }
  hideTradeEditorSuccess();
}

function hideTradeEditorSuccess() {
  const successEl = document.getElementById('trade-success');
  if (successEl) {
    successEl.textContent = '';
    successEl.classList.add('hidden');
  }
}

function showTradeEditorError(message) {
  hideTradeEditorSuccess();
  const errorEl = document.getElementById('trade-error');
  if (errorEl) {
    errorEl.textContent = message;
    errorEl.classList.remove('hidden');
  }
}

function showTradeEditorSuccess(message) {
  const errorEl = document.getElementById('trade-error');
  if (errorEl) {
    errorEl.textContent = '';
    errorEl.classList.add('hidden');
  }
  const successEl = document.getElementById('trade-success');
  if (successEl) {
    successEl.textContent = message;
    successEl.classList.remove('hidden');
  }
}

function parseCsv(text) {
  if (typeof text !== 'string') {
    return [];
  }

  const rows = [];
  let current = '';
  let row = [];
  let inQuotes = false;

  for (let i = 0; i < text.length; i += 1) {
    const char = text[i];
    if (inQuotes) {
      if (char === '"') {
        if (text[i + 1] === '"') {
          current += '"';
          i += 1;
        } else {
          inQuotes = false;
        }
      } else {
        current += char;
      }
    } else if (char === '"') {
      inQuotes = true;
    } else if (char === ',') {
      row.push(current);
      current = '';
    } else if (char === '\r') {
      // Ignore carriage returns
    } else if (char === '\n') {
      row.push(current);
      rows.push(row);
      row = [];
      current = '';
    } else {
      current += char;
    }
  }

  row.push(current);
  rows.push(row);

  return rows.filter((cells) => cells.some((cell) => cell.trim() !== ''));
}

function normalizeNumberString(value) {
  if (typeof value !== 'string') {
    return '';
  }
  return value.replace(/[^0-9.\-]/g, '');
}

function normalizeTradeTime(value) {
  if (typeof value !== 'string') {
    return '';
  }
  const trimmed = value.trim();
  if (!trimmed) {
    return '';
  }
  const match = trimmed.match(/^(\d{1,2})(?::(\d{1,2}))?(?::(\d{1,2}))?$/);
  if (!match) {
    return '';
  }
  const hour = Number(match[1]);
  const minute = match[2] !== undefined ? Number(match[2]) : 0;
  const second = match[3] !== undefined ? Number(match[3]) : null;
  if (!Number.isInteger(hour) || hour < 0 || hour > 23) {
    return '';
  }
  if (!Number.isInteger(minute) || minute < 0 || minute > 59) {
    return '';
  }
  if (second !== null) {
    if (!Number.isInteger(second) || second < 0 || second > 59) {
      return '';
    }
    return `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}:${String(second).padStart(2, '0')}`;
  }
  return `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
}

function parseTradeCsv(text) {
  const rows = parseCsv(text);
  if (!rows.length) {
    throw new Error('The CSV file is empty.');
  }

  const headerAliases = {
    action: ['action', 'type', 'side'],
    symbol: ['symbol', 'ticker', 'security'],
    qty: ['qty', 'quantity', 'shares', 'volume'],
    price: ['price', 'fill price', 'trade price', 'avg price'],
    time: ['time', 'trade time', 'execution time', 'filled at', 'fill time'],
    fee: ['fee', 'fees', 'commission', 'commissions'],
  };

  const normalizedHeader = rows[0].map((cell) => cell.trim().toLowerCase());
  const columnIndex = {};

  normalizedHeader.forEach((header, index) => {
    Object.entries(headerAliases).forEach(([key, aliases]) => {
      if (columnIndex[key] !== undefined) {
        return;
      }
      if (aliases.includes(header)) {
        columnIndex[key] = index;
      }
    });
  });

  const requiredKeys = ['action', 'symbol', 'qty', 'price'];
  const hasHeader = requiredKeys.every((key) => columnIndex[key] !== undefined);

  if (!hasHeader) {
    if (rows[0].length < requiredKeys.length) {
      throw new Error('CSV rows must include action, symbol, quantity, and price columns.');
    }
    columnIndex.action = 0;
    columnIndex.symbol = 1;
    columnIndex.qty = 2;
    columnIndex.price = 3;
  }

  const dataRows = hasHeader ? rows.slice(1) : rows;

  const trades = [];
  const errors = [];

  dataRows.forEach((cells, rowIndex) => {
    const values = {
      action: columnIndex.action < cells.length ? cells[columnIndex.action] : '',
      symbol: columnIndex.symbol < cells.length ? cells[columnIndex.symbol] : '',
      qty: columnIndex.qty < cells.length ? cells[columnIndex.qty] : '',
      price: columnIndex.price < cells.length ? cells[columnIndex.price] : '',
      time:
        columnIndex.time !== undefined && columnIndex.time < cells.length
          ? cells[columnIndex.time]
          : '',
      fee:
        columnIndex.fee !== undefined && columnIndex.fee < cells.length
          ? cells[columnIndex.fee]
          : '',
    };

    const trimmed = {
      action: (values.action || '').trim(),
      symbol: (values.symbol || '').trim(),
      qty: (values.qty || '').trim(),
      price: (values.price || '').trim(),
      time: (values.time || '').trim(),
      fee: (values.fee || '').trim(),
    };

    if (!trimmed.action && !trimmed.symbol && !trimmed.qty && !trimmed.price && !trimmed.time && !trimmed.fee) {
      return;
    }

    const rowNumber = hasHeader ? rowIndex + 2 : rowIndex + 1;

    if (!trimmed.symbol) {
      errors.push(`Row ${rowNumber}: Symbol is required.`);
      return;
    }

    if (!trimmed.action) {
      errors.push(`Row ${rowNumber}: Action is required.`);
      return;
    }

    const normalizedAction = trimmed.action.toUpperCase();
    if (normalizedAction !== 'BUY' && normalizedAction !== 'SELL') {
      errors.push(`Row ${rowNumber}: Action must be BUY or SELL.`);
      return;
    }

    if (!trimmed.qty) {
      errors.push(`Row ${rowNumber}: Quantity is required.`);
      return;
    }

    if (!trimmed.price) {
      errors.push(`Row ${rowNumber}: Price is required.`);
      return;
    }

    const qtyValue = parseFloat(normalizeNumberString(trimmed.qty));
    const priceValue = parseFloat(normalizeNumberString(trimmed.price));
    const timeValue = trimmed.time ? normalizeTradeTime(trimmed.time) : '';
    if (trimmed.time && !timeValue) {
      errors.push(`Row ${rowNumber}: Time must be in HH:MM or HH:MM:SS format.`);
      return;
    }
    let feeValue = 0;
    if (trimmed.fee) {
      feeValue = parseFloat(normalizeNumberString(trimmed.fee));
    }

    if (!Number.isFinite(qtyValue) || qtyValue <= 0) {
      errors.push(`Row ${rowNumber}: Quantity must be a positive number.`);
      return;
    }

    if (!Number.isFinite(priceValue) || priceValue <= 0) {
      errors.push(`Row ${rowNumber}: Price must be a positive number.`);
      return;
    }

    if (trimmed.fee && (!Number.isFinite(feeValue) || feeValue < 0)) {
      errors.push(`Row ${rowNumber}: Fee must be zero or a positive number.`);
      return;
    }

    trades.push({
      action: normalizedAction,
      symbol: trimmed.symbol.toUpperCase(),
      qty: Math.abs(qtyValue),
      price: Math.abs(priceValue),
      time: timeValue,
      fee: trimmed.fee ? Math.abs(feeValue) : 0,
    });
  });

  if (errors.length) {
    throw new Error(errors.join(' '));
  }

  if (!trades.length) {
    throw new Error('No trades were found in the CSV file.');
  }

  return trades;
}

function applyImportedTrades(trades, dateStr) {
  const tbody = document.getElementById('trade-table-body');
  if (!tbody) {
    return;
  }

  tbody.innerHTML = '';
  trades.forEach((trade, index) => {
    tbody.appendChild(
      createTradeRow({
        action: trade.action,
        symbol: trade.symbol,
        qty: trade.qty,
        price: trade.price,
        time: trade.time || '',
        fee: trade.fee !== undefined ? trade.fee : '',
        sequence: index,
      }, dateStr)
    );
  });

  updateTradeEmptyState();
  refreshTradeEditorDirtyState();
  focusTradeEditorFirstField();
}

function handleTradeCsvImport(event, dateStr) {
  const input = event && event.target ? event.target : null;
  const files = input && input.files ? Array.from(input.files) : [];
  const file = files.length ? files[0] : null;

  if (!file) {
    return;
  }

  clearTradeEditorMessages();

  const reader = new FileReader();
  reader.onload = () => {
    try {
      const text = typeof reader.result === 'string' ? reader.result : '';
      const trades = parseTradeCsv(text);
      applyImportedTrades(trades, dateStr);
      const dateLabel = dateStr || 'this date';
      showTradeEditorSuccess(
        `${trades.length} trade${trades.length === 1 ? '' : 's'} imported. Save to overwrite existing trades for ${dateLabel}.`,
      );
    } catch (error) {
      showTradeEditorError(error && error.message ? error.message : 'Unable to import trades from CSV.');
    } finally {
      input.value = '';
    }
  };
  reader.onerror = () => {
    showTradeEditorError('Failed to read the CSV file. Please try again.');
    input.value = '';
  };
  reader.readAsText(file);
}

function escapeCsvValue(value) {
  const stringValue = value === undefined || value === null ? '' : String(value);
  if (/[",\n\r]/.test(stringValue)) {
    return '"' + stringValue.replace(/"/g, '""') + '"';
  }
  return stringValue;
}

function exportTradesToCsv(dateStr) {
  clearTradeEditorMessages();

  let parsed;
  try {
    parsed = JSON.parse(captureTradeEditorSnapshot());
  } catch (error) {
    showTradeEditorError('Unable to export trades. Try again after making a change.');
    return;
  }

  if (!Array.isArray(parsed)) {
    showTradeEditorError('Unable to export trades.');
    return;
  }

  const rows = [];
  let hasIncomplete = false;

  parsed.forEach((row) => {
    const action = (row.action || 'BUY').toString().toUpperCase();
    const symbol = (row.symbol || '').trim();
    const qty = (row.qty || '').toString().trim();
    const price = (row.price || '').toString().trim();
    const time = (row.time || '').toString().trim();
    const fee = (row.fee || '').toString().trim();
    const hasAny = symbol || qty || price || time || fee;
    if (!hasAny) {
      return;
    }
    if (!symbol || !qty || !price) {
      hasIncomplete = true;
      return;
    }

    rows.push([
      action === 'SELL' ? 'SELL' : 'BUY',
      symbol.toUpperCase(),
      qty,
      price,
      time,
      fee || '0',
    ]);
  });

  if (hasIncomplete) {
    showTradeEditorError('Cannot export CSV because some trades are incomplete. Complete or remove them and try again.');
    return;
  }

  if (!rows.length) {
    showTradeEditorError('No trades are available to export. Add trades first.');
    return;
  }

  const csvRows = [
    ['Action', 'Symbol', 'Quantity', 'Price', 'Time', 'Fee'],
    ...rows,
  ];

  const csvContent = csvRows.map((cells) => cells.map(escapeCsvValue).join(',')).join('\r\n');
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const downloadName = `trades-${(dateStr || 'day').replace(/[^0-9A-Za-z_-]/g, '') || 'day'}.csv`;

  const link = document.createElement('a');
  link.href = url;
  link.download = downloadName;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  setTimeout(() => URL.revokeObjectURL(url), 0);

  showTradeEditorSuccess('CSV downloaded.');
}

function saveTrades(dateStr) {
  const modal = getModalController();
  if (!modal) return;
  const tbody = document.getElementById('trade-table-body');
  if (!tbody) return;

  clearTradeEditorMessages();

  const rows = Array.from(tbody.querySelectorAll('tr'));
  const trades = [];
  let hasError = false;

  rows.forEach((row, index) => {
    const actionSelect = row.querySelector('.trade-action');
    const symbolInput = row.querySelector('.trade-symbol');
    const qtyInput = row.querySelector('.trade-qty');
    const priceInput = row.querySelector('.trade-price');
    const timeInput = row.querySelector('.trade-time');
    const feeInput = row.querySelector('.trade-fee');

    const symbol = symbolInput ? symbolInput.value.trim() : '';
    const qtyRaw = qtyInput ? qtyInput.value.trim() : '';
    const priceRaw = priceInput ? priceInput.value.trim() : '';
    const timeRaw = timeInput ? timeInput.value.trim() : '';
    const feeRaw = feeInput ? feeInput.value.trim() : '';
    const isEmpty = !symbol && !qtyRaw && !priceRaw && !timeRaw && !feeRaw;

    if (isEmpty) {
      row.classList.remove('bg-danger-soft');
      return;
    }

    const qty = parseFloat(qtyRaw);
    const price = parseFloat(priceRaw);
    let fee = 0;
    if (feeRaw) {
      fee = parseFloat(feeRaw);
    }
    if (!symbol || Number.isNaN(qty) || Number.isNaN(price) || qty <= 0 || price <= 0 || (feeRaw && (Number.isNaN(fee) || fee < 0))) {
      row.classList.add('bg-danger-soft');
      hasError = true;
      return;
    }

    row.classList.remove('bg-danger-soft');
    trades.push({
      id: row.dataset.tradeId ? Number(row.dataset.tradeId) : null,
      symbol: symbol.toUpperCase(),
      action: actionSelect ? actionSelect.value : 'BUY',
      qty: Math.abs(qty),
      price: Math.abs(price),
      time: timeRaw || null,
      fee: feeRaw ? Math.abs(fee) : 0,
      sequence: index,
    });
  });

  if (hasError) {
    showTradeEditorError('Please complete all fields for each trade or remove unused rows.');
    return;
  }

  modal.saving = true;

  fetch('/api/trades/' + dateStr, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ trades }),
  })
    .then(response => {
      if (!response.ok) {
        return response.json().catch(() => ({})).then(data => {
          const message = data && data.detail ? data.detail : 'Failed to save trades.';
          throw new Error(message);
        });
      }
      return response.json();
    })
    .then(data => {
      const savedTrades = data && Array.isArray(data.trades) ? data.trades : [];
      setupTradeEditor(savedTrades, dateStr);
      showTradeEditorSuccess('Trades saved. You can continue adding stocks.');
      modal.shouldReloadOnClose = true;
      updateTradeIndicators(dateStr, savedTrades);
    })
    .catch(err => {
      showTradeEditorError(err.message || 'Failed to save trades.');
    })
    .finally(() => {
      modal.saving = false;
    });
}

function clearTrades(dateStr) {
  if (!dateStr) {
    return;
  }

  const modal = getModalController();
  if (!modal) {
    return;
  }

  const confirmed = window.confirm(`Clear all trades for ${dateStr}? This action cannot be undone.`);
  if (!confirmed) {
    return;
  }

  modal.saving = true;
  clearTradeEditorMessages();

  fetch('/api/trades/' + dateStr, { method: 'DELETE' })
    .then(response => {
      if (!response.ok) {
        return response.json().catch(() => ({})).then(data => {
          const message = data && data.detail ? data.detail : 'Failed to clear trades.';
          throw new Error(message);
        });
      }
      return response.json();
    })
    .then(data => {
      setupTradeEditor([], dateStr);
      showTradeEditorSuccess('All trades cleared for this date.');
      updateTradeIndicators(dateStr, []);
      modal.shouldReloadOnClose = true;
    })
    .catch(err => {
      showTradeEditorError(err && err.message ? err.message : 'Failed to clear trades.');
    })
    .finally(() => {
      modal.saving = false;
    });
}

function updateTradeIndicators(dateStr, trades) {
  const cell = document.querySelector(`[data-day-cell='${dateStr}']`);
  if (!cell) {
    return;
  }
  const trigger = cell.querySelector("button[aria-label='View trades']");
  if (!trigger) {
    return;
  }

  const tradeCount = Array.isArray(trades) ? trades.length : 0;
  trigger.classList.toggle('icon-translucent', tradeCount === 0);

  let badge = trigger.querySelector('.trade-count-badge');
  if (tradeCount > 0) {
    if (!badge) {
      badge = document.createElement('span');
      badge.className = 'trade-count-badge absolute -top-1 -right-1 min-w-[1.25rem] rounded-full text-[10px] font-semibold px-1 text-center';
      trigger.appendChild(badge);
    }
    badge.textContent = String(tradeCount);
  } else if (badge) {
    badge.remove();
  }
}

  
const DIVIDEND_ACTION_OPTIONS = [
  'Bank Interest',
  'Cash Dividend',
  'Qual Div Reinvest',
  'Qualified Dividend',
  'Reinvest Dividend',
  'Other',
];

const dividendEditorState = {
  initialSnapshot: '[]',
  isDirty: false,
  unsavedWarning: null,
  currentDate: null,
  dragManager: null,
  columnVisibility: {
    description: true,
    quantity: true,
    price: true,
    fee: true,
    time: true,
  },
};

function loadDividendColumnPreferences() {
  try {
    const stored = localStorage.getItem('bagholder_dividend_columns');
    if (!stored) {
      return;
    }
    const parsed = JSON.parse(stored);
    if (parsed && typeof parsed === 'object') {
      ['description', 'quantity', 'price', 'fee', 'time'].forEach((key) => {
        if (Object.prototype.hasOwnProperty.call(parsed, key)) {
          dividendEditorState.columnVisibility[key] = !!parsed[key];
        }
      });
    }
  } catch (error) {
    // Ignore preference parsing errors
  }
}

function saveDividendColumnPreferences() {
  try {
    localStorage.setItem('bagholder_dividend_columns', JSON.stringify(dividendEditorState.columnVisibility));
  } catch (error) {
    // Ignore persistence errors
  }
}

function applyDividendColumnVisibility() {
  const visibility = dividendEditorState.columnVisibility;
  const columns = ['description', 'quantity', 'price', 'fee', 'time'];
  columns.forEach((key) => {
    const visible = visibility[key];
    document.querySelectorAll(`.dividend-col-${key}`).forEach((el) => {
      el.classList.toggle('hidden', !visible);
    });
    document.querySelectorAll(`[data-dividend-toggle='${key}']`).forEach((btn) => {
      btn.classList.toggle('bg-neutral-800', visible);
      btn.classList.toggle('text-neutral-200', visible);
      btn.classList.toggle('text-neutral-500', !visible);
      btn.setAttribute('aria-pressed', visible ? 'true' : 'false');
    });
  });
  saveDividendColumnPreferences();
}

function getDividendEditorWarningElement() {
  if (dividendEditorState.unsavedWarning && document.body && document.body.contains(dividendEditorState.unsavedWarning)) {
    return dividendEditorState.unsavedWarning;
  }
  const element = document.getElementById('dividend-unsaved');
  dividendEditorState.unsavedWarning = element || null;
  return dividendEditorState.unsavedWarning;
}

function setDividendEditorDirty(isDirty) {
  dividendEditorState.isDirty = !!isDirty;
  const warning = getDividendEditorWarningElement();
  if (warning) {
    warning.classList.toggle('hidden', !dividendEditorState.isDirty);
  }
}

function clearDividendEditorMessages() {
  const errorEl = document.getElementById('dividend-error');
  const successEl = document.getElementById('dividend-success');
  if (errorEl) {
    errorEl.classList.add('hidden');
    errorEl.textContent = '';
  }
  if (successEl) {
    successEl.classList.add('hidden');
    successEl.textContent = '';
  }
}

function showDividendEditorError(message) {
  const el = document.getElementById('dividend-error');
  if (!el) {
    window.alert(message);
    return;
  }
  el.textContent = message;
  el.classList.remove('hidden');
}

function showDividendEditorSuccess(message) {
  const el = document.getElementById('dividend-success');
  if (!el) {
    return;
  }
  el.textContent = message;
  el.classList.remove('hidden');
}

function hideDividendEditorSuccess() {
  const el = document.getElementById('dividend-success');
  if (el) {
    el.classList.add('hidden');
  }
}

function captureDividendEditorSnapshot() {
  const tbody = document.getElementById('dividend-table-body');
  if (!tbody) {
    return '[]';
  }
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const normalized = rows.map((row) => {
    const actionSelect = row.querySelector('.dividend-action');
    const symbolInput = row.querySelector('.dividend-symbol');
    const descriptionInput = row.querySelector('.dividend-description');
    const qtyInput = row.querySelector('.dividend-qty');
    const priceInput = row.querySelector('.dividend-price');
    const feeInput = row.querySelector('.dividend-fee');
    const amountInput = row.querySelector('.dividend-amount');
    const timeInput = row.querySelector('.dividend-time');
    return {
      id: row.dataset.dividendId ? String(row.dataset.dividendId) : '',
      action: actionSelect ? actionSelect.value : '',
      symbol: symbolInput ? symbolInput.value : '',
      description: descriptionInput ? descriptionInput.value : '',
      qty: qtyInput ? qtyInput.value : '',
      price: priceInput ? priceInput.value : '',
      fee: feeInput ? feeInput.value : '',
      amount: amountInput ? amountInput.value : '',
      time: timeInput ? timeInput.value : '',
    };
  });
  return JSON.stringify(normalized);
}

function refreshDividendEditorDirtyState() {
  const snapshot = captureDividendEditorSnapshot();
  const isDirty = snapshot !== dividendEditorState.initialSnapshot;
  setDividendEditorDirty(isDirty);
  return isDirty;
}

function resetDividendEditorInitialSnapshot() {
  dividendEditorState.initialSnapshot = captureDividendEditorSnapshot();
  setDividendEditorDirty(false);
}

function updateDividendEmptyState() {
  const tbody = document.getElementById('dividend-table-body');
  const message = document.getElementById('dividend-empty-message');
  if (!tbody || !message) {
    return;
  }
  const hasRows = tbody.querySelector('tr') !== null;
  message.classList.toggle('hidden', hasRows);
}

function createDividendEditorHTML() {
  return `
    <div id="dividend-editor" class="space-y-3">
      <p id="dividend-error" class="text-sm text-danger hidden"></p>
      <p id="dividend-success" class="text-sm text-success hidden"></p>
      <p id="dividend-unsaved" class="text-xs text-warning hidden">Unsaved changes. Save your dividends to keep them.</p>
      <div id="dividend-empty-message" class="text-sm text-neutral-400 hidden">No dividends recorded for this date.</div>
      <div class="flex flex-wrap items-center gap-2 text-xs text-neutral-400" id="dividend-column-toggles">
        <span class="font-semibold text-neutral-300">Columns:</span>
        <button type="button" data-dividend-toggle="description" class="dividend-toggle px-2 py-1 rounded border border-neutral-700 text-neutral-500 transition hover:bg-neutral-800 focus:outline-none focus:ring-1 focus:ring-neutral-600">Description</button>
        <button type="button" data-dividend-toggle="quantity" class="dividend-toggle px-2 py-1 rounded border border-neutral-700 text-neutral-500 transition hover:bg-neutral-800 focus:outline-none focus:ring-1 focus:ring-neutral-600">Quantity</button>
        <button type="button" data-dividend-toggle="price" class="dividend-toggle px-2 py-1 rounded border border-neutral-700 text-neutral-500 transition hover:bg-neutral-800 focus:outline-none focus:ring-1 focus:ring-neutral-600">Price</button>
        <button type="button" data-dividend-toggle="fee" class="dividend-toggle px-2 py-1 rounded border border-neutral-700 text-neutral-500 transition hover:bg-neutral-800 focus:outline-none focus:ring-1 focus:ring-neutral-600">Fee</button>
        <button type="button" data-dividend-toggle="time" class="dividend-toggle px-2 py-1 rounded border border-neutral-700 text-neutral-500 transition hover:bg-neutral-800 focus:outline-none focus:ring-1 focus:ring-neutral-600">Time</button>
      </div>
      <div class="overflow-x-auto" style="max-height: 20rem; overflow-y: auto;">
        <table class="min-w-full text-sm text-left text-neutral-200 border border-neutral-800">
          <thead class="bg-neutral-900 text-neutral-400">
            <tr>
              <th class="px-2 py-1 border border-neutral-800 text-center">Order</th>
              <th class="px-2 py-1 border border-neutral-800">Action</th>
              <th class="px-2 py-1 border border-neutral-800">Symbol</th>
              <th class="px-2 py-1 border border-neutral-800 dividend-col-description">Description</th>
              <th class="px-2 py-1 border border-neutral-800 text-right dividend-col-quantity">Quantity</th>
              <th class="px-2 py-1 border border-neutral-800 text-right dividend-col-price">Price</th>
              <th class="px-2 py-1 border border-neutral-800 text-right dividend-col-fee">Fee</th>
              <th class="px-2 py-1 border border-neutral-800 text-right">Amount</th>
              <th class="px-2 py-1 border border-neutral-800 text-center dividend-col-time">Time</th>
              <th class="px-2 py-1 border border-neutral-800 text-right">Remove</th>
            </tr>
          </thead>
          <tbody id="dividend-table-body"></tbody>
        </table>
      </div>
      <div class="space-y-2">
        <div class="flex items-center justify-between flex-wrap gap-2">
          <div class="flex items-center gap-2 flex-wrap">
            <button type="button" id="add-dividend-row" class="px-3 py-1 rounded border border-neutral-700 hover:bg-neutral-800 text-sm">Add dividend</button>
            <button type="button" id="clear-dividends" class="btn btn-outline-danger px-3 py-1 text-sm">Clear all dividends</button>
          </div>
        </div>
        <span class="text-xs text-neutral-500">Amounts can be positive or negative. Use the column toggles to hide fields you do not track.</span>
      </div>
    </div>`;
}

function createDividendRow(dividend, dateStr, dragManager) {
  const row = document.createElement('tr');
  row.className = 'border-b border-neutral-800';
  if (dividend && dividend.id !== undefined && dividend.id !== null) {
    row.dataset.dividendId = String(dividend.id);
  }
  if (dividend && dividend.sequence !== undefined && dividend.sequence !== null) {
    row.dataset.dividendSequence = String(dividend.sequence);
  }

  const markDirty = () => {
    hideDividendEditorSuccess();
    refreshDividendEditorDirtyState();
  };

  const orderCell = document.createElement('td');
  orderCell.className = 'px-2 py-1 border border-neutral-800 text-center align-middle';
  const handleButton = document.createElement('button');
  handleButton.type = 'button';
  handleButton.className = 'dividend-drag-handle drag-handle inline-flex h-6 w-6 items-center justify-center rounded border border-neutral-700 bg-neutral-900 text-xs text-neutral-300 transition hover:bg-neutral-800 focus:outline-none focus:ring-1 focus:ring-neutral-600';
  handleButton.innerHTML = '<span aria-hidden="true">☰</span><span class="sr-only">Drag to reorder</span>';
  orderCell.appendChild(handleButton);
  row.appendChild(orderCell);

  const actionCell = document.createElement('td');
  actionCell.className = 'px-2 py-1 border border-neutral-800';
  const actionSelect = document.createElement('select');
  actionSelect.className = 'dividend-action bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-neutral-100';
  const normalizedAction = dividend && dividend.action ? String(dividend.action).trim() : '';
  const options = new Set(DIVIDEND_ACTION_OPTIONS);
  if (normalizedAction && !options.has(normalizedAction)) {
    options.add(normalizedAction);
  }
  Array.from(options).forEach((label) => {
    const option = document.createElement('option');
    option.value = label;
    option.textContent = label;
    actionSelect.appendChild(option);
  });
  actionSelect.value = normalizedAction || DIVIDEND_ACTION_OPTIONS[0];
  actionSelect.addEventListener('change', markDirty);
  actionCell.appendChild(actionSelect);
  row.appendChild(actionCell);

  const symbolCell = document.createElement('td');
  symbolCell.className = 'px-2 py-1 border border-neutral-800';
  const symbolInput = document.createElement('input');
  symbolInput.type = 'text';
  symbolInput.className = 'dividend-symbol w-full bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-neutral-100 uppercase';
  symbolInput.value = dividend && dividend.symbol ? dividend.symbol : '';
  symbolInput.autocomplete = 'off';
  symbolInput.spellcheck = false;
  symbolInput.addEventListener('input', markDirty);
  symbolCell.appendChild(symbolInput);
  row.appendChild(symbolCell);

  const descriptionCell = document.createElement('td');
  descriptionCell.className = 'px-2 py-1 border border-neutral-800 dividend-col-description';
  const descriptionInput = document.createElement('input');
  descriptionInput.type = 'text';
  descriptionInput.className = 'dividend-description w-full bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-neutral-100';
  descriptionInput.value = dividend && dividend.description ? dividend.description : '';
  descriptionInput.addEventListener('input', markDirty);
  descriptionCell.appendChild(descriptionInput);
  row.appendChild(descriptionCell);

  const qtyCell = document.createElement('td');
  qtyCell.className = 'px-2 py-1 border border-neutral-800 text-right dividend-col-quantity';
  const qtyInput = document.createElement('input');
  qtyInput.type = 'number';
  qtyInput.step = '0.0001';
  qtyInput.min = '0';
  qtyInput.inputMode = 'decimal';
  qtyInput.className = 'dividend-qty w-full min-w-[6rem] bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-neutral-100 text-right';
  qtyInput.value = dividend && dividend.qty !== undefined && dividend.qty !== null ? dividend.qty : '';
  qtyInput.addEventListener('input', markDirty);
  qtyCell.appendChild(qtyInput);
  row.appendChild(qtyCell);

  const priceCell = document.createElement('td');
  priceCell.className = 'px-2 py-1 border border-neutral-800 text-right dividend-col-price';
  const priceInput = document.createElement('input');
  priceInput.type = 'number';
  priceInput.step = '0.0001';
  priceInput.min = '0';
  priceInput.inputMode = 'decimal';
  priceInput.className = 'dividend-price w-full min-w-[6rem] bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-neutral-100 text-right';
  priceInput.value = dividend && dividend.price !== undefined && dividend.price !== null ? dividend.price : '';
  priceInput.addEventListener('input', markDirty);
  priceCell.appendChild(priceInput);
  row.appendChild(priceCell);

  const feeCell = document.createElement('td');
  feeCell.className = 'px-2 py-1 border border-neutral-800 text-right dividend-col-fee';
  const feeInput = document.createElement('input');
  feeInput.type = 'number';
  feeInput.step = '0.01';
  feeInput.min = '0';
  feeInput.inputMode = 'decimal';
  feeInput.className = 'dividend-fee w-full min-w-[6rem] bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-neutral-100 text-right';
  if (dividend && dividend.fee !== undefined && dividend.fee !== null && Number.isFinite(Number(dividend.fee))) {
    feeInput.value = Number(dividend.fee) === 0 ? '' : String(dividend.fee);
  }
  feeInput.addEventListener('input', markDirty);
  feeCell.appendChild(feeInput);
  row.appendChild(feeCell);

  const amountCell = document.createElement('td');
  amountCell.className = 'px-2 py-1 border border-neutral-800 text-right';
  const amountInput = document.createElement('input');
  amountInput.type = 'number';
  amountInput.step = '0.01';
  amountInput.inputMode = 'decimal';
  amountInput.className = 'dividend-amount w-full min-w-[6rem] bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-neutral-100 text-right';
  amountInput.value = dividend && dividend.amount !== undefined && dividend.amount !== null ? dividend.amount : '';
  amountInput.addEventListener('input', markDirty);
  amountCell.appendChild(amountInput);
  row.appendChild(amountCell);

  const timeCell = document.createElement('td');
  timeCell.className = 'px-2 py-1 border border-neutral-800 text-center dividend-col-time';
  const timeInput = document.createElement('input');
  timeInput.type = 'time';
  timeInput.step = '1';
  timeInput.className = 'dividend-time w-full bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-neutral-100 text-center';
  timeInput.value = dividend && dividend.time ? dividend.time : '';
  timeInput.addEventListener('change', markDirty);
  timeInput.addEventListener('input', markDirty);
  timeCell.appendChild(timeInput);
  row.appendChild(timeCell);

  const removeCell = document.createElement('td');
  removeCell.className = 'px-2 py-1 border border-neutral-800 text-right';
  const removeButton = document.createElement('button');
  removeButton.type = 'button';
  removeButton.className = 'remove-dividend-row btn btn-outline-danger px-2 py-1 text-xs';
  removeButton.textContent = 'Remove';
  removeButton.addEventListener('click', () => {
    hideDividendEditorSuccess();
    row.remove();
    updateDividendEmptyState();
    refreshDividendEditorDirtyState();
  });
  removeCell.appendChild(removeButton);
  row.appendChild(removeCell);

  if (dragManager && typeof dragManager.registerRow === 'function') {
    dragManager.registerRow(row);
  }

  return row;
}

function setupDividendEditor(dividends, dateStr, options = {}) {
  clearDividendEditorMessages();
  loadDividendColumnPreferences();
  const tbody = document.getElementById('dividend-table-body');
  if (!tbody) {
    return;
  }

  tbody.innerHTML = '';
  dividendEditorState.dragManager = createTableDragManager(tbody, {
    handleSelector: '.dividend-drag-handle',
    onReorder: () => {
      hideDividendEditorSuccess();
      refreshDividendEditorDirtyState();
    },
  });

  (dividends || []).forEach((dividend) => {
    tbody.appendChild(createDividendRow(dividend, dateStr, dividendEditorState.dragManager));
  });

  const addButton = document.getElementById('add-dividend-row');
  if (addButton) {
    addButton.onclick = () => {
      hideDividendEditorSuccess();
      tbody.appendChild(
        createDividendRow(
          { action: DIVIDEND_ACTION_OPTIONS[0], symbol: '', description: '', qty: '', price: '', fee: '', amount: '', time: '' },
          dateStr,
          dividendEditorState.dragManager,
        ),
      );
      updateDividendEmptyState();
      refreshDividendEditorDirtyState();
    };
  }

  const clearButton = document.getElementById('clear-dividends');
  if (clearButton) {
    clearButton.onclick = () => {
      hideDividendEditorSuccess();
      clearDividends(dateStr);
    };
  }

  const toggleButtons = document.querySelectorAll('[data-dividend-toggle]');
  toggleButtons.forEach((button) => {
    button.onclick = () => {
      const key = button.dataset.dividendToggle;
      if (!key) {
        return;
      }
      dividendEditorState.columnVisibility[key] = !dividendEditorState.columnVisibility[key];
      applyDividendColumnVisibility();
    };
  });

  updateDividendEmptyState();
  applyDividendColumnVisibility();

  dividendEditorState.unsavedWarning = document.getElementById('dividend-unsaved');
  dividendEditorState.currentDate = dateStr;
  if (options && typeof options.initialSnapshotOverride === 'string') {
    dividendEditorState.initialSnapshot = options.initialSnapshotOverride;
    refreshDividendEditorDirtyState();
  } else {
    resetDividendEditorInitialSnapshot();
  }

  const modal = getModalController();
  if (modal) {
    modal.beforeClose = () => {
      const dirty = refreshDividendEditorDirtyState();
      if (!dirty) {
        return true;
      }
      const confirmClose = window.confirm('You have unsaved dividend changes. Discard them?');
      if (!confirmClose) {
        return false;
      }
      return true;
    };
  }
}

function openDividends(dateStr) {
  fetch('/api/dividends/' + dateStr)
    .then((response) => {
      if (!response.ok) {
        return response.json().catch(() => ({})).then((data) => {
          const message = data && data.detail ? data.detail : 'Failed to load dividends.';
          throw new Error(message);
        });
      }
      return response.json();
    })
    .then((js) => {
      const modal = getModalController();
      if (!modal) {
        return;
      }
      modal.title = 'Dividends ' + dateStr;
      modal.body = createDividendEditorHTML();
      modal.saveLabel = 'Save dividends';
      modal.closeLabel = 'Close';
      modal.save = () => saveDividends(dateStr);
      modal.open = true;
      setTimeout(() => setupDividendEditor(js.dividends || [], dateStr), 0);
    })
    .catch((err) => {
      const modal = getModalController();
      if (!modal) {
        return;
      }
      modal.title = 'Dividends ' + dateStr;
      modal.body = `<p class="text-sm text-danger">${err.message || 'Failed to load dividends.'}</p>`;
      modal.save = null;
      modal.open = true;
    });
}

function saveDividends(dateStr) {
  const modal = getModalController();
  if (!modal) {
    return;
  }
  const tbody = document.getElementById('dividend-table-body');
  if (!tbody) {
    return;
  }

  clearDividendEditorMessages();
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const dividends = [];
  let hasError = false;

  rows.forEach((row, index) => {
    const actionSelect = row.querySelector('.dividend-action');
    const symbolInput = row.querySelector('.dividend-symbol');
    const descriptionInput = row.querySelector('.dividend-description');
    const qtyInput = row.querySelector('.dividend-qty');
    const priceInput = row.querySelector('.dividend-price');
    const feeInput = row.querySelector('.dividend-fee');
    const amountInput = row.querySelector('.dividend-amount');
    const timeInput = row.querySelector('.dividend-time');

    const symbol = symbolInput ? symbolInput.value.trim().toUpperCase() : '';
    const description = descriptionInput ? descriptionInput.value.trim() : '';
    const qtyRaw = qtyInput ? qtyInput.value.trim() : '';
    const priceRaw = priceInput ? priceInput.value.trim() : '';
    const feeRaw = feeInput ? feeInput.value.trim() : '';
    const amountRaw = amountInput ? amountInput.value.trim() : '';
    const timeRaw = timeInput ? timeInput.value.trim() : '';

    const isEmpty = !symbol && !description && !qtyRaw && !priceRaw && !feeRaw && !amountRaw && !timeRaw;
    if (isEmpty) {
      row.classList.remove('bg-danger-soft');
      return;
    }

    let qty = 0;
    if (qtyRaw) {
      qty = parseFloat(normalizeNumberString(qtyRaw));
      if (!Number.isFinite(qty) || qty < 0) {
        row.classList.add('bg-danger-soft');
        hasError = true;
        return;
      }
    }

    let price = 0;
    if (priceRaw) {
      price = parseFloat(normalizeNumberString(priceRaw));
      if (!Number.isFinite(price) || price < 0) {
        row.classList.add('bg-danger-soft');
        hasError = true;
        return;
      }
    }

    let fee = 0;
    if (feeRaw) {
      fee = parseFloat(normalizeNumberString(feeRaw));
      if (!Number.isFinite(fee) || fee < 0) {
        row.classList.add('bg-danger-soft');
        hasError = true;
        return;
      }
    }

    const amount = parseFloat(normalizeNumberString(amountRaw));
    if (!Number.isFinite(amount)) {
      row.classList.add('bg-danger-soft');
      hasError = true;
      return;
    }

    const timeValue = timeRaw ? normalizeTradeTime(timeRaw) : '';
    if (timeRaw && !timeValue) {
      row.classList.add('bg-danger-soft');
      hasError = true;
      return;
    }

    row.classList.remove('bg-danger-soft');
    dividends.push({
      id: row.dataset.dividendId ? Number(row.dataset.dividendId) : null,
      action: actionSelect ? actionSelect.value : DIVIDEND_ACTION_OPTIONS[0],
      symbol: symbol,
      description,
      qty: qtyRaw ? qty : 0,
      price: priceRaw ? price : 0,
      fee: feeRaw ? fee : 0,
      amount,
      time: timeValue,
      sequence: index,
    });
  });

  if (hasError) {
    showDividendEditorError('Please correct highlighted dividends or remove empty rows before saving.');
    return;
  }

  modal.saving = true;

  fetch('/api/dividends/' + dateStr, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ dividends }),
  })
    .then((response) => {
      if (!response.ok) {
        return response.json().catch(() => ({})).then((data) => {
          const message = data && data.detail ? data.detail : 'Failed to save dividends.';
          throw new Error(message);
        });
      }
      return response.json();
    })
    .then((data) => {
      const saved = data && Array.isArray(data.dividends) ? data.dividends : [];
      setupDividendEditor(saved, dateStr);
      showDividendEditorSuccess('Dividends saved.');
      modal.shouldReloadOnClose = true;
      updateDividendIndicators(dateStr, saved);
    })
    .catch((err) => {
      showDividendEditorError(err.message || 'Failed to save dividends.');
    })
    .finally(() => {
      modal.saving = false;
    });
}

function clearDividends(dateStr) {
  if (!dateStr) {
    return;
  }
  const modal = getModalController();
  if (!modal) {
    return;
  }
  const confirmed = window.confirm(`Clear all dividends for ${dateStr}? This action cannot be undone.`);
  if (!confirmed) {
    return;
  }
  modal.saving = true;
  clearDividendEditorMessages();
  fetch('/api/dividends/' + dateStr, { method: 'DELETE' })
    .then((response) => {
      if (!response.ok) {
        return response.json().catch(() => ({})).then((data) => {
          const message = data && data.detail ? data.detail : 'Failed to clear dividends.';
          throw new Error(message);
        });
      }
      return response.json();
    })
    .then((data) => {
      setupDividendEditor([], dateStr);
      showDividendEditorSuccess('All dividends cleared for this date.');
      updateDividendIndicators(dateStr, []);
      modal.shouldReloadOnClose = true;
    })
    .catch((err) => {
      showDividendEditorError(err && err.message ? err.message : 'Failed to clear dividends.');
    })
    .finally(() => {
      modal.saving = false;
    });
}

function updateDividendIndicators(dateStr, dividends) {
  const cell = document.querySelector(`[data-day-cell='${dateStr}']`);
  if (!cell) {
    return;
  }
  const trigger = cell.querySelector("button[aria-label='View dividends']");
  if (!trigger) {
    return;
  }
  const count = Array.isArray(dividends) ? dividends.length : 0;
  trigger.classList.toggle('icon-translucent', count === 0);
  let badge = trigger.querySelector('.dividend-count-badge');
  if (count > 0) {
    if (!badge) {
      badge = document.createElement('span');
      badge.className = 'dividend-count-badge absolute -top-1 -right-1 min-w-[1.25rem] rounded-full text-[10px] font-semibold px-1 text-center';
      trigger.appendChild(badge);
    }
    badge.textContent = String(count);
  } else if (badge) {
    badge.remove();
  }
}

function openManual(dateStr, realized, invested) {
    const modal = getModalController();
    if (!modal) return;

    const normalizedRealized = typeof realized === 'number' && Number.isFinite(realized) ? realized : '';
    const normalizedInvested = typeof invested === 'number' && Number.isFinite(invested) ? invested : '';

    modal.title = 'Manual edit ' + dateStr;
    modal.closeLabel = 'Cancel';
    modal.saveLabel = 'Save values';
    modal.saving = false;
    modal.body = `
      <form id="manual-form" class="space-y-3">
        <p class="text-sm text-red-400 hidden" data-manual-error></p>
        <p class="text-sm leading-relaxed text-amber-200 bg-amber-900/40 border border-amber-500/40 rounded px-3 py-2">
          Manual overrides are not recommended when trades are also tracked for this day. The next trade import or recompute
          will overwrite these values and can leave your stock market values mismatched.
        </p>
        <label class="block text-sm space-y-1">
          <span class="text-neutral-300">Realized</span>
          <input type="number" step="0.01" inputmode="decimal" name="realized" value="${normalizedRealized}" class="w-full rounded border border-neutral-700 bg-neutral-900 px-2 py-1 text-neutral-100 focus:outline-none focus:ring-1 focus:ring-neutral-500">
        </label>
        <label class="block text-sm space-y-1">
          <span class="text-neutral-300">Invested total</span>
          <input type="number" step="0.01" inputmode="decimal" name="invested" value="${normalizedInvested}" class="w-full rounded border border-neutral-700 bg-neutral-900 px-2 py-1 text-neutral-100 focus:outline-none focus:ring-1 focus:ring-neutral-500">
        </label>
      </form>`;
    modal.save = () => {
      const form = document.getElementById('manual-form');
      if (!form) {
        modal.save = null;
        return;
      }

      const errorEl = form.querySelector('[data-manual-error]');
      if (errorEl) {
        errorEl.textContent = '';
        errorEl.classList.add('hidden');
      }

      const fd = new FormData(form);
      modal.saving = true;

      fetch('/api/daily/' + dateStr, { method: 'POST', body: fd })
        .then((response) => {
          if (!response.ok) {
            return response
              .json()
              .catch(() => ({}))
              .then((data) => {
                const message = data && data.detail ? data.detail : 'Failed to save daily values.';
                throw new Error(message);
              });
          }
          return response.json();
        })
        .then(() => {
          modal.saving = false;
          modal.close(true);
          window.location.reload();
        })
        .catch((error) => {
          console.error(error);
          modal.saving = false;
          if (errorEl) {
            errorEl.textContent = error && error.message ? error.message : 'Failed to save daily values.';
            errorEl.classList.remove('hidden');
          }
        });
    };
    modal.open = true;
  }

function escapeHtml(value) {
  return String(value ?? '').replace(/[&<>"']/g, (char) => {
    switch (char) {
      case '&':
        return '&amp;';
      case '<':
        return '&lt;';
      case '>':
        return '&gt;';
      case '"':
        return '&quot;';
      case "'":
        return '&#39;';
      default:
        return char;
    }
  });
}

function formatNoteTimestamp(isoString) {
  if (!isoString) {
    return '';
  }
  try {
    const value = new Date(isoString);
    if (Number.isNaN(value.getTime())) {
      return '';
    }
    return value.toLocaleString(undefined, {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    });
  } catch (error) {
    return '';
  }
}

function formatDailySubtitle(dateStr) {
  try {
    const [year, month, day] = dateStr.split('-').map(Number);
    const value = new Date(year, (month || 1) - 1, day || 1);
    return value.toLocaleDateString(undefined, {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });
  } catch (error) {
    return dateStr;
  }
}

function getIsoWeekStart(year, week) {
  const simple = new Date(year, 0, 1 + (week - 1) * 7);
  const dayOfWeek = simple.getDay() || 7;
  const isoStart = new Date(simple);
  if (dayOfWeek <= 4) {
    isoStart.setDate(simple.getDate() - dayOfWeek + 1);
  } else {
    isoStart.setDate(simple.getDate() + (8 - dayOfWeek));
  }
  isoStart.setHours(0, 0, 0, 0);
  return isoStart;
}

function formatWeeklySubtitle(year, week) {
  try {
    const start = getIsoWeekStart(year, week);
    const end = new Date(start);
    end.setDate(start.getDate() + 6);
    const startLabel = start.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
    const endLabel = end.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
    return `Week ${week} • ${startLabel} – ${endLabel}`;
  } catch (error) {
    return `Week ${week}, ${year}`;
  }
}

function formatMonthlySubtitle(year, month) {
  try {
    const value = new Date(year, (month || 1) - 1, 1);
    return value.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
  } catch (error) {
    return `${year}-${String(month).padStart(2, '0')}`;
  }
}

function openNoteEditor(config) {
  const modal = getModalController();
  if (!modal) {
    return;
  }

  const {
    title,
    subtitle,
    fetchUrl,
    saveUrl,
    placeholder,
    onSave,
    prepareNote = null,
    closeLabel = 'Cancel',
    saveLabel = 'Save note',
  } = config;

  modal.title = title;
  modal.closeLabel = closeLabel;
  modal.saveLabel = saveLabel;
  modal.saving = false;
  modal.body = '<div class="flex items-center justify-center p-6 text-sm text-neutral-300">Loading note…</div>';
  modal.save = null;
  modal.open = true;

  fetch(fetchUrl)
    .then((response) => {
      if (!response.ok) {
        return response
          .json()
          .catch(() => ({}))
          .then((data) => {
            const message = data && data.detail ? data.detail : 'Failed to load note.';
            throw new Error(message);
          });
      }
      return response.json();
    })
    .then((payload) => {
      const noteText = payload && typeof payload.note === 'string' ? payload.note : '';
      const updatedAt = payload && typeof payload.updated_at === 'string' ? payload.updated_at : '';
      const prepareResult = typeof prepareNote === 'function' ? prepareNote(noteText) : noteText;
      let preparedText;
      let selectionRange = null;
      let scrollToSelection = false;
      if (prepareResult && typeof prepareResult === 'object') {
        preparedText = typeof prepareResult.text === 'string' ? prepareResult.text : '';
        const start = Number.isFinite(prepareResult.selectionStart) ? prepareResult.selectionStart : null;
        const end = Number.isFinite(prepareResult.selectionEnd) ? prepareResult.selectionEnd : null;
        if (start !== null) {
          const safeEnd = end !== null ? end : start;
          selectionRange = { start, end: safeEnd };
        }
        scrollToSelection = prepareResult.scrollToSelection === true;
      } else {
        preparedText = typeof prepareResult === 'string' ? prepareResult : '';
      }

      renderNoteEditor(modal, {
        subtitle,
        noteText: preparedText,
        selectionRange,
        updatedAt,
        placeholder,
        saveUrl,
        onSave,
        saveLabel,
        scrollToSelection,
      });
    })
    .catch((error) => {
      console.error(error);
      const message = error && error.message ? error.message : 'Failed to load note.';
      modal.body = `<p class="text-sm text-danger">${escapeHtml(message)}</p>`;
      modal.closeLabel = 'Close';
      modal.saveLabel = 'Save';
      modal.save = null;
    });
}

function renderNoteEditor(modal, config) {
  const {
    subtitle,
    noteText,
    selectionRange,
    updatedAt,
    placeholder,
    saveUrl,
    onSave,
    saveLabel,
    scrollToSelection = false,
  } = config;

  const subtitleText = subtitle ? escapeHtml(subtitle) : '';
  const placeholderText = placeholder ? escapeHtml(placeholder) : 'Add your note…';

  modal.saveLabel = saveLabel;
  modal.body = `
    <div class="space-y-4" data-note-editor-root>
      <div class="space-y-1">
        <p class="text-xs uppercase tracking-wide text-neutral-500">Context</p>
        <p class="text-sm text-neutral-300">${subtitleText}</p>
        <p class="text-xs text-neutral-500" data-note-updated-display></p>
      </div>
      <div class="space-y-2">
        <label class="block text-sm text-neutral-300" for="note-field">
          <span class="mb-2 block text-neutral-400">Note</span>
          <textarea id="note-field" data-autofocus class="w-full min-h-[14rem] rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-neutral-100 focus:outline-none focus-ring-primary" placeholder="${placeholderText}" spellcheck="true"></textarea>
        </label>
        <div class="flex items-center justify-between text-xs text-neutral-500">
          <span>Notes are saved as plain text.</span>
          <span data-note-char-count>0 characters</span>
        </div>
        <p class="text-xs text-warning hidden" data-note-unsaved-warning>Unsaved changes. Save your note to keep it.</p>
      </div>
      <p class="text-sm text-danger hidden" data-note-error></p>
      <div class="flex items-center justify-between border-t border-neutral-800 pt-3">
        <button type="button" class="text-xs text-neutral-400 transition hover:text-neutral-100" data-note-clear>Clear note</button>
        <span class="text-xs text-neutral-500" data-note-updated-display-secondary></span>
      </div>
    </div>
  `;

  window.requestAnimationFrame(() => {
    initializeNoteEditor({
      modal,
      noteText,
      selectionRange,
      updatedAt,
      saveUrl,
      onSave,
      scrollToSelection,
    });
  });
}

function initializeNoteEditor(options) {
  const { modal, noteText, selectionRange, updatedAt, saveUrl, onSave, scrollToSelection = false } = options;
  const root = document.querySelector('[data-note-editor-root]');
  if (!root) {
    return;
  }

  const field = root.querySelector('#note-field');
  const counter = root.querySelector('[data-note-char-count]');
  const errorEl = root.querySelector('[data-note-error]');
  const clearButton = root.querySelector('[data-note-clear]');
  const updatedDisplays = root.querySelectorAll('[data-note-updated-display], [data-note-updated-display-secondary]');
  const unsavedWarning = root.querySelector('[data-note-unsaved-warning]');

  let initialValue = typeof noteText === 'string' ? noteText : '';

  const updateDirtyState = () => {
    const currentValue = field ? field.value : '';
    const isDirty = currentValue !== initialValue;
    if (unsavedWarning) {
      unsavedWarning.classList.toggle('hidden', !isDirty);
    }
    return isDirty;
  };

  const updateDisplays = (isoString) => {
    let label = 'Not saved yet';
    if (isoString) {
      const formatted = formatNoteTimestamp(isoString);
      label = formatted ? `Last updated ${formatted}` : `Last updated ${isoString}`;
    }
    updatedDisplays.forEach((element) => {
      if (element) {
        element.textContent = label;
      }
    });
  };

  const updateCounter = () => {
    if (!counter || !field) {
      return;
    }
    const length = field.value.length;
    counter.textContent = `${length} ${length === 1 ? 'character' : 'characters'}`;
  };

  if (field) {
    const value = typeof noteText === 'string' ? noteText : '';
    field.value = value;
    initialValue = value;
    try {
      if (scrollToSelection) {
        field.focus();
      } else {
        field.focus({ preventScroll: true });
      }
    } catch (error) {
      field.focus();
    }
    const length = value.length;
    const clampIndex = (input) => {
      if (!Number.isFinite(input)) {
        return null;
      }
      if (input < 0) {
        return 0;
      }
      if (input > length) {
        return length;
      }
      return input;
    };
    let start = length;
    let end = length;
    if (selectionRange && typeof selectionRange === 'object') {
      const rawStart = Number.isFinite(selectionRange.start)
        ? selectionRange.start
        : Number.isFinite(selectionRange.selectionStart)
          ? selectionRange.selectionStart
          : null;
      const rawEnd = Number.isFinite(selectionRange.end)
        ? selectionRange.end
        : Number.isFinite(selectionRange.selectionEnd)
          ? selectionRange.selectionEnd
          : null;
      const safeStart = clampIndex(rawStart);
      if (safeStart !== null) {
        start = safeStart;
        const safeEnd = clampIndex(rawEnd !== null ? rawEnd : safeStart);
        end = safeEnd !== null ? safeEnd : safeStart;
      }
    }
    if (typeof field.setSelectionRange === 'function') {
      try {
        field.setSelectionRange(start, end);
      } catch (error) {
        // ignore selection issues for unsupported inputs
      }
    } else {
      try {
        field.selectionStart = start;
        field.selectionEnd = end;
      } catch (error) {
        // ignore assignment issues for unsupported inputs
      }
    }
    if (scrollToSelection) {
      window.requestAnimationFrame(() => {
        if (!field) {
          return;
        }
        if (typeof field.scrollTo === 'function') {
          try {
            field.scrollTo({ top: field.scrollHeight });
          } catch (error) {
            field.scrollTop = field.scrollHeight;
          }
        } else {
          field.scrollTop = field.scrollHeight;
        }
      });
    }
    field.addEventListener('input', () => {
      updateCounter();
      if (errorEl) {
        errorEl.textContent = '';
        errorEl.classList.add('hidden');
      }
      updateDirtyState();
    });
  }

  updateCounter();
  updateDisplays(updatedAt);
  updateDirtyState();

  if (clearButton && field) {
    clearButton.addEventListener('click', () => {
      field.value = '';
      try {
        field.focus({ preventScroll: true });
      } catch (error) {
        field.focus();
      }
      updateCounter();
      updateDirtyState();
    });
  }

  modal.beforeClose = () => {
    const dirty = updateDirtyState();
    if (!dirty) {
      return true;
    }
    const confirmClose = window.confirm('You have unsaved changes to this note. Discard them?');
    if (!confirmClose) {
      if (field) {
        try {
          field.focus({ preventScroll: true });
        } catch (error) {
          field.focus();
        }
      }
      return false;
    }
    return true;
  };

  modal.save = () => {
    if (!field) {
      return;
    }

    if (errorEl) {
      errorEl.textContent = '';
      errorEl.classList.add('hidden');
    }

    const noteValue = field.value;
    modal.saving = true;
    const fd = new FormData();
    fd.append('note', noteValue);

    fetch(saveUrl, { method: 'POST', body: fd })
      .then((response) => {
        if (!response.ok) {
          return response
            .json()
            .catch(() => ({}))
            .then((data) => {
              const message = data && data.detail ? data.detail : 'Failed to save note.';
              throw new Error(message);
            });
        }
        return response.json();
      })
      .then((payload) => {
        modal.saving = false;
        const updatedValue = payload && typeof payload.updated_at === 'string'
          ? payload.updated_at
          : new Date().toISOString();
        if (typeof onSave === 'function') {
          onSave(noteValue, { updatedAt: updatedValue });
        }
        initialValue = noteValue;
        updateDirtyState();
        modal.close(true);
      })
      .catch((error) => {
        console.error(error);
        modal.saving = false;
        if (errorEl) {
          errorEl.textContent = error && error.message ? error.message : 'Failed to save note.';
          errorEl.classList.remove('hidden');
        }
      });
  };
}

function openDailyNote(dateStr, options = {}) {
  const prepareNote = options && typeof options.prepareNote === 'function' ? options.prepareNote : null;
  const extraOnSave = options && typeof options.onSave === 'function' ? options.onSave : null;
  openNoteEditor({
    title: 'Daily note',
    subtitle: formatDailySubtitle(dateStr),
    fetchUrl: '/api/notes/daily/' + dateStr,
    saveUrl: '/api/notes/daily/' + dateStr,
    placeholder: 'Capture highlights from this trading day…',
    prepareNote,
    onSave: (noteValue, meta) => {
      updateDailyNoteIndicator(dateStr, noteValue, meta && meta.updatedAt);
      if (extraOnSave) {
        extraOnSave(noteValue, meta);
      }
    },
  });
}

function openWeeklyNote(year, week) {
  openNoteEditor({
    title: 'Weekly note',
    subtitle: formatWeeklySubtitle(year, week),
    fetchUrl: `/api/notes/weekly/${year}/${week}`,
    saveUrl: `/api/notes/weekly/${year}/${week}`,
    placeholder: 'Summarize how the week went…',
    onSave: (noteValue, meta) => {
      updateWeeklyNoteIndicator(year, week, noteValue, meta && meta.updatedAt);
    },
  });
}

function openMonthlyNote(year, month) {
  openNoteEditor({
    title: 'Monthly note',
    subtitle: formatMonthlySubtitle(year, month),
    fetchUrl: `/api/notes/monthly/${year}/${month}`,
    saveUrl: `/api/notes/monthly/${year}/${month}`,
    placeholder: 'Reflect on the month as a whole…',
    onSave: (noteValue, meta) => {
      updateMonthlyNoteIndicator(year, month, noteValue, meta && meta.updatedAt);
    },
  });
}

function getModalController() {
  const modal = window.modalController;
  if (!modal) {
    console.error('Modal controller is not ready yet');
    return null;
  }
  return modal;
}

function updateNoteTrigger(trigger, options = {}) {
  if (!trigger) {
    return false;
  }

  const { noteText, updatedAt, emptyLabel, filledLabel } = options;
  const normalized = typeof noteText === 'string' ? noteText : '';
  const trimmed = normalized.trim();
  const hasNote = trimmed.length > 0;
  const updatedValue = typeof updatedAt === 'string' ? updatedAt : '';

  trigger.dataset.noteText = normalized;
  trigger.dataset.noteUpdated = updatedValue;

  if (typeof emptyLabel === 'string' && typeof filledLabel === 'string') {
    trigger.setAttribute('aria-label', hasNote ? filledLabel : emptyLabel);
  } else {
    trigger.setAttribute('aria-label', hasNote ? 'Edit note' : 'Add note');
  }

  trigger.classList.toggle('has-note', hasNote);
  trigger.classList.toggle('icon-translucent', !hasNote);
  const tooltipBody = trigger.querySelector('.note-tooltip [data-note-tooltip-body]');
  if (tooltipBody) {
    tooltipBody.textContent = normalized;
  }

  const tooltipUpdated = trigger.querySelector('.note-tooltip [data-note-tooltip-updated]');
  if (tooltipUpdated) {
    if (updatedValue) {
      const formatted = formatNoteTimestamp(updatedValue);
      tooltipUpdated.textContent = formatted ? `Updated ${formatted}` : `Updated ${updatedValue}`;
    } else {
      tooltipUpdated.textContent = 'Not saved yet';
    }
  }

  trigger.removeAttribute('title');

  return hasNote;
}

function updateWeeklyNoteIndicator(year, week, noteText, updatedAt) {
  const selector = `[data-week-year='${year}'][data-week-index='${week}']`;
  const trigger = document.querySelector(selector);
  if (!trigger) {
    return;
  }
  const hasNote = updateNoteTrigger(trigger, {
    noteText,
    updatedAt,
    emptyLabel: 'Add weekly note',
    filledLabel: 'Edit weekly note',
  });
  const svg = trigger.querySelector('svg');
  if (svg) {
    svg.classList.toggle('text-amber-400', hasNote);
  }
}

function updateDailyNoteIndicator(dateStr, noteText, updatedAt) {
  const cell = document.querySelector(`[data-day-cell='${dateStr}']`);
  if (!cell) {
    return;
  }
  const trigger = cell.querySelector('.note-trigger');
  if (!trigger) {
    return;
  }
  updateNoteTrigger(trigger, {
    noteText,
    updatedAt,
    emptyLabel: 'Add daily note',
    filledLabel: 'Edit daily note',
  });
}

function updateMonthlyNoteIndicator(year, month, noteText, updatedAt) {
  const selector = `[data-month-key='${year}-${String(month).padStart(2, '0')}']`;
  const trigger = document.querySelector(selector);
  if (!trigger) {
    return;
  }
  const normalized = typeof noteText === 'string' ? noteText : '';
  const hasNote = normalized.trim().length > 0;
  trigger.dataset.noteText = normalized;
  trigger.dataset.noteUpdated = updatedAt || '';
  trigger.classList.toggle('has-note', hasNote);
  trigger.classList.toggle('icon-translucent', !hasNote);
  trigger.setAttribute('aria-label', hasNote ? 'Edit monthly note' : 'Add monthly note');
  const tooltipBody = trigger.querySelector('.note-tooltip [data-note-tooltip-body]');
  if (tooltipBody) {
    tooltipBody.textContent = normalized;
  }
}

document.querySelectorAll('.note-trigger').forEach((trigger) => {
  updateNoteTrigger(trigger, {
    noteText: trigger.dataset.noteText || '',
    updatedAt: trigger.dataset.noteUpdated || '',
    emptyLabel: trigger.dataset.noteLabelEmpty,
    filledLabel: trigger.dataset.noteLabelFilled,
  });
});
</script>
{% endblock %}
