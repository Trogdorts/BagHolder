{% extends "base.html" %}
{% block content %}
{% set ui_cfg = cfg.get('ui', {}) %}
{% set show_unrealized_default = ui_cfg.get('show_unrealized', True) %}
{% set show_trade_count_badges = show_trade_badges if show_trade_badges is defined else ui_cfg.get('show_trade_count', True) %}
<div x-data="{
        showUnrealized: {{ 'true' if show_unrealized_default else 'false' }},
        exportOpen: false,
        init() {
          try {
            const storage = window.localStorage;
            if (!storage) {
              return;
            }

            const stored = storage.getItem('bagholder:showUnrealized');
            if (stored !== null) {
              this.showUnrealized = stored === 'true';
            }

            this.$watch('showUnrealized', (value) => {
              storage.setItem('bagholder:showUnrealized', value ? 'true' : 'false');
            });
          } catch (error) {
            console.warn('Unable to persist showUnrealized preference', error);
          }
        }
      }" class="space-y-4">
<div class="flex items-center justify-between">
  <div class="text-lg font-semibold">{{ year }}-{{ "%02d"|format(month) }}</div>
  <div class="flex items-center gap-2 flex-wrap justify-end" @keydown.escape.window="exportOpen = false">
    {% set prev_year = (month == 1) and year-1 or year %}
    {% set prev_month = (month == 1) and 12 or month-1 %}
    {% set next_year = (month == 12) and year+1 or year %}
    {% set next_month = (month == 12) and 1 or month+1 %}
    <a href="/calendar/{{ prev_year }}/{{ prev_month }}" class="px-3 py-1 border border-neutral-700 rounded hover:bg-neutral-800">Prev</a>
    <a href="/calendar/{{ current_year }}/{{ current_month }}" class="px-3 py-1 border border-neutral-700 rounded hover:bg-neutral-800">Home</a>
    <a href="/calendar/{{ next_year }}/{{ next_month }}" class="px-3 py-1 border border-neutral-700 rounded hover:bg-neutral-800">Next</a>
    <div class="relative">
      <button type="button"
              class="px-3 py-1 border border-neutral-700 rounded hover:bg-neutral-800 transition"
              :class="{ 'bg-neutral-800 text-neutral-100 border-neutral-600': exportOpen }"
              @click="exportOpen = !exportOpen"
              aria-haspopup="true"
              :aria-expanded="exportOpen.toString()">
        Export
      </button>
      <div x-show="exportOpen"
           x-cloak
           @click.outside="exportOpen = false"
           class="absolute right-0 z-30 mt-2 w-72 space-y-3 rounded border border-neutral-800 bg-neutral-950 p-4 shadow-xl">
        <form method="get" action="/export" class="space-y-3">
          <p class="text-sm text-neutral-300">Download daily summaries as CSV.</p>
          <div class="space-y-2">
            <label class="block text-sm">
              <span class="text-neutral-400">Start date</span>
              <input type="date" name="start" value="{{ export_default_start }}"
                     class="mt-1 w-full rounded border border-neutral-700 bg-neutral-900 px-2 py-1 text-neutral-100 focus:outline-none focus:ring-1 focus:ring-neutral-500" />
            </label>
            <label class="block text-sm">
              <span class="text-neutral-400">End date</span>
              <input type="date" name="end" value="{{ export_default_end }}"
                     class="mt-1 w-full rounded border border-neutral-700 bg-neutral-900 px-2 py-1 text-neutral-100 focus:outline-none focus:ring-1 focus:ring-neutral-500" />
            </label>
          </div>
          <div class="flex items-center justify-end gap-2 pt-2 border-t border-neutral-800">
            <button type="button" class="px-3 py-1 rounded border border-neutral-700 hover:bg-neutral-800" @click="exportOpen = false">Cancel</button>
            <button type="submit" class="px-3 py-1 rounded bg-blue-600 text-white hover:bg-blue-500">Download</button>
          </div>
        </form>
      </div>
    </div>
    <button type="button"
            class="px-3 py-1 border border-neutral-700 rounded hover:bg-neutral-800 transition"
            :class="{ 'bg-neutral-800 text-neutral-100 border-neutral-600': !showUnrealized }"
            @click="showUnrealized = !showUnrealized"
            aria-pressed="{{ 'true' if show_unrealized_default else 'false' }}"
            :aria-pressed="showUnrealized.toString()">
      <span x-text="showUnrealized ? 'Hide unrealized' : 'Show unrealized'">
        {% if show_unrealized_default %}Hide unrealized{% else %}Show unrealized{% endif %}
      </span>
    </button>
  </div>
</div>

{% set show_weekends = ui_cfg.get('show_weekends', False) %}
{% set day_labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'] %}
{% set visible_day_labels = day_labels if show_weekends else day_labels[:5] %}
{% set grid_columns = visible_day_labels|length + 1 %}

<div class="grid gap-2" style="grid-template-columns: repeat({{ grid_columns }}, minmax(0, 1fr));">
  {% for label in visible_day_labels %}
  <div class="text-xs text-neutral-400">{{ label }}</div>
  {% endfor %}
  <div class="text-xs text-neutral-400 text-right">Week</div>
</div>

<div class="grid gap-2 mt-2" style="grid-template-columns: repeat({{ grid_columns }}, minmax(0, 1fr));">
{% for week in weeks %}
  {% for d in week.days %}
    {% if show_weekends or not d.is_weekend %}
      {% set cls = (d.realized > 0) and 'cell-bg-pos' or (d.realized < 0) and 'cell-bg-neg' or 'bg-neutral-900' %}
      <div class="relative min-h-[7rem] rounded border border-neutral-800 p-2 {{ 'opacity-100' if d.in_month else 'opacity-30' }} {{ cls }} flex flex-col gap-2" data-day-cell="{{ d.date.strftime('%Y-%m-%d') }}">
        <div class="flex items-center gap-1 text-xs text-neutral-400">
          <span>{{ d.date.day }}</span>
          {% if d.has_trades %}
          <button type="button"
                  class="relative inline-flex items-center justify-center rounded-full bg-emerald-900/20 p-1 text-emerald-400 hover:bg-emerald-800/30 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                  onclick="openTrades('{{ d.date.strftime('%Y-%m-%d') }}'); return false;"
                  aria-label="View trades">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
              <circle cx="12" cy="12" r="9" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h-1.125a1.875 1.875 0 000 3.75h2.25a1.875 1.875 0 010 3.75H12m0-10.5v10.5" />
            </svg>
            <span class="sr-only">View trades</span>
            {% set trade_count = d.trades|length %}
            {% if trade_count and show_trade_count_badges %}
            <span class="absolute -top-1 -right-1 min-w-[1.25rem] rounded-full bg-emerald-400 text-neutral-900 text-[10px] font-semibold px-1 text-center">{{ trade_count }}</span>
            {% endif %}
          </button>
          {% endif %}
        </div>

        {% if cfg.ui.show_text %}
        <div class="text-sm space-y-1">
          {% set realized_class = 'text-green-400' if d.realized > 0 else ('text-red-400' if d.realized < 0 else 'text-neutral-200') %}
          {% if d.has_values %}
          <div class="{{ realized_class }}">Realized: {{ d.realized|money }}</div>
          {% else %}
          <div class="{{ realized_class }}" x-show="showUnrealized" x-cloak>Realized: {{ d.realized|money }}</div>
          {% endif %}
          <div class="{{ 'text-green-400' if d.unrealized > 0 else ('text-red-400' if d.unrealized < 0 else 'text-neutral-200') }}"
               x-show="showUnrealized" x-cloak>
            Unrealized: {{ d.unrealized|money }}
          </div>
        </div>
        {% endif %}

        <!-- Gear icon for manual entry -->
        <a class="absolute top-1 right-1 icon-translucent z-10" href="#"
           aria-label="Edit daily values"
           onclick="openManual('{{ d.date.strftime('%Y-%m-%d') }}', {{ d.realized }}, {{ d.unrealized }}); return false;">
          <svg class="w-4 h-4 action-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M19.14,12.94a7.43,7.43,0,0,0,.05-.94,7.43,7.43,0,0,0-.05-.94l2.11-1.65a.5.5,0,0,0,.12-.64l-2-3.46a.5.5,0,0,0-.6-.22l-2.49,1a7.3,7.3,0,0,0-1.63-.94l-.38-2.65A.5.5,0,0,0,12.64,1H9.36a.5.5,0,0,0-.49.41L8.49,4.06a7.3,7.3,0,0,0-1.63.94l-2.49-1a.5.5,0,0,0-.6.22l-2,3.46a.5.5,0,0,0,.12.64L3.94,11.06a7.43,7.43,0,0,0-.05.94,7.43,7.43,0,0,0,.05.94L1.83,14.59a.5.5,0,0,0-.12.64l2,3.46a.5.5,0,0,0,.6.22l2.49-1a7.3,7.3,0,0,0,1.63.94l.38,2.65a.5.5,0,0,0,.49.41h3.28a.5.5,0,0,0,.49-.41l.38-2.65a7.3,7.3,0,0,0,1.63-.94l2.49,1a.5.5,0,0,0,.6-.22l2-3.46a.5.5,0,0,0-.12-.64Zm-7.14,2.56A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z" fill="currentColor" />
          </svg>
        </a>
        <!-- Note icon -->
        <a class="note-trigger absolute bottom-1 right-1 icon-translucent z-10{% if d.has_note %} has-note{% endif %}"
           href="#"
           aria-label="{{ 'Edit daily note' if d.has_note else 'Add daily note' }}"
           data-note-date="{{ d.date.strftime('%Y-%m-%d') }}"
           data-note-text="{{ d.note | e }}"
           onclick="openDailyNote('{{ d.date.strftime('%Y-%m-%d') }}'); return false;">
          <svg class="w-4 h-4 action-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M19 3H5a2 2 0 0 0-2 2v14l4-4h12a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z" fill="currentColor" />
          </svg>
          <div class="note-tooltip absolute bottom-6 right-0 z-20 whitespace-pre-line rounded border border-neutral-700 bg-neutral-900 p-2 text-xs text-neutral-100 shadow-lg w-fit">
            {{ d.note | e }}
          </div>
        </a>
      </div>
    {% endif %}
  {% endfor %}
  {% set week_cls = (week.week_realized > 0) and 'cell-bg-pos' or (week.week_realized < 0) and 'cell-bg-neg' or 'bg-neutral-900' %}
  <div class="relative min-h-[7rem] rounded border border-neutral-800 p-2 flex flex-col justify-between {{ week_cls }}">
    <div>
      <div class="text-xs text-neutral-400">Week {{ week.week_index }}</div>
      <div class="mt-2 text-sm space-y-1 text-right">
        <div class="{{ 'text-green-400' if week.week_realized > 0 else ('text-red-400' if week.week_realized < 0 else 'text-neutral-200') }}">Realized: {{ week.week_realized|money }}</div>
        <div class="{{ 'text-green-400' if week.week_unrealized > 0 else ('text-red-400' if week.week_unrealized < 0 else 'text-neutral-200') }}"
             x-show="showUnrealized" x-cloak>
          Unrealized: {{ week.week_unrealized|money }}
        </div>
      </div>
    </div>
    <div class="flex justify-end">
      <a class="z-10 weekly-note-trigger{% if not week.has_note %} icon-translucent{% endif %}" href="#" aria-label="Add weekly note"
         data-week-year="{{ week.week_year }}"
         data-week-index="{{ week.week_number }}"
         data-note-text="{{ week.note | default('', true) | e }}"
         onclick="openWeeklyNote({{ week.week_year }}, {{ week.week_number }}); return false;">
        <svg class="w-4 h-4 action-icon{% if week.has_note %} text-amber-400{% endif %}" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M19 3H5a2 2 0 0 0-2 2v14l4-4h12a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z" fill="currentColor" />
        </svg>
      </a>
    </div>
  </div>
{% endfor %}
</div>

<div class="mt-6 max-w-3xl">
  <div class="grid gap-4 sm:grid-cols-2">
    <div class="rounded border border-neutral-800 p-3 bg-neutral-950 relative">
      <h2 class="font-semibold">Monthly summary</h2>
      <div>Realized: <span class="{{ 'text-green-400' if month_realized > 0 else ('text-red-400' if month_realized < 0 else 'text-neutral-200') }}">{{ month_realized|money }}</span></div>
      <div x-show="showUnrealized" x-cloak>
        Unrealized (invested): <span class="{{ 'text-green-400' if month_unrealized > 0 else ('text-red-400' if month_unrealized < 0 else 'text-neutral-200') }}">{{ month_unrealized|money }}</span>
      </div>
      <a class="absolute top-1 right-1 icon-translucent z-10" href="#" aria-label="Add monthly note"
         onclick="openMonthlyNote({{ year }}, {{ month }}); return false;">
        <svg class="w-4 h-4 action-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M19 3H5a2 2 0 0 0-2 2v14l4-4h12a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z" fill="currentColor" />
        </svg>
      </a>
    </div>
    <div class="rounded border border-neutral-800 p-3 bg-neutral-950">
      <h2 class="font-semibold">Yearly summary</h2>
      <div>Realized: <span class="{{ 'text-green-400' if year_realized > 0 else ('text-red-400' if year_realized < 0 else 'text-neutral-200') }}">{{ year_realized|money }}</span></div>
      <div x-show="showUnrealized" x-cloak>
        Unrealized (invested): <span class="{{ 'text-green-400' if year_unrealized > 0 else ('text-red-400' if year_unrealized < 0 else 'text-neutral-200') }}">{{ year_unrealized|money }}</span>
      </div>
    </div>
  </div>
</div>

</div>

<!-- Modals -->
<div
  id="modal"
  x-data="{
    open: false,
    title: '',
    body: '',
    save: null,
    previouslyFocused: null,
    init() {
      window.modalController = this;
      this.$watch('open', (value) => {
        document.body.classList.toggle('modal-open', value);
        this.toggleBackgroundInteractivity(value);
        if (value) {
          this.storeActiveElement();
          this.$nextTick(() => this.focusFirstElement());
        } else {
          this.restoreActiveElement();
        }
      });
    },
    toggleBackgroundInteractivity(isOpen) {
      const selectors = ['main', 'nav'];
      selectors.forEach((selector) => {
        const element = document.querySelector(selector);
        if (!element) {
          return;
        }
        element.classList.toggle('modal-background-inert', isOpen);
        if (isOpen) {
          element.setAttribute('aria-hidden', 'true');
        } else {
          element.removeAttribute('aria-hidden');
        }
        if ('inert' in element) {
          element.inert = isOpen;
        }
      });
    },
    storeActiveElement() {
      this.previouslyFocused = document.activeElement;
    },
    restoreActiveElement() {
      if (this.previouslyFocused && typeof this.previouslyFocused.focus === 'function') {
        this.previouslyFocused.focus({ preventScroll: true });
      }
      this.previouslyFocused = null;
    },
    focusFirstElement() {
      const dialog = this.$refs.dialog;
      if (!dialog) {
        return;
      }
      const focusable = dialog.querySelector('[data-autofocus], button, textarea, input, select, [tabindex]:not([tabindex="-1"])');
      if (focusable && typeof focusable.focus === 'function') {
        focusable.focus();
      } else if (typeof dialog.focus === 'function') {
        dialog.focus();
      }
    },
    close() {
      this.open = false;
    },
  }"
  x-show="open"
  x-cloak
  class="fixed inset-0 z-50 bg-black/60 flex items-center justify-center"
  role="dialog"
  aria-modal="true"
  :aria-hidden="(!open).toString()"
  @click.self="close()"
>
  <div
    x-ref="dialog"
    class="bg-neutral-950 border border-neutral-800 rounded p-4 w-full max-w-3xl focus:outline-none"
    role="document"
    tabindex="-1"
    @click.stop
  >
    <h3 class="font-semibold mb-2" x-text="title"></h3>
    <div x-html="body"></div>
    <div class="mt-4 flex justify-end gap-2">
      <button class="px-3 py-1 rounded border border-neutral-700" @click="close()">Close</button>
      <button class="px-3 py-1 rounded bg-blue-600 hover:bg-blue-500" @click="if (save) save()">Save</button>
    </div>
  </div>
</div>

<script>
function openTrades(dateStr) {
  fetch('/api/trades/' + dateStr)
    .then(response => {
      if (!response.ok) {
        return response.json().catch(() => ({})).then(data => {
          const message = data && data.detail ? data.detail : 'Failed to load trades.';
          throw new Error(message);
        });
      }
      return response.json();
    })
    .then(js => {
      const modal = getModalController();
      if (!modal) return;
      modal.title = 'Trades ' + dateStr;
      modal.body = createTradeEditorHTML();
      modal.save = () => saveTrades(dateStr);
      modal.open = true;
      setTimeout(() => setupTradeEditor(js.trades || []), 0);
    })
    .catch(err => {
      const modal = getModalController();
      if (!modal) return;
      modal.title = 'Trades ' + dateStr;
      modal.body = `<p class="text-sm text-red-400">${err.message || 'Failed to load trades.'}</p>`;
      modal.save = null;
      modal.open = true;
    });
}

function createTradeEditorHTML() {
  return `
    <div id="trade-editor" class="space-y-3">
      <p id="trade-error" class="text-sm text-red-400 hidden"></p>
      <div id="trade-empty-message" class="text-sm text-neutral-400 hidden">No trades recorded for this date.</div>
      <div class="overflow-x-auto" style="max-height: 20rem; overflow-y: auto;">
        <table class="min-w-full text-sm text-left text-neutral-200 border border-neutral-800">
          <thead class="bg-neutral-900 text-neutral-400">
            <tr>
              <th class="px-2 py-1 border border-neutral-800">Action</th>
              <th class="px-2 py-1 border border-neutral-800">Symbol</th>
              <th class="px-2 py-1 border border-neutral-800 text-right">Quantity</th>
              <th class="px-2 py-1 border border-neutral-800 text-right">Price</th>
              <th class="px-2 py-1 border border-neutral-800 text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="trade-table-body"></tbody>
        </table>
      </div>
      <div class="flex items-center justify-between">
        <button type="button" id="add-trade-row" class="px-3 py-1 rounded border border-neutral-700 hover:bg-neutral-800 text-sm">Add trade</button>
        <span class="text-xs text-neutral-500">Remove a row to delete a trade. Amounts are calculated on save.</span>
      </div>
    </div>`;
}

function setupTradeEditor(trades) {
  clearTradeEditorError();
  const tbody = document.getElementById('trade-table-body');
  if (!tbody) return;

  tbody.innerHTML = '';
  (trades || []).forEach(trade => {
    tbody.appendChild(createTradeRow(trade));
  });

  const addButton = document.getElementById('add-trade-row');
  if (addButton) {
    addButton.onclick = () => {
      tbody.appendChild(createTradeRow({ action: 'BUY', symbol: '', qty: '', price: '' }));
      updateTradeEmptyState();
    };
  }

  updateTradeEmptyState();
}

function createTradeRow(trade) {
  const row = document.createElement('tr');
  row.className = 'border-b border-neutral-800';
  if (trade && trade.id !== undefined && trade.id !== null) {
    row.dataset.tradeId = String(trade.id);
  }

  const actionCell = document.createElement('td');
  actionCell.className = 'px-2 py-1 border border-neutral-800';
  const actionSelect = document.createElement('select');
  actionSelect.className = 'trade-action bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-neutral-100';
  ['BUY', 'SELL'].forEach(optionValue => {
    const option = document.createElement('option');
    option.value = optionValue;
    option.textContent = optionValue;
    actionSelect.appendChild(option);
  });
  const actionValue = trade && trade.action ? String(trade.action).toUpperCase() : 'BUY';
  actionSelect.value = actionValue;
  actionCell.appendChild(actionSelect);
  row.appendChild(actionCell);

  const symbolCell = document.createElement('td');
  symbolCell.className = 'px-2 py-1 border border-neutral-800';
  const symbolInput = document.createElement('input');
  symbolInput.type = 'text';
  symbolInput.className = 'trade-symbol w-full bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-neutral-100 uppercase';
  symbolInput.value = trade && trade.symbol ? trade.symbol : '';
  symbolInput.autocomplete = 'off';
  symbolInput.spellcheck = false;
  symbolCell.appendChild(symbolInput);
  row.appendChild(symbolCell);

  const qtyCell = document.createElement('td');
  qtyCell.className = 'px-2 py-1 border border-neutral-800 text-right';
  const qtyInput = document.createElement('input');
  qtyInput.type = 'number';
  qtyInput.step = '0.0001';
  qtyInput.min = '0';
  qtyInput.inputMode = 'decimal';
  qtyInput.className = 'trade-qty w-full bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-neutral-100 text-right';
  qtyInput.value = trade && trade.qty !== undefined && trade.qty !== null ? trade.qty : '';
  qtyCell.appendChild(qtyInput);
  row.appendChild(qtyCell);

  const priceCell = document.createElement('td');
  priceCell.className = 'px-2 py-1 border border-neutral-800 text-right';
  const priceInput = document.createElement('input');
  priceInput.type = 'number';
  priceInput.step = '0.0001';
  priceInput.min = '0';
  priceInput.inputMode = 'decimal';
  priceInput.className = 'trade-price w-full bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-neutral-100 text-right';
  priceInput.value = trade && trade.price !== undefined && trade.price !== null ? trade.price : '';
  priceCell.appendChild(priceInput);
  row.appendChild(priceCell);

  const actionsCell = document.createElement('td');
  actionsCell.className = 'px-2 py-1 border border-neutral-800 text-right';
  const removeButton = document.createElement('button');
  removeButton.type = 'button';
  removeButton.className = 'remove-trade-row px-2 py-1 rounded border border-red-700 text-red-300 hover:bg-red-900/40 text-xs';
  removeButton.textContent = 'Remove';
  removeButton.addEventListener('click', () => {
    row.remove();
    updateTradeEmptyState();
  });
  actionsCell.appendChild(removeButton);
  row.appendChild(actionsCell);

  return row;
}

function updateTradeEmptyState() {
  const tbody = document.getElementById('trade-table-body');
  const message = document.getElementById('trade-empty-message');
  if (!tbody || !message) return;
  if (tbody.children.length === 0) {
    message.classList.remove('hidden');
  } else {
    message.classList.add('hidden');
  }
}

function clearTradeEditorError() {
  const errorEl = document.getElementById('trade-error');
  if (errorEl) {
    errorEl.textContent = '';
    errorEl.classList.add('hidden');
  }
}

function showTradeEditorError(message) {
  const errorEl = document.getElementById('trade-error');
  if (errorEl) {
    errorEl.textContent = message;
    errorEl.classList.remove('hidden');
  }
}

function saveTrades(dateStr) {
  const modal = getModalController();
  if (!modal) return;
  const tbody = document.getElementById('trade-table-body');
  if (!tbody) return;

  clearTradeEditorError();

  const rows = Array.from(tbody.querySelectorAll('tr'));
  const trades = [];
  let hasError = false;

  rows.forEach(row => {
    const actionSelect = row.querySelector('.trade-action');
    const symbolInput = row.querySelector('.trade-symbol');
    const qtyInput = row.querySelector('.trade-qty');
    const priceInput = row.querySelector('.trade-price');

    const symbol = symbolInput ? symbolInput.value.trim() : '';
    const qtyRaw = qtyInput ? qtyInput.value.trim() : '';
    const priceRaw = priceInput ? priceInput.value.trim() : '';
    const isEmpty = !symbol && !qtyRaw && !priceRaw;

    if (isEmpty) {
      row.classList.remove('bg-red-900/40');
      return;
    }

    const qty = parseFloat(qtyRaw);
    const price = parseFloat(priceRaw);
    if (!symbol || Number.isNaN(qty) || Number.isNaN(price) || qty <= 0 || price <= 0) {
      row.classList.add('bg-red-900/40');
      hasError = true;
      return;
    }

    row.classList.remove('bg-red-900/40');
    trades.push({
      id: row.dataset.tradeId ? Number(row.dataset.tradeId) : null,
      symbol: symbol.toUpperCase(),
      action: actionSelect ? actionSelect.value : 'BUY',
      qty: Math.abs(qty),
      price: Math.abs(price),
    });
  });

  if (hasError) {
    showTradeEditorError('Please complete all fields for each trade or remove unused rows.');
    return;
  }

  fetch('/api/trades/' + dateStr, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ trades }),
  })
    .then(response => {
      if (!response.ok) {
        return response.json().catch(() => ({})).then(data => {
          const message = data && data.detail ? data.detail : 'Failed to save trades.';
          throw new Error(message);
        });
      }
      return response.json();
    })
    .then(() => {
      modal.open = false;
      location.reload();
    })
    .catch(err => {
      showTradeEditorError(err.message || 'Failed to save trades.');
    });
}

function openManual(dateStr, realized, unrealized) {
  const modal = getModalController();
  if (!modal) return;
  modal.title = "Manual edit " + dateStr;
  modal.body = `
    <form id="manual-form">
      <label class="block mb-2 text-sm">Realized
        <input type="number" step="0.01" name="realized" value="${realized}" class="w-full bg-neutral-800 rounded px-2 py-1">
      </label>
      <label class="block mb-2 text-sm">Unrealized (invested)
        <input type="number" step="0.01" name="unrealized" value="${unrealized}" class="w-full bg-neutral-800 rounded px-2 py-1">
      </label>
    </form>`;
  modal.save = () => {
    const form = document.getElementById('manual-form');
    const fd = new FormData(form);
    fetch('/api/daily/' + dateStr, { method:'POST', body: fd }).then(() => location.reload());
  };
  modal.open = true;
}

function openDailyNote(dateStr) {
  fetch('/api/notes/daily/' + dateStr)
    .then((response) => response.json())
    .then((js) => {
      const modal = getModalController();
      if (!modal) return;
      const noteText = js && typeof js.note === 'string' ? js.note : '';
      modal.title = 'Daily note ' + dateStr;
      modal.body = `
        <div class="space-y-4">
          <label class="block text-sm text-neutral-300">
            <span class="mb-2 block text-neutral-400">Note</span>
            <textarea id="note-field" class="w-full h-48 bg-neutral-800 border border-neutral-700 rounded px-3 py-2 text-neutral-100 focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="Write your note..." spellcheck="true"></textarea>
          </label>
        </div>`;
      modal.save = () => {
        const noteField = document.getElementById('note-field');
        const noteValue = noteField ? noteField.value : '';
        const fd = new FormData();
        fd.append('note', noteValue);
        fd.append('use_markdown', 'false');
        fetch('/api/notes/daily/' + dateStr, { method: 'POST', body: fd })
          .then((response) => {
            if (!response.ok) {
              throw new Error('Failed to save daily note');
            }
            return response.json();
          })
          .then(() => {
            modal.open = false;
            updateDailyNoteIndicator(dateStr, noteValue);
          })
          .catch((err) => {
            console.error(err);
          });
      };
      modal.open = true;
      setTimeout(() => {
        const noteField = document.getElementById('note-field');
        if (noteField) {
          noteField.value = noteText;
          noteField.focus();
          const length = noteText.length;
          if (typeof noteField.setSelectionRange === 'function') {
            try {
              noteField.setSelectionRange(length, length);
            } catch (error) {
              // Some input types may not support selection updates; ignore.
            }
          }
        }
      });
    });
}
function openWeeklyNote(year, week) {
  fetch('/api/notes/weekly/' + year + '/' + week).then(r => r.json()).then(js => {
    const modal = getModalController();
    if (!modal) return;
    const noteText = (js && typeof js.note === 'string') ? js.note : '';
    modal.title = "Weekly note Y"+year+" W"+week;
    modal.body = '<textarea id="note-field" class="w-full h-40 bg-neutral-800 rounded p-2"></textarea>';
    modal.save = () => {
      const field = document.getElementById('note-field');
      const noteValue = field ? field.value : '';
      const fd = new FormData();
      fd.append('note', noteValue);
      fetch('/api/notes/weekly/' + year + '/' + week, {method:'POST', body:fd})
        .then((response) => {
          if (!response.ok) {
            throw new Error('Failed to save weekly note');
          }
          return response.json();
        })
        .then(() => {
          modal.open = false;
          updateWeeklyNoteIndicator(year, week, noteValue);
        })
        .catch((err) => {
          console.error(err);
        });
    };
    modal.open = true;
    setTimeout(() => {
      const noteField = document.getElementById('note-field');
      if (noteField) {
        noteField.value = noteText;
      }
    });
  });
}

function openMonthlyNote(year, month) {
  fetch('/api/notes/monthly/' + year + '/' + month).then(r => r.json()).then(js => {
    const modal = getModalController();
    if (!modal) return;
    const noteText = (js && typeof js.note === 'string') ? js.note : '';
    modal.title = "Monthly note " + year + "-" + String(month).padStart(2,'0');
    modal.body = '<textarea id="note-field" class="w-full h-40 bg-neutral-800 rounded p-2"></textarea>';
    modal.save = () => {
      const field = document.getElementById('note-field');
      const noteValue = field ? field.value : '';
      const fd = new FormData();
      fd.append('note', noteValue);
      fetch('/api/notes/monthly/' + year + '/' + month, {method:'POST', body:fd})
        .then((response) => {
          if (!response.ok) {
            throw new Error('Failed to save monthly note');
          }
          return response.json();
        })
        .then(() => {
          modal.open = false;
        })
        .catch((err) => {
          console.error(err);
        });
    };
    modal.open = true;
    setTimeout(() => {
      const noteField = document.getElementById('note-field');
      if (noteField) {
        noteField.value = noteText;
      }
    });
  });
}

function getModalController() {
  const modal = window.modalController;
  if (!modal) {
    console.error('Modal controller is not ready yet');
    return null;
  }
  return modal;
}

function updateWeeklyNoteIndicator(year, week, noteText) {
  const selector = `[data-week-year='${year}'][data-week-index='${week}']`;
  const trigger = document.querySelector(selector);
  if (!trigger) {
    return;
  }
  const normalized = typeof noteText === 'string' ? noteText : '';
  const hasNote = normalized.trim().length > 0;
  trigger.dataset.noteText = normalized;
  if (hasNote) {
    trigger.classList.remove('icon-translucent');
  } else {
    trigger.classList.add('icon-translucent');
  }
  const svg = trigger.querySelector('svg');
  if (svg) {
    if (hasNote) {
      svg.classList.add('text-amber-400');
    } else {
      svg.classList.remove('text-amber-400');
    }
  }
  if (hasNote) {
    trigger.setAttribute('title', normalized);
  } else {
    trigger.removeAttribute('title');
  }
}

function updateDailyNoteIndicator(dateStr, noteText) {
  const cell = document.querySelector(`[data-day-cell='${dateStr}']`);
  if (!cell) {
    return;
  }
  const trigger = cell.querySelector('.note-trigger');
  if (!trigger) {
    return;
  }
  const tooltip = trigger.querySelector('.note-tooltip');
  const hasNote = noteText.trim().length > 0;
  trigger.dataset.noteText = noteText;
  trigger.classList.toggle('has-note', hasNote);
  trigger.setAttribute('aria-label', hasNote ? 'Edit daily note' : 'Add daily note');
  if (tooltip) {
    tooltip.textContent = noteText;
  }
}
</script>
{% endblock %}
