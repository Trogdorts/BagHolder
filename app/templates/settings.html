{% extends "base.html" %}
{% block content %}
<h1 class="text-xl font-semibold mb-4">Settings</h1>
{% if config_imported %}
  <div class="mb-4 rounded border border-green-800 bg-green-900/40 px-4 py-3 text-sm text-green-100">
    Configuration imported successfully.
  </div>
{% elif config_error_message %}
  <div class="mb-4 rounded border border-red-800 bg-red-900/40 px-4 py-3 text-sm text-red-100">
    {{ config_error_message }}
  </div>
{% endif %}
{% if backup_restored %}
  <div class="mb-4 rounded border border-green-800 bg-green-900/40 px-4 py-3 text-sm text-green-100">
    Backup imported successfully.
  </div>
{% elif backup_error_message %}
  <div class="mb-4 rounded border border-red-800 bg-red-900/40 px-4 py-3 text-sm text-red-100">
    {{ backup_error_message }}
  </div>
{% endif %}
{% if cleared %}
  <div class="mb-4 rounded border border-green-800 bg-green-900/40 px-4 py-3 text-sm text-green-100">
    All application data has been cleared.
  </div>
{% endif %}
{% if shutting_down %}
  <div class="mb-4 rounded border border-yellow-800 bg-yellow-900/40 px-4 py-3 text-sm text-yellow-100">
    The server is shutting down. You may now close this window.
  </div>
{% endif %}
{% set show_unrealized = cfg.ui.get('show_unrealized', True) %}
{% set unrealized_fill = cfg.ui.get('unrealized_fill_strategy', 'carry_forward') %}
{% set export_fill_empty = cfg.export.get('fill_empty_with_zero', True) %}
<form method="post" action="/settings" class="space-y-4 bg-neutral-950 p-4 rounded border border-neutral-800"
      x-data="{
        showUnrealizedSetting: {{ 'true' if show_unrealized else 'false' }},
        hasChanges: false,
        initialData: '',
        formEl: null,
        init() {
          this.formEl = this.$el;
          this.initialData = this.serializeForm();
          this.$watch('showUnrealizedSetting', () => this.evaluateChanges());
          this.formEl.addEventListener('input', () => this.evaluateChanges());
          this.formEl.addEventListener('change', () => this.evaluateChanges());
        },
        serializeForm() {
          if (!this.formEl) {
            return '';
          }
          const formData = new FormData(this.formEl);
          formData.set('show_unrealized', this.showUnrealizedSetting ? 'true' : 'false');
          return new URLSearchParams(formData).toString();
        },
        evaluateChanges() {
          this.hasChanges = this.serializeForm() !== this.initialData;
        },
        resetChanges() {
          this.initialData = this.serializeForm();
          this.hasChanges = false;
        }
      }"
      @submit="resetChanges()">
  <div x-show="hasChanges" x-cloak x-transition.opacity.duration.150ms
       class="rounded border border-yellow-800 bg-yellow-900/40 px-4 py-3 text-sm text-yellow-100">
    You have unsaved changes. Don't forget to save.
  </div>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <label class="block">
      <span class="block text-sm text-neutral-400">Theme</span>
      <select name="theme" class="bg-neutral-800 rounded px-2 py-1 w-full">
        <option value="dark" {% if cfg.ui.theme == 'dark' %}selected{% endif %}>Dark</option>
        <option value="light" {% if cfg.ui.theme == 'light' %}selected{% endif %}>Light</option>
      </select>
    </label>
    <label class="block">
      <span class="block text-sm text-neutral-400">Show numbers inside cells</span>
      <select name="show_text" class="bg-neutral-800 rounded px-2 py-1 w-full">
        <option value="true" {% if cfg.ui.show_text %}selected{% endif %}>True</option>
        <option value="false" {% if not cfg.ui.show_text %}selected{% endif %}>False</option>
      </select>
    </label>
    <div class="block">
      <span class="block text-sm text-neutral-400">Unrealized values</span>
      <input type="hidden" name="show_unrealized" value="{{ 'true' if show_unrealized else 'false' }}"
             :value="showUnrealizedSetting ? 'true' : 'false'">
      <button type="button"
              class="mt-1 w-full px-3 py-1 border border-neutral-700 rounded hover:bg-neutral-800 transition"
              :class="{ 'bg-neutral-800 text-neutral-100 border-neutral-600': !showUnrealizedSetting }"
              @click="showUnrealizedSetting = !showUnrealizedSetting"
              aria-pressed="{{ 'true' if show_unrealized else 'false' }}"
              :aria-pressed="showUnrealizedSetting.toString()">
        <span x-text="showUnrealizedSetting ? 'Hide by default' : 'Show by default'">
          {% if show_unrealized %}Hide by default{% else %}Show by default{% endif %}
        </span>
      </button>
      <p class="mt-1 text-xs text-neutral-500" x-show="!showUnrealizedSetting" x-cloak>
        Unrealized gains and losses will be hidden unless toggled on the calendar view.
      </p>
    </div>
    <label class="block">
      <span class="block text-sm text-neutral-400">Missing unrealized fill</span>
      <select name="unrealized_fill_strategy" class="bg-neutral-800 rounded px-2 py-1 w-full">
        <option value="carry_forward" {% if unrealized_fill == 'carry_forward' %}selected{% endif %}>Carry forward</option>
        <option value="average_neighbors" {% if unrealized_fill == 'average_neighbors' %}selected{% endif %}>Average nearest values</option>
      </select>
      <p class="mt-1 text-xs text-neutral-500">
        Choose how to populate days without an imported unrealized value on the calendar view.
      </p>
    </label>
    <label class="block">
      <span class="block text-sm text-neutral-400">Display weekends</span>
      <select name="show_weekends" class="bg-neutral-800 rounded px-2 py-1 w-full">
        <option value="false" {% if not cfg.ui.show_weekends %}selected{% endif %}>Hide</option>
        <option value="true" {% if cfg.ui.show_weekends %}selected{% endif %}>Show</option>
      </select>
    </label>
    <label class="block">
      <span class="block text-sm text-neutral-400">Default month view</span>
      <select name="default_view" class="bg-neutral-800 rounded px-2 py-1 w-full">
        <option value="latest" {% if cfg.view.default == 'latest' %}selected{% endif %}>Latest</option>
        <option value="last_viewed" {% if cfg.view.default == 'last_viewed' %}selected{% endif %}>Last Viewed</option>
      </select>
    </label>
    <label class="block">
      <span class="block text-sm text-neutral-400">Action icon color</span>
      <input type="color" name="icon_color" value="{{ cfg.ui.icon_color }}"
             class="bg-neutral-800 rounded px-2 py-1 w-full h-10 p-1 cursor-pointer">
    </label>
  </div>
  <div class="pt-4 border-t border-neutral-800">
    <h2 class="text-lg font-semibold mb-2">Export data</h2>
    <p class="text-sm text-neutral-500 mb-3">
      Choose how empty values should appear when exporting daily summaries.
    </p>
    <label class="block md:w-1/2">
      <span class="block text-sm text-neutral-400">Empty value handling</span>
      <select name="export_empty_values" class="bg-neutral-800 rounded px-2 py-1 w-full">
        <option value="zero" {% if export_fill_empty %}selected{% endif %}>Fill with 0</option>
        <option value="empty" {% if not export_fill_empty %}selected{% endif %}>Leave empty</option>
      </select>
    </label>
  </div>
  <button class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-500">Save</button>
</form>

<div class="mt-6 rounded border border-neutral-800 bg-neutral-950 p-4 space-y-3">
  <h2 class="text-lg font-semibold">Configuration</h2>
  <p class="text-sm text-neutral-500">
    Download a JSON copy of your current configuration or import a configuration that was previously exported.
  </p>
  <div class="grid gap-4 md:grid-cols-2">
    <a href="/settings/config/export"
       class="w-full inline-flex items-center justify-center rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-500"
       download>
      Download config (JSON)
    </a>
    <form method="post" action="/settings/config/import" class="space-y-2" enctype="multipart/form-data">
      <label class="block">
        <span class="block text-sm text-neutral-400">Import configuration file</span>
        <input type="file" name="config_file" accept=".json,application/json"
               class="mt-1 w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100"
               required>
      </label>
      <p class="text-xs text-neutral-500">
        Upload a JSON file exported from BagHolder. Missing values revert to their defaults.
      </p>
      <button type="submit" class="w-full inline-flex items-center justify-center rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-500">
        Import config
      </button>
    </form>
  </div>
</div>

<div class="mt-6 rounded border border-neutral-800 bg-neutral-950 p-4 space-y-3">
  <h2 class="text-lg font-semibold">Full backup</h2>
  <p class="text-sm text-neutral-500">
    Download a ZIP archive containing all application data, or restore from a previous export.
  </p>
  <div class="grid gap-4 md:grid-cols-2">
    <a href="/settings/backup/export"
       class="w-full inline-flex items-center justify-center rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-500"
       download>
      Download full backup (ZIP)
    </a>
    <form method="post" action="/settings/backup/import" class="space-y-2" enctype="multipart/form-data">
      <label class="block">
        <span class="block text-sm text-neutral-400">Import backup archive</span>
        <input type="file" name="backup_file" accept=".zip"
               class="mt-1 w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100"
               required>
      </label>
      <p class="text-xs text-neutral-500">
        Upload a ZIP file generated by BagHolder. The current database, notes, and configuration will be replaced.
      </p>
      <button class="w-full inline-flex items-center justify-center rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-500">
        Import backup
      </button>
    </form>
  </div>
</div>

<div class="mt-6 space-y-3 rounded border border-red-900 bg-red-950/40 p-4">
  <div>
    <h2 class="text-lg font-semibold text-red-200">Danger zone</h2>
    <p class="text-sm text-red-100/80">
      Clearing data removes every imported trade, calculated summary, and saved note. This action cannot be undone.
    </p>
  </div>
  <form method="post" action="/settings/clear-data"
        onsubmit="return confirm('This will delete all trades, summaries, and notes. Continue?');"
        class="space-y-2">
    <button class="w-full px-4 py-2 rounded bg-red-600 text-white hover:bg-red-500">Clear all data</button>
  </form>
  <form method="post" action="/settings/shutdown"
        onsubmit="return confirm('This will stop the server. Continue?');"
        class="space-y-2">
    <button class="w-full px-4 py-2 rounded border border-red-500 text-red-100 hover:bg-red-900/60">
      Shut down server
    </button>
  </form>
</div>
{% endblock %}
