{% extends "base.html" %}
{% block content %}
{% set show_unrealized = cfg.ui.get('show_unrealized', True) %}
{% set show_total = cfg.ui.get('show_total', True) %}
{% set show_trade_count = cfg.ui.get('show_trade_count', False) %}
{% set show_text = cfg.ui.get('show_text', True) %}
{% set show_weekends = cfg.ui.get('show_weekends', False) %}
{% set show_percentages = cfg.ui.get('show_percentages', True) %}
{% set default_view = cfg.view.get('default', 'latest') %}
{% set unrealized_fill = cfg.ui.get('unrealized_fill_strategy', 'carry_forward') %}
{% set export_fill_empty = cfg.export.get('fill_empty_with_zero', True) %}
{% set server_port = cfg.get('server', {}).get('port', 8012) %}
<div class="mx-auto flex w-full max-w-6xl flex-col gap-8 px-4 py-8 sm:px-6 lg:px-8">
  <header class="rounded-3xl border border-neutral-800/70 bg-gradient-to-br from-neutral-900/80 via-neutral-950/80 to-black/80 p-8 shadow-lg shadow-black/30">
    <div class="flex flex-col gap-2">
      <div>
        <p class="text-xs font-semibold uppercase tracking-wide text-blue-300">BagHolder</p>
        <h1 class="text-3xl font-semibold text-neutral-50 sm:text-4xl">Settings</h1>
      </div>
      <p class="max-w-2xl text-sm text-neutral-400">
        Fine-tune how BagHolder looks, calculates totals, and manages data without scrolling through empty space.
      </p>
    </div>
  </header>

  <nav aria-label="Settings sections" class="-mx-1 mt-2 flex flex-wrap gap-2 overflow-x-auto pb-1 text-sm text-neutral-400 sm:mt-0">
    <a href="#account-settings" class="rounded-full border border-neutral-800 bg-neutral-900/60 px-4 py-2 font-medium text-neutral-200 transition hover:border-blue-500/60 hover:text-blue-200">Portfolios</a>
    <a href="#display-settings" class="rounded-full border border-neutral-800 bg-neutral-900/60 px-4 py-2 font-medium text-neutral-200 transition hover:border-blue-500/60 hover:text-blue-200">Appearance</a>
    <a href="#calculation-settings" class="rounded-full border border-neutral-800 bg-neutral-900/60 px-4 py-2 font-medium text-neutral-200 transition hover:border-blue-500/60 hover:text-blue-200">Data handling</a>
    <a href="#server-settings" class="rounded-full border border-neutral-800 bg-neutral-900/60 px-4 py-2 font-medium text-neutral-200 transition hover:border-blue-500/60 hover:text-blue-200">Server</a>
    <a href="#palette-settings" class="rounded-full border border-neutral-800 bg-neutral-900/60 px-4 py-2 font-medium text-neutral-200 transition hover:border-blue-500/60 hover:text-blue-200">Palette</a>
    <a href="#diagnostic-settings" class="rounded-full border border-neutral-800 bg-neutral-900/60 px-4 py-2 font-medium text-neutral-200 transition hover:border-blue-500/60 hover:text-blue-200">Diagnostics</a>
    <a href="#stock-data-import" class="rounded-full border border-neutral-800 bg-neutral-900/60 px-4 py-2 font-medium text-neutral-200 transition hover:border-blue-500/60 hover:text-blue-200">Imports</a>
    <a href="#configuration-settings" class="rounded-full border border-neutral-800 bg-neutral-900/60 px-4 py-2 font-medium text-neutral-200 transition hover:border-blue-500/60 hover:text-blue-200">Configuration</a>
    <a href="#backup-settings" class="rounded-full border border-neutral-800 bg-neutral-900/60 px-4 py-2 font-medium text-neutral-200 transition hover:border-blue-500/60 hover:text-blue-200">Backups</a>
    <a href="#user-management" class="rounded-full border border-neutral-800 bg-neutral-900/60 px-4 py-2 font-medium text-neutral-200 transition hover:border-blue-500/60 hover:text-blue-200">User management</a>
  </nav>

  <div class="space-y-3">
    {% if config_imported %}
      <div class="alert alert-success px-4 py-3 text-sm">Configuration imported successfully.</div>
    {% elif config_error_message %}
      <div class="alert alert-error px-4 py-3 text-sm">{{ config_error_message }}</div>
    {% endif %}
    {% if account_status_message %}
      <div class="alert alert-success px-4 py-3 text-sm">{{ account_status_message }}</div>
    {% elif account_error_message %}
      <div class="alert alert-error px-4 py-3 text-sm">{{ account_error_message }}</div>
    {% endif %}
    {% if password_status_message %}
      <div class="alert alert-success px-4 py-3 text-sm">{{ password_status_message }}</div>
    {% elif password_error_message %}
      <div class="alert alert-error px-4 py-3 text-sm">{{ password_error_message }}</div>
    {% endif %}
    {% if user_status_message %}
      <div class="alert alert-success px-4 py-3 text-sm">{{ user_status_message }}</div>
    {% elif user_error_message %}
      <div class="alert alert-error px-4 py-3 text-sm">{{ user_error_message }}</div>
    {% endif %}
    {% if self_error_message %}
      <div class="alert alert-error px-4 py-3 text-sm">{{ self_error_message }}</div>
    {% endif %}
    {% if backup_restored %}
      <div class="alert alert-success px-4 py-3 text-sm">Backup imported successfully.</div>
    {% elif backup_error_message %}
      <div class="alert alert-error px-4 py-3 text-sm">{{ backup_error_message }}</div>
    {% endif %}
    {% if log_error_message %}
      <div class="alert alert-error px-4 py-3 text-sm">{{ log_error_message }}</div>
    {% endif %}
    {% if cleared %}
      <div class="alert alert-success px-4 py-3 text-sm">All portfolio data has been cleared while keeping user accounts intact.</div>
    {% endif %}
    {% if shutting_down %}
      <div class="alert alert-warning px-4 py-3 text-sm">The server is shutting down. You may now close this window.</div>
    {% endif %}
  </div>

  <div class="lg:grid lg:grid-cols-[minmax(0,240px)_minmax(0,1fr)] lg:items-start lg:gap-8">
    <aside class="sticky top-24 hidden h-fit flex-col gap-2 rounded-2xl border border-neutral-800/60 bg-neutral-950/70 px-4 py-5 text-sm text-neutral-400 shadow-lg shadow-black/30 lg:flex">
      <p class="text-xs font-semibold uppercase tracking-wide text-neutral-500">Quick navigation</p>
      <a href="#account-settings" class="rounded-lg px-3 py-2 font-medium text-neutral-300 transition hover:bg-neutral-900 hover:text-neutral-100">Portfolios</a>
      <a href="#display-settings" class="rounded-lg px-3 py-2 font-medium text-neutral-300 transition hover:bg-neutral-900 hover:text-neutral-100">Appearance &amp; calendar</a>
      <a href="#calculation-settings" class="rounded-lg px-3 py-2 font-medium text-neutral-300 transition hover:bg-neutral-900 hover:text-neutral-100">Data handling</a>
      <a href="#server-settings" class="rounded-lg px-3 py-2 font-medium text-neutral-300 transition hover:bg-neutral-900 hover:text-neutral-100">Server access</a>
      <a href="#palette-settings" class="rounded-lg px-3 py-2 font-medium text-neutral-300 transition hover:bg-neutral-900 hover:text-neutral-100">Color palette</a>
      <a href="#diagnostic-settings" class="rounded-lg px-3 py-2 font-medium text-neutral-300 transition hover:bg-neutral-900 hover:text-neutral-100">Diagnostics</a>
      <a href="#stock-data-import" class="rounded-lg px-3 py-2 font-medium text-neutral-300 transition hover:bg-neutral-900 hover:text-neutral-100">Imports</a>
      <a href="#configuration-settings" class="rounded-lg px-3 py-2 font-medium text-neutral-300 transition hover:bg-neutral-900 hover:text-neutral-100">Configuration</a>
      <a href="#backup-settings" class="rounded-lg px-3 py-2 font-medium text-neutral-300 transition hover:bg-neutral-900 hover:text-neutral-100">Full backup</a>
      <a href="#user-management" class="rounded-lg px-3 py-2 font-medium text-neutral-300 transition hover:bg-neutral-900 hover:text-neutral-100">User management</a>
    </aside>

    <div class="flex flex-col gap-6">
    <section id="account-settings" class="rounded-2xl border border-neutral-800/70 bg-neutral-900/70 p-6 shadow-xl shadow-black/20 backdrop-blur">
        <header class="mb-4 flex flex-col gap-1">
          <h2 class="text-lg font-semibold text-neutral-50">Portfolios</h2>
          <p class="text-sm text-neutral-400">Create dedicated data sets, rename them, and switch between portfolios with a click.</p>
        </header>
        <div class="flex flex-col gap-4">
          <form method="post" action="/settings/accounts/create" class="flex flex-col gap-2 sm:flex-row sm:items-center sm:gap-3">
            <input type="hidden" name="redirect_to" value="/settings">
            <label for="new-account-name" class="sr-only">Portfolio name</label>
            <input id="new-account-name" name="account_name" placeholder="Name this portfolio" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/50" autocomplete="off">
            <button class="btn btn-primary w-full px-4 py-2 text-sm sm:w-auto">Add portfolio</button>
          </form>
          <div class="space-y-3">
            {% for account in accounts %}
              {% set is_primary = account.id == 'primary' %}
              <div class="rounded-xl border border-neutral-800/80 bg-neutral-950/50 p-4 shadow-inner shadow-black/30">
                <div class="flex flex-wrap items-center justify-between gap-3">
                  <div>
                    <p class="text-sm font-semibold text-neutral-100">{{ account.name }}</p>
                    <p class="text-xs text-neutral-500">Data folder: {{ account.storage }}</p>
                  </div>
                  <form method="post" action="/settings/accounts/switch" class="flex items-center">
                    <input type="hidden" name="account_id" value="{{ account.id }}">
                    <input type="hidden" name="redirect_to" value="/settings">
                    <button class="btn btn-outline-primary px-3 py-1.5 text-xs font-semibold uppercase tracking-wide sm:text-sm" {% if account.is_active %}disabled{% endif %}>
                      {% if account.is_active %}Active portfolio{% else %}Set active{% endif %}
                    </button>
                  </form>
                </div>
                <form method="post" action="/settings/accounts/rename" class="mt-3 flex flex-col gap-2 sm:flex-row sm:items-center sm:gap-2">
                  <input type="hidden" name="account_id" value="{{ account.id }}">
                  <input type="hidden" name="redirect_to" value="/settings">
                  <label for="account-name-{{ account.id }}" class="sr-only">Portfolio name</label>
                  <input id="account-name-{{ account.id }}" name="account_name" value="{{ account.name }}" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/50" autocomplete="off">
                  <button class="btn btn-outline-primary px-3 py-2 text-sm sm:w-auto">Rename</button>
                </form>
                <div class="mt-4 flex flex-col gap-2 sm:flex-row sm:justify-end">
                  <form method="post" action="/settings/accounts/clear" class="flex w-full sm:w-auto"
                        onsubmit="return confirm('This will delete all trades, summaries, and notes for this portfolio. Continue?');">
                    <input type="hidden" name="account_id" value="{{ account.id }}">
                    <input type="hidden" name="redirect_to" value="/settings">
                    <button class="btn btn-outline-danger w-full px-3 py-2 text-sm sm:w-auto">
                      Clear portfolio data
                    </button>
                  </form>
                  <form method="post" action="/settings/accounts/delete" class="flex w-full sm:w-auto"
                        onsubmit="return confirm('This will permanently delete the portfolio and its data. Continue?');">
                    <input type="hidden" name="account_id" value="{{ account.id }}">
                    <input type="hidden" name="redirect_to" value="/settings">
                    <button class="btn btn-danger w-full px-3 py-2 text-sm sm:w-auto {% if is_primary %}opacity-60 cursor-not-allowed pointer-events-none{% endif %}"
                            {% if is_primary %}aria-disabled="true" tabindex="-1" disabled{% endif %}>
                      Delete portfolio
                    </button>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
          <div class="rounded-xl border border-neutral-800/80 bg-neutral-950/50 p-4 shadow-inner shadow-black/30">
            <div class="mb-3 flex flex-col gap-1">
              <h3 class="text-sm font-semibold text-neutral-100">Update password</h3>
              <p class="text-xs text-neutral-500">Change the credentials used to access BagHolder.</p>
            </div>
            <form method="post" action="/settings/account/password" class="grid gap-3 md:grid-cols-2">
              <input type="hidden" name="redirect_to" value="/settings">
              <div class="md:col-span-2">
                <label for="current-password" class="block text-xs font-medium uppercase tracking-wide text-neutral-400">Current password</label>
                <input id="current-password" name="current_password" type="password" autocomplete="current-password" required class="mt-1 w-full rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40">
              </div>
              <div>
                <label for="new-password" class="block text-xs font-medium uppercase tracking-wide text-neutral-400">New password</label>
                <input id="new-password" name="new_password" type="password" minlength="8" autocomplete="new-password" required class="mt-1 w-full rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40">
              </div>
              <div>
                <label for="confirm-new-password" class="block text-xs font-medium uppercase tracking-wide text-neutral-400">Confirm new password</label>
                <input id="confirm-new-password" name="confirm_password" type="password" minlength="8" autocomplete="new-password" required class="mt-1 w-full rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40">
              </div>
              <div class="md:col-span-2">
                <button class="btn btn-outline-primary w-full px-4 py-2 text-sm md:w-auto">Save password</button>
              </div>
            </form>
          </div>
        </div>
    </section>

    <form method="post" action="/settings" class="flex flex-col gap-6" x-data="settingsForm()" @submit="resetChanges()">
        <div x-show="hasChanges" x-cloak x-transition.opacity.duration.200ms class="rounded-lg border border-amber-500/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-200">
          You have unsaved changes. Don't forget to save before leaving this page.
        </div>

        <section id="display-settings" class="rounded-2xl border border-neutral-800/70 bg-neutral-900/70 p-6 shadow-xl shadow-black/20 backdrop-blur">
        <header class="mb-4 flex flex-col gap-1">
          <h2 class="text-lg font-semibold text-neutral-50">Appearance &amp; calendar</h2>
          <p class="text-sm text-neutral-400">Configure the default look and feel of the calendar.</p>
        </header>
        <div class="grid gap-5">
          <div class="grid gap-3 sm:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] sm:items-start">
            <div>
              <label for="theme" class="block text-sm font-medium text-neutral-200">Theme</label>
              <p class="mt-1 text-xs text-neutral-500">Switch between the dark and light presentation.</p>
            </div>
            <select id="theme" name="theme" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="dark" {% if cfg.ui.theme == 'dark' %}selected{% endif %}>Dark</option>
              <option value="light" {% if cfg.ui.theme == 'light' %}selected{% endif %}>Light</option>
            </select>
          </div>
          <div class="grid gap-3 sm:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] sm:items-start">
            <div>
              <label for="show_text" class="block text-sm font-medium text-neutral-200">Daily profit and loss</label>
              <p class="mt-1 text-xs text-neutral-500">Choose whether calendar cells show the numeric values.</p>
            </div>
            <select id="show_text" name="show_text" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="true" {% if show_text %}selected{% endif %}>Show values</option>
              <option value="false" {% if not show_text %}selected{% endif %}>Hide values</option>
            </select>
          </div>
          <div class="grid gap-3 sm:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] sm:items-start">
            <div>
              <label for="show_trade_count" class="block text-sm font-medium text-neutral-200">Trade count badges</label>
              <p class="mt-1 text-xs text-neutral-500">Show how many trades occurred each day.</p>
            </div>
            <select id="show_trade_count" name="show_trade_count" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="true" {% if show_trade_count %}selected{% endif %}>Show badges</option>
              <option value="false" {% if not show_trade_count %}selected{% endif %}>Hide badges</option>
            </select>
          </div>
          <div class="grid gap-3 sm:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] sm:items-start">
            <div>
              <label for="show_percentages" class="block text-sm font-medium text-neutral-200">Percentage change</label>
              <p class="mt-1 text-xs text-neutral-500">Display percent change badges alongside totals.</p>
            </div>
            <select id="show_percentages" name="show_percentages" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="true" {% if show_percentages %}selected{% endif %}>Show percentages</option>
              <option value="false" {% if not show_percentages %}selected{% endif %}>Hide percentages</option>
            </select>
          </div>
          <div class="grid gap-3 sm:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] sm:items-start">
            <div>
              <p class="block text-sm font-medium text-neutral-200">Unrealized values</p>
              <p class="mt-1 text-xs text-neutral-500" x-show="!showUnrealizedSetting" x-cloak>
                Unrealized gains and losses remain hidden until toggled from the calendar toolbar.
              </p>
            </div>
            <div>
              <input type="hidden" name="show_unrealized" value="{{ 'true' if show_unrealized else 'false' }}" :value="showUnrealizedSetting ? 'true' : 'false'">
              <button type="button" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm font-medium text-neutral-100 transition"
                      :class="{ 'bg-neutral-800 text-neutral-50 border-neutral-600': !showUnrealizedSetting }"
                      @click="showUnrealizedSetting = !showUnrealizedSetting"
                      aria-pressed="{{ 'true' if show_unrealized else 'false' }}"
                      :aria-pressed="showUnrealizedSetting.toString()">
                <span x-text="showUnrealizedSetting ? 'Hide by default' : 'Show by default'">
                  {% if show_unrealized %}Hide by default{% else %}Show by default{% endif %}
                </span>
              </button>
            </div>
          </div>
          <div class="grid gap-3 sm:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] sm:items-start">
            <div>
              <p class="block text-sm font-medium text-neutral-200">Total values</p>
              <p class="mt-1 text-xs text-neutral-500" x-show="!showTotalSetting" x-cloak>
                Hide or show the daily account total by default on the calendar.
              </p>
            </div>
            <div>
              <input type="hidden" name="show_total" value="{{ 'true' if show_total else 'false' }}" :value="showTotalSetting ? 'true' : 'false'">
              <button type="button" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm font-medium text-neutral-100 transition"
                      :class="{ 'bg-neutral-800 text-neutral-50 border-neutral-600': !showTotalSetting }"
                      @click="showTotalSetting = !showTotalSetting"
                      aria-pressed="{{ 'true' if show_total else 'false' }}"
                      :aria-pressed="showTotalSetting.toString()">
                <span x-text="showTotalSetting ? 'Hide by default' : 'Show by default'">
                  {% if show_total %}Hide by default{% else %}Show by default{% endif %}
                </span>
              </button>
            </div>
          </div>
          <div class="grid gap-3 sm:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] sm:items-start">
            <div>
              <label for="show_weekends" class="block text-sm font-medium text-neutral-200">Display weekends</label>
              <p class="mt-1 text-xs text-neutral-500">Choose whether Saturday and Sunday appear in the grid.</p>
            </div>
            <select id="show_weekends" name="show_weekends" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="false" {% if not show_weekends %}selected{% endif %}>Hide weekends</option>
              <option value="true" {% if show_weekends %}selected{% endif %}>Show weekends</option>
            </select>
          </div>
          <div class="grid gap-3 sm:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] sm:items-start">
            <div>
              <label for="default_view" class="block text-sm font-medium text-neutral-200">Default month view</label>
              <p class="mt-1 text-xs text-neutral-500">Decide where the calendar opens when you sign in.</p>
            </div>
            <select id="default_view" name="default_view" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="latest" {% if default_view == 'latest' %}selected{% endif %}>Jump to latest month</option>
              <option value="last_viewed" {% if default_view == 'last_viewed' %}selected{% endif %}>Remember last viewed</option>
            </select>
          </div>
        </div>
      </section>

      <section id="calculation-settings" class="rounded-2xl border border-neutral-800/70 bg-neutral-900/70 p-6 shadow-xl shadow-black/20 backdrop-blur">
        <header class="mb-4 flex flex-col gap-1">
          <h2 class="text-lg font-semibold text-neutral-50">Data handling</h2>
          <p class="text-sm text-neutral-400">Decide how missing values are calculated and exported.</p>
        </header>
        <div class="grid gap-5">
          <div class="grid gap-3 sm:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] sm:items-start">
            <div>
              <label for="unrealized_fill_strategy" class="block text-sm font-medium text-neutral-200">Missing unrealized values</label>
              <p class="mt-1 text-xs text-neutral-500">Determines how empty calendar days are filled when no unrealized value was imported.</p>
            </div>
            <select id="unrealized_fill_strategy" name="unrealized_fill_strategy" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="carry_forward" {% if unrealized_fill == 'carry_forward' %}selected{% endif %}>Carry forward last known</option>
              <option value="average_neighbors" {% if unrealized_fill == 'average_neighbors' %}selected{% endif %}>Average nearest values</option>
            </select>
          </div>
          <div class="grid gap-3 sm:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] sm:items-start">
            <div>
              <label for="export_empty_values" class="block text-sm font-medium text-neutral-200">Empty values in exports</label>
              <p class="mt-1 text-xs text-neutral-500">Control whether missing values export as zeros or blank cells.</p>
            </div>
            <select id="export_empty_values" name="export_empty_values" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="zero" {% if export_fill_empty %}selected{% endif %}>Fill with 0</option>
              <option value="empty" {% if not export_fill_empty %}selected{% endif %}>Leave empty</option>
            </select>
          </div>
        </div>
      </section>

      <section id="server-settings" class="rounded-2xl border border-neutral-800/70 bg-neutral-900/70 p-6 shadow-xl shadow-black/20 backdrop-blur">
        <header class="mb-4 flex flex-col gap-1">
          <h2 class="text-lg font-semibold text-neutral-50">Server access</h2>
          <p class="text-sm text-neutral-400">Adjust how the app listens for connections.</p>
        </header>
        <div class="grid gap-5">
          <div class="grid gap-3 sm:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] sm:items-start">
            <div>
              <label for="listening_port" class="block text-sm font-medium text-neutral-200">Listening port</label>
              <p class="mt-1 text-xs text-neutral-500">Choose the network port BagHolder binds to. A restart may be required for changes to take effect.</p>
            </div>
            <div class="flex flex-col gap-2">
              <input type="number" id="listening_port" name="listening_port" min="1" max="65535" value="{{ server_port }}" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <p class="text-[11px] uppercase tracking-wide text-neutral-600">Range: 1–65535</p>
            </div>
          </div>
        </div>
      </section>

      <section id="palette-settings" class="rounded-2xl border border-neutral-800/70 bg-neutral-900/70 p-6 shadow-xl shadow-black/20 backdrop-blur">
        <div class="mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h2 class="text-lg font-semibold text-neutral-50">Color palette</h2>
            <p class="mt-1 text-sm text-neutral-400">Adjust the interface accents used across the calendar, actions, and notes.</p>
          </div>
          <button type="button" class="btn btn-outline-primary px-3 py-2 text-sm"
                  @click="resetAllColors()"
                  :class="{ 'opacity-50 cursor-not-allowed pointer-events-none': colorsAreDefault() }"
                  :aria-disabled="colorsAreDefault().toString()"
                  :disabled="colorsAreDefault()">
            Reset palette
          </button>
        </div>
        <div class="grid gap-4">
          {% for group in color_groups | default([], true) %}
          <div class="rounded-xl border border-neutral-800/80 bg-neutral-950/50 p-4 shadow-inner shadow-black/30">
            <div class="mb-4 space-y-1">
              <h3 class="text-sm font-semibold text-neutral-100">{{ group.title }}</h3>
              <p class="text-xs text-neutral-500 leading-relaxed">{{ group.description }}</p>
            </div>
            <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
              {% for field in group.fields %}
              <label class="flex flex-col gap-2">
                <div class="flex items-center justify-between gap-2">
                  <span class="text-sm font-medium text-neutral-200">{{ field.label }}</span>
                  <button type="button" class="text-xs text-neutral-400 transition hover:text-neutral-100"
                          @click.prevent="resetColor('{{ field.name }}')"
                          :class="{ 'opacity-40 pointer-events-none': isColorDefault('{{ field.name }}') }"
                          :aria-disabled="isColorDefault('{{ field.name }}').toString()">
                    Reset
                  </button>
                </div>
                <input type="color" name="{{ field.name }}" value="{{ field.current }}" class="h-10 w-full cursor-pointer rounded border border-neutral-700 bg-transparent p-1">
                <p class="text-xs text-neutral-500 leading-snug">
                  {{ field.description }}
                  <span class="ml-1 uppercase tracking-wide text-[11px]">Default: {{ field.default | upper }}</span>
                </p>
              </label>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        </div>
      </section>

      <section id="diagnostic-settings" class="rounded-2xl border border-neutral-800/70 bg-neutral-900/70 p-6 shadow-xl shadow-black/20 backdrop-blur">
        <header class="mb-4 flex flex-col gap-1">
          <h2 class="text-lg font-semibold text-neutral-50">Diagnostics</h2>
          <p class="text-sm text-neutral-400">Persist detailed logs for troubleshooting and share them with support.</p>
        </header>
        <div class="grid gap-5">
          <div class="grid gap-3 sm:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] sm:items-start">
            <div>
              <label for="debug_logging" class="block text-sm font-medium text-neutral-200">Debug logging</label>
              <p class="mt-1 text-xs text-neutral-500">When enabled, verbose diagnostic entries are stored in the persistent log file.</p>
            </div>
            <select id="debug_logging" name="debug_logging" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="true" {% if debug_logging_enabled %}selected{% endif %}>Enabled</option>
              <option value="false" {% if not debug_logging_enabled %}selected{% endif %}>Disabled</option>
            </select>
          </div>
          <div class="grid gap-3 sm:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] sm:items-start">
            <div>
              <p class="block text-sm font-medium text-neutral-200">Export debug log</p>
              <p class="mt-1 text-xs text-neutral-500">
                {% if log_export_available %}
                  Download the latest log for sharing with support.
                {% else %}
                  A log file appears here once the app records diagnostic events.
                {% endif %}
              </p>
            </div>
            <a href="/settings/logs/export" class="btn btn-outline-primary w-full px-4 py-2 text-sm {% if not log_export_available %}opacity-60 cursor-not-allowed pointer-events-none{% endif %}"
               {% if not log_export_available %}aria-disabled="true" tabindex="-1"{% endif %}>
              Download log
            </a>
          </div>
        </div>
      </section>

      <div class="flex flex-col items-stretch justify-between gap-3 rounded-2xl border border-neutral-800/70 bg-neutral-900/70 p-5 shadow-xl shadow-black/20 backdrop-blur sm:flex-row sm:items-center">
        <p class="text-xs text-neutral-500" x-show="!hasChanges" x-cloak>All changes are synced with the current configuration.</p>
        <button type="submit" class="btn btn-primary w-full px-5 py-2.5 sm:w-auto"
                :class="{ 'opacity-60 cursor-not-allowed': !hasChanges }"
                :disabled="!hasChanges">
          Save changes
        </button>
      </div>
    </form>

    <section id="stock-data-import" class="rounded-2xl border border-neutral-800/70 bg-neutral-900/70 p-6 shadow-xl shadow-black/20 backdrop-blur">
        <header class="mb-4">
          <h2 class="text-lg font-semibold text-neutral-50">Import trade history</h2>
          <p class="mt-1 text-sm text-neutral-400">Upload CSV trade summaries or ThinkOrSwim statements.</p>
          <p class="mt-3 text-xs text-neutral-400">
            Imports are applied to <span class="font-semibold text-neutral-100">{{ active_account.name }}</span>
            (<span class="text-neutral-300">{{ active_account.storage }}</span>)
            portfolio.
          </p>
        </header>
        <div class="space-y-5">
          <div class="rounded-xl border border-neutral-800/80 bg-neutral-950/50 p-4 shadow-inner shadow-black/30">
            <h3 class="text-sm font-semibold text-neutral-100">Stock buy &amp; sell CSV data</h3>
            <p class="mt-1 text-xs text-neutral-500">Import executed trades from a CSV with the columns date, symbol, action, qty, price, amount.</p>
            {% if trade_csv_error_message %}
            <div class="mt-3 rounded border border-red-500/60 bg-red-500/10 px-3 py-2 text-xs text-red-200">{{ trade_csv_error_message }}</div>
            {% endif %}
            <form action="/import/trades" method="post" enctype="multipart/form-data" class="mt-4 flex flex-col gap-3">
              <input type="file" name="file" accept=".csv" class="block w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 file:mr-4 file:rounded-md file:border-0 file:bg-neutral-800 file:px-4 file:py-2 file:text-neutral-200 hover:file:bg-neutral-700">
              <button class="btn btn-primary px-4 py-2">Upload</button>
            </form>
          </div>
          <div class="rounded-xl border border-neutral-800/80 bg-neutral-950/50 p-4 shadow-inner shadow-black/30">
            <h3 class="text-sm font-semibold text-neutral-100">ThinkOrSwim account statement</h3>
            <p class="mt-1 text-xs text-neutral-500">Only trade fields are persisted (date, symbol, action, qty, price, amount). Account identifiers are discarded after parsing.</p>
            {% if thinkorswim_error_message %}
            <div class="mt-3 rounded border border-red-500/60 bg-red-500/10 px-3 py-2 text-xs text-red-200">{{ thinkorswim_error_message }}</div>
            {% endif %}
            <form action="/import/thinkorswim" method="post" enctype="multipart/form-data" class="mt-4 flex flex-col gap-3">
              <input type="file" name="file" accept=".csv" class="block w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 file:mr-4 file:rounded-md file:border-0 file:bg-neutral-800 file:px-4 file:py-2 file:text-neutral-200 hover:file:bg-neutral-700">
              <button class="btn btn-primary px-4 py-2">Upload</button>
            </form>
          </div>
        </div>
    </section>

    <section id="configuration-settings" class="rounded-2xl border border-neutral-800/70 bg-neutral-900/70 p-6 shadow-xl shadow-black/20 backdrop-blur">
        <header class="mb-4">
          <h2 class="text-lg font-semibold text-neutral-50">Configuration</h2>
          <p class="mt-1 text-sm text-neutral-400">Export the current configuration or apply a previously exported JSON file.</p>
        </header>
        <div class="flex flex-col gap-4">
          <a href="/settings/config/export" class="btn btn-primary px-4 py-2 text-center" download>
            Download config (JSON)
          </a>
          <form method="post" action="/settings/config/import" class="flex flex-col gap-3" enctype="multipart/form-data">
            <label class="flex flex-col gap-2 text-sm font-medium text-neutral-200">
              Import configuration file
              <input type="file" name="config_file" accept=".json,application/json" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100" required>
            </label>
            <p class="text-xs text-neutral-500">Upload a JSON file exported from BagHolder. Missing values revert to their defaults.</p>
            <button type="submit" class="btn btn-primary w-full px-4 py-2">Import config</button>
          </form>
        </div>
    </section>

    <section id="backup-settings" class="rounded-2xl border border-neutral-800/70 bg-neutral-900/70 p-6 shadow-xl shadow-black/20 backdrop-blur">
        <header class="mb-4">
          <h2 class="text-lg font-semibold text-neutral-50">Full backup</h2>
          <p class="mt-1 text-sm text-neutral-400">Create or restore a ZIP archive containing all application data.</p>
        </header>
        <div class="flex flex-col gap-4">
          <a href="/settings/backup/export" class="btn btn-primary px-4 py-2 text-center" download>
            Download full backup (ZIP)
          </a>
          <form method="post" action="/settings/backup/import" class="flex flex-col gap-3" enctype="multipart/form-data">
            <label class="flex flex-col gap-2 text-sm font-medium text-neutral-200">
              Import backup archive
              <input type="file" name="backup_file" accept=".zip" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100" required>
            </label>
            <p class="text-xs text-neutral-500">Upload a ZIP file generated by BagHolder. Existing data will be replaced.</p>
            <button class="btn btn-primary w-full px-4 py-2">Import backup</button>
          </form>
        </div>
    </section>

    <section id="user-management" class="rounded-2xl border border-neutral-800/70 bg-neutral-900/70 p-6 shadow-xl shadow-black/20 backdrop-blur">
        <header class="mb-4">
          <h2 class="text-lg font-semibold text-neutral-50">User management</h2>
          <p class="mt-1 text-sm text-neutral-400">Invite teammates, update credentials, and manage administrative tools.</p>
        </header>
        {% if current_user and current_user.is_admin %}
          <div class="space-y-6">
            <div class="rounded-xl border border-neutral-800/70 bg-neutral-950/50 p-5">
              <div class="mb-4">
                <h3 class="text-sm font-semibold text-neutral-100">Team access</h3>
                <p class="text-xs text-neutral-400">Invite new administrators or remove existing users from BagHolder.</p>
              </div>
              <div class="space-y-4">
                <div>
                  <p class="text-xs font-semibold uppercase tracking-wide text-neutral-500">Current users</p>
                  <div class="mt-2 space-y-2">
                    {% if managed_users %}
                      {% for user in managed_users %}
                        <div class="flex items-center justify-between rounded-lg border border-neutral-800/60 bg-neutral-900/70 px-3 py-2">
                          <div>
                            <p class="text-sm font-medium text-neutral-100">
                              {{ user.username }}
                              {% if current_user and user.id|int == current_user.id %}<span class="text-xs text-neutral-400">(you)</span>{% endif %}
                            </p>
                            <p class="text-[11px] text-neutral-500">Added {{ user.created_at }}</p>
                          </div>
                          <span class="rounded-full border border-blue-500/40 px-2 py-0.5 text-[10px] uppercase tracking-widest text-blue-200/90">{% if user.is_admin %}Admin{% else %}User{% endif %}</span>
                        </div>
                      {% endfor %}
                    {% else %}
                      <p class="text-xs text-neutral-400">No users have been configured yet.</p>
                    {% endif %}
                  </div>
                </div>
                <form method="post" action="/settings/users/create" class="grid gap-3 sm:grid-cols-2">
                  <input type="hidden" name="redirect_to" value="/settings">
                  <label class="flex flex-col gap-1 text-xs font-medium uppercase tracking-wide text-neutral-500">
                    Username
                    <input name="username" class="rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40" autocomplete="off" required>
                  </label>
                  <label class="flex flex-col gap-1 text-xs font-medium uppercase tracking-wide text-neutral-500">
                    Password
                    <input type="password" name="password" class="rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40" minlength="8" required>
                  </label>
                  <label class="flex flex-col gap-1 text-xs font-medium uppercase tracking-wide text-neutral-500">
                    Confirm password
                    <input type="password" name="confirm_password" class="rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40" minlength="8" required>
                  </label>
                  <label class="flex items-center gap-2 text-xs font-medium uppercase tracking-wide text-neutral-500">
                    <input type="checkbox" name="is_admin" value="true" class="h-4 w-4 rounded border-neutral-700 bg-neutral-900 text-blue-500 focus:ring-blue-500">
                    Grant administrator access
                  </label>
                  <div class="sm:col-span-2">
                    <button class="btn btn-primary w-full px-4 py-2 text-sm">Add user</button>
                  </div>
                </form>
                <form method="post" action="/settings/users/reset-password" class="grid gap-3 sm:grid-cols-2">
                  <input type="hidden" name="redirect_to" value="/settings">
                  <label class="flex flex-col gap-1 text-xs font-medium uppercase tracking-wide text-neutral-500">
                    Select user
                    <select name="user_id" class="rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40" required>
                      <option value="" disabled selected>Choose a user</option>
                      {% for user in managed_users %}
                        <option value="{{ user.id }}">{{ user.username }}{% if user.is_admin %} (admin){% endif %}</option>
                      {% endfor %}
                    </select>
                  </label>
                  <div class="grid gap-3 sm:grid-cols-2 sm:col-span-2">
                    <label class="flex flex-col gap-1 text-xs font-medium uppercase tracking-wide text-neutral-500">
                      New password
                      <input type="password" name="new_password" class="rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40" minlength="8" required>
                    </label>
                    <label class="flex flex-col gap-1 text-xs font-medium uppercase tracking-wide text-neutral-500">
                      Confirm password
                      <input type="password" name="confirm_password" class="rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40" minlength="8" required>
                    </label>
                  </div>
                  <div class="sm:col-span-2">
                    <button class="btn btn-outline-danger w-full px-4 py-2 text-sm">Reset user password</button>
                  </div>
                </form>
                <form method="post" action="/settings/users/delete" class="flex flex-col gap-3 sm:flex-row sm:items-end">
                  <input type="hidden" name="redirect_to" value="/settings">
                  <label class="flex w-full flex-col gap-1 text-xs font-medium uppercase tracking-wide text-neutral-500">
                    Remove user
                    <select name="user_id" class="rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40" required>
                      <option value="" disabled selected>Select a user</option>
                      {% for user in managed_users %}
                        <option value="{{ user.id }}">{{ user.username }}{% if user.is_admin %} (admin){% endif %}</option>
                      {% endfor %}
                    </select>
                  </label>
                  <button class="btn btn-outline-danger w-full px-4 py-2 text-sm sm:w-auto">Delete user</button>
                </form>
                <p class="text-[11px] text-neutral-500">Administrators cannot delete their own account from this list. Use the personal controls below to remove yourself.</p>
              </div>
            </div>
            <div class="rounded-xl border border-neutral-800/70 bg-neutral-950/50 p-5">
              <div class="mb-4">
                <h3 class="text-sm font-semibold text-neutral-100">Application maintenance</h3>
                <p class="text-xs text-neutral-400">Reset trading data or safely restart the server when maintenance is required.</p>
              </div>
              <form method="post" action="/settings/clear-data" class="flex flex-col gap-3"
                    onsubmit="return confirm('This will remove all trades, summaries, notes, and configuration data for every portfolio. User accounts will remain. Continue?');">
                <input type="hidden" name="redirect_to" value="/settings">
                <button class="btn btn-danger w-full px-4 py-2">Reset application data</button>
              </form>
              <form method="post" action="/settings/shutdown" class="mt-3 flex flex-col gap-3"
                    onsubmit="return confirm('This will stop the server. Continue?');">
                <button class="btn btn-outline-danger w-full px-4 py-2">Shut down server</button>
              </form>
            </div>
            <div class="rounded-xl border border-neutral-800/70 bg-neutral-950/50 p-5">
              <div class="mb-3">
                <h3 class="text-sm font-semibold text-neutral-100">Personal account</h3>
                <p class="text-xs text-neutral-400">Remove your own login once another administrator is available to manage the system.</p>
              </div>
              <form method="post" action="/settings/account/delete" class="flex flex-col gap-3"
                    onsubmit="return confirm('This will permanently delete your user account and sign you out. Continue?');">
                <input type="hidden" name="redirect_to" value="/settings">
                <button class="btn btn-outline-danger w-full px-4 py-2">Delete my account</button>
              </form>
            </div>
          </div>
        {% else %}
          <div class="rounded-xl border border-neutral-800/70 bg-neutral-950/50 p-5">
            <div class="mb-3">
              <h3 class="text-sm font-semibold text-neutral-100">Delete my account</h3>
              <p class="text-xs text-neutral-400">Remove your access to BagHolder. This action is permanent and cannot be undone.</p>
            </div>
            <form method="post" action="/settings/account/delete" class="flex flex-col gap-3"
                  onsubmit="return confirm('This will permanently delete your user account and sign you out. Continue?');">
              <input type="hidden" name="redirect_to" value="/settings">
              <button class="btn btn-danger w-full px-4 py-2">Delete my account</button>
            </form>
            <p class="mt-3 text-xs text-neutral-400">Need other help? Contact an administrator to reset data or invite you again.</p>
          </div>
        {% endif %}
    </section>
    <a href="https://buymeacoffee.com/crissejdav6" target="_blank" rel="noopener noreferrer"
       class="btn btn-outline-danger inline-flex w-full justify-center rounded-full px-4 py-2 text-xs uppercase tracking-wide">
      Buy me a coffee
    </a>
    </div>
  </div>
</div>
<script>
  document.addEventListener('alpine:init', () => {
    Alpine.data('settingsForm', () => ({
      showUnrealizedSetting: {{ 'true' if show_unrealized else 'false' }},
      showTotalSetting: {{ 'true' if show_total else 'false' }},
      hasChanges: false,
      initialData: '',
      formEl: null,
      defaultColors: {{ color_defaults | default({}, true) | tojson | safe }},
      init() {
        this.formEl = this.$el;
        this.initialData = this.serializeForm();
        this.$watch('showUnrealizedSetting', () => this.evaluateChanges());
        this.$watch('showTotalSetting', () => this.evaluateChanges());
        this.formEl.addEventListener('input', () => this.evaluateChanges());
        this.formEl.addEventListener('change', () => this.evaluateChanges());
      },
      serializeForm() {
        if (!this.formEl) {
          return '';
        }
        const formData = new FormData(this.formEl);
        formData.set('show_unrealized', this.showUnrealizedSetting ? 'true' : 'false');
        formData.set('show_total', this.showTotalSetting ? 'true' : 'false');
        return new URLSearchParams(formData).toString();
      },
      evaluateChanges() {
        this.hasChanges = this.serializeForm() !== this.initialData;
      },
      resetChanges() {
        this.initialData = this.serializeForm();
        this.hasChanges = false;
      },
      isColorDefault(field) {
        const defaultValue = this.defaultColors[field];
        if (!this.formEl || typeof defaultValue !== 'string') {
          return false;
        }
        const input = this.formEl.querySelector(`[name='${field}']`);
        if (!input) {
          return false;
        }
        return input.value.toLowerCase() === defaultValue.toLowerCase();
      },
      resetColor(field) {
        const defaultValue = this.defaultColors[field];
        if (typeof defaultValue !== 'string' || !this.formEl) {
          return;
        }
        const input = this.formEl.querySelector(`[name='${field}']`);
        if (!input) {
          return;
        }
        input.value = defaultValue.toLowerCase();
        input.dispatchEvent(new Event('input', { bubbles: true }));
        input.dispatchEvent(new Event('change', { bubbles: true }));
        this.evaluateChanges();
      },
      resetAllColors() {
        if (!this.formEl) {
          return;
        }
        Object.keys(this.defaultColors).forEach((field) => {
          this.resetColor(field);
        });
      },
      colorsAreDefault() {
        if (!this.formEl) {
          return false;
        }
        return Object.keys(this.defaultColors).every((field) => this.isColorDefault(field));
      }
    }));
  });
</script>
{% endblock %}
