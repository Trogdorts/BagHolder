{% extends "base.html" %}
{% block content %}
{% set show_market_value = cfg.ui.get('show_market_value', cfg.ui.get('show_total', True)) %}
{% set show_trade_count = cfg.ui.get('show_trade_count', False) %}
{% set show_text = cfg.ui.get('show_text', True) %}
{% set show_weekends = cfg.ui.get('show_weekends', False) %}
{% set show_percentages = cfg.ui.get('show_percentages', True) %}
{% set default_view = cfg.view.get('default', 'latest') %}
{% set export_fill_empty = cfg.export.get('fill_empty_with_zero', True) %}
{% set server_port = cfg.get('server', {}).get('port', 8012) %}
{% set running_in_docker = running_in_docker | default(false) %}
<div class="mx-auto flex w-full max-w-6xl flex-col gap-8 px-4 py-8 sm:px-6 lg:px-8">
  <header class="rounded-3xl border border-neutral-800/70 bg-gradient-to-br from-neutral-900/80 via-neutral-950/80 to-black/80 p-8 shadow-lg shadow-black/30">
    <div class="flex flex-col gap-2">
      <div>
        <p class="text-xs font-semibold uppercase tracking-wide text-blue-300">BagHolder</p>
        <h1 class="text-3xl font-semibold text-neutral-50 sm:text-4xl">Settings</h1>
      </div>
      <p class="max-w-2xl text-sm text-neutral-400">
        Fine-tune how BagHolder looks, calculates totals, and manages data without scrolling through empty space.
      </p>
    </div>
  </header>

  <nav aria-label="Settings sections" class="-mx-1 mt-2 flex flex-wrap gap-2 overflow-x-auto pb-1 text-sm text-neutral-400 sm:mt-0">
    <a href="#account-settings" class="rounded-full border border-neutral-800 bg-neutral-900/60 px-4 py-2 font-medium text-neutral-200 transition hover:border-blue-500/60 hover:text-blue-200">Portfolios</a>
    <a href="#display-settings" class="rounded-full border border-neutral-800 bg-neutral-900/60 px-4 py-2 font-medium text-neutral-200 transition hover:border-blue-500/60 hover:text-blue-200">Appearance</a>
    <a href="#calculation-settings" class="rounded-full border border-neutral-800 bg-neutral-900/60 px-4 py-2 font-medium text-neutral-200 transition hover:border-blue-500/60 hover:text-blue-200">Data handling</a>
    <a href="#server-settings" class="rounded-full border border-neutral-800 bg-neutral-900/60 px-4 py-2 font-medium text-neutral-200 transition hover:border-blue-500/60 hover:text-blue-200">Server</a>
    <a href="#palette-settings" class="rounded-full border border-neutral-800 bg-neutral-900/60 px-4 py-2 font-medium text-neutral-200 transition hover:border-blue-500/60 hover:text-blue-200">Palette</a>
    <a href="#diagnostic-settings" class="rounded-full border border-neutral-800 bg-neutral-900/60 px-4 py-2 font-medium text-neutral-200 transition hover:border-blue-500/60 hover:text-blue-200">Diagnostics</a>
    <a href="#stock-data-import" class="rounded-full border border-neutral-800 bg-neutral-900/60 px-4 py-2 font-medium text-neutral-200 transition hover:border-blue-500/60 hover:text-blue-200">Imports</a>
    <a href="#configuration-settings" class="rounded-full border border-neutral-800 bg-neutral-900/60 px-4 py-2 font-medium text-neutral-200 transition hover:border-blue-500/60 hover:text-blue-200">Configuration</a>
    <a href="#backup-settings" class="rounded-full border border-neutral-800 bg-neutral-900/60 px-4 py-2 font-medium text-neutral-200 transition hover:border-blue-500/60 hover:text-blue-200">Backups</a>
    <a href="#user-management" class="rounded-full border border-neutral-800 bg-neutral-900/60 px-4 py-2 font-medium text-neutral-200 transition hover:border-blue-500/60 hover:text-blue-200">User management</a>
    <a href="#contact-support" class="rounded-full border border-neutral-800 bg-neutral-900/60 px-4 py-2 font-medium text-neutral-200 transition hover:border-blue-500/60 hover:text-blue-200">Contact</a>
  </nav>

  <div class="space-y-3">
    {% if config_imported %}
      <div class="alert alert-success px-4 py-3 text-sm">Configuration imported successfully.</div>
    {% elif config_error_message %}
      <div class="alert alert-error px-4 py-3 text-sm">{{ config_error_message }}</div>
    {% endif %}
    {% if account_status_message %}
      <div class="alert alert-success px-4 py-3 text-sm">{{ account_status_message }}</div>
    {% elif account_error_message %}
      <div class="alert alert-error px-4 py-3 text-sm">{{ account_error_message }}</div>
    {% endif %}
    {% if password_status_message %}
      <div class="alert alert-success px-4 py-3 text-sm">{{ password_status_message }}</div>
    {% elif password_error_message %}
      <div class="alert alert-error px-4 py-3 text-sm">{{ password_error_message }}</div>
    {% endif %}
    {% if user_status_message %}
      <div class="alert alert-success px-4 py-3 text-sm">{{ user_status_message }}</div>
    {% elif user_error_message %}
      <div class="alert alert-error px-4 py-3 text-sm">{{ user_error_message }}</div>
    {% endif %}
    {% if self_error_message %}
      <div class="alert alert-error px-4 py-3 text-sm">{{ self_error_message }}</div>
    {% endif %}
    {% if backup_restored %}
      <div class="alert alert-success px-4 py-3 text-sm">Backup imported successfully.</div>
    {% elif backup_error_message %}
      <div class="alert alert-error px-4 py-3 text-sm">{{ backup_error_message }}</div>
    {% endif %}
    {% if log_error_message %}
      <div class="alert alert-error px-4 py-3 text-sm">{{ log_error_message }}</div>
    {% endif %}
    {% if cleared %}
      <div class="alert alert-success px-4 py-3 text-sm">All portfolio data has been cleared while keeping user accounts intact.</div>
    {% endif %}
    {% if shutting_down %}
      <div class="alert alert-warning px-4 py-3 text-sm">The server is shutting down. You may now close this window.</div>
    {% endif %}
  </div>

  <div class="lg:grid lg:grid-cols-[minmax(0,240px)_minmax(0,1fr)] lg:items-start lg:gap-8">
    <aside class="sticky top-24 hidden h-fit flex-col gap-2 rounded-2xl border border-neutral-800/60 bg-neutral-950/70 px-4 py-5 text-sm text-neutral-400 shadow-lg shadow-black/30 lg:flex">
      <p class="text-xs font-semibold uppercase tracking-wide text-neutral-500">Quick navigation</p>
      <a href="#account-settings" class="rounded-lg px-3 py-2 font-medium text-neutral-300 transition hover:bg-neutral-900 hover:text-neutral-100">Portfolios</a>
      <a href="#display-settings" class="rounded-lg px-3 py-2 font-medium text-neutral-300 transition hover:bg-neutral-900 hover:text-neutral-100">Appearance &amp; calendar</a>
      <a href="#calculation-settings" class="rounded-lg px-3 py-2 font-medium text-neutral-300 transition hover:bg-neutral-900 hover:text-neutral-100">Data handling</a>
      <a href="#server-settings" class="rounded-lg px-3 py-2 font-medium text-neutral-300 transition hover:bg-neutral-900 hover:text-neutral-100">Server access</a>
      <a href="#palette-settings" class="rounded-lg px-3 py-2 font-medium text-neutral-300 transition hover:bg-neutral-900 hover:text-neutral-100">Color palette</a>
      <a href="#diagnostic-settings" class="rounded-lg px-3 py-2 font-medium text-neutral-300 transition hover:bg-neutral-900 hover:text-neutral-100">Diagnostics</a>
      <a href="#stock-data-import" class="rounded-lg px-3 py-2 font-medium text-neutral-300 transition hover:bg-neutral-900 hover:text-neutral-100">Imports</a>
      <a href="#configuration-settings" class="rounded-lg px-3 py-2 font-medium text-neutral-300 transition hover:bg-neutral-900 hover:text-neutral-100">Configuration</a>
      <a href="#backup-settings" class="rounded-lg px-3 py-2 font-medium text-neutral-300 transition hover:bg-neutral-900 hover:text-neutral-100">Full backup</a>
      <a href="#user-management" class="rounded-lg px-3 py-2 font-medium text-neutral-300 transition hover:bg-neutral-900 hover:text-neutral-100">User management</a>
      <a href="#contact-support" class="rounded-lg px-3 py-2 font-medium text-neutral-300 transition hover:bg-neutral-900 hover:text-neutral-100">Contact</a>
    </aside>

    <div class="flex flex-col gap-6">
    <section id="account-settings" class="rounded-2xl border border-neutral-800/70 bg-neutral-900/70 p-6 shadow-xl shadow-black/20 backdrop-blur">
        <header class="mb-4 flex flex-col gap-1">
          <h2 class="text-lg font-semibold text-neutral-50">Portfolios</h2>
          <p class="text-sm text-neutral-400">Create dedicated data sets, rename them, and switch between portfolios with a click.</p>
        </header>
        <div class="flex flex-col gap-4">
          <form method="post" action="/settings/accounts/create" class="flex flex-col gap-2 sm:flex-row sm:items-center sm:gap-3">
            <input type="hidden" name="redirect_to" value="/settings">
            <label for="new-account-name" class="sr-only">Portfolio name</label>
            <input id="new-account-name" name="account_name" placeholder="Name this portfolio" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/50" autocomplete="off">
            <button class="btn btn-primary w-full px-4 py-2 text-sm sm:w-auto">Add portfolio</button>
          </form>
          <div class="space-y-3">
            {% for account in accounts %}
              {% set is_primary = account.id == 'primary' %}
              <div class="rounded-xl border border-neutral-800/80 bg-neutral-950/50 p-4 shadow-inner shadow-black/30" data-account-card="{{ account.id }}">
                <div class="flex flex-wrap items-center justify-between gap-3">
                  <div>
                    <p class="text-sm font-semibold text-neutral-100">{{ account.name }}</p>
                    <p class="text-xs text-neutral-500">Data folder: {{ account.storage }}</p>
                  </div>
                  <form method="post" action="/settings/accounts/switch" class="flex items-center">
                    <input type="hidden" name="account_id" value="{{ account.id }}">
                    <input type="hidden" name="redirect_to" value="/settings">
                    <button class="btn btn-outline-primary px-3 py-1.5 text-xs font-semibold uppercase tracking-wide sm:text-sm" {% if account.is_active %}disabled{% endif %}>
                      {% if account.is_active %}Active portfolio{% else %}Set active{% endif %}
                    </button>
                  </form>
                </div>
                <form method="post" action="/settings/accounts/rename" class="mt-3 flex flex-col gap-2 sm:flex-row sm:items-center sm:gap-2">
                  <input type="hidden" name="account_id" value="{{ account.id }}">
                  <input type="hidden" name="redirect_to" value="/settings">
                  <label for="account-name-{{ account.id }}" class="sr-only">Portfolio name</label>
                  <input id="account-name-{{ account.id }}" name="account_name" value="{{ account.name }}" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/50" autocomplete="off">
                  <button class="btn btn-outline-primary px-3 py-2 text-sm sm:w-auto">Rename</button>
                </form>
                <div class="mt-4 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                  <p class="text-xs text-neutral-400 sm:max-w-xs">
                    Replace this portfolio with simulated trades to explore BagHolder without importing your own data.
                  </p>
                  <button type="button"
                          class="btn btn-outline-primary px-3 py-2 text-sm sm:w-auto"
                          data-simulate-trades="{{ account.id }}">
                    Simulate trades
                  </button>
                </div>
                <p class="mt-2 text-xs text-neutral-400 hidden" data-simulate-status aria-live="polite"></p>
                <div class="mt-4 flex flex-col gap-2 sm:flex-row sm:justify-end">
                  <form method="post" action="/settings/accounts/clear" class="flex w-full sm:w-auto"
                        onsubmit="return confirm('This will delete all trades, summaries, and notes for this portfolio. Continue?');">
                    <input type="hidden" name="account_id" value="{{ account.id }}">
                    <input type="hidden" name="redirect_to" value="/settings">
                    <button class="btn btn-outline-danger w-full px-3 py-2 text-sm sm:w-auto">
                      Clear portfolio data
                    </button>
                  </form>
                  <form method="post" action="/settings/accounts/delete" class="flex w-full sm:w-auto"
                        onsubmit="return confirm('This will permanently delete the portfolio and its data. Continue?');">
                    <input type="hidden" name="account_id" value="{{ account.id }}">
                    <input type="hidden" name="redirect_to" value="/settings">
                    <button class="btn btn-danger w-full px-3 py-2 text-sm sm:w-auto {% if is_primary %}opacity-60 cursor-not-allowed pointer-events-none{% endif %}"
                            {% if is_primary %}aria-disabled="true" tabindex="-1" disabled{% endif %}>
                      Delete portfolio
                    </button>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
          <div class="rounded-xl border border-neutral-800/80 bg-neutral-950/50 p-4 shadow-inner shadow-black/30">
            <div class="mb-3 flex flex-col gap-1">
              <h3 class="text-sm font-semibold text-neutral-100">Update password</h3>
              <p class="text-xs text-neutral-500">Change the credentials used to access BagHolder.</p>
            </div>
            <form method="post" action="/settings/account/password" class="grid gap-3 md:grid-cols-2">
              <input type="hidden" name="redirect_to" value="/settings">
              <div class="md:col-span-2">
                <label for="current-password" class="block text-xs font-medium uppercase tracking-wide text-neutral-400">Current password</label>
                <input id="current-password" name="current_password" type="password" autocomplete="current-password" required class="mt-1 w-full rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40">
              </div>
              <div>
                <label for="new-password" class="block text-xs font-medium uppercase tracking-wide text-neutral-400">New password</label>
                <input id="new-password" name="new_password" type="password" minlength="8" autocomplete="new-password" required class="mt-1 w-full rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40">
              </div>
              <div>
                <label for="confirm-new-password" class="block text-xs font-medium uppercase tracking-wide text-neutral-400">Confirm new password</label>
                <input id="confirm-new-password" name="confirm_password" type="password" minlength="8" autocomplete="new-password" required class="mt-1 w-full rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40">
              </div>
              <div class="md:col-span-2">
                <button class="btn btn-outline-primary w-full px-4 py-2 text-sm md:w-auto">Save password</button>
              </div>
            </form>
          </div>
        </div>
    </section>

    <form method="post" action="/settings" class="flex flex-col gap-6" x-data="settingsForm()" @submit="resetChanges()">
        <div x-show="hasChanges" x-cloak x-transition.opacity.duration.200ms class="rounded-lg border border-amber-500/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-200">
          You have unsaved changes. Don't forget to save before leaving this page.
        </div>

        <section id="display-settings" class="rounded-2xl border border-neutral-800/70 bg-neutral-900/70 p-6 shadow-xl shadow-black/20 backdrop-blur">
        <header class="mb-4 flex flex-col gap-1">
          <h2 class="text-lg font-semibold text-neutral-50">Appearance &amp; calendar</h2>
          <p class="text-sm text-neutral-400">Configure the default look and feel of the calendar.</p>
        </header>
        <div class="grid gap-5">
          <div class="grid gap-3 sm:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] sm:items-start">
            <div>
              <label for="theme" class="block text-sm font-medium text-neutral-200">Theme</label>
              <p class="mt-1 text-xs text-neutral-500">Switch between the dark and light presentation.</p>
            </div>
            <select id="theme" name="theme" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="dark" {% if cfg.ui.theme == 'dark' %}selected{% endif %}>Dark</option>
              <option value="light" {% if cfg.ui.theme == 'light' %}selected{% endif %}>Light</option>
            </select>
          </div>
          <div class="grid gap-3 sm:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] sm:items-start">
            <div>
              <label for="show_text" class="block text-sm font-medium text-neutral-200">Daily profit and loss</label>
              <p class="mt-1 text-xs text-neutral-500">Choose whether calendar cells show the numeric values.</p>
            </div>
            <select id="show_text" name="show_text" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="true" {% if show_text %}selected{% endif %}>Show values</option>
              <option value="false" {% if not show_text %}selected{% endif %}>Hide values</option>
            </select>
          </div>
          <div class="grid gap-3 sm:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] sm:items-start">
            <div>
              <label for="show_trade_count" class="block text-sm font-medium text-neutral-200">Trade count badges</label>
              <p class="mt-1 text-xs text-neutral-500">Show how many trades occurred each day.</p>
            </div>
            <select id="show_trade_count" name="show_trade_count" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="true" {% if show_trade_count %}selected{% endif %}>Show badges</option>
              <option value="false" {% if not show_trade_count %}selected{% endif %}>Hide badges</option>
            </select>
          </div>
          <div class="grid gap-3 sm:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] sm:items-start">
            <div>
              <label for="show_percentages" class="block text-sm font-medium text-neutral-200">Percentage change</label>
              <p class="mt-1 text-xs text-neutral-500">Display percent change badges alongside totals.</p>
            </div>
            <select id="show_percentages" name="show_percentages" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="true" {% if show_percentages %}selected{% endif %}>Show percentages</option>
              <option value="false" {% if not show_percentages %}selected{% endif %}>Hide percentages</option>
            </select>
          </div>
          <div class="grid gap-3 sm:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] sm:items-start">
            <div>
              <p class="block text-sm font-medium text-neutral-200">Market values</p>
              <p class="mt-1 text-xs text-neutral-500" x-show="!showMarketValueSetting" x-cloak>
                Hide or show the daily market value of holdings by default on the calendar.
              </p>
            </div>
            <div>
              <input type="hidden" name="show_market_value" value="{{ 'true' if show_market_value else 'false' }}" :value="showMarketValueSetting ? 'true' : 'false'">
              <button type="button" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm font-medium text-neutral-100 transition"
                      :class="{ 'bg-neutral-800 text-neutral-50 border-neutral-600': !showMarketValueSetting }"
                      @click="showMarketValueSetting = !showMarketValueSetting"
                      aria-pressed="{{ 'true' if show_market_value else 'false' }}"
                      :aria-pressed="showMarketValueSetting.toString()">
                <span x-text="showMarketValueSetting ? 'Hide by default' : 'Show by default'">
                  {% if show_market_value %}Hide by default{% else %}Show by default{% endif %}
                </span>
              </button>
            </div>
          </div>
          <div class="grid gap-3 sm:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] sm:items-start">
            <div>
              <label for="show_weekends" class="block text-sm font-medium text-neutral-200">Display weekends</label>
              <p class="mt-1 text-xs text-neutral-500">Choose whether Saturday and Sunday appear in the grid.</p>
            </div>
            <select id="show_weekends" name="show_weekends" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="false" {% if not show_weekends %}selected{% endif %}>Hide weekends</option>
              <option value="true" {% if show_weekends %}selected{% endif %}>Show weekends</option>
            </select>
          </div>
          <div class="grid gap-3 sm:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] sm:items-start">
            <div>
              <label for="default_view" class="block text-sm font-medium text-neutral-200">Default month view</label>
              <p class="mt-1 text-xs text-neutral-500">Decide where the calendar opens when you sign in.</p>
            </div>
            <select id="default_view" name="default_view" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="latest" {% if default_view == 'latest' %}selected{% endif %}>Jump to latest month</option>
              <option value="last_viewed" {% if default_view == 'last_viewed' %}selected{% endif %}>Remember last viewed</option>
            </select>
          </div>
        </div>
      </section>

      <section id="calculation-settings" class="rounded-2xl border border-neutral-800/70 bg-neutral-900/70 p-6 shadow-xl shadow-black/20 backdrop-blur">
        <header class="mb-4 flex flex-col gap-1">
          <h2 class="text-lg font-semibold text-neutral-50">Data handling</h2>
          <p class="text-sm text-neutral-400">Decide how missing values are calculated and exported.</p>
        </header>
        <div class="grid gap-5">
          <div class="grid gap-3 sm:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] sm:items-start">
            <div>
              <label for="export_empty_values" class="block text-sm font-medium text-neutral-200">Empty values in exports</label>
              <p class="mt-1 text-xs text-neutral-500">Control whether missing values export as zeros or blank cells.</p>
            </div>
            <select id="export_empty_values" name="export_empty_values" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="zero" {% if export_fill_empty %}selected{% endif %}>Fill with 0</option>
              <option value="empty" {% if not export_fill_empty %}selected{% endif %}>Leave empty</option>
            </select>
          </div>
        </div>
      </section>

      <section id="server-settings" class="rounded-2xl border border-neutral-800/70 bg-neutral-900/70 p-6 shadow-xl shadow-black/20 backdrop-blur">
        <header class="mb-4 flex flex-col gap-1">
          <h2 class="text-lg font-semibold text-neutral-50">Server access</h2>
          <p class="text-sm text-neutral-400">Adjust how the app listens for connections.</p>
        </header>
        <div class="grid gap-5">
          <div class="grid gap-3 sm:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] sm:items-start">
            <div>
              <label for="listening_port" class="block text-sm font-medium text-neutral-200">Listening port</label>
              <p class="mt-1 text-xs text-neutral-500">Choose the network port BagHolder binds to. A restart may be required for changes to take effect.</p>
            </div>
            <div class="flex flex-col gap-2">
              <div class="flex items-center justify-between gap-4">
                <span class="text-xs font-medium uppercase tracking-wide text-neutral-500">Edit protection</span>
                <label class="inline-flex cursor-pointer items-center gap-3">
                  <span class="relative inline-flex h-6 w-11 items-center">
                    <input type="checkbox" class="peer sr-only" @change="setPortEditing($event.target.checked)">
                    <span aria-hidden="true" class="block h-6 w-11 rounded-full bg-neutral-700 transition peer-checked:bg-emerald-500"></span>
                    <span aria-hidden="true" class="absolute left-1 top-1 h-4 w-4 rounded-full bg-neutral-200 transition peer-checked:translate-x-5 peer-checked:bg-white"></span>
                  </span>
                  <span class="text-xs text-neutral-300">Allow editing</span>
                </label>
              </div>
              <input type="number"
                     id="listening_port"
                     name="listening_port"
                     min="1"
                     max="65535"
                     value="{{ server_port }}"
                     :readonly="!portEditingEnabled"
                     :aria-disabled="(!portEditingEnabled).toString()"
                     :aria-readonly="(!portEditingEnabled).toString()"
                     :class="[
                       'w-full rounded-lg border px-3 py-2 text-sm transition',
                       portEditingEnabled
                         ? 'border-neutral-700 bg-neutral-900 text-neutral-100 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/40'
                         : 'border-neutral-800 bg-neutral-950 text-neutral-500 opacity-70 cursor-not-allowed'
                     ]">
              <p class="text-[11px] uppercase tracking-wide text-neutral-600">Range: 1–65535</p>
              <template x-if="runningInDocker">
                <p class="text-xs text-amber-400">Docker environment detected. Adjusting the listening port can break container networking—only continue if you know exactly what you're doing.</p>
              </template>
              <template x-if="!runningInDocker">
                <p class="text-xs text-neutral-500">Changing the listening port can interrupt connections. Restart BagHolder after saving.</p>
              </template>
            </div>
          </div>
        </div>
      </section>

      <section id="palette-settings" class="rounded-2xl border border-neutral-800/70 bg-neutral-900/70 p-6 shadow-xl shadow-black/20 backdrop-blur">
        <div class="mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h2 class="text-lg font-semibold text-neutral-50">Color palette</h2>
            <p class="mt-1 text-sm text-neutral-400">Adjust the interface accents used across the calendar, actions, and notes.</p>
          </div>
          <button type="button" class="btn btn-outline-primary px-3 py-2 text-sm"
                  @click="resetAllColors()"
                  :class="{ 'opacity-50 cursor-not-allowed pointer-events-none': colorsAreDefault() }"
                  :aria-disabled="colorsAreDefault().toString()"
                  :disabled="colorsAreDefault()">
            Reset palette
          </button>
        </div>
        <div class="grid gap-4">
          {% for group in color_groups | default([], true) %}
          <div class="rounded-xl border border-neutral-800/80 bg-neutral-950/50 p-4 shadow-inner shadow-black/30">
            <div class="mb-4 space-y-1">
              <h3 class="text-sm font-semibold text-neutral-100">{{ group.title }}</h3>
              <p class="text-xs text-neutral-500 leading-relaxed">{{ group.description }}</p>
            </div>
            <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
              {% for field in group.fields %}
              <label class="flex flex-col gap-2">
                <div class="flex items-center justify-between gap-2">
                  <span class="text-sm font-medium text-neutral-200">{{ field.label }}</span>
                  <button type="button" class="text-xs text-neutral-400 transition hover:text-neutral-100"
                          @click.prevent="resetColor('{{ field.name }}')"
                          :class="{ 'opacity-40 pointer-events-none': isColorDefault('{{ field.name }}') }"
                          :aria-disabled="isColorDefault('{{ field.name }}').toString()">
                    Reset
                  </button>
                </div>
                <input type="color" name="{{ field.name }}" value="{{ field.current }}" class="h-10 w-full cursor-pointer rounded border border-neutral-700 bg-transparent p-1">
                <p class="text-xs text-neutral-500 leading-snug">
                  {{ field.description }}
                  <span class="ml-1 uppercase tracking-wide text-[11px]">Default: {{ field.default | upper }}</span>
                </p>
              </label>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        </div>
      </section>

      <section id="diagnostic-settings" class="rounded-2xl border border-neutral-800/70 bg-neutral-900/70 p-6 shadow-xl shadow-black/20 backdrop-blur">
        <header class="mb-4 flex flex-col gap-1">
          <h2 class="text-lg font-semibold text-neutral-50">Diagnostics</h2>
          <p class="text-sm text-neutral-400">Persist detailed logs for troubleshooting and share them with support.</p>
        </header>
        <div class="grid gap-5">
          <div class="grid gap-3 sm:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] sm:items-start">
            <div>
              <label for="debug_logging" class="block text-sm font-medium text-neutral-200">Debug logging</label>
              <p class="mt-1 text-xs text-neutral-500">When enabled, verbose diagnostic entries are stored in the persistent log file.</p>
            </div>
            <select id="debug_logging" name="debug_logging" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="true" {% if debug_logging_enabled %}selected{% endif %}>Enabled</option>
              <option value="false" {% if not debug_logging_enabled %}selected{% endif %}>Disabled</option>
            </select>
          </div>
          <div class="grid gap-3 sm:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] sm:items-start">
            <div>
              <p class="block text-sm font-medium text-neutral-200">Export debug log</p>
              <p class="mt-1 text-xs text-neutral-500">
                {% if log_export_available %}
                  Download the latest log for sharing with support.
                {% else %}
                  A log file appears here once the app records diagnostic events.
                {% endif %}
              </p>
            </div>
            <a href="/settings/logs/export" class="btn btn-outline-primary w-full px-4 py-2 text-sm {% if not log_export_available %}opacity-60 cursor-not-allowed pointer-events-none{% endif %}"
               {% if not log_export_available %}aria-disabled="true" tabindex="-1"{% endif %}>
              Download log
            </a>
          </div>
        </div>
      </section>

      <div class="flex flex-col items-stretch justify-between gap-3 rounded-2xl border border-neutral-800/70 bg-neutral-900/70 p-5 shadow-xl shadow-black/20 backdrop-blur sm:flex-row sm:items-center">
        <p class="text-xs text-neutral-500" x-show="!hasChanges" x-cloak>All changes are synced with the current configuration.</p>
        <button type="submit" class="btn btn-primary w-full px-5 py-2.5 sm:w-auto"
                :class="{ 'opacity-60 cursor-not-allowed': !hasChanges }"
                :disabled="!hasChanges">
          Save changes
        </button>
      </div>
    </form>

    <section id="stock-data-import" class="rounded-2xl border border-neutral-800/70 bg-neutral-900/70 p-6 shadow-xl shadow-black/20 backdrop-blur">
        <header class="mb-4">
          <h2 class="text-lg font-semibold text-neutral-50">Import trade history</h2>
          <p class="mt-1 text-sm text-neutral-400">Upload CSV trade summaries or ThinkOrSwim statements.</p>
          <p class="mt-3 text-xs text-neutral-400">
            Imports are applied to <span class="font-semibold text-neutral-100">{{ active_account.name }}</span>
            (<span class="text-neutral-300">{{ active_account.storage }}</span>)
            portfolio.
          </p>
        </header>
        <div class="space-y-5">
          <div class="rounded-xl border border-neutral-800/80 bg-neutral-950/50 p-4 shadow-inner shadow-black/30">
            <h3 class="text-sm font-semibold text-neutral-100">Stock buy &amp; sell CSV data</h3>
            <p class="mt-1 text-xs text-neutral-500">Import executed trades from a CSV with the columns date, symbol, action, qty, price, amount.</p>
            {% if trade_csv_error_message %}
            <div class="mt-3 rounded border border-red-500/60 bg-red-500/10 px-3 py-2 text-xs text-red-200">{{ trade_csv_error_message }}</div>
            {% endif %}
            <form action="/import/trades" method="post" enctype="multipart/form-data" class="mt-4 flex flex-col gap-3">
              <input type="file" name="file" accept=".csv" class="block w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 file:mr-4 file:rounded-md file:border-0 file:bg-neutral-800 file:px-4 file:py-2 file:text-neutral-200 hover:file:bg-neutral-700">
              <button class="btn btn-primary px-4 py-2">Upload</button>
            </form>
          </div>
          <div class="rounded-xl border border-neutral-800/80 bg-neutral-950/50 p-4 shadow-inner shadow-black/30">
            <h3 class="text-sm font-semibold text-neutral-100">ThinkOrSwim account statement</h3>
            <p class="mt-1 text-xs text-neutral-500">Only trade fields are persisted (date, symbol, action, qty, price, amount). Account identifiers are discarded after parsing.</p>
            {% if thinkorswim_error_message %}
            <div class="mt-3 rounded border border-red-500/60 bg-red-500/10 px-3 py-2 text-xs text-red-200">{{ thinkorswim_error_message }}</div>
            {% endif %}
            <form action="/import/thinkorswim" method="post" enctype="multipart/form-data" class="mt-4 flex flex-col gap-3">
              <input type="file" name="file" accept=".csv" class="block w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 file:mr-4 file:rounded-md file:border-0 file:bg-neutral-800 file:px-4 file:py-2 file:text-neutral-200 hover:file:bg-neutral-700">
              <button class="btn btn-primary px-4 py-2">Upload</button>
            </form>
          </div>
        </div>
    </section>

    <section id="configuration-settings" class="rounded-2xl border border-neutral-800/70 bg-neutral-900/70 p-6 shadow-xl shadow-black/20 backdrop-blur">
        <header class="mb-4">
          <h2 class="text-lg font-semibold text-neutral-50">Configuration</h2>
          <p class="mt-1 text-sm text-neutral-400">Export the current configuration or apply a previously exported JSON file.</p>
        </header>
        <div class="flex flex-col gap-4">
          <a href="/settings/config/export" class="btn btn-primary px-4 py-2 text-center" download>
            Download config (JSON)
          </a>
          <form method="post" action="/settings/config/import" class="flex flex-col gap-3" enctype="multipart/form-data">
            <label class="flex flex-col gap-2 text-sm font-medium text-neutral-200">
              Import configuration file
              <input type="file" name="config_file" accept=".json,application/json" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100" required>
            </label>
            <p class="text-xs text-neutral-500">Upload a JSON file exported from BagHolder. Missing values revert to their defaults.</p>
            <button type="submit" class="btn btn-primary w-full px-4 py-2">Import config</button>
          </form>
        </div>
    </section>

    <section id="backup-settings" class="rounded-2xl border border-neutral-800/70 bg-neutral-900/70 p-6 shadow-xl shadow-black/20 backdrop-blur">
        <header class="mb-4">
          <h2 class="text-lg font-semibold text-neutral-50">Full backup</h2>
          <p class="mt-1 text-sm text-neutral-400">Create or restore a ZIP archive containing all application data.</p>
        </header>
        <div class="flex flex-col gap-4">
          <a href="/settings/backup/export" class="btn btn-primary px-4 py-2 text-center" download>
            Download full backup (ZIP)
          </a>
          <form method="post" action="/settings/backup/import" class="flex flex-col gap-3" enctype="multipart/form-data">
            <label class="flex flex-col gap-2 text-sm font-medium text-neutral-200">
              Import backup archive
              <input type="file" name="backup_file" accept=".zip" class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100" required>
            </label>
            <p class="text-xs text-neutral-500">Upload a ZIP file generated by BagHolder. Existing data will be replaced.</p>
            <button class="btn btn-primary w-full px-4 py-2">Import backup</button>
          </form>
        </div>
    </section>

    <section id="user-management" class="rounded-2xl border border-neutral-800/70 bg-neutral-900/70 p-6 shadow-xl shadow-black/20 backdrop-blur">
        <header class="mb-4">
          <h2 class="text-lg font-semibold text-neutral-50">User management</h2>
          <p class="mt-1 text-sm text-neutral-400">Invite teammates, update credentials, and manage administrative tools.</p>
        </header>
        {% if current_user and current_user.is_admin %}
          <div class="space-y-6">
            <div class="rounded-xl border border-neutral-800/70 bg-neutral-950/50 p-5">
              <div class="mb-4">
                <h3 class="text-sm font-semibold text-neutral-100">Team access</h3>
                <p class="text-xs text-neutral-400">Invite new administrators or remove existing users from BagHolder.</p>
              </div>
              <div class="space-y-4">
                <div>
                  <p class="text-xs font-semibold uppercase tracking-wide text-neutral-500">Current users</p>
                  <div class="mt-2 space-y-2">
                    {% if managed_users %}
                      {% for user in managed_users %}
                        <div class="flex items-center justify-between rounded-lg border border-neutral-800/60 bg-neutral-900/70 px-3 py-2">
                          <div>
                            <p class="text-sm font-medium text-neutral-100">
                              {{ user.username }}
                              {% if current_user and user.id|int == current_user.id %}<span class="text-xs text-neutral-400">(you)</span>{% endif %}
                            </p>
                            <p class="text-[11px] text-neutral-500">Added {{ user.created_at }}</p>
                          </div>
                          <span class="rounded-full border border-blue-500/40 px-2 py-0.5 text-[10px] uppercase tracking-widest text-blue-200/90">{% if user.is_admin %}Admin{% else %}User{% endif %}</span>
                        </div>
                      {% endfor %}
                    {% else %}
                      <p class="text-xs text-neutral-400">No users have been configured yet.</p>
                    {% endif %}
                  </div>
                </div>
                <form method="post" action="/settings/users/create" class="grid gap-3 sm:grid-cols-2">
                  <input type="hidden" name="redirect_to" value="/settings">
                  <label class="flex flex-col gap-1 text-xs font-medium uppercase tracking-wide text-neutral-500">
                    Username
                    <input name="username" class="rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40" autocomplete="off" required>
                  </label>
                  <label class="flex flex-col gap-1 text-xs font-medium uppercase tracking-wide text-neutral-500">
                    Password
                    <input type="password" name="password" class="rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40" minlength="8" required>
                  </label>
                  <label class="flex flex-col gap-1 text-xs font-medium uppercase tracking-wide text-neutral-500">
                    Confirm password
                    <input type="password" name="confirm_password" class="rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40" minlength="8" required>
                  </label>
                  <label class="flex items-center gap-2 text-xs font-medium uppercase tracking-wide text-neutral-500">
                    <input type="checkbox" name="is_admin" value="true" class="h-4 w-4 rounded border-neutral-700 bg-neutral-900 text-blue-500 focus:ring-blue-500">
                    Grant administrator access
                  </label>
                  <div class="sm:col-span-2">
                    <button class="btn btn-primary w-full px-4 py-2 text-sm">Add user</button>
                  </div>
                </form>
                <form method="post" action="/settings/users/reset-password" class="grid gap-3 sm:grid-cols-2">
                  <input type="hidden" name="redirect_to" value="/settings">
                  <label class="flex flex-col gap-1 text-xs font-medium uppercase tracking-wide text-neutral-500">
                    Select user
                    <select name="user_id" class="rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40" required>
                      <option value="" disabled selected>Choose a user</option>
                      {% for user in managed_users %}
                        <option value="{{ user.id }}">{{ user.username }}{% if user.is_admin %} (admin){% endif %}</option>
                      {% endfor %}
                    </select>
                  </label>
                  <div class="grid gap-3 sm:grid-cols-2 sm:col-span-2">
                    <label class="flex flex-col gap-1 text-xs font-medium uppercase tracking-wide text-neutral-500">
                      New password
                      <input type="password" name="new_password" class="rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40" minlength="8" required>
                    </label>
                    <label class="flex flex-col gap-1 text-xs font-medium uppercase tracking-wide text-neutral-500">
                      Confirm password
                      <input type="password" name="confirm_password" class="rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40" minlength="8" required>
                    </label>
                  </div>
                  <div class="sm:col-span-2">
                    <button class="btn btn-outline-danger w-full px-4 py-2 text-sm">Reset user password</button>
                  </div>
                </form>
                <form method="post" action="/settings/users/delete" class="flex flex-col gap-3 sm:flex-row sm:items-end">
                  <input type="hidden" name="redirect_to" value="/settings">
                  <label class="flex w-full flex-col gap-1 text-xs font-medium uppercase tracking-wide text-neutral-500">
                    Remove user
                    <select name="user_id" class="rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40" required>
                      <option value="" disabled selected>Select a user</option>
                      {% for user in managed_users %}
                        <option value="{{ user.id }}">{{ user.username }}{% if user.is_admin %} (admin){% endif %}</option>
                      {% endfor %}
                    </select>
                  </label>
                  <button class="btn btn-outline-danger w-full px-4 py-2 text-sm sm:w-auto">Delete user</button>
                </form>
                <p class="text-[11px] text-neutral-500">Administrators cannot delete their own account from this list. Use the personal controls below to remove yourself.</p>
              </div>
            </div>
            <div class="rounded-xl border border-neutral-800/70 bg-neutral-950/50 p-5">
              <div class="mb-4">
                <h3 class="text-sm font-semibold text-neutral-100">Application maintenance</h3>
                <p class="text-xs text-neutral-400">Reset trading data or safely restart the server when maintenance is required.</p>
              </div>
              <form method="post" action="/settings/clear-data" class="flex flex-col gap-3"
                    onsubmit="return confirm('This will remove all trades, summaries, notes, and configuration data for every portfolio. User accounts will remain. Continue?');">
                <input type="hidden" name="redirect_to" value="/settings">
                <button class="btn btn-danger w-full px-4 py-2">Reset application data</button>
              </form>
              <form method="post" action="/settings/shutdown" class="mt-3 flex flex-col gap-3"
                    onsubmit="return confirm('This will stop the server. Continue?');">
                <button class="btn btn-outline-danger w-full px-4 py-2">Shut down server</button>
              </form>
            </div>
            <div class="rounded-xl border border-neutral-800/70 bg-neutral-950/50 p-5">
              <div class="mb-3">
                <h3 class="text-sm font-semibold text-neutral-100">Personal account</h3>
                <p class="text-xs text-neutral-400">Remove your own login once another administrator is available to manage the system.</p>
              </div>
              <form method="post" action="/settings/account/delete" class="flex flex-col gap-3"
                    onsubmit="return confirm('This will permanently delete your user account and sign you out. Continue?');">
                <input type="hidden" name="redirect_to" value="/settings">
                <button class="btn btn-outline-danger w-full px-4 py-2">Delete my account</button>
              </form>
            </div>
          </div>
        {% else %}
          <div class="rounded-xl border border-neutral-800/70 bg-neutral-950/50 p-5">
            <div class="mb-3">
              <h3 class="text-sm font-semibold text-neutral-100">Delete my account</h3>
              <p class="text-xs text-neutral-400">Remove your access to BagHolder. This action is permanent and cannot be undone.</p>
            </div>
            <form method="post" action="/settings/account/delete" class="flex flex-col gap-3"
                  onsubmit="return confirm('This will permanently delete your user account and sign you out. Continue?');">
              <input type="hidden" name="redirect_to" value="/settings">
              <button class="btn btn-danger w-full px-4 py-2">Delete my account</button>
            </form>
            <p class="mt-3 text-xs text-neutral-400">Need other help? Contact an administrator to reset data or invite you again.</p>
          </div>
        {% endif %}
    </section>
    <section id="contact-support" class="rounded-2xl border border-neutral-800/70 bg-neutral-900/70 p-6 shadow-xl shadow-black/20 backdrop-blur">
      <header class="mb-4">
        <h2 class="text-lg font-semibold text-neutral-50">Contact &amp; support</h2>
        <p class="mt-1 text-sm text-neutral-400">Get in touch when you need help or want to share feedback.</p>
      </header>
      <div class="grid gap-4 sm:grid-cols-2">
        <div class="rounded-xl border border-neutral-800/70 bg-neutral-950/50 p-5">
          <h3 class="text-sm font-semibold text-neutral-100">Join the community</h3>
          <p class="mt-2 text-xs text-neutral-400 leading-relaxed">
            Start a thread in the r/bagholder_dev subreddit to ask questions, share feature ideas, or learn how others deploy BagHolder.
          </p>
          <a href="https://www.reddit.com/r/bagholder_dev" target="_blank" rel="noopener noreferrer"
             class="btn btn-outline-primary mt-4 inline-flex items-center gap-2 px-4 py-2 text-sm">
            <span>Visit Reddit</span>
          </a>
        </div>
        <div class="rounded-xl border border-neutral-800/70 bg-neutral-950/50 p-5">
          <h3 class="text-sm font-semibold text-neutral-100">Open a GitHub issue</h3>
          <p class="mt-2 text-xs text-neutral-400 leading-relaxed">
            Prefer collaborating in public? Create an issue with steps to reproduce or feature ideas so the community can jump in.
          </p>
          <a href="https://github.com/jesse-ai/bagholder/issues" target="_blank" rel="noopener noreferrer"
             class="btn btn-outline-primary mt-4 inline-flex items-center gap-2 px-4 py-2 text-sm">
            <span>Visit GitHub</span>
          </a>
        </div>
      </div>
    </section>
    <a href="https://buymeacoffee.com/crissejdav6" target="_blank" rel="noopener noreferrer"
       class="btn btn-outline-danger inline-flex w-full justify-center rounded-full px-4 py-2 text-xs uppercase tracking-wide">
      Buy me a coffee
    </a>
    </div>
  </div>
  </div>

  <div class="fixed inset-0 z-40 hidden flex items-center justify-center bg-black/70 px-4 py-6" data-simulate-dialog aria-hidden="true">
    <div class="w-full max-w-2xl rounded-2xl border border-neutral-800/80 bg-neutral-950/90 p-6 shadow-2xl shadow-black/40" role="dialog" aria-modal="true" aria-labelledby="simulate-dialog-title">
      <div class="flex items-start justify-between gap-4">
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-blue-300">Trade simulation</p>
          <h2 id="simulate-dialog-title" class="text-lg font-semibold text-neutral-100">Review simulation settings</h2>
          <p class="mt-1 text-sm text-neutral-400">Adjust the simulator inputs before generating trades.</p>
        </div>
        <button type="button"
                class="rounded-full p-2 text-neutral-400 transition hover:bg-neutral-800/60 hover:text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/50"
                data-simulate-close
                aria-label="Close simulation settings dialog">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form class="mt-6 space-y-6" data-simulate-form autocomplete="off">
        <input type="hidden" name="account_id" data-simulate-account>
        <p class="hidden rounded-lg border border-red-500/50 bg-red-500/10 px-4 py-3 text-sm text-red-200" data-simulate-error></p>
        <div class="grid gap-5 sm:grid-cols-2">
          <div class="space-y-1">
            <label for="simulate-years-back" class="text-sm font-medium text-neutral-200">Years of history</label>
            <input id="simulate-years-back" name="years_back" type="number" min="1" step="1" required class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40">
            <p class="text-xs text-neutral-500">How many years of market data to include.</p>
          </div>
          <div class="space-y-1">
            <label for="simulate-start-balance" class="text-sm font-medium text-neutral-200">Starting balance</label>
            <input id="simulate-start-balance" name="start_balance" type="number" min="0" step="0.01" required class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40">
            <p class="text-xs text-neutral-500">Initial account balance used by the simulator.</p>
          </div>
          <div class="space-y-1">
            <label for="simulate-risk-level" class="text-sm font-medium text-neutral-200">Risk level</label>
            <input id="simulate-risk-level" name="risk_level" type="number" min="0" max="1" step="0.05" required class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40">
            <p class="text-xs text-neutral-500">0 keeps trades conservative; 1 takes maximum risk.</p>
          </div>
          <div class="space-y-1">
            <label for="simulate-profit-target" class="text-sm font-medium text-neutral-200">Profit target</label>
            <input id="simulate-profit-target" name="profit_target" type="number" min="0" step="0.01" required class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40">
            <p class="text-xs text-neutral-500">Desired percentage gain before taking profit.</p>
          </div>
          <div class="space-y-1">
            <label for="simulate-stop-loss" class="text-sm font-medium text-neutral-200">Stop loss</label>
            <input id="simulate-stop-loss" name="stop_loss" type="number" min="0" step="0.01" required class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40">
            <p class="text-xs text-neutral-500">Percentage drop that triggers an exit.</p>
          </div>
          <div class="space-y-1">
            <label for="simulate-seed" class="text-sm font-medium text-neutral-200">Random seed</label>
            <input id="simulate-seed" name="seed" type="number" step="1" required class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40">
            <p class="text-xs text-neutral-500">Controls repeatability of generated trades.</p>
          </div>
          <div class="space-y-1">
            <label for="simulate-max-workers" class="text-sm font-medium text-neutral-200">Download workers</label>
            <input id="simulate-max-workers" name="max_workers" type="number" min="1" step="1" required class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40">
            <p class="text-xs text-neutral-500">Concurrent requests when refreshing price data.</p>
          </div>
        </div>
        <div class="space-y-3" x-data="{ open: false }">
          <button type="button"
                  class="flex w-full items-center justify-between rounded-lg border border-neutral-700 bg-neutral-900/80 px-4 py-2 text-left text-sm font-medium text-neutral-200 transition hover:border-neutral-500 hover:text-neutral-50 focus:outline-none focus:ring-2 focus:ring-blue-500/40"
                  @click="open = !open"
                  :aria-expanded="open ? 'true' : 'false'"
                  aria-controls="simulate-advanced-file-settings">
            <span>Advanced file settings</span>
            <span class="text-xs font-semibold uppercase tracking-wide text-neutral-500" x-text="open ? 'Hide files' : 'Show files'"></span>
          </button>
          <div id="simulate-advanced-file-settings"
               x-show="open"
               x-transition.opacity.duration.150ms
               x-cloak
               class="rounded-lg border border-neutral-800/70 bg-neutral-900/80 p-4">
            <div class="grid gap-5 sm:grid-cols-2">
              <div class="space-y-1 sm:col-span-2">
                <label for="simulate-symbol-cache" class="text-sm font-medium text-neutral-200">Symbol cache file</label>
                <input id="simulate-symbol-cache" name="symbol_cache" type="text" required class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40">
                <p class="text-xs text-neutral-500">File that stores cached U.S. ticker symbols.</p>
              </div>
              <div class="space-y-1 sm:col-span-2">
                <label for="simulate-price-cache" class="text-sm font-medium text-neutral-200">Price cache directory</label>
                <input id="simulate-price-cache" name="price_cache_dir" type="text" required class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40">
                <p class="text-xs text-neutral-500">Where downloaded historical price data is stored.</p>
              </div>
              <div class="space-y-1 sm:col-span-2">
                <label for="simulate-output-dir" class="text-sm font-medium text-neutral-200">Output directory</label>
                <input id="simulate-output-dir" name="output_dir" type="text" required class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40">
                <p class="text-xs text-neutral-500">Destination for generated trades and supporting files.</p>
              </div>
              <div class="space-y-1">
                <label for="simulate-output-name" class="text-sm font-medium text-neutral-200">Output filename</label>
                <input id="simulate-output-name" name="output_name" type="text" required class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40">
                <p class="text-xs text-neutral-500">Trade file that will be imported into the portfolio.</p>
              </div>
              <div class="space-y-1">
                <span class="text-sm font-medium text-neutral-200">Update caches only</span>
                <label class="flex items-center gap-2 text-sm text-neutral-300">
                  <input type="checkbox" name="generate_only" class="h-4 w-4 rounded border-neutral-600 bg-neutral-900 text-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40">
                  Update symbol and price caches without importing trades
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="flex flex-col gap-3 border-t border-neutral-800/60 pt-4 sm:flex-row sm:justify-end">
          <button type="button" class="rounded-lg border border-neutral-700 bg-neutral-900 px-4 py-2 text-sm font-medium text-neutral-200 transition hover:border-neutral-500 hover:text-neutral-50 focus:outline-none focus:ring-2 focus:ring-blue-500/40" data-simulate-cancel>
            Cancel
          </button>
          <button type="submit" class="btn btn-outline-primary px-4 py-2 text-sm" data-simulate-submit>
            Run simulation
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
  document.addEventListener('alpine:init', () => {
    Alpine.data('settingsForm', () => ({
      showMarketValueSetting: {{ 'true' if show_market_value else 'false' }},
      hasChanges: false,
      initialData: '',
      formEl: null,
      defaultColors: {{ color_defaults | default({}, true) | tojson | safe }},
      portEditingEnabled: false,
      runningInDocker: {{ 'true' if running_in_docker else 'false' }},
      init() {
        this.formEl = this.$el;
        this.initialData = this.serializeForm();
        this.$watch('showMarketValueSetting', () => this.evaluateChanges());
        this.formEl.addEventListener('input', () => this.evaluateChanges());
        this.formEl.addEventListener('change', () => this.evaluateChanges());
      },
      serializeForm() {
        if (!this.formEl) {
          return '';
        }
        const formData = new FormData(this.formEl);
        formData.set('show_market_value', this.showMarketValueSetting ? 'true' : 'false');
        return new URLSearchParams(formData).toString();
      },
      evaluateChanges() {
        this.hasChanges = this.serializeForm() !== this.initialData;
      },
      resetChanges() {
        this.initialData = this.serializeForm();
        this.hasChanges = false;
      },
      setPortEditing(enabled) {
        this.portEditingEnabled = Boolean(enabled);
        if (!this.portEditingEnabled) {
          const input = this.formEl?.querySelector('#listening_port');
          if (input instanceof HTMLInputElement) {
            input.blur();
          }
        }
        this.$nextTick(() => this.evaluateChanges());
      },
      isColorDefault(field) {
        const defaultValue = this.defaultColors[field];
        if (!this.formEl || typeof defaultValue !== 'string') {
          return false;
        }
        const input = this.formEl.querySelector(`[name='${field}']`);
        if (!input) {
          return false;
        }
        return input.value.toLowerCase() === defaultValue.toLowerCase();
      },
      resetColor(field) {
        const defaultValue = this.defaultColors[field];
        if (typeof defaultValue !== 'string' || !this.formEl) {
          return;
        }
        const input = this.formEl.querySelector(`[name='${field}']`);
        if (!input) {
          return;
        }
        input.value = defaultValue.toLowerCase();
        input.dispatchEvent(new Event('input', { bubbles: true }));
        input.dispatchEvent(new Event('change', { bubbles: true }));
        this.evaluateChanges();
      },
      resetAllColors() {
        if (!this.formEl) {
          return;
        }
        Object.keys(this.defaultColors).forEach((field) => {
          this.resetColor(field);
        });
      },
      colorsAreDefault() {
        if (!this.formEl) {
          return false;
        }
        return Object.keys(this.defaultColors).every((field) => this.isColorDefault(field));
      }
    }));
  });

  (function clearStoredExclusionsAfterReset() {
    const shouldClear = {{ 'true' if cleared else 'false' }};
    if (!shouldClear) {
      return;
    }

    try {
      const storage = window.localStorage;
      if (!storage) {
        return;
      }

      const prefixes = ['bagholder:excludedDays:', 'bagholder:excludedWeeks:'];
      const keysToRemove = [];

      for (let index = 0; index < storage.length; index += 1) {
        const key = storage.key(index);
        if (!key) {
          continue;
        }
        if (prefixes.some((prefix) => key.startsWith(prefix))) {
          keysToRemove.push(key);
        }
      }

      keysToRemove.forEach((key) => {
        storage.removeItem(key);
      });
    } catch (error) {
      console.warn('Unable to clear stored exclusions after portfolio reset', error);
    }
  })();

  (function setupSimulationControls() {
    const buttons = document.querySelectorAll('[data-simulate-trades]');
    if (!buttons.length) {
      return;
    }

    const setStatus = (statusEl, message, tone = 'info') => {
      if (!statusEl) {
        return;
      }
      statusEl.classList.remove('hidden');
      statusEl.classList.remove('text-danger', 'text-success', 'text-neutral-400', 'text-neutral-300');
      if (tone === 'error') {
        statusEl.classList.add('text-danger');
      } else if (tone === 'success') {
        statusEl.classList.add('text-success');
      } else {
        statusEl.classList.add('text-neutral-300');
      }
      statusEl.textContent = message;
    };

    const dialog = document.querySelector('[data-simulate-dialog]');
    const form = dialog ? dialog.querySelector('[data-simulate-form]') : null;
    const submitButton = form ? form.querySelector('[data-simulate-submit]') : null;
    const cancelButton = form ? form.querySelector('[data-simulate-cancel]') : null;
    const closeButton = dialog ? dialog.querySelector('[data-simulate-close]') : null;
    const errorEl = dialog ? dialog.querySelector('[data-simulate-error]') : null;
    const accountInput = form ? form.querySelector('[data-simulate-account]') : null;

    if (!dialog || !form || !submitButton || !accountInput) {
      console.warn('Simulation dialog is not available.');
      return;
    }

    const fieldMap = {
      years_back: form.querySelector('[name="years_back"]'),
      start_balance: form.querySelector('[name="start_balance"]'),
      risk_level: form.querySelector('[name="risk_level"]'),
      profit_target: form.querySelector('[name="profit_target"]'),
      stop_loss: form.querySelector('[name="stop_loss"]'),
      seed: form.querySelector('[name="seed"]'),
      max_workers: form.querySelector('[name="max_workers"]'),
      symbol_cache: form.querySelector('[name="symbol_cache"]'),
      price_cache_dir: form.querySelector('[name="price_cache_dir"]'),
      output_dir: form.querySelector('[name="output_dir"]'),
      output_name: form.querySelector('[name="output_name"]'),
      generate_only: form.querySelector('[name="generate_only"]'),
    };

    const defaultCache = new Map();
    let activeContext = null;
    let lastFocusedElement = null;

    const loadDefaults = async (accountId) => {
      if (defaultCache.has(accountId)) {
        return { ...defaultCache.get(accountId) };
      }

      const response = await fetch(`/api/accounts/${encodeURIComponent(accountId)}/simulate/options`, {
        headers: { Accept: 'application/json' },
      });
      if (!response.ok) {
        throw new Error(`Failed to load defaults (${response.status})`);
      }
      const payload = await response.json();
      if (!payload || typeof payload !== 'object' || typeof payload.options !== 'object' || payload.options === null) {
        throw new Error('Invalid defaults payload');
      }
      const normalized = { ...payload.options };
      defaultCache.set(accountId, normalized);
      return { ...normalized };
    };

    const resetFormFields = () => {
      Object.values(fieldMap).forEach((field) => {
        if (!field) {
          return;
        }
        if (field instanceof HTMLInputElement || field instanceof HTMLTextAreaElement) {
          if (field.type === 'checkbox') {
            field.checked = false;
          } else {
            field.value = '';
          }
        }
      });
    };

    const populateForm = (options) => {
      const assignNumeric = (field, value, toInt = false) => {
        if (!(field instanceof HTMLInputElement)) {
          return;
        }
        let normalized = typeof value === 'number' ? value : Number.parseFloat(String(value));
        if (!Number.isFinite(normalized)) {
          field.value = '';
          return;
        }
        if (toInt) {
          normalized = Math.trunc(normalized);
        }
        field.value = String(normalized);
      };

      const assignText = (field, value) => {
        if (!(field instanceof HTMLInputElement)) {
          return;
        }
        if (typeof value === 'string') {
          field.value = value;
          return;
        }
        if (value !== undefined && value !== null) {
          field.value = String(value);
          return;
        }
        field.value = '';
      };

      assignNumeric(fieldMap.years_back, options.years_back, true);
      assignNumeric(fieldMap.start_balance, options.start_balance);
      assignNumeric(fieldMap.risk_level, options.risk_level);
      assignNumeric(fieldMap.profit_target, options.profit_target);
      assignNumeric(fieldMap.stop_loss, options.stop_loss);
      assignNumeric(fieldMap.seed, options.seed, true);
      assignNumeric(fieldMap.max_workers, options.max_workers, true);
      assignText(fieldMap.symbol_cache, options.symbol_cache);
      assignText(fieldMap.price_cache_dir, options.price_cache_dir);
      assignText(fieldMap.output_dir, options.output_dir);
      assignText(fieldMap.output_name, options.output_name);
      if (fieldMap.generate_only instanceof HTMLInputElement) {
        fieldMap.generate_only.checked = Boolean(options.generate_only);
      }
    };

    const hideDialog = (restoreFocus = true) => {
      dialog.classList.add('hidden');
      dialog.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('overflow-hidden');
      if (restoreFocus && lastFocusedElement instanceof HTMLElement) {
        lastFocusedElement.focus();
      }
      lastFocusedElement = null;
    };

    const showDialog = async (context) => {
      activeContext = context;
      lastFocusedElement = document.activeElement instanceof HTMLElement ? document.activeElement : null;
      accountInput.value = context.accountId;
      dialog.classList.remove('hidden');
      dialog.setAttribute('aria-hidden', 'false');
      document.body.classList.add('overflow-hidden');
      if (errorEl) {
        errorEl.classList.add('hidden');
        errorEl.textContent = '';
      }
      submitButton.disabled = true;
      submitButton.textContent = 'Run simulation';
      resetFormFields();

      try {
        const defaults = await loadDefaults(context.accountId);
        populateForm(defaults);
        submitButton.disabled = false;
        const firstField = fieldMap.years_back;
        if (firstField instanceof HTMLElement) {
          firstField.focus();
          if (firstField instanceof HTMLInputElement && typeof firstField.select === 'function') {
            firstField.select();
          }
        }
      } catch (error) {
        console.error('Unable to load simulation defaults', error);
        if (errorEl) {
          errorEl.textContent = 'Unable to load simulation defaults. Please try again later.';
          errorEl.classList.remove('hidden');
        }
        submitButton.disabled = true;
        const fallbackTarget = cancelButton || closeButton;
        if (fallbackTarget instanceof HTMLElement) {
          fallbackTarget.focus();
        }
      }
    };

    const collectOverrides = () => {
      const readNumber = (field, toInt = false) => {
        if (!(field instanceof HTMLInputElement)) {
          return null;
        }
        const raw = field.value;
        if (raw === '') {
          return null;
        }
        const value = toInt ? Number.parseInt(raw, 10) : Number.parseFloat(raw);
        return Number.isFinite(value) ? value : null;
      };

      const readText = (field) => {
        if (!(field instanceof HTMLInputElement)) {
          return null;
        }
        return field.value.trim();
      };

      const overrides = {
        years_back: readNumber(fieldMap.years_back, true),
        start_balance: readNumber(fieldMap.start_balance),
        risk_level: readNumber(fieldMap.risk_level),
        profit_target: readNumber(fieldMap.profit_target),
        stop_loss: readNumber(fieldMap.stop_loss),
        seed: readNumber(fieldMap.seed, true),
        max_workers: readNumber(fieldMap.max_workers, true),
        symbol_cache: readText(fieldMap.symbol_cache),
        price_cache_dir: readText(fieldMap.price_cache_dir),
        output_dir: readText(fieldMap.output_dir),
        output_name: readText(fieldMap.output_name),
        generate_only: Boolean(fieldMap.generate_only && fieldMap.generate_only.checked),
      };

      Object.keys(overrides).forEach((key) => {
        const value = overrides[key];
        if (value === null) {
          delete overrides[key];
        }
      });

      return overrides;
    };

    const runSimulation = async (context, overrides) => {
      const { button, accountId, statusEl, originalLabel } = context;
      let payload = null;

      button.disabled = true;
      button.textContent = 'Simulating…';
      setStatus(statusEl, 'Running trade simulation…');

      try {
        const response = await fetch(`/api/accounts/${encodeURIComponent(accountId)}/simulate`, {
          method: 'POST',
          headers: {
            Accept: 'application/json',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(overrides),
        });

        const contentType = response.headers.get('content-type') || '';
        if (contentType.includes('application/json')) {
          payload = await response.json();
        }

        if (!response.ok || !payload || payload.ok !== true) {
          const message = (payload && payload.detail) ? payload.detail : 'Failed to simulate trades.';
          setStatus(statusEl, message, 'error');
          button.disabled = false;
          button.textContent = originalLabel;
          return;
        }

        if (payload.generate_only) {
          const message = payload.message || 'Symbol and price caches have been updated.';
          setStatus(statusEl, message, 'success');
          button.disabled = false;
          button.textContent = originalLabel;
          return;
        }

        const tradesImported = typeof payload.trades_imported === 'number' ? payload.trades_imported : null;
        const daysWithTrades = typeof payload.days_with_trades === 'number' ? payload.days_with_trades : null;
        let successMessage = 'Simulation completed successfully.';
        if (tradesImported !== null && daysWithTrades !== null) {
          successMessage = `Imported ${tradesImported} simulated trades across ${daysWithTrades} day${daysWithTrades === 1 ? '' : 's'}.`;
        }
        setStatus(statusEl, `${successMessage} Reloading calendar…`, 'success');

        const redirect = typeof payload.redirect === 'string' && payload.redirect ? payload.redirect : '/';
        if (payload.reload) {
          setTimeout(() => {
            window.location.href = redirect;
          }, 1200);
        } else {
          button.disabled = false;
          button.textContent = originalLabel;
        }
      } catch (error) {
        console.error('Failed to simulate trades', error);
        setStatus(statusEl, 'Failed to simulate trades. Please try again.', 'error');
        button.disabled = false;
        button.textContent = originalLabel;
      }
    };

    buttons.forEach((button) => {
      button.addEventListener('click', async () => {
        const accountId = button.dataset.simulateTrades;
        if (!accountId) {
          return;
        }

        const card = button.closest('[data-account-card]');
        const statusEl = card ? card.querySelector('[data-simulate-status]') : null;
        const originalLabel = button.textContent || 'Simulate trades';

        const context = {
          button,
          accountId,
          statusEl,
          originalLabel,
        };

        await showDialog(context);
      });
    });

    const cancelHandler = () => {
      hideDialog();
      activeContext = null;
    };

    cancelButton?.addEventListener('click', cancelHandler);
    closeButton?.addEventListener('click', cancelHandler);

    dialog.addEventListener('click', (event) => {
      if (event.target === dialog) {
        cancelHandler();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && !dialog.classList.contains('hidden')) {
        cancelHandler();
      }
    });

    form.addEventListener('submit', (event) => {
      event.preventDefault();
      if (!activeContext) {
        hideDialog();
        return;
      }
      if (typeof form.reportValidity === 'function' && !form.reportValidity()) {
        return;
      }

      const overrides = collectOverrides();
      hideDialog(false);
      runSimulation(activeContext, overrides);
      activeContext = null;
    });
  })();
</script>
{% endblock %}
