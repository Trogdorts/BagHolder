{% extends "base.html" %}
{% block content %}
{% set show_unrealized = cfg.ui.get('show_unrealized', True) %}
{% set show_trade_count = cfg.ui.get('show_trade_count', True) %}
{% set show_text = cfg.ui.get('show_text', True) %}
{% set show_weekends = cfg.ui.get('show_weekends', False) %}
{% set default_view = cfg.view.get('default', 'latest') %}
{% set unrealized_fill = cfg.ui.get('unrealized_fill_strategy', 'carry_forward') %}
{% set export_fill_empty = cfg.export.get('fill_empty_with_zero', True) %}
<div class="settings-page">
  <section class="settings-hero">
    <div>
      <h1 class="text-neutral-50">Settings</h1>
      <p>Fine-tune BagHolder's appearance, data workflows, and diagnostics. Use the quick links below to jump to a section, or review the current defaults in the summary panel.</p>
      <nav class="settings-quicknav" aria-label="Settings quick navigation">
        <a href="#display-settings">Display &amp; calendar</a>
        <a href="#calculation-settings">Calculations</a>
        <a href="#palette-settings">Color palette</a>
        <a href="#diagnostic-settings">Diagnostics</a>
        <a href="#stock-data-import">Imports</a>
        <a href="#configuration-settings">Configuration</a>
        <a href="#backup-settings">Backups</a>
        <a href="#danger-zone">Danger zone</a>
      </nav>
    </div>
    <aside>
      <dl class="settings-summary-grid" aria-label="Current configuration summary">
        <div class="settings-summary-item">
          <dt>Active theme</dt>
          <dd>{{ cfg.ui.theme | default('dark') | replace('_', ' ') | title }}</dd>
        </div>
        <div class="settings-summary-item">
          <dt>Calendar start</dt>
          <dd>{{ 'Latest month' if default_view == 'latest' else 'Last viewed' }}</dd>
        </div>
        <div class="settings-summary-item">
          <dt>Weekends</dt>
          <dd>{{ 'Shown' if show_weekends else 'Hidden' }}</dd>
        </div>
        <div class="settings-summary-item">
          <dt>Unrealized P&amp;L</dt>
          <dd>{{ 'Visible by default' if show_unrealized else 'Hidden by default' }}</dd>
        </div>
        <div class="settings-summary-item">
          <dt>Trade badges</dt>
          <dd>{{ 'Enabled' if show_trade_count else 'Disabled' }}</dd>
        </div>
        <div class="settings-summary-item">
          <dt>Diagnostics</dt>
          <dd>{{ 'Logging on' if debug_logging_enabled else 'Logging off' }}</dd>
        </div>
      </dl>
    </aside>
  </section>

  <div class="space-y-3">
    {% if config_imported %}
      <div class="alert alert-success px-4 py-3 text-sm">Configuration imported successfully.</div>
    {% elif config_error_message %}
      <div class="alert alert-error px-4 py-3 text-sm">{{ config_error_message }}</div>
    {% endif %}
    {% if backup_restored %}
      <div class="alert alert-success px-4 py-3 text-sm">Backup imported successfully.</div>
    {% elif backup_error_message %}
      <div class="alert alert-error px-4 py-3 text-sm">{{ backup_error_message }}</div>
    {% endif %}
    {% if log_error_message %}
      <div class="alert alert-error px-4 py-3 text-sm">{{ log_error_message }}</div>
    {% endif %}
    {% if cleared %}
      <div class="alert alert-success px-4 py-3 text-sm">All application data has been cleared.</div>
    {% endif %}
    {% if shutting_down %}
      <div class="alert alert-warning px-4 py-3 text-sm">The server is shutting down. You may now close this window.</div>
    {% endif %}
  </div>

  <div class="settings-grid two-column lg:grid-cols-4">
    <form method="post" action="/settings" class="space-y-8 lg:col-span-3"
          x-data="{
            showUnrealizedSetting: {{ 'true' if show_unrealized else 'false' }},
            hasChanges: false,
            initialData: '',
            formEl: null,
            defaultColors: {{ color_defaults | default({}, true) | tojson }},
            init() {
              this.formEl = this.$el;
              this.initialData = this.serializeForm();
              this.$watch('showUnrealizedSetting', () => this.evaluateChanges());
              this.formEl.addEventListener('input', () => this.evaluateChanges());
              this.formEl.addEventListener('change', () => this.evaluateChanges());
            },
            serializeForm() {
              if (!this.formEl) {
                return '';
              }
              const formData = new FormData(this.formEl);
              formData.set('show_unrealized', this.showUnrealizedSetting ? 'true' : 'false');
              return new URLSearchParams(formData).toString();
            },
            evaluateChanges() {
              this.hasChanges = this.serializeForm() !== this.initialData;
            },
            resetChanges() {
              this.initialData = this.serializeForm();
              this.hasChanges = false;
            },
            isColorDefault(field) {
              if (!this.formEl || !this.defaultColors[field]) {
                return false;
              }
              const input = this.formEl.querySelector(`[name='${field}']`);
              if (!input) {
                return false;
              }
              return input.value.toLowerCase() === this.defaultColors[field];
            },
            resetColor(field) {
              const defaultValue = this.defaultColors[field];
              if (!defaultValue || !this.formEl) {
                return;
              }
              const input = this.formEl.querySelector(`[name='${field}']`);
              if (!input) {
                return;
              }
              input.value = defaultValue;
              input.dispatchEvent(new Event('input', { bubbles: true }));
              input.dispatchEvent(new Event('change', { bubbles: true }));
              this.evaluateChanges();
            },
            resetAllColors() {
              if (!this.formEl) {
                return;
              }
              Object.keys(this.defaultColors).forEach((field) => {
                this.resetColor(field);
              });
            },
            colorsAreDefault() {
              if (!this.formEl) {
                return false;
              }
              return Object.keys(this.defaultColors).every((field) => this.isColorDefault(field));
            }
          }"
          @submit="resetChanges()">
      <div x-show="hasChanges" x-cloak x-transition.opacity.duration.200ms class="alert alert-warning px-4 py-3 text-sm">
        You have unsaved changes. Don't forget to save before leaving this page.
      </div>

      <section id="display-settings" class="settings-card settings-section space-y-6">
        <div>
          <h2 class="settings-section-title text-neutral-100">Display &amp; calendar</h2>
          <p class="settings-muted">Choose how the calendar renders by default across views.</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="space-y-2 block">
            <span class="text-sm font-medium text-neutral-200">Theme</span>
            <select name="theme" class="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="dark" {% if cfg.ui.theme == 'dark' %}selected{% endif %}>Dark</option>
              <option value="light" {% if cfg.ui.theme == 'light' %}selected{% endif %}>Light</option>
            </select>
          </label>
          <label class="space-y-2 block">
            <span class="text-sm font-medium text-neutral-200">Show daily profit and loss</span>
            <select name="show_text" class="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="true" {% if show_text %}selected{% endif %}>Show values</option>
              <option value="false" {% if not show_text %}selected{% endif %}>Hide values</option>
            </select>
          </label>
          <label class="space-y-2 block">
            <span class="text-sm font-medium text-neutral-200">Show trade count badges</span>
            <select name="show_trade_count" class="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="true" {% if show_trade_count %}selected{% endif %}>Show badges</option>
              <option value="false" {% if not show_trade_count %}selected{% endif %}>Hide badges</option>
            </select>
          </label>
          <div class="space-y-2 block">
            <span class="text-sm font-medium text-neutral-200">Unrealized values</span>
            <input type="hidden" name="show_unrealized" value="{{ 'true' if show_unrealized else 'false' }}"
                   :value="showUnrealizedSetting ? 'true' : 'false'">
            <button type="button"
                    class="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm font-medium transition"
                    :class="{ 'bg-neutral-800 text-neutral-100 border-neutral-600': !showUnrealizedSetting }"
                    @click="showUnrealizedSetting = !showUnrealizedSetting"
                    aria-pressed="{{ 'true' if show_unrealized else 'false' }}"
                    :aria-pressed="showUnrealizedSetting.toString()">
              <span x-text="showUnrealizedSetting ? 'Hide by default' : 'Show by default'">
                {% if show_unrealized %}Hide by default{% else %}Show by default{% endif %}
              </span>
            </button>
            <p class="settings-muted text-xs" x-show="!showUnrealizedSetting" x-cloak>
              Unrealized gains and losses remain hidden until toggled from the calendar toolbar.
            </p>
          </div>
          <label class="space-y-2 block">
            <span class="text-sm font-medium text-neutral-200">Display weekends</span>
            <select name="show_weekends" class="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="false" {% if not show_weekends %}selected{% endif %}>Hide weekends</option>
              <option value="true" {% if show_weekends %}selected{% endif %}>Show weekends</option>
            </select>
          </label>
          <label class="space-y-2 block">
            <span class="text-sm font-medium text-neutral-200">Default month view</span>
            <select name="default_view" class="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="latest" {% if default_view == 'latest' %}selected{% endif %}>Jump to latest month</option>
              <option value="last_viewed" {% if default_view == 'last_viewed' %}selected{% endif %}>Remember last viewed</option>
            </select>
          </label>
        </div>
      </section>

      <section id="calculation-settings" class="settings-card settings-section space-y-6">
        <div>
          <h2 class="settings-section-title text-neutral-100">Calculations &amp; export</h2>
          <p class="settings-muted">Define how gaps are filled and how CSV exports treat empty values.</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="space-y-2 block md:col-span-1">
            <span class="text-sm font-medium text-neutral-200">Missing unrealized values</span>
            <select name="unrealized_fill_strategy" class="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="carry_forward" {% if unrealized_fill == 'carry_forward' %}selected{% endif %}>Carry forward last known</option>
              <option value="average_neighbors" {% if unrealized_fill == 'average_neighbors' %}selected{% endif %}>Average nearest values</option>
            </select>
            <p class="settings-muted text-xs">Determines how empty calendar days are filled when no unrealized value was imported.</p>
          </label>
          <label class="space-y-2 block md:col-span-1">
            <span class="text-sm font-medium text-neutral-200">Empty values in exports</span>
            <select name="export_empty_values" class="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="zero" {% if export_fill_empty %}selected{% endif %}>Fill with 0</option>
              <option value="empty" {% if not export_fill_empty %}selected{% endif %}>Leave empty</option>
            </select>
            <p class="settings-muted text-xs">Control whether missing values export as zeros or blank cells.</p>
          </label>
        </div>
      </section>

      <section id="palette-settings" class="settings-card settings-section space-y-6">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h2 class="settings-section-title text-neutral-100">Color palette</h2>
            <p class="settings-muted">Adjust the interface accents used across the calendar, actions, and notes.</p>
          </div>
          <button type="button"
                  class="btn btn-outline-primary px-3 py-2 text-sm"
                  @click="resetAllColors()"
                  :class="{ 'opacity-50 cursor-not-allowed pointer-events-none': colorsAreDefault() }"
                  :aria-disabled="colorsAreDefault().toString()"
                  :disabled="colorsAreDefault()">
            Reset palette
          </button>
        </div>
        <div class="space-y-4">
          {% for group in color_groups | default([], true) %}
          <div class="settings-subcard space-y-4">
            <div>
              <h3 class="text-sm font-semibold text-neutral-100">{{ group.title }}</h3>
              <p class="settings-muted text-xs leading-snug">{{ group.description }}</p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
              {% for field in group.fields %}
              <label class="space-y-2 block">
                <div class="flex items-center justify-between gap-2">
                  <span class="text-sm font-medium text-neutral-200">{{ field.label }}</span>
                  <button type="button"
                          class="text-xs text-neutral-400 hover:text-neutral-100 transition"
                          @click.prevent="resetColor('{{ field.name }}')"
                          :class="{ 'opacity-40 pointer-events-none': isColorDefault('{{ field.name }}') }"
                          :aria-disabled="isColorDefault('{{ field.name }}').toString()">
                    Reset
                  </button>
                </div>
                <input type="color" name="{{ field.name }}" value="{{ field.current }}"
                       class="h-10 w-full cursor-pointer rounded border border-neutral-700 bg-transparent p-1">
                <p class="settings-muted text-xs leading-snug">
                  {{ field.description }}
                  <span class="ml-1 uppercase tracking-wide text-[11px]">Default: {{ field.default | upper }}</span>
                </p>
              </label>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        </div>
      </section>

      <section id="diagnostic-settings" class="settings-card settings-section space-y-6">
        <div>
          <h2 class="settings-section-title text-neutral-100">Diagnostics</h2>
          <p class="settings-muted">Persist detailed logs for troubleshooting and share them with support.</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="space-y-2 block">
            <span class="text-sm font-medium text-neutral-200">Debug logging</span>
            <select name="debug_logging" class="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100">
              <option value="true" {% if debug_logging_enabled %}selected{% endif %}>Enabled</option>
              <option value="false" {% if not debug_logging_enabled %}selected{% endif %}>Disabled</option>
            </select>
            <p class="settings-muted text-xs">When enabled, verbose diagnostic entries are stored in the persistent log file.</p>
          </label>
          <div class="space-y-2">
            <span class="text-sm font-medium text-neutral-200 block">Export debug log</span>
            <a href="/settings/logs/export"
               class="btn btn-outline-primary px-4 py-2 text-sm w-full md:w-auto {% if not log_export_available %}opacity-60 cursor-not-allowed pointer-events-none{% endif %}"
               {% if not log_export_available %}aria-disabled="true" tabindex="-1"{% endif %}>
              Download log
            </a>
            <p class="settings-muted text-xs">
              {% if log_export_available %}
                Download the latest log for sharing with support.
              {% else %}
                A log file appears here once the app records diagnostic events.
              {% endif %}
            </p>
          </div>
        </div>
      </section>

      <div class="settings-form-footer">
        <p class="settings-muted text-xs" x-show="!hasChanges" x-cloak>All changes are synced with the current configuration.</p>
        <button type="submit"
                class="btn btn-primary px-5 py-2.5"
                :class="{ 'opacity-60 cursor-not-allowed': !hasChanges }"
                :disabled="!hasChanges">
          Save changes
        </button>
      </div>
    </form>

    <div class="settings-aside lg:col-span-1">
      <section class="settings-card space-y-4">
        <div>
          <h2 class="settings-section-title text-neutral-100">Quick actions</h2>
          <p class="settings-muted">Jump directly to the tools used most often.</p>
        </div>
        <div class="settings-quicklinks-list">
          <a href="#stock-data-import">Import new trades</a>
          <a href="#configuration-settings">Export configuration</a>
          <a href="#backup-settings">Download a backup</a>
          <a href="#danger-zone">Reset or shut down</a>
        </div>
      </section>

      <section id="stock-data-import" class="settings-card settings-section space-y-4">
        <div>
          <h2 class="settings-section-title text-neutral-100">Stock data importing</h2>
          <p class="settings-muted">Upload CSV trade summaries or ThinkOrSwim statements.</p>
        </div>
        <div class="settings-subcard space-y-3">
          <h3 class="text-sm font-semibold text-neutral-100">Stock buy &amp; sell CSV trade data</h3>
          <p class="settings-muted text-xs">Import executed trades from a CSV with the columns date, symbol, action, qty, price, amount.</p>
          {% if trade_csv_error_message %}
          <div class="alert alert-error px-3 py-2 text-xs">{{ trade_csv_error_message }}</div>
          {% endif %}
          <form action="/import/trades" method="post" enctype="multipart/form-data" class="space-y-3">
            <input type="file" name="file" accept=".csv"
                   class="block w-full text-sm text-neutral-300 file:mr-4 file:rounded file:border-0 file:bg-neutral-800 file:px-4 file:py-2 file:text-neutral-200 hover:file:bg-neutral-700">
            <button class="btn btn-primary px-4 py-2">Upload</button>
          </form>
        </div>
        <div class="settings-subcard space-y-3">
          <h3 class="text-sm font-semibold text-neutral-100">ThinkOrSwim account statement</h3>
          <p class="settings-muted text-xs">Only trade fields are persisted (date, symbol, action, qty, price, amount). Account identifiers are discarded after parsing.</p>
          {% if thinkorswim_error_message %}
          <div class="alert alert-error px-3 py-2 text-xs">{{ thinkorswim_error_message }}</div>
          {% endif %}
          <form action="/import/thinkorswim" method="post" enctype="multipart/form-data" class="space-y-3">
            <input type="file" name="file" accept=".csv"
                   class="block w-full text-sm text-neutral-300 file:mr-4 file:rounded file:border-0 file:bg-neutral-800 file:px-4 file:py-2 file:text-neutral-200 hover:file:bg-neutral-700">
            <button class="btn btn-primary px-4 py-2">Upload</button>
          </form>
        </div>
      </section>

      <section id="configuration-settings" class="settings-card settings-section space-y-4">
        <div>
          <h2 class="settings-section-title text-neutral-100">Configuration</h2>
          <p class="settings-muted">Export the current configuration or apply a previously exported JSON file.</p>
        </div>
        <div class="grid gap-3">
          <a href="/settings/config/export"
             class="btn btn-primary px-4 py-2 text-center"
             download>
            Download config (JSON)
          </a>
          <form method="post" action="/settings/config/import" class="space-y-2" enctype="multipart/form-data">
            <label class="space-y-2 block">
              <span class="text-sm font-medium text-neutral-200">Import configuration file</span>
              <input type="file" name="config_file" accept=".json,application/json"
                     class="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100"
                     required>
            </label>
            <p class="settings-muted text-xs">Upload a JSON file exported from BagHolder. Missing values revert to their defaults.</p>
            <button type="submit" class="btn btn-primary w-full px-4 py-2">Import config</button>
          </form>
        </div>
      </section>

      <section id="backup-settings" class="settings-card settings-section space-y-4">
        <div>
          <h2 class="settings-section-title text-neutral-100">Full backup</h2>
          <p class="settings-muted">Create or restore a ZIP archive containing all application data.</p>
        </div>
        <div class="grid gap-3">
          <a href="/settings/backup/export"
             class="btn btn-primary px-4 py-2 text-center"
             download>
            Download full backup (ZIP)
          </a>
          <form method="post" action="/settings/backup/import" class="space-y-2" enctype="multipart/form-data">
            <label class="space-y-2 block">
              <span class="text-sm font-medium text-neutral-200">Import backup archive</span>
              <input type="file" name="backup_file" accept=".zip"
                     class="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100"
                     required>
            </label>
            <p class="settings-muted text-xs">Upload a ZIP file generated by BagHolder. Existing data will be replaced.</p>
            <button class="btn btn-primary w-full px-4 py-2">Import backup</button>
          </form>
        </div>
      </section>

      <section id="danger-zone" class="settings-card danger-zone settings-section space-y-4">
        <div>
          <h2 class="settings-section-title danger-text">Danger zone</h2>
          <p class="settings-muted danger-text-subtle">Clearing data removes every imported trade, calculated summary, and saved note. This action cannot be undone.</p>
        </div>
        <form method="post" action="/settings/clear-data"
              onsubmit="return confirm('This will delete all trades, summaries, and notes. Continue?');"
              class="space-y-2">
          <button class="btn btn-danger w-full px-4 py-2">Clear all data</button>
        </form>
        <form method="post" action="/settings/shutdown"
              onsubmit="return confirm('This will stop the server. Continue?');"
              class="space-y-2">
          <button class="btn btn-outline-danger w-full px-4 py-2">Shut down server</button>
        </form>
      </section>
    </div>
  </div>
</div>
{% endblock %}
