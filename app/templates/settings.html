{% extends "base.html" %}
{% block content %}
<h1 class="text-xl font-semibold mb-4">Settings</h1>
{% if config_imported %}
  <div class="mb-4 rounded border alert alert-success px-4 py-3 text-sm">
    Configuration imported successfully.
  </div>
{% elif config_error_message %}
  <div class="mb-4 rounded border alert alert-error px-4 py-3 text-sm">
    {{ config_error_message }}
  </div>
{% endif %}
{% if backup_restored %}
  <div class="mb-4 rounded border alert alert-success px-4 py-3 text-sm">
    Backup imported successfully.
  </div>
{% elif backup_error_message %}
  <div class="mb-4 rounded border alert alert-error px-4 py-3 text-sm">
    {{ backup_error_message }}
  </div>
{% endif %}
{% if cleared %}
  <div class="mb-4 rounded border alert alert-success px-4 py-3 text-sm">
    All application data has been cleared.
  </div>
{% endif %}
{% if shutting_down %}
  <div class="mb-4 rounded border alert alert-warning px-4 py-3 text-sm">
    The server is shutting down. You may now close this window.
  </div>
{% endif %}
{% set show_unrealized = cfg.ui.get('show_unrealized', True) %}
{% set show_trade_count = cfg.ui.get('show_trade_count', True) %}
{% set unrealized_fill = cfg.ui.get('unrealized_fill_strategy', 'carry_forward') %}
{% set export_fill_empty = cfg.export.get('fill_empty_with_zero', True) %}
<form method="post" action="/settings" class="space-y-4 bg-neutral-950 p-4 rounded border border-neutral-800"
      x-data="{
        showUnrealizedSetting: {{ 'true' if show_unrealized else 'false' }},
        hasChanges: false,
        initialData: '',
        formEl: null,
        init() {
          this.formEl = this.$el;
          this.initialData = this.serializeForm();
          this.$watch('showUnrealizedSetting', () => this.evaluateChanges());
          this.formEl.addEventListener('input', () => this.evaluateChanges());
          this.formEl.addEventListener('change', () => this.evaluateChanges());
        },
        serializeForm() {
          if (!this.formEl) {
            return '';
          }
          const formData = new FormData(this.formEl);
          formData.set('show_unrealized', this.showUnrealizedSetting ? 'true' : 'false');
          return new URLSearchParams(formData).toString();
        },
        evaluateChanges() {
          this.hasChanges = this.serializeForm() !== this.initialData;
        },
        resetChanges() {
          this.initialData = this.serializeForm();
          this.hasChanges = false;
        }
      }"
      @submit="resetChanges()">
  <div x-show="hasChanges" x-cloak x-transition.opacity.duration.150ms
       class="rounded border alert alert-warning px-4 py-3 text-sm">
    You have unsaved changes. Don't forget to save.
  </div>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <label class="block">
      <span class="block text-sm text-neutral-400">Theme</span>
      <select name="theme" class="bg-neutral-800 rounded px-2 py-1 w-full">
        <option value="dark" {% if cfg.ui.theme == 'dark' %}selected{% endif %}>Dark</option>
        <option value="light" {% if cfg.ui.theme == 'light' %}selected{% endif %}>Light</option>
      </select>
    </label>
    <label class="block">
      <span class="block text-sm text-neutral-400">Show daily profit and loss amount</span>
      <select name="show_text" class="bg-neutral-800 rounded px-2 py-1 w-full">
        <option value="true" {% if cfg.ui.show_text %}selected{% endif %}>True</option>
        <option value="false" {% if not cfg.ui.show_text %}selected{% endif %}>False</option>
      </select>
    </label>
    <label class="block">
      <span class="block text-sm text-neutral-400">Show trade count badges</span>
      <select name="show_trade_count" class="bg-neutral-800 rounded px-2 py-1 w-full">
        <option value="true" {% if show_trade_count %}selected{% endif %}>Show</option>
        <option value="false" {% if not show_trade_count %}selected{% endif %}>Hide</option>
      </select>
    </label>
    <div class="block">
      <span class="block text-sm text-neutral-400">Unrealized values</span>
      <input type="hidden" name="show_unrealized" value="{{ 'true' if show_unrealized else 'false' }}"
             :value="showUnrealizedSetting ? 'true' : 'false'">
      <button type="button"
              class="mt-1 w-full px-3 py-1 border border-neutral-700 rounded hover:bg-neutral-800 transition"
              :class="{ 'bg-neutral-800 text-neutral-100 border-neutral-600': !showUnrealizedSetting }"
              @click="showUnrealizedSetting = !showUnrealizedSetting"
              aria-pressed="{{ 'true' if show_unrealized else 'false' }}"
              :aria-pressed="showUnrealizedSetting.toString()">
        <span x-text="showUnrealizedSetting ? 'Hide by default' : 'Show by default'">
          {% if show_unrealized %}Hide by default{% else %}Show by default{% endif %}
        </span>
      </button>
      <p class="mt-1 text-xs text-neutral-500" x-show="!showUnrealizedSetting" x-cloak>
        Unrealized gains and losses will be hidden unless toggled on the calendar view.
      </p>
    </div>
    <label class="block">
      <span class="block text-sm text-neutral-400">Missing unrealized fill</span>
      <select name="unrealized_fill_strategy" class="bg-neutral-800 rounded px-2 py-1 w-full">
        <option value="carry_forward" {% if unrealized_fill == 'carry_forward' %}selected{% endif %}>Carry forward</option>
        <option value="average_neighbors" {% if unrealized_fill == 'average_neighbors' %}selected{% endif %}>Average nearest values</option>
      </select>
      <p class="mt-1 text-xs text-neutral-500">
        Choose how to populate days without an imported unrealized value on the calendar view.
      </p>
    </label>
    <label class="block">
      <span class="block text-sm text-neutral-400">Display weekends</span>
      <select name="show_weekends" class="bg-neutral-800 rounded px-2 py-1 w-full">
        <option value="false" {% if not cfg.ui.show_weekends %}selected{% endif %}>Hide</option>
        <option value="true" {% if cfg.ui.show_weekends %}selected{% endif %}>Show</option>
      </select>
    </label>
    <label class="block">
      <span class="block text-sm text-neutral-400">Default month view</span>
      <select name="default_view" class="bg-neutral-800 rounded px-2 py-1 w-full">
        <option value="latest" {% if cfg.view.default == 'latest' %}selected{% endif %}>Latest</option>
        <option value="last_viewed" {% if cfg.view.default == 'last_viewed' %}selected{% endif %}>Last Viewed</option>
      </select>
    </label>
  </div>
  <div class="pt-4 border-t border-neutral-800">
    <h2 class="text-lg font-semibold mb-2">Color palette</h2>
    <p class="text-sm text-neutral-500 mb-3">
      Customize the accent colors used for buttons, alerts, and trade highlights.
    </p>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <label class="block">
        <span class="block text-sm text-neutral-400">Action icon color</span>
        <input type="color" name="icon_color" value="{{ cfg.ui.icon_color }}"
               class="bg-neutral-800 rounded px-2 py-1 w-full h-10 p-1 cursor-pointer">
      </label>
      <label class="block">
        <span class="block text-sm text-neutral-400">Primary button color</span>
        <input type="color" name="primary_color" value="{{ cfg.ui.primary_color }}"
               class="bg-neutral-800 rounded px-2 py-1 w-full h-10 p-1 cursor-pointer">
      </label>
      <label class="block">
        <span class="block text-sm text-neutral-400">Primary hover color</span>
        <input type="color" name="primary_hover_color" value="{{ cfg.ui.primary_hover_color }}"
               class="bg-neutral-800 rounded px-2 py-1 w-full h-10 p-1 cursor-pointer">
      </label>
      <label class="block">
        <span class="block text-sm text-neutral-400">Success accent color</span>
        <input type="color" name="success_color" value="{{ cfg.ui.success_color }}"
               class="bg-neutral-800 rounded px-2 py-1 w-full h-10 p-1 cursor-pointer">
      </label>
      <label class="block">
        <span class="block text-sm text-neutral-400">Warning accent color</span>
        <input type="color" name="warning_color" value="{{ cfg.ui.warning_color }}"
               class="bg-neutral-800 rounded px-2 py-1 w-full h-10 p-1 cursor-pointer">
      </label>
      <label class="block">
        <span class="block text-sm text-neutral-400">Danger accent color</span>
        <input type="color" name="danger_color" value="{{ cfg.ui.danger_color }}"
               class="bg-neutral-800 rounded px-2 py-1 w-full h-10 p-1 cursor-pointer">
      </label>
      <label class="block">
        <span class="block text-sm text-neutral-400">Danger hover color</span>
        <input type="color" name="danger_hover_color" value="{{ cfg.ui.danger_hover_color }}"
               class="bg-neutral-800 rounded px-2 py-1 w-full h-10 p-1 cursor-pointer">
      </label>
      <label class="block">
        <span class="block text-sm text-neutral-400">Trade badge color</span>
        <input type="color" name="trade_badge_color" value="{{ cfg.ui.trade_badge_color }}"
               class="bg-neutral-800 rounded px-2 py-1 w-full h-10 p-1 cursor-pointer">
      </label>
      <label class="block">
        <span class="block text-sm text-neutral-400">Trade badge text color</span>
        <input type="color" name="trade_badge_text_color" value="{{ cfg.ui.trade_badge_text_color }}"
               class="bg-neutral-800 rounded px-2 py-1 w-full h-10 p-1 cursor-pointer">
      </label>
      <label class="block">
        <span class="block text-sm text-neutral-400">Note icon highlight color</span>
        <input type="color" name="note_icon_color" value="{{ cfg.notes.icon_has_note_color }}"
               class="bg-neutral-800 rounded px-2 py-1 w-full h-10 p-1 cursor-pointer">
        <p class="mt-1 text-xs text-neutral-500">Applies when a day or week already has a note.</p>
      </label>
    </div>
  </div>
  <div class="pt-4 border-t border-neutral-800">
    <h2 class="text-lg font-semibold mb-2">Export data</h2>
    <p class="text-sm text-neutral-500 mb-3">
      Choose how empty values should appear when exporting daily summaries.
    </p>
    <label class="block md:w-1/2">
      <span class="block text-sm text-neutral-400">Empty value handling</span>
      <select name="export_empty_values" class="bg-neutral-800 rounded px-2 py-1 w-full">
        <option value="zero" {% if export_fill_empty %}selected{% endif %}>Fill with 0</option>
        <option value="empty" {% if not export_fill_empty %}selected{% endif %}>Leave empty</option>
      </select>
    </label>
  </div>
  <button class="btn btn-primary px-4 py-2">Save</button>
</form>

<div id="stock-data-import" class="mt-6 rounded border border-neutral-800 bg-neutral-950 p-4 space-y-6">
  <div>
    <h2 class="text-lg font-semibold">Stock data importing</h2>
    <p class="text-sm text-neutral-500">
      Upload CSV files with historical summaries or broker statements using the workflows below.
    </p>
  </div>
  <section class="space-y-3 rounded border border-neutral-800 bg-neutral-900 p-4">
    <h3 class="text-base font-semibold">Stock buy &amp; sell CSV trade data</h3>
    <p class="text-sm text-neutral-400">Import executed stock trades from a CSV with columns: date, symbol, action, qty, price, amount.</p>
    {% if trade_csv_error_message %}
    <div class="rounded border alert alert-error p-3 text-sm">
      {{ trade_csv_error_message }}
    </div>
    {% endif %}
    <form action="/import/trades" method="post" enctype="multipart/form-data" class="space-y-4">
      <input type="file" name="file" accept=".csv"
             class="block w-full text-sm text-neutral-300 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:bg-neutral-800 file:text-neutral-200 hover:file:bg-neutral-700">
      <button class="btn btn-primary px-4 py-2">Upload</button>
    </form>
  </section>
  <section class="space-y-3 rounded border border-neutral-800 bg-neutral-900 p-4">
    <h3 class="text-base font-semibold">ThinkOrSwim account statement</h3>
    <p class="text-sm text-neutral-400">Only trade fields are persisted (date, symbol, action, qty, price, amount). Account identifiers are discarded after parsing.</p>
    {% if thinkorswim_error_message %}
    <div class="rounded border alert alert-error p-3 text-sm">
      {{ thinkorswim_error_message }}
    </div>
    {% endif %}
    <form action="/import/thinkorswim" method="post" enctype="multipart/form-data" class="space-y-4">
      <input type="file" name="file" accept=".csv"
             class="block w-full text-sm text-neutral-300 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:bg-neutral-800 file:text-neutral-200 hover:file:bg-neutral-700">
      <button class="btn btn-primary px-4 py-2">Upload</button>
    </form>
  </section>
  <section class="space-y-3 rounded border border-neutral-800 bg-neutral-900 p-4">
    <h3 class="text-base font-semibold">Daily summaries</h3>
    <p class="text-sm text-neutral-400">Restore daily realized and unrealized performance from a CSV export. Columns: date, realized, unrealized.</p>
    {% if daily_summary_error_message %}
    <div class="rounded border alert alert-error p-3 text-sm">
      {{ daily_summary_error_message }}
    </div>
    {% endif %}
    <form action="/import/daily-summaries" method="post" enctype="multipart/form-data" class="space-y-4">
      <input type="file" name="file" accept=".csv"
             class="block w-full text-sm text-neutral-300 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:bg-neutral-800 file:text-neutral-200 hover:file:bg-neutral-700">
      <button class="btn btn-primary px-4 py-2">Upload</button>
    </form>
  </section>
</div>

<div class="mt-6 rounded border border-neutral-800 bg-neutral-950 p-4 space-y-3">
  <h2 class="text-lg font-semibold">Configuration</h2>
  <p class="text-sm text-neutral-500">
    Download a JSON copy of your current configuration or import a configuration that was previously exported.
  </p>
  <div class="grid gap-4 md:grid-cols-2">
    <a href="/settings/config/export"
       class="btn btn-primary w-full px-4 py-2"
       download>
      Download config (JSON)
    </a>
    <form method="post" action="/settings/config/import" class="space-y-2" enctype="multipart/form-data">
      <label class="block">
        <span class="block text-sm text-neutral-400">Import configuration file</span>
        <input type="file" name="config_file" accept=".json,application/json"
               class="mt-1 w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100"
               required>
      </label>
      <p class="text-xs text-neutral-500">
        Upload a JSON file exported from BagHolder. Missing values revert to their defaults.
      </p>
      <button type="submit" class="btn btn-primary w-full px-4 py-2">
        Import config
      </button>
    </form>
  </div>
</div>

<div class="mt-6 rounded border border-neutral-800 bg-neutral-950 p-4 space-y-3">
  <h2 class="text-lg font-semibold">Full backup</h2>
  <p class="text-sm text-neutral-500">
    Download a ZIP archive containing all application data, or restore from a previous export.
  </p>
  <div class="grid gap-4 md:grid-cols-2">
    <a href="/settings/backup/export"
       class="btn btn-primary w-full px-4 py-2"
       download>
      Download full backup (ZIP)
    </a>
    <form method="post" action="/settings/backup/import" class="space-y-2" enctype="multipart/form-data">
      <label class="block">
        <span class="block text-sm text-neutral-400">Import backup archive</span>
        <input type="file" name="backup_file" accept=".zip"
               class="mt-1 w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100"
               required>
      </label>
      <p class="text-xs text-neutral-500">
        Upload a ZIP file generated by BagHolder. The current database, notes, and configuration will be replaced.
      </p>
      <button class="btn btn-primary w-full px-4 py-2">
        Import backup
      </button>
    </form>
  </div>
</div>

<div class="danger-zone mt-6 space-y-3 rounded border p-4">
  <div>
    <h2 class="text-lg font-semibold danger-text">Danger zone</h2>
    <p class="text-sm danger-text-subtle">
      Clearing data removes every imported trade, calculated summary, and saved note. This action cannot be undone.
    </p>
  </div>
  <form method="post" action="/settings/clear-data"
        onsubmit="return confirm('This will delete all trades, summaries, and notes. Continue?');"
        class="space-y-2">
    <button class="btn btn-danger w-full px-4 py-2">Clear all data</button>
  </form>
  <form method="post" action="/settings/shutdown"
        onsubmit="return confirm('This will stop the server. Continue?');"
        class="space-y-2">
    <button class="btn btn-outline-danger w-full px-4 py-2">
      Shut down server
    </button>
  </form>
</div>
{% endblock %}
